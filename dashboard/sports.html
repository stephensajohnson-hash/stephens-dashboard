<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Season Tracker</title>
    <link rel="icon" href="/images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg-dark: #111827; --panel-bg: rgba(31, 41, 55, 0.7); --sports-red: #ef4444; }
        body { background-color: var(--bg-dark); color: white; font-family: 'Inter', sans-serif; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }

        .glass-panel { 
            background: var(--panel-bg); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.1); 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .game-card {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 220px; 
        }
        .game-card.editable:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); 
            background-color: rgba(55, 65, 81, 0.9);
        }
        
        /* Visual styles for read-only archive items */
        .game-card.archived {
            opacity: 0.75;
            border-style: dashed;
            border-color: #4b5563;
        }
        
        .win-border { border-top: 4px solid #10b981; }
        .loss-border { border-top: 4px solid #ef4444; }
        .tie-border { border-top: 4px solid #9ca3af; }
        .scheduled-border { border-top: 4px solid #3b82f6; }
        
        .team-logo-lg { width: 80px; height: 80px; object-fit: contain; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 right-0 bg-gray-800 border-b border-gray-700 shadow-xl z-40 p-2 flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
            <a href="bullet_calendar.html" class="text-gray-400 hover:text-white p-2 transition-colors flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                <span class="font-bold text-lg">Back to Calendar</span>
            </a>
        </div>
        <div class="text-xl font-bold text-red-500 tracking-widest uppercase">Season Tracker</div>
        <div class="w-24"></div> 
    </nav>

    <!-- Main Layout -->
    <div class="flex flex-1 pt-16 h-full">
        
        <!-- Sidebar Controls -->
        <aside class="w-64 bg-gray-800 border-r border-gray-700 p-6 flex flex-col gap-6 shrink-0">
            
            <!-- Archive Loader -->
            <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-700 text-center" id="archive-control">
                <p class="text-xs text-gray-500 mb-2">Viewing Local Data</p>
                <button onclick="loadArchives()" class="w-full bg-gray-700 hover:bg-gray-600 text-blue-300 text-xs font-bold py-2 rounded border border-gray-600 flex items-center justify-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Load Archives (2025-30)
                </button>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Filter by League</label>
                <select id="league-select" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:border-red-500 outline-none" onchange="updateSeasonOptions()">
                    <!-- Populated via JS -->
                </select>
            </div>
            
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Season</label>
                <select id="season-select" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:border-red-500 outline-none" onchange="renderPage()">
                     <!-- Populated Dynamic via JS -->
                </select>
            </div>

            <div class="mt-auto pt-6 border-t border-gray-700">
                <button onclick="openAddGameModal()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded shadow-lg flex items-center justify-center gap-2 transition-colors">
                    <span>+ Add Game</span>
                </button>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto p-8 bg-gray-900">
            
            <!-- Stats Banner -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center">
                    <span class="text-gray-400 text-xs uppercase tracking-wider">Record</span>
                    <span class="text-4xl font-black text-white mt-1" id="stat-record">0-0-0</span>
                </div>
                <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center">
                    <span class="text-gray-400 text-xs uppercase tracking-wider">Win %</span>
                    <span class="text-4xl font-black text-green-400 mt-1" id="stat-winpct">.000</span>
                </div>
                <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center">
                    <span class="text-gray-400 text-xs uppercase tracking-wider">Streak</span>
                    <span class="text-4xl font-black text-blue-400 mt-1" id="stat-streak">-</span>
                </div>
                <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center bg-red-900/20 border-red-800/50">
                    <span class="text-red-300 text-xs uppercase tracking-wider">Next Game</span>
                    <div class="text-center mt-1" id="stat-next-game">
                        <span class="text-sm text-gray-400">No Upcoming Games</span>
                    </div>
                </div>
            </div>

            <!-- Game List Grid -->
            <h2 class="text-xl font-bold text-gray-400 mb-4 border-b border-gray-700 pb-2 flex justify-between items-end">
                <span>Game Schedule</span>
                <span class="text-xs font-normal text-gray-500" id="game-count-label">0 Games</span>
            </h2>
            
            <div id="game-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Games injected here -->
            </div>
            
            <div id="loader" class="hidden text-center py-10 text-gray-500 italic">Loading historical data...</div>
        </main>
    </div>

    <!-- Add/Edit Game Modal -->
    <div id="game-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-2xl w-full max-w-md border border-gray-700 shadow-2xl p-6">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-2">
                <h3 class="text-xl font-bold text-white" id="modal-title">Add Game</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <input type="hidden" id="edit-game-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs text-gray-500 block mb-1">Date</label><input type="date" id="game-date" class="w-full bg-gray-700 rounded p-2 text-white focus:border-red-500 outline-none"></div>
                    <div><label class="text-xs text-gray-500 block mb-1">Time</label><input type="time" id="game-time" class="w-full bg-gray-700 rounded p-2 text-white focus:border-red-500 outline-none"></div>
                </div>
                
                <div class="flex items-end gap-2">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 block mb-1">Home Team</label>
                        <select id="game-home-team" class="w-full bg-gray-700 rounded p-2 text-white text-sm focus:border-red-500 outline-none"></select>
                    </div>
                    <span class="text-gray-500 pb-2">vs</span>
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 block mb-1">Away Team</label>
                        <select id="game-away-team" class="w-full bg-gray-700 rounded p-2 text-white text-sm focus:border-red-500 outline-none"></select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                    <div><label class="text-xs text-gray-500 block mb-1">Home Score</label><input type="number" id="game-home-score" class="w-full bg-gray-700 rounded p-2 text-white text-center font-bold focus:border-red-500 outline-none"></div>
                    <div><label class="text-xs text-gray-500 block mb-1">Away Score</label><input type="number" id="game-away-score" class="w-full bg-gray-700 rounded p-2 text-white text-center font-bold focus:border-red-500 outline-none"></div>
                </div>
                
                <div>
                    <label class="text-xs text-gray-500 block mb-1">Location / Notes</label>
                    <input type="text" id="game-location" class="w-full bg-gray-700 rounded p-2 text-white text-sm focus:border-red-500 outline-none" placeholder="Stadium...">
                </div>
                
                <div>
                    <label class="text-xs text-gray-500 block mb-1">Season</label>
                    <input type="text" id="game-season-input" class="w-full bg-gray-700 rounded p-2 text-white text-sm focus:border-red-500 outline-none">
                </div>

                <button onclick="saveGame()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2 rounded mt-2">Save Game</button>
                <button onclick="deleteGame()" id="btn-delete" class="w-full text-red-400 hover:text-red-300 text-xs py-2 hidden border border-red-900/30 rounded mt-2 hover:bg-red-900/20">Delete Game</button>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'bullet_cal_data_v2'; 
        const ARCHIVE_YEARS = [2025, 2026, 2027, 2028, 2029, 2030];
        const DEFAULT_DATA = { "meta": { "year": 2025, "version": "1.2", "owner": "Stephens" }, "leagues": [], "teams": [], "items": [] };
        
        let appData = { leagues: [], teams: [], items: [] }; // Local
        let combinedData = { leagues: [], teams: [], items: [] }; // Local + Archive
        
        let currentLeague = '';

        window.onload = async () => {
            await loadData();
        };

        async function loadData() {
            // Load Local
            try {
                const localStr = localStorage.getItem(STORAGE_KEY);
                if (localStr) {
                    const json = JSON.parse(localStr);
                    appData = { ...appData, ...json };
                } else {
                     // Fallback default init if empty
                     appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
                     saveData();
                }
            } catch (e) { console.error("Load Error", e); }
            
            // Initial Combined is just AppData
            combinedData = JSON.parse(JSON.stringify(appData));
            
            initFilters();
        }
        
        async function loadArchives() {
            const loader = document.getElementById('loader');
            const btn = document.getElementById('archive-control');
            loader.classList.remove('hidden');
            
            const promises = ARCHIVE_YEARS.map(year => 
                fetch(`bullet_cal_data_${year}.json`)
                    .then(res => { if(!res.ok) throw new Error(); return res.json(); })
                    .catch(() => null) // Ignore missing files
            );
            
            const results = await Promise.all(promises);
            
            // Merge
            // We need a Map to deduplicate items by ID. Local appData takes precedence.
            const itemMap = new Map();
            const teamMap = new Map();
            const leagueSet = new Set(appData.leagues);

            // 1. Add Local Data First (Priority)
            appData.items.forEach(i => itemMap.set(i.id, i));
            appData.teams.forEach(t => teamMap.set(t.id, t));

            // 2. Add Archives (Only if ID not present)
            results.forEach(data => {
                if(!data) return;
                
                if(data.items) {
                    data.items.forEach(i => {
                        if(!itemMap.has(i.id) && i.type === 'sports') itemMap.set(i.id, i);
                    });
                }
                if(data.teams) {
                    data.teams.forEach(t => {
                        if(!teamMap.has(t.id)) teamMap.set(t.id, t);
                    });
                }
                if(data.leagues) {
                    data.leagues.forEach(l => leagueSet.add(l));
                }
            });
            
            combinedData.items = Array.from(itemMap.values());
            combinedData.teams = Array.from(teamMap.values());
            combinedData.leagues = Array.from(leagueSet);
            
            loader.classList.add('hidden');
            btn.innerHTML = '<span class="text-green-400 text-xs">âœ“ Archives Loaded</span>';
            
            // Refresh UI
            initFilters(); // Re-init to catch new leagues
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
                // After save, re-merge to update view
                // Simple way: just update combined items with new appData items
                // For full correctness we might re-run loadArchives logic but that's heavy.
                // We'll just update combined items that match ID
                appData.items.forEach(localItem => {
                    const idx = combinedData.items.findIndex(c => c.id === localItem.id);
                    if (idx !== -1) combinedData.items[idx] = localItem;
                    else combinedData.items.push(localItem);
                });
                
            } catch(e) { console.error("Save Error", e); }
        }

        function initFilters() {
            const sel = document.getElementById('league-select');
            const oldVal = sel.value;
            
            // Sort leagues
            const sortedLeagues = (combinedData.leagues || []).sort();
            
            sel.innerHTML = sortedLeagues.map(l => `<option value="${l}">${l}</option>`).join('');
            
            if (oldVal && sortedLeagues.includes(oldVal)) sel.value = oldVal;
            else if (sortedLeagues.length > 0) currentLeague = sortedLeagues[0];
            else currentLeague = "";
            
            if(currentLeague) sel.value = currentLeague;
            
            updateSeasonOptions();
        }

        function updateSeasonOptions() {
            currentLeague = document.getElementById('league-select').value;
            const seasonSel = document.getElementById('season-select');
            const oldSeason = seasonSel.value;

            const seasons = new Set();
            const currentYear = new Date().getFullYear();
            // Default if no data
            seasons.add(`${currentYear}/${currentYear+1}`);
            
            // Scan combined items for seasons
            (combinedData.items || []).forEach(item => {
                if (item.type === 'sports' && item.league === currentLeague && item.season) {
                    seasons.add(item.season);
                }
            });
            
            const sortedSeasons = Array.from(seasons).sort().reverse();
            
            seasonSel.innerHTML = sortedSeasons.map(s => `<option value="${s}">${s}</option>`).join('');
            
            if (oldSeason && sortedSeasons.includes(oldSeason)) seasonSel.value = oldSeason;
            
            populateTeamSelects();
            renderPage();
        }

        function populateTeamSelects() {
            const h = document.getElementById('game-home-team');
            const a = document.getElementById('game-away-team');
            h.innerHTML = ''; a.innerHTML = '';
            
            const league = document.getElementById('league-select').value;
            const teams = combinedData.teams.filter(t => t.league === league).sort((a,b) => a.name.localeCompare(b.name));
            
            teams.forEach(t => {
                const opt = `<option value="${t.id}">${t.name}</option>`;
                h.innerHTML += opt;
                a.innerHTML += opt;
            });
        }
        
        function parseLocalYMD(dateStr) {
            if(!dateStr) return new Date();
            const parts = dateStr.split('-');
            return new Date(parts[0], parts[1]-1, parts[2]);
        }

        function renderPage() {
            currentLeague = document.getElementById('league-select').value;
            const season = document.getElementById('season-select').value;
            const container = document.getElementById('game-list');
            container.innerHTML = '';

            // Filter Games from Combined Data
            let games = (combinedData.items || []).filter(i => 
                i.type === 'sports' && 
                i.league === currentLeague && 
                (i.season === season)
            );
            
            document.getElementById('game-count-label').innerText = `${games.length} Games`;

            games.sort((a, b) => {
                const dateA = new Date(a.date + 'T' + (a.startTime || '00:00'));
                const dateB = new Date(b.date + 'T' + (b.startTime || '00:00'));
                return dateA - dateB;
            });

            const favTeam = combinedData.teams.find(t => t.league === currentLeague && t.isFavorite);
            
            let wins=0, losses=0, ties=0;
            let nextGame = null;
            const now = new Date();
            const todayStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
            let completedGames = [];

            games.forEach(g => {
                const home = combinedData.teams.find(t => t.id === g.homeTeamId) || { name: 'Unknown', logo: '', abbrev: 'UNK' };
                const away = combinedData.teams.find(t => t.id === g.awayTeamId) || { name: 'Unknown', logo: '', abbrev: 'UNK' };
                
                // Is this item editable? (Exists in local AppData)
                const isEditable = appData.items.some(i => i.id === g.id);
                
                let borderClass = 'scheduled-border';
                let resultBadge = '';
                let cardOpacity = isEditable ? 'opacity-100' : 'game-card archived'; // Style for archive

                if (g.status === 'completed') {
                    if(isEditable) cardOpacity = 'opacity-80 hover:opacity-100';
                    
                    if (favTeam) {
                        const isHome = g.homeTeamId === favTeam.id;
                        const isAway = g.awayTeamId === favTeam.id;
                        
                        if (isHome || isAway) {
                            const myScore = isHome ? g.homeScore : g.awayScore;
                            const oppScore = isHome ? g.awayScore : g.homeScore;
                            
                            let resultChar = 'T';
                            if (myScore > oppScore) { wins++; resultChar = 'W'; borderClass = 'win-border'; }
                            else if (myScore < oppScore) { losses++; resultChar = 'L'; borderClass = 'loss-border'; }
                            else { ties++; borderClass = 'tie-border'; }
                            
                            completedGames.push({ date: g.date, result: resultChar });
                            
                            let badgeColor = resultChar === 'W' ? 'bg-green-600' : (resultChar === 'L' ? 'bg-red-600' : 'bg-gray-500');
                            resultBadge = `<div class="absolute top-2 right-2 ${badgeColor} text-white text-[10px] font-bold px-2 py-0.5 rounded shadow">${resultChar}</div>`;
                        } else {
                            borderClass = 'tie-border';
                        }
                    } else {
                        borderClass = 'tie-border';
                    }
                } else {
                    if (!nextGame && g.date >= todayStr) {
                        nextGame = g;
                        borderClass = 'border-t-4 border-yellow-400'; 
                    }
                }

                const dateObj = parseLocalYMD(g.date);
                const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                const timeStr = g.startTime ? formatTime12(g.startTime) : 'TBD';
                
                const scoreDisplay = g.status === 'completed' 
                    ? `<div class="text-3xl font-black tracking-widest flex gap-4"><span>${g.awayScore}</span><span class="text-gray-600">-</span><span>${g.homeScore}</span></div>`
                    : `<div class="text-lg font-mono text-blue-300 bg-blue-900/20 border border-blue-800/50 px-3 py-1 rounded mt-1">${timeStr}</div>`;

                // Click handler only for editable items
                const clickAttr = isEditable ? `onclick="editGame('${g.id}')"` : '';
                const editClass = isEditable ? 'editable cursor-pointer' : 'cursor-default';

                const html = `
                    <div class="glass-panel rounded-xl p-0 flex flex-col game-card ${editClass} ${borderClass} ${cardOpacity} relative" ${clickAttr}>
                        ${resultBadge}
                        ${!isEditable ? '<div class="absolute top-2 left-2 bg-gray-700/80 text-white text-[10px] px-2 py-0.5 rounded">ARCHIVE</div>' : ''}
                        <div class="bg-gray-800/50 p-3 flex justify-between items-center border-b border-gray-700/50">
                            <div class="text-xs font-bold text-gray-400 uppercase tracking-wider">${dateStr}</div>
                            <div class="text-[10px] text-gray-500 truncate max-w-[50%]">${g.description || ''}</div>
                        </div>
                        
                        <div class="flex-1 flex items-center justify-between px-6 py-6">
                            <div class="flex flex-col items-center w-1/3 group">
                                <img src="${away.logo}" class="team-logo-lg mb-2" onerror="this.style.display='none'">
                                <span class="font-bold text-sm text-center leading-tight text-gray-300">${away.name}</span>
                                <span class="text-[10px] text-gray-500 mt-1 font-mono">AWAY</span>
                            </div>
                            
                            <div class="flex flex-col items-center justify-center w-1/3 h-full">
                                ${scoreDisplay}
                            </div>

                            <div class="flex flex-col items-center w-1/3 group">
                                <img src="${home.logo}" class="team-logo-lg mb-2" onerror="this.style.display='none'">
                                <span class="font-bold text-sm text-center leading-tight text-gray-300">${home.name}</span>
                                <span class="text-[10px] text-gray-500 mt-1 font-mono">HOME</span>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });

            // Stats
            document.getElementById('stat-record').innerText = `${wins}-${losses}-${ties}`;
            const totalGames = wins + losses + ties;
            const winPct = totalGames > 0 ? ((wins + (ties * 0.5)) / totalGames).toFixed(3).substring(1) : '.000';
            document.getElementById('stat-winpct').innerText = winPct;
            
            let streakLabel = '-';
            let streakColor = 'text-gray-400';
            
            if (completedGames.length > 0) {
                completedGames.sort((a, b) => new Date(b.date) - new Date(a.date)); 
                const lastResult = completedGames[0].result;
                let count = 0;
                for (let i = 0; i < completedGames.length; i++) {
                    if (completedGames[i].result === lastResult) count++;
                    else break;
                }
                streakLabel = `${lastResult}${count}`;
                if (lastResult === 'W') streakColor = 'text-green-400';
                else if (lastResult === 'L') streakColor = 'text-red-400';
            }
            
            const streakEl = document.getElementById('stat-streak');
            streakEl.innerText = streakLabel;
            streakEl.className = `text-4xl font-black mt-1 ${streakColor}`;
            
            if (nextGame) {
                 const oppId = nextGame.homeTeamId === favTeam?.id ? nextGame.awayTeamId : nextGame.homeTeamId;
                 const opp = combinedData.teams.find(t => t.id === oppId);
                 const d = parseLocalYMD(nextGame.date);
                 document.getElementById('stat-next-game').innerHTML = `
                    <div class="font-bold text-white text-xl">vs ${opp ? (opp.abbrev || opp.name) : 'Opponent'}</div>
                    <div class="text-sm text-red-400 font-bold mt-1">${d.toLocaleDateString('en-US', {month:'short', day:'numeric'})} @ ${formatTime12(nextGame.startTime)}</div>
                 `;
            } else {
                 document.getElementById('stat-next-game').innerHTML = `<span class="text-sm text-gray-500">No Scheduled Games</span>`;
            }
        }

        // --- MODAL LOGIC ---
        function openAddGameModal() {
            document.getElementById('modal-title').innerText = "Add Game";
            document.getElementById('edit-game-id').value = '';
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            document.getElementById('game-date').value = `${year}-${month}-${day}`;
            document.getElementById('game-time').value = '19:00';
            document.getElementById('game-home-score').value = '';
            document.getElementById('game-away-score').value = '';
            document.getElementById('game-location').value = '';
            document.getElementById('game-season-input').value = document.getElementById('season-select').value;
            document.getElementById('btn-delete').classList.add('hidden');
            populateTeamSelects(); 
            document.getElementById('game-modal').classList.remove('hidden');
        }

        function editGame(id) {
            // Only search in local appData for editing
            const g = appData.items.find(i => i.id === id);
            if(!g) return; // Archive items are ignored here
            
            document.getElementById('modal-title').innerText = "Edit Game";
            document.getElementById('edit-game-id').value = g.id;
            document.getElementById('game-date').value = g.date;
            document.getElementById('game-time').value = g.startTime;
            document.getElementById('game-season-input').value = g.season || document.getElementById('season-select').value;
            document.getElementById('game-home-team').value = g.homeTeamId;
            document.getElementById('game-away-team').value = g.awayTeamId;
            document.getElementById('game-home-score').value = g.homeScore !== null ? g.homeScore : '';
            document.getElementById('game-away-score').value = g.awayScore !== null ? g.awayScore : '';
            document.getElementById('game-location').value = g.description || '';
            document.getElementById('btn-delete').classList.remove('hidden');
            
            document.getElementById('game-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('game-modal').classList.add('hidden');
        }

        function saveGame() {
            const id = document.getElementById('edit-game-id').value;
            const league = document.getElementById('league-select').value;
            const season = document.getElementById('game-season-input').value;
            const hScore = document.getElementById('game-home-score').value;
            const aScore = document.getElementById('game-away-score').value;
            
            const newGame = {
                id: id || `game_${Date.now()}`,
                type: 'sports',
                category: 'personal', 
                league: league,
                season: season,
                date: document.getElementById('game-date').value,
                startTime: document.getElementById('game-time').value,
                homeTeamId: document.getElementById('game-home-team').value,
                awayTeamId: document.getElementById('game-away-team').value,
                homeScore: hScore === '' ? null : parseInt(hScore),
                awayScore: aScore === '' ? null : parseInt(aScore),
                description: document.getElementById('game-location').value,
                status: (hScore !== '' && aScore !== '') ? 'completed' : 'scheduled',
                title: '' 
            };
            
            const home = combinedData.teams.find(t=>t.id === newGame.homeTeamId);
            const away = combinedData.teams.find(t=>t.id === newGame.awayTeamId);
            newGame.title = `${away?.abbrev || 'Away'} @ ${home?.abbrev || 'Home'}`;

            if (id) {
                const idx = appData.items.findIndex(i => i.id === id);
                if(idx !== -1) appData.items[idx] = newGame;
            } else {
                appData.items.push(newGame);
            }
            
            saveData();
            closeModal();
            updateSeasonOptions(); // Will refresh view via its call to renderPage
        }

        function deleteGame() {
            if(!confirm("Delete this game?")) return;
            const id = document.getElementById('edit-game-id').value;
            appData.items = appData.items.filter(i => i.id !== id);
            saveData();
            closeModal();
            updateSeasonOptions();
        }

        function formatTime12(timeStr) {
            if (!timeStr) return '';
            const [h, m] = timeStr.split(':');
            const hour = parseInt(h);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${m} ${ampm}`;
        }
    </script>
</body>
</html>
