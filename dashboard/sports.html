<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Season Tracker</title>
    <link rel="icon" href="/images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg-dark: #111827; --panel-bg: rgba(31, 41, 55, 0.7); --sports-red: #ef4444; }
        body { background-color: var(--bg-dark); color: white; font-family: 'Inter', sans-serif; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }

        .glass-panel { 
            background: var(--panel-bg); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.1); 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .game-card {
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 220px; /* Approx 3 inches relative scaling */
        }
        .game-card:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 10px 20px rgba(0,0,0,0.5); 
            background-color: rgba(55, 65, 81, 0.9);
        }
        
        .win-border { border-top: 4px solid #10b981; }
        .loss-border { border-top: 4px solid #ef4444; }
        .tie-border { border-top: 4px solid #9ca3af; }
        .scheduled-border { border-top: 4px solid #3b82f6; }
        
        .team-logo-lg { width: 80px; height: 80px; object-fit: contain; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 right-0 bg-gray-800 border-b border-gray-700 shadow-xl z-40 p-2 flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
            <a href="bullet_calendar.html" class="text-gray-400 hover:text-white p-2 transition-colors flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                <span class="font-bold text-lg">Back to Calendar</span>
            </a>
        </div>
        <div class="text-xl font-bold text-red-500 tracking-widest uppercase">Season Tracker</div>
        <div class="w-24"></div> 
    </nav>

    <!-- Main Layout -->
    <div class="flex flex-1 pt-16 h-full">
        
        <!-- Sidebar Controls -->
        <aside class="w-64 bg-gray-800 border-r border-gray-700 p-6 flex flex-col gap-6 shrink-0">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Filter by League</label>
                <select id="league-select" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:border-red-500 outline-none" onchange="updateSeasonOptions()">
                    <!-- Populated via JS -->
                </select>
            </div>
            
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Season</label>
                <select id="season-select" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:border-red-500 outline-none" onchange="renderPage()">
                     <!-- Populated Dynamic via JS -->
                </select>
            </div>

            <div class="mt-auto pt-6 border-t border-gray-700">
                <button onclick="openAddGameModal()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded shadow-lg flex items-center justify-center gap-2 transition-colors">
                    <span>+ Add Game</span>
                </button>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="flex-1 overflow-y-auto p-8 bg-gray-900">
            
            <!-- Stats Banner -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center">
                    <span class="text-gray-400 text-xs uppercase tracking-wider">Record</span>
                    <span class="text-4xl font-black text-white mt-1" id="stat-record">0-0-0</span>
                </div>
                <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center">
                    <span class="text-gray-400 text-xs uppercase tracking-wider">Win %</span>
                    <span class="text-4xl font-black text-green-400 mt-1" id="stat-winpct">.000</span>
                </div>
                <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center">
                    <span class="text-gray-400 text-xs uppercase tracking-wider">Streak</span>
                    <span class="text-4xl font-black text-blue-400 mt-1" id="stat-streak">-</span>
                </div>
                <div class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center bg-red-900/20 border-red-800/50">
                    <span class="text-red-300 text-xs uppercase tracking-wider">Next Game</span>
                    <div class="text-center mt-1" id="stat-next-game">
                        <span class="text-sm text-gray-400">No Upcoming Games</span>
                    </div>
                </div>
            </div>

            <!-- Game List Grid -->
            <h2 class="text-xl font-bold text-gray-400 mb-4 border-b border-gray-700 pb-2 flex justify-between items-end">
                <span>Game Schedule</span>
                <span class="text-xs font-normal text-gray-500" id="game-count-label">0 Games</span>
            </h2>
            
            <div id="game-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Games injected here -->
            </div>
        </main>
    </div>

    <!-- Add/Edit Game Modal -->
    <div id="game-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-2xl w-full max-w-md border border-gray-700 shadow-2xl p-6">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-2">
                <h3 class="text-xl font-bold text-white" id="modal-title">Add Game</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <input type="hidden" id="edit-game-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs text-gray-500 block mb-1">Date</label><input type="date" id="game-date" class="w-full bg-gray-700 rounded p-2 text-white focus:border-red-500 outline-none"></div>
                    <div><label class="text-xs text-gray-500 block mb-1">Time</label><input type="time" id="game-time" class="w-full bg-gray-700 rounded p-2 text-white focus:border-red-500 outline-none"></div>
                </div>
                
                <div class="flex items-end gap-2">
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 block mb-1">Home Team</label>
                        <select id="game-home-team" class="w-full bg-gray-700 rounded p-2 text-white text-sm focus:border-red-500 outline-none"></select>
                    </div>
                    <span class="text-gray-500 pb-2">vs</span>
                    <div class="flex-1">
                        <label class="text-xs text-gray-500 block mb-1">Away Team</label>
                        <select id="game-away-team" class="w-full bg-gray-700 rounded p-2 text-white text-sm focus:border-red-500 outline-none"></select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                    <div><label class="text-xs text-gray-500 block mb-1">Home Score</label><input type="number" id="game-home-score" class="w-full bg-gray-700 rounded p-2 text-white text-center font-bold focus:border-red-500 outline-none"></div>
                    <div><label class="text-xs text-gray-500 block mb-1">Away Score</label><input type="number" id="game-away-score" class="w-full bg-gray-700 rounded p-2 text-white text-center font-bold focus:border-red-500 outline-none"></div>
                </div>
                
                <div>
                    <label class="text-xs text-gray-500 block mb-1">Location / Notes</label>
                    <input type="text" id="game-location" class="w-full bg-gray-700 rounded p-2 text-white text-sm focus:border-red-500 outline-none" placeholder="Stadium...">
                </div>
                
                <!-- Season Field (Hidden in add if inferred, but useful for editing) -->
                <div>
                    <label class="text-xs text-gray-500 block mb-1">Season</label>
                    <input type="text" id="game-season-input" class="w-full bg-gray-700 rounded p-2 text-white text-sm focus:border-red-500 outline-none">
                </div>

                <button onclick="saveGame()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-2 rounded mt-2">Save Game</button>
                <button onclick="deleteGame()" id="btn-delete" class="w-full text-red-400 hover:text-red-300 text-xs py-2 hidden border border-red-900/30 rounded mt-2 hover:bg-red-900/20">Delete Game</button>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'bullet_cal_data_v2'; 
        let appData = { leagues: [], teams: [], items: [] };
        let currentLeague = '';

        window.onload = async () => {
            await loadData();
            initFilters();
        };

        async function loadData() {
            // Load from LocalStorage first
            try {
                const localStr = localStorage.getItem(STORAGE_KEY);
                if (localStr) {
                    const json = JSON.parse(localStr);
                    appData = { ...appData, ...json };
                }
            } catch (e) { console.error("Load Error", e); }

            // Fallback to fetch if empty
            if (!appData.teams || appData.teams.length === 0) {
                try {
                    const res = await fetch('bullet_cal_data_2025.json');
                    if (res.ok) {
                        const json = await res.json();
                        if(json.teams) appData.teams = json.teams;
                        if(json.leagues) appData.leagues = json.leagues;
                        if(json.items) {
                            json.items.forEach(i => {
                                if (!appData.items.some(exist => exist.id === i.id)) {
                                    appData.items.push(i);
                                }
                            });
                        }
                        saveData(); // Save initial fetch to local
                    }
                } catch(e) { console.warn("No fallback JSON"); }
            }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
            } catch(e) { console.error("Save Error", e); }
        }

        function initFilters() {
            const sel = document.getElementById('league-select');
            sel.innerHTML = (appData.leagues || []).map(l => `<option value="${l}">${l}</option>`).join('');
            if (appData.leagues && appData.leagues.length > 0) currentLeague = appData.leagues[0];
            updateSeasonOptions();
        }

        function updateSeasonOptions() {
            currentLeague = document.getElementById('league-select').value;
            const seasonSel = document.getElementById('season-select');
            
            // Find all seasons associated with this league in the items data
            const seasons = new Set();
            
            // Add default current year/next year as fallback
            const currentYear = new Date().getFullYear();
            seasons.add(`${currentYear}/${currentYear+1}`);
            
            (appData.items || []).forEach(item => {
                if (item.type === 'sports' && item.league === currentLeague && item.season) {
                    seasons.add(item.season);
                }
            });
            
            // Sort seasons descending (newest first)
            const sortedSeasons = Array.from(seasons).sort().reverse();
            
            seasonSel.innerHTML = sortedSeasons.map(s => `<option value="${s}">${s}</option>`).join('');
            
            // Trigger render
            populateTeamSelects();
            renderPage();
        }

        function populateTeamSelects() {
            const h = document.getElementById('game-home-team');
            const a = document.getElementById('game-away-team');
            h.innerHTML = ''; a.innerHTML = '';
            
            const league = document.getElementById('league-select').value;
            const teams = (appData.teams || []).filter(t => t.league === league).sort((a,b) => a.name.localeCompare(b.name));
            
            teams.forEach(t => {
                const opt = `<option value="${t.id}">${t.name}</option>`;
                h.innerHTML += opt;
                a.innerHTML += opt;
            });
        }
        
        // --- HELPER: DATE PARSING ---
        function parseLocalYMD(dateStr) {
            // dateStr is YYYY-MM-DD. splitting creates local date values
            if(!dateStr) return new Date();
            const parts = dateStr.split('-');
            return new Date(parts[0], parts[1]-1, parts[2]);
        }

        function renderPage() {
            currentLeague = document.getElementById('league-select').value;
            const season = document.getElementById('season-select').value;
            const container = document.getElementById('game-list');
            container.innerHTML = '';

            // Filter Games
            let games = (appData.items || []).filter(i => 
                i.type === 'sports' && 
                i.league === currentLeague && 
                (i.season === season)
            );
            
            document.getElementById('game-count-label').innerText = `${games.length} Games`;

            // Sort by Date
            games.sort((a, b) => {
                const dateA = new Date(a.date + 'T' + (a.startTime || '00:00'));
                const dateB = new Date(b.date + 'T' + (b.startTime || '00:00'));
                return dateA - dateB;
            });

            // Identify Favorite Team
            const favTeam = appData.teams.find(t => t.league === currentLeague && t.isFavorite);
            
            // --- STATS LOGIC ---
            let wins=0, losses=0, ties=0;
            let nextGame = null;
            // Get today's date string YYYY-MM-DD in local time for accurate comparison
            const now = new Date();
            const todayStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
            
            // Streak Logic Prep
            let completedGames = [];

            games.forEach(g => {
                const home = appData.teams.find(t => t.id === g.homeTeamId) || { name: 'Unknown', logo: '', abbrev: 'UNK' };
                const away = appData.teams.find(t => t.id === g.awayTeamId) || { name: 'Unknown', logo: '', abbrev: 'UNK' };
                
                let borderClass = 'scheduled-border';
                let resultBadge = '';
                let cardOpacity = 'opacity-100';

                // Game Result Logic
                if (g.status === 'completed') {
                    cardOpacity = 'opacity-80 hover:opacity-100'; // slightly dim completed games
                    if (favTeam) {
                        const isHome = g.homeTeamId === favTeam.id;
                        const isAway = g.awayTeamId === favTeam.id;
                        
                        if (isHome || isAway) {
                            const myScore = isHome ? g.homeScore : g.awayScore;
                            const oppScore = isHome ? g.awayScore : g.homeScore;
                            
                            let resultChar = 'T';
                            if (myScore > oppScore) { wins++; resultChar = 'W'; borderClass = 'win-border'; }
                            else if (myScore < oppScore) { losses++; resultChar = 'L'; borderClass = 'loss-border'; }
                            else { ties++; borderClass = 'tie-border'; }
                            
                            completedGames.push({ date: g.date, result: resultChar });
                            
                            // Badge
                            let badgeColor = resultChar === 'W' ? 'bg-green-600' : (resultChar === 'L' ? 'bg-red-600' : 'bg-gray-500');
                            resultBadge = `<div class="absolute top-2 right-2 ${badgeColor} text-white text-[10px] font-bold px-2 py-0.5 rounded shadow">${resultChar}</div>`;
                        } else {
                            borderClass = 'tie-border'; // Neutral game
                        }
                    } else {
                        borderClass = 'tie-border';
                    }
                } else {
                    // Find Next Game
                    if (!nextGame && g.date >= todayStr) {
                        nextGame = g;
                        borderClass = 'border-t-4 border-yellow-400'; // Highlight next game
                    }
                }

                // Render Card
                const dateObj = parseLocalYMD(g.date);
                const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                const timeStr = g.startTime ? formatTime12(g.startTime) : 'TBD';
                
                const scoreDisplay = g.status === 'completed' 
                    ? `<div class="text-3xl font-black tracking-widest flex gap-4"><span>${g.awayScore}</span><span class="text-gray-600">-</span><span>${g.homeScore}</span></div>`
                    : `<div class="text-lg font-mono text-blue-300 bg-blue-900/20 border border-blue-800/50 px-3 py-1 rounded mt-1">${timeStr}</div>`;

                const html = `
                    <div class="glass-panel rounded-xl p-0 flex flex-col game-card cursor-pointer ${borderClass} ${cardOpacity} relative" onclick="editGame('${g.id}')">
                        ${resultBadge}
                        <div class="bg-gray-800/50 p-3 flex justify-between items-center border-b border-gray-700/50">
                            <div class="text-xs font-bold text-gray-400 uppercase tracking-wider">${dateStr}</div>
                            <div class="text-[10px] text-gray-500 truncate max-w-[50%]">${g.description || ''}</div>
                        </div>
                        
                        <div class="flex-1 flex items-center justify-between px-6 py-6">
                            <!-- Away Team -->
                            <div class="flex flex-col items-center w-1/3 group">
                                <img src="${away.logo}" class="team-logo-lg mb-2 group-hover:scale-110 transition-transform" onerror="this.style.display='none'">
                                <span class="font-bold text-sm text-center leading-tight text-gray-300 group-hover:text-white">${away.name}</span>
                                <span class="text-[10px] text-gray-500 mt-1 font-mono">AWAY</span>
                            </div>
                            
                            <!-- VS / Score -->
                            <div class="flex flex-col items-center justify-center w-1/3 h-full">
                                ${scoreDisplay}
                            </div>

                            <!-- Home Team -->
                            <div class="flex flex-col items-center w-1/3 group">
                                <img src="${home.logo}" class="team-logo-lg mb-2 group-hover:scale-110 transition-transform" onerror="this.style.display='none'">
                                <span class="font-bold text-sm text-center leading-tight text-gray-300 group-hover:text-white">${home.name}</span>
                                <span class="text-[10px] text-gray-500 mt-1 font-mono">HOME</span>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });

            // Update Stats Banner
            document.getElementById('stat-record').innerText = `${wins}-${losses}-${ties}`;
            
            const totalGames = wins + losses + ties;
            // Win % = (Wins + 0.5 * Ties) / Total Games
            const winPct = totalGames > 0 ? ((wins + (ties * 0.5)) / totalGames).toFixed(3).substring(1) : '.000';
            document.getElementById('stat-winpct').innerText = winPct;
            
            // Streak Calculation
            let streakLabel = '-';
            let streakColor = 'text-gray-400';
            
            if (completedGames.length > 0) {
                // Sort newest to oldest for streak counting
                // Note: games array was sorted oldest to newest for display, so reverse completedGames logic or re-sort
                completedGames.sort((a, b) => new Date(b.date) - new Date(a.date)); // Newest first
                
                const lastResult = completedGames[0].result;
                let count = 0;
                for (let i = 0; i < completedGames.length; i++) {
                    if (completedGames[i].result === lastResult) {
                        count++;
                    } else {
                        break;
                    }
                }
                
                streakLabel = `${lastResult}${count}`;
                if (lastResult === 'W') streakColor = 'text-green-400';
                else if (lastResult === 'L') streakColor = 'text-red-400';
                else streakColor = 'text-gray-400';
            }
            
            const streakEl = document.getElementById('stat-streak');
            streakEl.innerText = streakLabel;
            streakEl.className = `text-4xl font-black mt-1 ${streakColor}`;
            
            if (nextGame) {
                 const oppId = nextGame.homeTeamId === favTeam?.id ? nextGame.awayTeamId : nextGame.homeTeamId;
                 const opp = appData.teams.find(t => t.id === oppId);
                 const d = parseLocalYMD(nextGame.date);
                 document.getElementById('stat-next-game').innerHTML = `
                    <div class="font-bold text-white text-xl">vs ${opp ? (opp.abbrev || opp.name) : 'Opponent'}</div>
                    <div class="text-sm text-red-400 font-bold mt-1">${d.toLocaleDateString('en-US', {month:'short', day:'numeric'})} @ ${formatTime12(nextGame.startTime)}</div>
                 `;
            } else {
                 document.getElementById('stat-next-game').innerHTML = `<span class="text-sm text-gray-500">No Scheduled Games</span>`;
            }
        }

        // --- MODAL LOGIC ---
        function openAddGameModal() {
            document.getElementById('modal-title').innerText = "Add Game";
            document.getElementById('edit-game-id').value = '';
            // Get local date string
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            document.getElementById('game-date').value = `${year}-${month}-${day}`;
            
            document.getElementById('game-time').value = '19:00';
            document.getElementById('game-home-score').value = '';
            document.getElementById('game-away-score').value = '';
            document.getElementById('game-location').value = '';
            document.getElementById('game-season-input').value = document.getElementById('season-select').value; // Default to current view
            document.getElementById('btn-delete').classList.add('hidden');
            
            populateTeamSelects(); 
            document.getElementById('game-modal').classList.remove('hidden');
        }

        function editGame(id) {
            const g = appData.items.find(i => i.id === id);
            if(!g) return;
            
            document.getElementById('modal-title').innerText = "Edit Game";
            document.getElementById('edit-game-id').value = g.id;
            document.getElementById('game-date').value = g.date;
            document.getElementById('game-time').value = g.startTime;
            document.getElementById('game-season-input').value = g.season || document.getElementById('season-select').value;
            
            // Ensure options are populated for this league before setting values
            // We might need to switch the league filter temporarily in logic, but simpler to just re-pop
            // Note: This simplistic approach assumes user is editing game in current view league. 
            // If cross-league editing is needed, we'd need to switch dropdowns. 
            // For now, assume context is correct.
            document.getElementById('game-home-team').value = g.homeTeamId;
            document.getElementById('game-away-team').value = g.awayTeamId;
            
            document.getElementById('game-home-score').value = g.homeScore !== null ? g.homeScore : '';
            document.getElementById('game-away-score').value = g.awayScore !== null ? g.awayScore : '';
            document.getElementById('game-location').value = g.description || '';
            document.getElementById('btn-delete').classList.remove('hidden');
            
            document.getElementById('game-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('game-modal').classList.add('hidden');
        }

        function saveGame() {
            const id = document.getElementById('edit-game-id').value;
            const league = document.getElementById('league-select').value;
            const season = document.getElementById('game-season-input').value;
            
            const hScore = document.getElementById('game-home-score').value;
            const aScore = document.getElementById('game-away-score').value;
            
            const newGame = {
                id: id || `game_${Date.now()}`,
                type: 'sports',
                category: 'personal', 
                league: league,
                season: season,
                date: document.getElementById('game-date').value,
                startTime: document.getElementById('game-time').value,
                homeTeamId: document.getElementById('game-home-team').value,
                awayTeamId: document.getElementById('game-away-team').value,
                homeScore: hScore === '' ? null : parseInt(hScore),
                awayScore: aScore === '' ? null : parseInt(aScore),
                description: document.getElementById('game-location').value,
                status: (hScore !== '' && aScore !== '') ? 'completed' : 'scheduled',
                title: '' 
            };
            
            // Find names for title
            const home = appData.teams.find(t=>t.id === newGame.homeTeamId);
            const away = appData.teams.find(t=>t.id === newGame.awayTeamId);
            newGame.title = `${away?.abbrev} @ ${home?.abbrev}`;

            if (id) {
                const idx = appData.items.findIndex(i => i.id === id);
                if(idx !== -1) appData.items[idx] = newGame;
            } else {
                appData.items.push(newGame);
            }
            
            saveData();
            closeModal();
            
            // Refresh season options in case a new season was added
            updateSeasonOptions(); 
        }

        function deleteGame() {
            if(!confirm("Delete this game?")) return;
            const id = document.getElementById('edit-game-id').value;
            appData.items = appData.items.filter(i => i.id !== id);
            saveData();
            closeModal();
            renderPage();
        }

        // Helpers
        function formatTime12(timeStr) {
            if (!timeStr) return '';
            const [h, m] = timeStr.split(':');
            const hour = parseInt(h);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${m} ${ampm}`;
        }
    </script>
</body>
</html>
