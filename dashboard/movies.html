<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movies</title>
    <link rel="icon" href="/images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg-dark: #111827; --panel-bg: rgba(31, 41, 55, 0.7); --accent-purple: #8b5cf6; }
        body { background-color: var(--bg-dark); color: white; font-family: 'Inter', sans-serif; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }

        .glass-panel { 
            background: var(--panel-bg); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.1); 
            transition: all 0.3s ease;
        }
        
        .media-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            border-color: var(--accent-purple);
        }
        
        .poster-aspect { aspect-ratio: 2/3; object-fit: cover; width: 100%; }
        
        .star-text { color: #fbbf24; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    </style>
    <script>
        tailwind.config = { theme: { extend: { colors: { media: '#8b5cf6' } } } }
    </script>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 right-0 bg-gray-800 border-b border-gray-700 shadow-xl z-40 p-2 flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
            <a href="bullet_calendar.html" class="text-gray-400 hover:text-white p-2 transition-colors flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                <span class="font-bold text-lg">Back to Calendar</span>
            </a>
        </div>
        <div class="text-xl font-bold text-media tracking-widest uppercase">Movies</div>
        <div class="w-24"></div> 
    </nav>

    <!-- Main Layout -->
    <div class="flex flex-1 pt-16 h-full">
        
        <!-- Sidebar Controls -->
        <aside class="w-64 bg-gray-800 border-r border-gray-700 p-6 flex flex-col gap-6 shrink-0">
            
            <!-- Stats -->
            <div class="bg-gray-900/50 rounded-xl p-4 border border-gray-700 text-center">
                <div class="text-xs text-gray-500 uppercase font-bold mb-1">Total Watched</div>
                <div class="text-3xl font-black text-white" id="stat-total">0</div>
            </div>
            
            <div class="bg-gray-900/50 rounded-xl p-4 border border-gray-700 text-center">
                <div class="text-xs text-gray-500 uppercase font-bold mb-1">Avg Rating</div>
                <div class="text-3xl font-black text-yellow-400" id="stat-avg">0.0</div>
            </div>

            <div class="mt-4">
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Filter Year</label>
                <select id="year-select" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:border-media outline-none" onchange="handleYearChange()">
                    <option value="current">Current Year (Local)</option>
                    <option value="all">All History (Load Files)</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Sort By</label>
                <select id="sort-select" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:border-media outline-none" onchange="renderGallery()">
                    <option value="date-desc">Recent First</option>
                    <option value="date-asc">Oldest First</option>
                    <option value="rating-desc">Highest Rated</option>
                    <option value="rating-asc">Lowest Rated</option>
                    <option value="alpha-asc">Alphabetic (A-Z)</option>
                </select>
            </div>

            <div class="mt-auto pt-6 border-t border-gray-700">
                <button onclick="openMediaModal()" class="w-full bg-media hover:bg-purple-500 text-white font-bold py-3 rounded shadow-lg flex items-center justify-center gap-2 transition-colors">
                    <span>+ Log Media</span>
                </button>
            </div>
        </aside>

        <!-- Gallery Area -->
        <main class="flex-1 overflow-y-auto p-8 bg-gray-900">
            <div id="loading-indicator" class="hidden text-center text-gray-500 py-10">Loading Archive Data...</div>
            <div id="media-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                <!-- Cards injected here -->
            </div>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div id="media-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-2xl w-full max-w-md border border-gray-700 shadow-2xl p-6">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-2">
                <h3 class="text-xl font-bold text-white" id="modal-title">Log Movie / Show</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <input type="hidden" id="edit-id">
                <div>
                    <label class="text-xs text-gray-500 block mb-1">Title</label>
                    <input type="text" id="media-title" class="w-full bg-gray-700 rounded p-2 text-white focus:border-media outline-none" placeholder="e.g. Inception">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-500 block mb-1">Date Watched</label>
                        <input type="date" id="media-date" class="w-full bg-gray-700 rounded p-2 text-white focus:border-media outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 block mb-1">Rating (1-10)</label>
                        <input type="number" id="media-rating" min="1" max="10" class="w-full bg-gray-700 rounded p-2 text-white focus:border-media outline-none">
                    </div>
                </div>
                
                <div>
                    <label class="text-xs text-gray-500 block mb-1">Image URL (Poster)</label>
                    <input type="text" id="media-img" class="w-full bg-gray-700 rounded p-2 text-white text-xs focus:border-media outline-none" placeholder="https://...">
                </div>

                <div>
                    <label class="text-xs text-gray-500 block mb-1">Review / Notes</label>
                    <textarea id="media-notes" rows="3" class="w-full bg-gray-700 rounded p-2 text-white text-sm focus:border-media outline-none" placeholder="Thoughts..."></textarea>
                </div>

                <div class="flex gap-2 pt-2">
                    <button onclick="saveMedia()" class="flex-1 bg-media hover:bg-purple-500 text-white font-bold py-2 rounded shadow">Save</button>
                    <button onclick="deleteMedia()" id="btn-delete" class="px-4 text-red-400 hover:text-red-300 text-xs hidden border border-red-900/50 rounded hover:bg-red-900/20">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const STORAGE_KEY = 'bullet_cal_data_v2'; 
        const DEFAULT_DATA = { "meta": { "year": 2025, "version": "1.0", "owner": "Stephens" }, "leagues": [], "teams": [], "items": [] };
        
        // Define which years have archive files. 
        // As you add years, simply add them to this list.
        const KNOWN_YEARS = [2025, 2026, 2027, 2028, 2029, 2030]; 

        let appData = { items: [] }; // Current Local Storage Data
        let combinedData = { items: [] }; // Aggregated Data (Local + Archives)

        window.onload = async () => {
            await loadLocalData();
            // Default to displaying what is in local storage
            combinedData.items = [...appData.items]; 
            renderGallery();
        };

        async function loadLocalData() {
            try {
                const localStr = localStorage.getItem(STORAGE_KEY);
                if (localStr) {
                    const json = JSON.parse(localStr);
                    appData = { ...appData, ...json };
                } else {
                    appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
                    saveData();
                }
            } catch (e) { 
                console.error("Load Error", e);
                appData = JSON.parse(JSON.stringify(DEFAULT_DATA));
            }
        }

        async function handleYearChange() {
            const mode = document.getElementById('year-select').value;
            const loader = document.getElementById('loading-indicator');
            
            if (mode === 'current') {
                // Just use local storage data
                combinedData.items = [...appData.items];
                renderGallery();
                return;
            }
            
            if (mode === 'all') {
                loader.classList.remove('hidden');
                const allItems = new Map(); // Use Map to prevent duplicates by ID

                // 1. Add current local items first
                appData.items.filter(i => i.type === 'media').forEach(i => allItems.set(i.id, i));

                // 2. Fetch all historical files
                const promises = KNOWN_YEARS.map(year => 
                    fetch(`bullet_cal_data_${year}.json`)
                        .then(res => {
                            if(!res.ok) throw new Error(res.status);
                            return res.json();
                        })
                        .then(data => {
                            if(data.items) {
                                data.items.filter(i => i.type === 'media').forEach(i => {
                                    // Only add if not already present (Local edits take precedence)
                                    if(!allItems.has(i.id)) allItems.set(i.id, i);
                                });
                            }
                        })
                        .catch(err => console.warn(`Could not load ${year} data:`, err))
                );

                await Promise.allSettled(promises);
                
                combinedData.items = Array.from(allItems.values());
                loader.classList.add('hidden');
                renderGallery();
            }
        }

        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
                // If we are in "Current" mode, update view immediately
                if (document.getElementById('year-select').value === 'current') {
                    combinedData.items = [...appData.items];
                    renderGallery();
                }
            } catch(e) { console.error("Save Error", e); }
        }

        function renderGallery() {
            const container = document.getElementById('media-grid');
            const sortMode = document.getElementById('sort-select').value;
            container.innerHTML = '';

            // Filter for media items from the combined dataset
            let mediaItems = (combinedData.items || []).filter(i => i.type === 'media');
            
            // Sort
            mediaItems.sort((a, b) => {
                if (sortMode === 'date-desc') return new Date(b.date) - new Date(a.date);
                if (sortMode === 'date-asc') return new Date(a.date) - new Date(b.date);
                if (sortMode === 'rating-desc') return b.rating - a.rating;
                if (sortMode === 'rating-asc') return a.rating - b.rating;
                if (sortMode === 'alpha-asc') return a.title.localeCompare(b.title);
                return 0;
            });

            // Update Stats
            document.getElementById('stat-total').innerText = mediaItems.length;
            const avg = mediaItems.length > 0 
                ? (mediaItems.reduce((sum, i) => sum + (parseInt(i.rating)||0), 0) / mediaItems.length).toFixed(1) 
                : "0.0";
            document.getElementById('stat-avg').innerText = avg;

            // Render Cards
            mediaItems.forEach(item => {
                const stars = '★'.repeat(item.rating || 0) + '☆'.repeat(10 - (item.rating || 0));
                const dateStr = new Date(item.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const imgUrl = item.imgUrl || 'https://via.placeholder.com/300x450/1f2937/4b5563?text=No+Poster';

                // Check if item is "Read Only" (from archive) or Editable (in local storage)
                const isEditable = appData.items.some(i => i.id === item.id);
                const opacityClass = isEditable ? '' : 'opacity-75 border-dashed border-gray-600';

                const card = document.createElement('div');
                card.className = `glass-panel media-card rounded-xl overflow-hidden flex flex-col cursor-pointer relative group ${opacityClass}`;
                
                // Only allow editing if it is in local storage
                if (isEditable) {
                    card.onclick = () => editMedia(item.id);
                } else {
                    card.title = "Archived Item (Read Only)";
                }
                
                card.innerHTML = `
                    <div class="relative">
                        <img src="${imgUrl}" class="poster-aspect w-full bg-gray-800" alt="${item.title}">
                        <div class="absolute top-2 right-2 bg-black/70 text-yellow-400 text-xs font-bold px-2 py-1 rounded backdrop-blur-sm">
                            ${item.rating}/10
                        </div>
                        ${!isEditable ? '<div class="absolute top-2 left-2 bg-gray-700/80 text-white text-[10px] px-2 py-1 rounded">ARCHIVE</div>' : ''}
                    </div>
                    <div class="p-4 flex flex-col flex-1">
                        <h3 class="font-bold text-white text-lg leading-tight mb-1">${item.title}</h3>
                        <div class="text-xs text-gray-400 mb-3">${dateStr}</div>
                        <p class="text-sm text-gray-300 line-clamp-3 italic opacity-80">${item.description || item.notes || ''}</p>
                        <div class="mt-auto pt-3 text-[10px] text-yellow-500 tracking-widest opacity-60">${stars}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- MODAL LOGIC ---
        function openMediaModal() {
            document.getElementById('modal-title').innerText = "Log Movie / Show";
            document.getElementById('edit-id').value = '';
            document.getElementById('media-title').value = '';
            document.getElementById('media-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('media-rating').value = '5';
            document.getElementById('media-img').value = '';
            document.getElementById('media-notes').value = '';
            document.getElementById('btn-delete').classList.add('hidden');
            document.getElementById('media-modal').classList.remove('hidden');
        }

        function editMedia(id) {
            const item = appData.items.find(i => i.id === id);
            if(!item) return; // Should not happen due to isEditable check
            
            document.getElementById('modal-title').innerText = "Edit Entry";
            document.getElementById('edit-id').value = item.id;
            document.getElementById('media-title').value = item.title;
            document.getElementById('media-date').value = item.date;
            document.getElementById('media-rating').value = item.rating;
            document.getElementById('media-img').value = item.imgUrl || '';
            document.getElementById('media-notes').value = item.description || item.notes || '';
            
            document.getElementById('btn-delete').classList.remove('hidden');
            document.getElementById('media-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('media-modal').classList.add('hidden');
        }

        function saveMedia() {
            const id = document.getElementById('edit-id').value;
            
            const newItem = {
                id: id || `media_${Date.now()}`,
                type: 'media',
                category: 'personal', 
                title: document.getElementById('media-title').value,
                date: document.getElementById('media-date').value,
                rating: parseInt(document.getElementById('media-rating').value),
                imgUrl: document.getElementById('media-img').value,
                description: document.getElementById('media-notes').value,
                notes: document.getElementById('media-notes').value
            };
            
            if(!newItem.title) return alert("Title required");

            if (id) {
                const idx = appData.items.findIndex(i => i.id === id);
                if(idx !== -1) appData.items[idx] = newItem;
            } else {
                appData.items.push(newItem);
            }
            
            saveData();
            closeModal();
        }

        function deleteMedia() {
            if(!confirm("Delete this entry?")) return;
            const id = document.getElementById('edit-id').value;
            appData.items = appData.items.filter(i => i.id !== id);
            saveData();
            closeModal();
        }
    </script>
</body>
</html>
