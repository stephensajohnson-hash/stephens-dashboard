<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bullet Calendar</title>
    <link rel="icon" href="/images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { transition: all 0.2s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }
        html { font-family: 'Inter', sans-serif; }
        .glass-panel { background: rgba(31, 41, 55, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Sidebar Animation */
        #bullet-sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-open { transform: translateX(0); }
        .sidebar-closed { transform: translateX(-100%); }
        
        /* Macro bars */
        .macro-bar-bg { background-color: rgba(255,255,255,0.1); border-radius: 2px; height: 6px; width: 100%; overflow: hidden; }
        .macro-bar-fill { height: 100%; border-radius: 2px; }
    </style>
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'], }, colors: { work: '#3b82f6', personal: '#10b981', media: '#8b5cf6', health: '#f59e0b' } } } }
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col overflow-hidden">

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 right-0 bg-gray-800 border-b border-gray-700 shadow-xl z-40 p-2 flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
            <!-- Hamburger Button (Controls Sidebar) -->
            <button id="menu-button" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 focus:outline-none" onclick="toggleSidebar()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>

            <!-- Home Button -->
            <a href="index.html" class="text-gray-400 hover:text-white p-2 transition-colors" title="Return to Dashboard">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            </a>
            
            <!-- Navigation Controls -->
            <div class="flex items-center bg-gray-700 rounded-lg p-1 ml-4">
                <button onclick="navigate(-1)" class="p-1 hover:text-blue-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <button onclick="jumpToToday()" class="px-3 text-sm font-bold hover:text-blue-400">Today</button>
                <button onclick="navigate(1)" class="p-1 hover:text-blue-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
            </div>

            <!-- Current Date Display -->
            <div id="current-view-label" class="text-lg font-bold ml-4 text-blue-200"></div>
        </div>

        <div class="flex items-center gap-4">
             <!-- View Switcher -->
             <div class="hidden md:flex bg-gray-700 rounded-lg p-1">
                <button onclick="switchView('day')" id="btn-view-day" class="px-3 py-1 text-sm rounded-md bg-blue-600">Day</button>
                <button onclick="switchView('week')" id="btn-view-week" class="px-3 py-1 text-sm rounded-md hover:bg-gray-600">Week</button>
                <button onclick="switchView('month')" id="btn-view-month" class="px-3 py-1 text-sm rounded-md hover:bg-gray-600">Month</button>
            </div>

            <!-- Weather Widget -->
            <div id="weather-display" class="text-sm flex items-center bg-gray-700 px-3 py-1 rounded-full border border-gray-600">
                <span class="flex items-center" id="weather-content">
                    <span id="weather-current-temp" class="text-lg font-bold mr-3">--¬∞</span>
                    <span class="mr-1 text-xl" id="weather-icon">...</span>
                </span>
            </div>
        </div>
    </nav>

    <!-- Layout Container -->
    <div class="flex flex-1 pt-16 relative overflow-hidden">
        
        <!-- Sidebar Overlay (Mobile) -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden backdrop-blur-sm"></div>

        <!-- Sidebar Outline -->
        <aside id="bullet-sidebar" class="absolute lg:relative z-50 w-64 h-full bg-gray-800 border-r border-gray-700 flex flex-col sidebar-closed lg:sidebar-open shadow-2xl">
            <div class="p-4 border-b border-gray-700">
                <h2 class="text-xl font-bold text-purple-400">Bullet Journal</h2>
                <p class="text-xs text-gray-500">Year 2025</p>
            </div>
            
            <div class="flex-1 overflow-y-auto p-2 space-y-1">
                <button onclick="jumpToToday(); toggleSidebar()" class="w-full text-left px-4 py-2 rounded hover:bg-gray-700 text-blue-300 font-bold">
                    <i class="mr-2">üìÖ</i> Today
                </button>
                <div class="border-b border-gray-700 my-2"></div>
                <!-- Months generated by JS -->
                <div id="month-list" class="space-y-1"></div>
            </div>

            <div class="p-4 border-t border-gray-700">
                 <a href="recipes.html" class="block w-full text-left py-2 px-3 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-white text-sm mb-1">
                    View Recipes
                </a>
                <button onclick="downloadData()" class="block w-full text-left py-2 px-3 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-white text-sm mb-1 transition-colors">
                    Download Data
                </button>
                <p id="version-display" class="text-xs font-mono text-gray-500 mt-2 text-center">Stephens' Dashboard V1.0</p>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto p-4 sm:p-6 relative bg-gray-900" id="main-scroll">
            <div id="view-container" class="max-w-7xl mx-auto min-h-full">
                <!-- Content injected via JS -->
            </div>
        </main>
    </div>

    <!-- Nutrition Editor Modal -->
    <div id="nutrition-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-2xl w-full max-w-2xl max-h-[90vh] flex flex-col shadow-2xl border border-gray-700">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-health">Log Nutrition</h3>
                <button onclick="closeNutritionModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <!-- Daily Stats -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Weight (lbs)</label>
                        <input type="number" step="0.1" id="edit-weight" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:border-health outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Calorie Goal</label>
                        <input type="number" id="edit-cal-goal" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:border-health outline-none">
                    </div>
                </div>

                <!-- Meals -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-gray-500 uppercase">Meals</label>
                        <button type="button" onclick="addMealInput()" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-health font-bold border border-gray-600">+ Add Item</button>
                    </div>
                    <div id="meal-inputs-container" class="space-y-2">
                        <!-- Meal rows injected here -->
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-gray-700 flex justify-end gap-3">
                <button onclick="closeNutritionModal()" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                <button onclick="saveNutrition()" class="px-6 py-2 bg-health hover:bg-orange-600 text-white font-bold rounded-lg shadow-lg">Save Log</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        // Default/Sample Data (Injected from the JSON design)
        const DEFAULT_DATA = {
            "meta": { "year": 2025, "version": "1.3", "owner": "Stephens" },
            "items": [
                {
                "id": "evt_1732190000", "date": "2025-11-21", "type": "meeting", "category": "work", "title": "Sync with Dev Team", "description": "Discussing the Q4 API migration roadmap.", "startTime": "10:00", "durationMinutes": 60, "timeSpentMinutes": 65, "status": "completed", "tags": ["internal", "planning"], "linkUrl": "https://zoom.us/j/123456789", "imgUrl": null
                },
                {
                "id": "task_1732194500", "date": "2025-11-21", "type": "task", "category": "work", "title": "Fix login bug on staging", "ticketNumber": "JIRA-4291", "description": "Investigate the auth token expiration issue.", "timeSpentMinutes": 120, "status": "in-progress", "tags": ["bugfix", "urgent"], "linkUrl": "https://jira.company.com/browse/JIRA-4291", "imgUrl": null
                },
                {
                "id": "habit_1732210000", "date": "2025-11-21", "type": "habit", "category": "personal", "title": "Learn Spanish", "streakCount": 1494, "status": "completed", "notes": "Completed Duolingo lesson on Subjunctive verbs.", "linkUrl": "https://www.duolingo.com"
                },
                {
                "id": "mov_1732230000", "date": "2025-11-21", "type": "media", "category": "entertainment", "title": "Blade Runner 2049", "rating": 9, "mediaType": "movie", "notes": "Still holds up visually. Deakins is a genius.", "timeSpentMinutes": 164, "linkUrl": "https://www.imdb.com/title/tt1856101/", "imgUrl": "https://m.media-amazon.com/images/M/MV5BNzA1Njg4NzYxOV5BMl5BanBnXkFtZTgwODk5NjU3MzI@._V1_FMjpg_UX1000_.jpg"
                },
                {
                "id": "health_1732180000", "date": "2025-11-21", "type": "health", "category": "personal", "weightLbs": 270.0, "notes": "Good energy levels. Hit protein goal.", 
                "goals": { "tdee": 2816, "calorieGoal": 2220, "protein": 167, "fat": 150, "netCarbs": 100 },
                "meals": [
                    { "name": "Eggs (4), Bacon (2)", "mealType": "breakfast", "calories": 446, "protein": 28, "carbs": 2, "fiber": 0, "fat": 35 },
                    { "name": "2 Homemade Wraps + Avocado", "mealType": "lunch", "calories": 498, "protein": 35, "carbs": 45, "fiber": 12, "fat": 20 },
                    { "name": "Hamburger w/Sourdough", "mealType": "dinner", "calories": 570, "protein": 32, "carbs": 48, "fiber": 3, "fat": 28 },
                    { "name": "Poppers w/Ranch", "mealType": "snack", "calories": 570, "protein": 6.5, "carbs": 15, "fiber": 1, "fat": 52.5 }
                ]
                },
                {
                "id": "task_1732240000", "date": "2025-11-21", "type": "task", "category": "personal", "title": "Water the plants", "status": "pending", "tags": ["chores"]
                }
            ]
        };

        // --- STATE ---
        let appState = {
            currentDate: new Date("2025-11-21T12:00:00"), // Defaulting to sample data date for demo
            view: 'day', // 'day', 'week', 'month'
            data: DEFAULT_DATA
        };

        // --- INITIALIZATION ---
        window.onload = () => {
            renderSidebar();
            fetchWeather();
            updateUI();
        };

        // --- ACTIONS ---
        function downloadData() {
            const dataStr = JSON.stringify(appState.data, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bullet_cal_data_${appState.data.meta.year}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            if(window.innerWidth < 1024) {
                const sb = document.getElementById('bullet-sidebar');
                if(sb.classList.contains('sidebar-open')) toggleSidebar();
            }
        }

        // --- NAVIGATION & STATE MGMT ---
        function navigate(dir) {
            const d = new Date(appState.currentDate);
            if (appState.view === 'day') d.setDate(d.getDate() + dir);
            else if (appState.view === 'week') d.setDate(d.getDate() + (dir * 7));
            else if (appState.view === 'month') d.setMonth(d.getMonth() + dir);
            
            appState.currentDate = d;
            updateUI();
        }

        function jumpToToday() {
            appState.currentDate = new Date();
            appState.view = 'day';
            updateUI();
        }

        function switchView(v) {
            appState.view = v;
            updateUI();
        }

        function jumpToMonth(monthIndex) {
            appState.currentDate.setMonth(monthIndex);
            appState.currentDate.setDate(1);
            appState.view = 'month';
            updateUI();
            toggleSidebar();
        }

        // --- UI UPDATES ---
        function updateUI() {
            ['day', 'week', 'month'].forEach(v => {
                const btn = document.getElementById(`btn-view-${v}`);
                if(v === appState.view) btn.className = "px-3 py-1 text-sm rounded-md bg-blue-600 text-white shadow";
                else btn.className = "px-3 py-1 text-sm rounded-md hover:bg-gray-600 text-gray-300";
            });

            const container = document.getElementById('view-container');
            const label = document.getElementById('current-view-label');
            container.innerHTML = '';

            if (appState.view === 'day') {
                label.innerText = appState.currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
                renderDayView(container);
            } else if (appState.view === 'week') {
                const start = getStartOfWeek(appState.currentDate);
                const end = new Date(start); end.setDate(end.getDate() + 6);
                label.innerText = `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
                renderWeekView(container);
            } else if (appState.view === 'month') {
                label.innerText = appState.currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                renderMonthView(container);
            }
        }

        // --- RENDERERS ---
        
        function renderSidebar() {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const list = document.getElementById('month-list');
            list.innerHTML = months.map((m, i) => `
                <button onclick="jumpToMonth(${i})" class="w-full text-left px-4 py-2 rounded hover:bg-gray-700 text-gray-300 text-sm transition">
                    ${m}
                </button>
            `).join('');
        }

        function renderDayView(container) {
            const ymd = toLocalYMD(appState.currentDate);
            const items = appState.data.items.filter(i => i.date === ymd);

            if (items.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-96 opacity-50">
                    <div class="text-6xl mb-4">üì≠</div>
                    <div class="text-xl">No entries for this day</div>
                    <button onclick="openNutritionModal()" class="mt-4 px-4 py-2 bg-gray-800 rounded-lg border border-gray-700 hover:bg-gray-700">Log Nutrition</button>
                </div>`;
                return;
            }

            const health = items.find(i => i.type === 'health');
            const work = items.filter(i => i.category === 'work');
            const personal = items.filter(i => i.category !== 'work' && i.type !== 'health');

            let html = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">`;

            // COL 1
            html += `<div class="space-y-6">`;
            html += `<h3 class="text-xl font-bold text-work border-b border-gray-700 pb-2">Work & Tasks</h3>`;
            if(work.length === 0) html += `<p class="text-gray-500 italic">No work items recorded.</p>`;
            work.forEach(item => { html += renderCard(item); });
            html += `</div>`;

            // COL 2
            html += `<div class="space-y-6">`;
            html += `<h3 class="text-xl font-bold text-personal border-b border-gray-700 pb-2">Life & Media</h3>`;
            if(personal.length === 0) html += `<p class="text-gray-500 italic">No personal items recorded.</p>`;
            personal.forEach(item => { html += renderCard(item); });
            html += `</div>`;

            // COL 3
            html += `<div class="space-y-6">`;
            html += `<h3 class="text-xl font-bold text-health border-b border-gray-700 pb-2 flex justify-between items-center">
                Health & Nutrition
                <button onclick="openNutritionModal()" class="text-sm bg-gray-800 hover:bg-gray-700 p-1 rounded text-gray-400 hover:text-white transition" title="Edit Meals">‚úèÔ∏è</button>
            </h3>`;
            if(health) html += renderHealthCard(health);
            else html += `<div class="glass-panel p-6 rounded-xl text-center text-gray-500 cursor-pointer hover:bg-gray-800/50 transition" onclick="openNutritionModal()">Click to log nutrition</div>`;
            html += `</div>`;

            html += `</div>`;
            container.innerHTML = html;
        }

        function renderWeekView(container) {
            const start = getStartOfWeek(appState.currentDate);
            let html = `<div class="grid grid-cols-7 gap-2 min-h-[600px]">`;
            
            for(let i=0; i<7; i++) {
                const d = new Date(start);
                d.setDate(d.getDate() + i);
                const ymd = toLocalYMD(d);
                const isToday = ymd === toLocalYMD(new Date());
                const items = appState.data.items.filter(item => item.date === ymd);

                html += `
                    <div class="glass-panel rounded-lg flex flex-col h-full ${isToday ? 'border-blue-500 bg-blue-900/10' : ''}">
                        <div class="p-2 text-center border-b border-gray-700/50 ${isToday ? 'bg-blue-600 text-white' : 'bg-gray-800'}">
                            <div class="text-xs uppercase text-gray-400 font-bold">${d.toLocaleDateString('en-US', {weekday:'short'})}</div>
                            <div class="text-lg font-bold">${d.getDate()}</div>
                        </div>
                        <div class="p-1 flex-1 overflow-y-auto space-y-1">
                            ${items.map(item => `
                                <div class="text-[10px] p-1 rounded border-l-2 ${getTypeColor(item.type)} bg-gray-800 mb-1 truncate cursor-pointer hover:brightness-110" title="${item.title}">
                                    ${item.title}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            html += `</div>`;
            container.innerHTML = html;
        }

        function renderMonthView(container) {
            const year = appState.currentDate.getFullYear();
            const month = appState.currentDate.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            const startDayIndex = (firstDay.getDay() + 6) % 7;
            const daysInMonth = lastDay.getDate();

            let html = `<div class="glass-panel rounded-2xl p-4">`;
            
            // Header
            html += `<div class="grid grid-cols-7 mb-2 text-center">`;
            ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d => html += `<div class="font-bold text-gray-500 text-sm py-2">${d}</div>`);
            html += `</div>`;

            // Grid
            html += `<div class="grid grid-cols-7 gap-2 auto-rows-fr">`;

            // Empty cells
            for(let i=0; i<startDayIndex; i++) {
                html += `<div class="h-24 bg-gray-800/30 rounded-lg"></div>`;
            }

            // Days
            for(let d=1; d<=daysInMonth; d++) {
                const currentDayStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const items = appState.data.items.filter(i => i.date === currentDayStr);
                const isToday = currentDayStr === toLocalYMD(new Date());

                html += `
                    <div class="h-24 bg-gray-800 rounded-lg border ${isToday ? 'border-blue-500' : 'border-gray-700'} p-1 flex flex-col hover:bg-gray-700 transition cursor-pointer" onclick="goToDay('${currentDayStr}')">
                        <div class="text-right text-sm font-bold text-gray-400 mb-1">${d}</div>
                        <div class="flex flex-wrap gap-1 content-start">
                             ${items.map(i => `<div class="w-2 h-2 rounded-full ${getTypeDotColor(i.type)}" title="${i.title}"></div>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            html += `</div></div>`;
            container.innerHTML = html;
        }

        // --- CARD RENDERERS ---

        function renderCard(item) {
            const borderClass = getTypeColor(item.type);
            let content = '';
            let meta = '';

            if(item.type === 'meeting') {
                meta = `<span class="text-xs text-gray-400"><i class="mr-1">‚è∞</i> ${item.startTime} (${item.durationMinutes}m)</span>`;
                if(item.linkUrl) content += `<a href="${item.linkUrl}" target="_blank" class="text-xs bg-blue-600 px-2 py-1 rounded hover:bg-blue-500 inline-block mt-2">Join Meeting</a>`;
            }
            else if(item.type === 'task') {
                meta = `<span class="text-xs text-gray-400">${item.ticketNumber || 'No Ticket'}</span>`;
                content += `<div class="mt-2 flex gap-2">
                    <span class="text-[10px] px-2 py-0.5 rounded-full border border-gray-600 uppercase">${item.status}</span>
                    ${item.linkUrl ? `<a href="${item.linkUrl}" target="_blank" class="text-[10px] text-blue-400 hover:underline flex items-center">View Ticket ‚Üó</a>` : ''}
                </div>`;
            }
            else if(item.type === 'media') {
                meta = `<div class="flex text-yellow-400 text-xs">${'‚òÖ'.repeat(item.rating)}${'‚òÜ'.repeat(10-item.rating)}</div>`;
                if(item.imgUrl) content += `<img src="${item.imgUrl}" class="w-full h-48 object-cover rounded-lg mt-2 mb-2 shadow-lg">`;
                content += `<p class="text-xs text-gray-400 italic">"${item.notes}"</p>`;
            }
            else if(item.type === 'habit') {
                 content += `<div class="mt-2 flex items-center gap-2">
                    <div class="text-2xl">üî•</div>
                    <div>
                        <div class="text-xl font-bold">${item.streakCount}</div>
                        <div class="text-[10px] uppercase text-gray-500">Day Streak</div>
                    </div>
                 </div>`;
            }

            return `
                <div class="glass-panel p-4 rounded-xl border-l-4 ${borderClass} hover:translate-x-1 transition-transform relative group">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-lg">${item.title}</h4>
                            ${meta}
                        </div>
                        <div class="opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="text-gray-400 hover:text-white">‚úé</button>
                        </div>
                    </div>
                    ${item.description ? `<p class="text-sm text-gray-300 mt-2">${item.description}</p>` : ''}
                    ${content}
                </div>
            `;
        }

        function renderHealthCard(item) {
            const g = item.goals || { tdee: 2500, calorieGoal: 2000, protein: 150, fat: 80, netCarbs: 100 };
            
            let totalCal=0, totalPro=0, totalCarb=0, totalFat=0, totalFiber=0;
            (item.meals || []).forEach(m => {
                totalCal += Number(m.calories || 0);
                totalPro += Number(m.protein || 0);
                totalCarb += Number(m.carbs || 0);
                totalFat += Number(m.fat || 0);
                totalFiber += Number(m.fiber || 0);
            });
            const netCarbs = totalCarb - totalFiber;
            const calRemaining = g.calorieGoal - totalCal;
            const tdeeDiff = totalCal - g.tdee;
            
            const pctCal = Math.min((totalCal / g.calorieGoal) * 100, 100);
            const pctPro = Math.min((totalPro / g.protein) * 100, 100);
            const pctFat = Math.min((totalFat / g.fat) * 100, 100);
            const pctCarb = Math.min((netCarbs / g.netCarbs) * 100, 100);

            const weeklyData = getWeeklyDeficit();
            const runningDeficit = weeklyData.deficit;

            const mealsHtml = (item.meals || []).map(m => `
                <div class="flex justify-between items-center text-sm py-1 border-b border-gray-700/50 last:border-0">
                    <div class="overflow-hidden">
                        <span class="text-[10px] text-gray-500 uppercase bg-gray-800 px-1 rounded mr-1">${m.mealType || 'meal'}</span>
                        <span class="font-medium text-gray-300 truncate">${m.name}</span>
                    </div>
                    <span class="text-gray-400 whitespace-nowrap ml-2">${m.calories} Cal</span>
                </div>
            `).join('');

            return `
                <div class="glass-panel p-5 rounded-xl border-l-4 border-health">
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-sm text-gray-400">Weight</div>
                        <span class="text-xl font-bold text-white">${item.weightLbs} lbs</span>
                    </div>
                    
                    <div class="bg-gray-800/50 rounded-lg p-3 mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-400">Calories</span>
                            <span class="font-bold ${totalCal > g.calorieGoal ? 'text-red-400' : 'text-white'}">
                                ${totalCal.toLocaleString()} / ${g.calorieGoal.toLocaleString()}
                            </span>
                        </div>
                        <div class="macro-bar-bg mb-2"><div class="macro-bar-fill bg-health" style="width: ${pctCal}%"></div></div>
                        <div class="flex justify-between text-xs">
                            <span class="${calRemaining >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${calRemaining >= 0 ? 'Remaining: ' + calRemaining : 'Over: ' + Math.abs(calRemaining)}
                            </span>
                            <span class="text-gray-500">${pctCal.toFixed(1)}% of Goal</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-3 mb-4">
                         <div class="bg-gray-800/30 p-2 rounded">
                            <div class="flex justify-between text-xs text-gray-400 mb-1">
                                <span>Pro</span>
                                <span>${totalPro}/${g.protein}g</span>
                            </div>
                            <div class="macro-bar-bg"><div class="macro-bar-fill bg-blue-500" style="width: ${pctPro}%"></div></div>
                            <div class="text-[10px] text-right mt-1 text-blue-300">${pctPro.toFixed(0)}%</div>
                        </div>
                         <div class="bg-gray-800/30 p-2 rounded">
                            <div class="flex justify-between text-xs text-gray-400 mb-1">
                                <span>Fat</span>
                                <span>${totalFat}/${g.fat}g</span>
                            </div>
                            <div class="macro-bar-bg"><div class="macro-bar-fill bg-yellow-500" style="width: ${pctFat}%"></div></div>
                            <div class="text-[10px] text-right mt-1 text-yellow-300">${pctFat.toFixed(0)}%</div>
                        </div>
                         <div class="bg-gray-800/30 p-2 rounded">
                            <div class="flex justify-between text-xs text-gray-400 mb-1">
                                <span>Carb</span>
                                <span>${netCarbs}/${g.netCarbs}g</span>
                            </div>
                            <div class="macro-bar-bg"><div class="macro-bar-fill bg-green-500" style="width: ${pctCarb}%"></div></div>
                            <div class="text-[10px] text-right mt-1 text-green-300">${pctCarb.toFixed(0)}%</div>
                        </div>
                    </div>

                    <div class="border-t border-gray-700 pt-3 mb-4">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-400">Daily Deficit (vs TDEE)</span>
                            <span class="text-sm font-bold ${tdeeDiff < 0 ? 'text-green-400' : 'text-red-400'}">
                                ${tdeeDiff > 0 ? '+' : ''}${tdeeDiff.toLocaleString()} Cal
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-400">Weekly Running Deficit</span>
                            <span class="text-sm font-bold ${runningDeficit < 0 ? 'text-green-400' : 'text-gray-400'}">
                                ${runningDeficit.toLocaleString()} Cal
                            </span>
                        </div>
                        <div class="text-[10px] text-gray-500 text-right mt-1">Target: -4,200/wk (1.2lbs)</div>
                    </div>

                    <div class="space-y-1">
                        <div class="text-xs font-bold text-gray-500 uppercase mb-1">Today's Meals</div>
                        ${mealsHtml}
                    </div>
                </div>
            `;
        }

        // --- MODAL LOGIC ---
        function openNutritionModal() {
            const ymd = toLocalYMD(appState.currentDate);
            let item = appState.data.items.find(i => i.date === ymd && i.type === 'health');
            
            if (!item) {
                // Default template
                item = { 
                    weightLbs: 0, 
                    goals: { calorieGoal: 2220 }, 
                    meals: [] 
                };
            }

            document.getElementById('edit-weight').value = item.weightLbs || '';
            document.getElementById('edit-cal-goal').value = (item.goals ? item.goals.calorieGoal : 2220);
            
            const container = document.getElementById('meal-inputs-container');
            container.innerHTML = '';
            
            if (item.meals && item.meals.length > 0) {
                item.meals.forEach(m => addMealInput(m));
            } else {
                addMealInput(); // Add one empty row
            }

            document.getElementById('nutrition-modal').classList.remove('hidden');
        }

        function closeNutritionModal() {
            document.getElementById('nutrition-modal').classList.add('hidden');
        }

        function addMealInput(data = {}) {
            const container = document.getElementById('meal-inputs-container');
            const div = document.createElement('div');
            div.className = "bg-gray-700/30 p-3 rounded-lg border border-gray-700 meal-row";
            div.innerHTML = `
                <div class="flex gap-2 mb-2">
                    <select class="meal-type bg-gray-700 border border-gray-600 rounded text-xs px-2 py-1 text-gray-300 outline-none focus:border-health">
                        <option value="breakfast" ${data.mealType === 'breakfast' ? 'selected' : ''}>Breakfast</option>
                        <option value="lunch" ${data.mealType === 'lunch' ? 'selected' : ''}>Lunch</option>
                        <option value="dinner" ${data.mealType === 'dinner' ? 'selected' : ''}>Dinner</option>
                        <option value="snack" ${data.mealType === 'snack' ? 'selected' : ''}>Snack</option>
                    </select>
                    <input type="text" placeholder="Food Item" value="${data.name || ''}" class="meal-name flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm text-white outline-none focus:border-health">
                    <button onclick="this.closest('.meal-row').remove()" class="text-red-400 hover:text-red-300 px-1">&times;</button>
                </div>
                <div class="grid grid-cols-5 gap-2">
                    <div><label class="text-[10px] text-gray-500 block">Cal</label><input type="number" value="${data.calories || ''}" class="meal-cal w-full bg-gray-800 border border-gray-600 rounded px-1 py-1 text-xs outline-none focus:border-health"></div>
                    <div><label class="text-[10px] text-gray-500 block">Pro</label><input type="number" value="${data.protein || ''}" class="meal-pro w-full bg-gray-800 border border-gray-600 rounded px-1 py-1 text-xs outline-none focus:border-health"></div>
                    <div><label class="text-[10px] text-gray-500 block">Carb</label><input type="number" value="${data.carbs || ''}" class="meal-carb w-full bg-gray-800 border border-gray-600 rounded px-1 py-1 text-xs outline-none focus:border-health"></div>
                    <div><label class="text-[10px] text-gray-500 block">Fat</label><input type="number" value="${data.fat || ''}" class="meal-fat w-full bg-gray-800 border border-gray-600 rounded px-1 py-1 text-xs outline-none focus:border-health"></div>
                    <div><label class="text-[10px] text-gray-500 block">Fiber</label><input type="number" value="${data.fiber || ''}" class="meal-fiber w-full bg-gray-800 border border-gray-600 rounded px-1 py-1 text-xs outline-none focus:border-health"></div>
                </div>
            `;
            container.appendChild(div);
        }

        function saveNutrition() {
            const ymd = toLocalYMD(appState.currentDate);
            
            // Gather Data
            const weight = parseFloat(document.getElementById('edit-weight').value) || 0;
            const calGoal = parseFloat(document.getElementById('edit-cal-goal').value) || 2220;
            
            const mealRows = document.querySelectorAll('.meal-row');
            const meals = Array.from(mealRows).map(row => ({
                mealType: row.querySelector('.meal-type').value,
                name: row.querySelector('.meal-name').value,
                calories: parseFloat(row.querySelector('.meal-cal').value) || 0,
                protein: parseFloat(row.querySelector('.meal-pro').value) || 0,
                carbs: parseFloat(row.querySelector('.meal-carb').value) || 0,
                fat: parseFloat(row.querySelector('.meal-fat').value) || 0,
                fiber: parseFloat(row.querySelector('.meal-fiber').value) || 0
            })).filter(m => m.name.trim() !== ""); // Filter empty names

            // Find or Create Item
            let itemIndex = appState.data.items.findIndex(i => i.date === ymd && i.type === 'health');
            
            const newItem = {
                id: itemIndex >= 0 ? appState.data.items[itemIndex].id : `health_${new Date().getTime()}`,
                date: ymd,
                type: 'health',
                category: 'personal',
                weightLbs: weight,
                goals: {
                    tdee: 2816, // Hardcoded base TDEE for now
                    calorieGoal: calGoal,
                    protein: 167,
                    fat: 150,
                    netCarbs: 100
                },
                meals: meals
            };

            if (itemIndex >= 0) {
                appState.data.items[itemIndex] = newItem;
            } else {
                appState.data.items.push(newItem);
            }

            closeNutritionModal();
            updateUI();
        }

        // --- LOGIC ---
        function getWeeklyDeficit() {
            const start = getStartOfWeek(appState.currentDate);
            const end = new Date(appState.currentDate); 
            
            let totalDeficit = 0;
            let daysCounted = 0;

            const loopDate = new Date(start);
            while(loopDate <= end) {
                const ymd = toLocalYMD(loopDate);
                const item = appState.data.items.find(i => i.date === ymd && i.type === 'health');
                
                if (item) {
                    let dailyCal = 0;
                    (item.meals || []).forEach(m => dailyCal += (m.calories || 0));
                    const tdee = (item.goals && item.goals.tdee) ? item.goals.tdee : 2816;
                    totalDeficit += (dailyCal - tdee);
                    daysCounted++;
                }
                loopDate.setDate(loopDate.getDate() + 1);
            }
            return { deficit: totalDeficit, days: daysCounted };
        }

        // --- HELPERS ---
        function toLocalYMD(date) {
            const offset = date.getTimezoneOffset();
            const adjusted = new Date(date.getTime() - (offset*60*1000));
            return adjusted.toISOString().split('T')[0];
        }

        function getStartOfWeek(d) {
            const date = new Date(d);
            const day = date.getDay(); 
            const diff = date.getDate() - (day === 0 ? 6 : day - 1);
            return new Date(date.setDate(diff));
        }
        
        function goToDay(dateStr) {
            appState.currentDate = new Date(dateStr + "T12:00:00");
            switchView('day');
        }

        function getTypeColor(type) {
            const map = {
                'meeting': 'border-work bg-work/10',
                'task': 'border-work bg-work/5',
                'habit': 'border-personal bg-personal/10',
                'media': 'border-media bg-media/10',
                'health': 'border-health bg-health/10'
            };
            return map[type] || 'border-gray-500';
        }

        function getTypeDotColor(type) {
            const map = {
                'meeting': 'bg-blue-500',
                'task': 'bg-blue-400',
                'habit': 'bg-green-500',
                'media': 'bg-purple-500',
                'health': 'bg-orange-500'
            };
            return map[type] || 'bg-gray-500';
        }

        function toggleSidebar() {
            const sb = document.getElementById('bullet-sidebar');
            const ov = document.getElementById('sidebar-overlay');
            if(sb.classList.contains('sidebar-closed')) {
                sb.classList.replace('sidebar-closed', 'sidebar-open');
                ov.classList.remove('hidden');
            } else {
                sb.classList.replace('sidebar-open', 'sidebar-closed');
                ov.classList.add('hidden');
            }
        }

        async function fetchWeather() {
            const ZIP = '75482,us', KEY = '87256fe2710631542ff491e4c5d73306';
            try {
                const wRes = await fetch(`https://api.openweathermap.org/data/2.5/weather?zip=${ZIP}&units=imperial&appid=${KEY}`);
                if(wRes.ok) {
                    const w = await wRes.json();
                    document.getElementById('weather-current-temp').textContent = Math.round(w.main.temp) + '¬∞';
                    document.getElementById('weather-icon').innerHTML = getForecastEmoji(w.weather[0].icon);
                }
            } catch(e) {}
        }
        function getForecastEmoji(c) { if(c.includes('01'))return'‚òÄÔ∏è'; if(c.includes('02'))return'üå§Ô∏è'; if(c.includes('03'))return'üå•Ô∏è'; if(c.includes('09')||c.includes('10'))return'üåßÔ∏è'; if(c.includes('13'))return'‚ùÑÔ∏è'; return'‚òÅÔ∏è'; }

    </script>
</body>
</html>
