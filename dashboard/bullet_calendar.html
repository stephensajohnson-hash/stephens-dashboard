<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bullet Calendar</title>
    <link rel="icon" href="/images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        * { transition: all 0.2s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }
        html { font-family: 'Inter', sans-serif; }
        .glass-panel { background: rgba(31, 41, 55, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .solid-panel { background: #1f2937; border: 1px solid #4b5563; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.04); z-index: 100; }
        #bullet-sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-open { transform: translateX(0); }
        .sidebar-closed { transform: translateX(-100%); }
        .macro-bar-bg { background-color: rgba(255,255,255,0.1); border-radius: 2px; height: 6px; width: 100%; overflow: hidden; }
        .macro-bar-fill { height: 100%; border-radius: 2px; }
        .star-btn:hover, .star-btn.active { color: #fbbf24; } 
        .star-btn { color: #4b5563; transition: color 0.1s; } 
    </style>
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'], }, colors: { work: '#3b82f6', personal: '#10b981', media: '#8b5cf6', health: '#f59e0b', sports: '#ef4444' } } } }
    </script>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col overflow-hidden">

    <!-- Tooltip Container -->
    <div id="hover-card-container" class="fixed z-50 hidden pointer-events-none drop-shadow-2xl max-w-sm w-full transition-opacity duration-200 opacity-0"></div>

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 right-0 bg-gray-800 border-b border-gray-700 shadow-xl z-40 p-2 flex items-center justify-between h-16">
        <div class="flex items-center gap-3">
            <button id="menu-button" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 focus:outline-none" onclick="toggleSidebar()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
            <a href="index.html" class="text-gray-400 hover:text-white p-2 transition-colors" title="Return to Dashboard">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            </a>
            <div class="flex items-center bg-gray-700 rounded-lg p-1 ml-4">
                <button onclick="navigate(-1)" class="p-1 hover:text-blue-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <button onclick="jumpToToday()" class="px-3 text-sm font-bold hover:text-blue-400">Today</button>
                <button onclick="navigate(1)" class="p-1 hover:text-blue-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
            </div>
            <div id="current-view-label" class="text-lg font-bold ml-4 text-blue-200"></div>
        </div>
        <div class="flex items-center gap-4">
             <div class="hidden md:flex bg-gray-700 rounded-lg p-1">
                <button onclick="switchView('day')" id="btn-view-day" class="px-3 py-1 text-sm rounded-md bg-blue-600">Day</button>
                <button onclick="switchView('week')" id="btn-view-week" class="px-3 py-1 text-sm rounded-md hover:bg-gray-600">Week</button>
                <button onclick="switchView('month')" id="btn-view-month" class="px-3 py-1 text-sm rounded-md hover:bg-gray-600">Month</button>
            </div>
            <div id="weather-display" class="text-sm flex items-center bg-gray-700 px-3 py-1 rounded-full border border-gray-600">
                <span class="flex items-center" id="weather-content">
                    <span id="weather-current-temp" class="text-lg font-bold mr-3">--¬∞</span>
                    <span class="mr-1 text-xl" id="weather-icon">...</span>
                </span>
            </div>
        </div>
    </nav>

    <!-- Layout -->
    <div class="flex flex-1 pt-16 relative overflow-hidden">
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden backdrop-blur-sm"></div>
        <aside id="bullet-sidebar" class="absolute lg:relative z-50 w-64 h-full bg-gray-800 border-r border-gray-700 flex flex-col sidebar-closed lg:sidebar-open shadow-2xl">
            <div class="p-4 border-b border-gray-700">
                <h2 class="text-xl font-bold text-purple-400">Bullet Journal</h2>
                <p class="text-xs text-gray-500">Year 2025</p>
            </div>
            <div class="flex-1 overflow-y-auto p-2 space-y-1">
                <button onclick="jumpToToday(); toggleSidebar()" class="w-full text-left px-4 py-2 rounded hover:bg-gray-700 text-blue-300 font-bold"><i class="mr-2">üìÖ</i> Today</button>
                <div class="border-b border-gray-700 my-2"></div>
                <div id="month-list" class="space-y-1"></div>
            </div>
            <div class="p-4 border-t border-gray-700">
                 <a href="recipes.html" class="block w-full text-left py-2 px-3 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-white text-sm mb-1">View Recipes</a>
                <button onclick="openSportsManager()" class="block w-full text-left py-2 px-3 rounded-lg text-blue-400 hover:bg-gray-700 hover:text-white text-sm mb-1 transition-colors">Manage Sports</button>
                <button onclick="downloadData()" class="block w-full text-left py-2 px-3 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-white text-sm mb-1 transition-colors">Download Data</button>
                <button onclick="resetData()" class="block w-full text-left py-2 px-3 rounded-lg text-red-400 hover:bg-red-900/20 hover:text-red-200 text-sm mb-1 transition-colors">Reset to JSON</button>
                <p id="version-display" class="text-xs font-mono text-gray-500 mt-2 text-center">Stephens' Dashboard V1.0</p>
            </div>
        </aside>
        <main class="flex-1 overflow-y-auto p-4 sm:p-6 relative bg-gray-900" id="main-scroll">
            <div id="view-container" class="max-w-7xl mx-auto min-h-full"></div>
        </main>
    </div>

    <!-- Sports Manager Modal -->
    <div id="sports-manager-modal" class="fixed inset-0 bg-black/80 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-2xl w-full max-w-3xl h-[80vh] flex flex-col shadow-2xl border border-gray-700">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white">Manage Sports Data</h3>
                <button onclick="closeSportsManager()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            
            <!-- Tabs -->
            <div class="flex border-b border-gray-700 px-6 pt-2">
                <button onclick="switchSportsTab('leagues')" id="tab-leagues" class="px-4 py-2 text-sm font-medium text-white border-b-2 border-blue-500">Leagues</button>
                <button onclick="switchSportsTab('teams')" id="tab-teams" class="px-4 py-2 text-sm font-medium text-gray-400 hover:text-white">Teams</button>
            </div>

            <div class="flex-1 overflow-y-auto p-6">
                
                <!-- LEAGUES TAB -->
                <div id="view-leagues" class="block">
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="new-league-input" placeholder="New League Name (e.g. NHL)" class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white focus:border-blue-500 outline-none">
                        <button onclick="addLeague()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded font-bold">Add</button>
                    </div>
                    <div id="leagues-list" class="space-y-2">
                        <!-- League Items -->
                    </div>
                </div>

                <!-- TEAMS TAB -->
                <div id="view-teams" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-full">
                        <!-- Add Team Form -->
                        <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-700 h-fit">
                            <h4 class="font-bold text-sm mb-3 text-gray-400 uppercase">Add Team</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs text-gray-500">League</label>
                                    <select id="team-league-select" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-xs text-white"></select>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500">Team Name</label>
                                    <input type="text" id="team-name-input" placeholder="e.g. Dallas Cowboys" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-xs text-white">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500">Abbreviation</label>
                                    <input type="text" id="team-abbrev-input" placeholder="e.g. DAL" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-xs text-white uppercase" maxlength="4">
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500">Logo URL</label>
                                    <input type="text" id="team-logo-input" placeholder="https://..." class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-xs text-white">
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" id="team-fav-input" class="rounded bg-gray-700 border-gray-600">
                                    <label for="team-fav-input" class="text-xs text-gray-300">Favorite Team?</label>
                                </div>
                                <button onclick="addTeam()" class="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded text-sm font-bold">Save Team</button>
                            </div>
                        </div>

                        <!-- Team List -->
                        <div class="md:col-span-2 overflow-y-auto">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-bold text-sm text-gray-400 uppercase">Current Teams</h4>
                                <select id="filter-league-select" class="bg-gray-700 border-gray-600 rounded text-xs px-2 py-1 text-white" onchange="renderTeamsList()"></select>
                            </div>
                            <div id="teams-list" class="space-y-2">
                                <!-- Teams injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nutrition Editor Modal -->
    <div id="nutrition-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-2xl w-full max-w-2xl max-h-[90vh] flex flex-col shadow-2xl border border-gray-700">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-health">Log Nutrition</h3>
                <button onclick="closeNutritionModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Weight (lbs)</label>
                        <input type="number" step="0.1" id="edit-weight" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:border-health outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Calorie Goal</label>
                        <input type="number" id="edit-cal-goal" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:border-health outline-none">
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-bold text-gray-500 uppercase">Meals</label>
                        <button type="button" onclick="addMealInput()" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded text-health font-bold border border-gray-600">+ Add Item</button>
                    </div>
                    <div id="meal-inputs-container" class="space-y-2"></div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-700 flex justify-end gap-3">
                <button onclick="closeNutritionModal()" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                <button onclick="saveNutrition()" class="px-6 py-2 bg-health hover:bg-orange-600 text-white font-bold rounded-lg shadow-lg">Save Log</button>
            </div>
        </div>
    </div>

    <!-- General Item Editor Modal -->
    <div id="item-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-2xl w-full max-w-md flex flex-col shadow-2xl border border-gray-700">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-xl font-bold text-white" id="item-modal-title">Add Item</h3>
                <button onclick="closeItemModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="item-category">
                <input type="hidden" id="item-id">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Type</label>
                    <select id="item-type" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:border-blue-500 outline-none" onchange="updateModalFields()">
                        <!-- Dynamic Options -->
                    </select>
                </div>
                
                <!-- Title Row -->
                <div id="field-title">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Title</label>
                    <input type="text" id="item-title" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:border-blue-500 outline-none" placeholder="Item title...">
                </div>

                <!-- SPORTS Specific Fields -->
                <div id="field-sports" class="hidden space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                         <div>
                             <label class="block text-xs font-bold text-gray-500 uppercase mb-1">League</label>
                             <select id="sports-league" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white text-xs" onchange="populateTeamSelects()">
                             </select>
                         </div>
                         <div>
                             <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Time / Status</label>
                             <input type="time" id="sports-time" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white text-xs">
                         </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <div class="flex-1">
                             <label class="block text-xs font-bold text-gray-500 uppercase mb-1">My Team</label>
                             <select id="sports-myteam" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white text-xs"></select>
                        </div>
                        <div class="flex flex-col items-center justify-end pb-1">
                            <label class="text-[10px] text-gray-500 uppercase mb-1">Vs/At</label>
                            <button onclick="swapHomeAway()" class="bg-gray-600 p-2 rounded hover:bg-gray-500">‚áÑ</button>
                        </div>
                        <div class="flex-1">
                             <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Opponent</label>
                             <select id="sports-opponent" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white text-xs"></select>
                        </div>
                    </div>
                    <input type="hidden" id="sports-is-home" value="false"> <!-- Track if My Team is Home -->
                    <div class="text-center text-xs text-gray-400" id="sports-matchup-label">My Team @ Opponent</div>

                    <div class="grid grid-cols-2 gap-4">
                         <div>
                             <label class="block text-xs font-bold text-gray-500 uppercase mb-1">My Score</label>
                             <input type="number" id="sports-score-my" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white">
                         </div>
                         <div>
                             <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Opp Score</label>
                             <input type="number" id="sports-score-opp" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white">
                         </div>
                    </div>
                </div>

                <div id="common-fields">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Description / Notes</label>
                    <textarea id="item-desc" rows="2" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white focus:border-blue-500 outline-none" placeholder="Details..."></textarea>
                </div>
                
                <!-- Meeting Fields -->
                <div id="field-meeting" class="hidden grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Start Time</label>
                        <input type="time" id="item-startTime" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Planned Duration</label>
                        <input type="text" id="item-duration" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white" placeholder="e.g. 1h 30m or 90">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Actual Duration</label>
                        <input type="text" id="item-actualDuration" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white" placeholder="e.g. 1h 15m">
                    </div>
                </div>
                
                <!-- Task Fields -->
                <div id="field-task" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Ticket Number (Optional)</label>
                    <input type="text" id="item-ticket" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white" placeholder="e.g. JIRA-123">
                </div>
                
                <!-- Media Fields -->
                <div id="field-media" class="hidden">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Rating (1-10 Stars)</label>
                    <input type="hidden" id="item-rating" value="5">
                    <div id="star-rating-container" class="flex gap-1 text-2xl cursor-pointer"></div>
                </div>

                <!-- Habit Fields -->
                <div id="field-habit" class="hidden">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Current Streak</label>
                            <input type="number" id="item-streak" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white" value="0">
                        </div>
                        <div class="flex items-center">
                             <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer mt-4">
                                <input type="checkbox" id="item-fill-month" class="w-4 h-4 rounded border-gray-600 bg-gray-700 text-blue-600 focus:ring-blue-500">
                                <span>Fill rest of month?</span>
                             </label>
                        </div>
                    </div>
                </div>

                <!-- URL/Image -->
                <div class="grid grid-cols-2 gap-4" id="field-url">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Link URL</label>
                        <input type="url" id="item-link" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white text-xs">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Image URL</label>
                        <input type="text" id="item-img" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white text-xs">
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-700 flex justify-end gap-3">
                <button onclick="closeItemModal()" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                <button onclick="saveItem()" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-lg">Save Item</button>
            </div>
        </div>
    </div>

    <script>
        // --- HELPER FUNCTIONS ---
        function toLocalYMD(date) { 
            const offset = date.getTimezoneOffset(); 
            const adjusted = new Date(date.getTime() - (offset*60*1000)); 
            return adjusted.toISOString().split('T')[0]; 
        }
        function getStartOfWeek(d) { 
            const date = new Date(d); 
            const day = date.getDay(); 
            const diff = date.getDate() - (day === 0 ? 6 : day - 1); 
            return new Date(date.setDate(diff)); 
        }
        function getTypeColor(type) { 
            const map = { 'meeting': 'border-work bg-work/10', 'task': 'border-work bg-work/5', 'habit': 'border-personal bg-personal/10', 'media': 'border-media bg-media/10', 'health': 'border-health bg-health/10', 'sports': 'border-sports bg-sports/10' }; 
            return map[type] || 'border-gray-500'; 
        }
        function getTypeDotColor(type) { 
            const map = { 'meeting': 'bg-blue-500', 'task': 'bg-blue-400', 'habit': 'bg-green-500', 'media': 'bg-purple-500', 'health': 'bg-orange-500', 'sports': 'bg-red-500' }; 
            return map[type] || 'bg-gray-500'; 
        }
        function formatTime(timeStr) {
            if (!timeStr) return '';
            const [h, m] = timeStr.split(':');
            const hour = parseInt(h);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${m} ${ampm}`;
        }
        function formatDuration(mins) {
            if(!mins) return '0m';
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            if(h > 0 && m > 0) return `${h}h ${m}m`;
            if(h > 0) return `${h}h`;
            return `${m}m`;
        }
        function parseDuration(str) {
            if(!str) return 0;
            if(!isNaN(str)) return parseInt(str);
            const h = str.match(/(\d+)\s*h/i);
            const m = str.match(/(\d+)\s*m/i);
            let mins = 0;
            if(h) mins += parseInt(h[1]) * 60;
            if(m) mins += parseInt(m[1]);
            return mins;
        }
        function toggleSidebar() {
            const sb = document.getElementById('bullet-sidebar');
            const ov = document.getElementById('sidebar-overlay');
            if(sb.classList.contains('sidebar-closed')) {
                sb.classList.replace('sidebar-closed', 'sidebar-open');
                ov.classList.remove('hidden');
            } else {
                sb.classList.replace('sidebar-open', 'sidebar-closed');
                ov.classList.add('hidden');
            }
        }
        async function fetchWeather() {
            const ZIP = '75482,us', KEY = '87256fe2710631542ff491e4c5d73306';
            try {
                const wRes = await fetch(`https://api.openweathermap.org/data/2.5/weather?zip=${ZIP}&units=imperial&appid=${KEY}`);
                if(wRes.ok) {
                    const w = await wRes.json();
                    document.getElementById('weather-current-temp').textContent = Math.round(w.main.temp) + '¬∞';
                    document.getElementById('weather-icon').innerHTML = getForecastEmoji(w.weather[0].icon);
                }
            } catch(e) { console.error("Weather fetch failed", e); }
        }
        function getForecastEmoji(c) {
            if(c.includes('01')) return '‚òÄÔ∏è';
            if(c.includes('02')) return 'üå§Ô∏è';
            if(c.includes('03')) return 'üå•Ô∏è';
            if(c.includes('09')||c.includes('10')) return 'üåßÔ∏è';
            if(c.includes('13')) return '‚ùÑÔ∏è';
            return '‚òÅÔ∏è';
        }

        // --- MAIN APP LOGIC ---
        const STORAGE_KEY = 'bullet_cal_data';
        const DEFAULT_DATA = { "meta": { "year": 2025, "version": "1.4", "owner": "Stephens" }, "leagues": [], "teams": [], "items": [] };
        let appState = { currentDate: new Date(), view: 'day', data: { meta: DEFAULT_DATA.meta, leagues:[], teams:[], items: [] } };
        let hoverTimeout;

        window.onload = () => { renderSidebar(); fetchWeather(); loadData(); };

        async function loadData() {
            const idMap = new Map();
            try {
                const localStr = localStorage.getItem(STORAGE_KEY);
                if (localStr) {
                    const localData = JSON.parse(localStr);
                    if(localData.items) localData.items.forEach(item => idMap.set(item.id, item));
                    appState.data.leagues = localData.leagues || [];
                    appState.data.teams = localData.teams || [];
                }
            } catch (e) { console.warn("Error reading local storage", e); }
            try {
                const response = await fetch('bullet_cal_data_2025.json');
                if (response.ok) {
                    const jsonData = await response.json();
                    if(jsonData.items) {
                        jsonData.items.forEach(item => { if (!idMap.has(item.id)) idMap.set(item.id, item); });
                    }
                    appState.data.meta = jsonData.meta || appState.data.meta;
                    if (appState.data.teams.length === 0) appState.data.teams = jsonData.teams || [];
                    if (appState.data.leagues.length === 0) appState.data.leagues = jsonData.leagues || [];
                }
            } catch (error) { console.warn("Error fetching JSON", error); }
            appState.data.items = Array.from(idMap.values());
            updateUI();
        }

        function saveData() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(appState.data)); } catch (e) { console.error("Save failed", e); } }
        function resetData() { if(confirm("Wipe local edits?")) { localStorage.removeItem(STORAGE_KEY); appState.data.items = []; loadData(); } }
        
        function downloadData() {
            const url = URL.createObjectURL(new Blob([JSON.stringify(appState.data, null, 2)], { type: "application/json" }));
            const a = document.createElement('a'); a.href = url; a.download = `bullet_cal_data_${appState.data.meta.year}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            if(window.innerWidth < 1024) document.getElementById('bullet-sidebar').classList.replace('sidebar-open','sidebar-closed');
        }

        function deleteItem(id, type) {
            if(!confirm("Delete this item?")) return;
            appState.data.items = appState.data.items.filter(i => i.id !== id);
            saveData();
            updateUI();
        }

        // --- SPORTS MANAGER LOGIC ---
        function openSportsManager() {
            document.getElementById('sports-manager-modal').classList.remove('hidden');
            switchSportsTab('leagues');
        }
        
        function closeSportsManager() {
            document.getElementById('sports-manager-modal').classList.add('hidden');
        }
        
        function switchSportsTab(tab) {
            document.getElementById('tab-leagues').className = tab === 'leagues' ? 'px-4 py-2 text-sm font-medium text-white border-b-2 border-blue-500' : 'px-4 py-2 text-sm font-medium text-gray-400 hover:text-white';
            document.getElementById('tab-teams').className = tab === 'teams' ? 'px-4 py-2 text-sm font-medium text-white border-b-2 border-blue-500' : 'px-4 py-2 text-sm font-medium text-gray-400 hover:text-white';
            
            document.getElementById('view-leagues').classList.toggle('hidden', tab !== 'leagues');
            document.getElementById('view-teams').classList.toggle('hidden', tab !== 'teams');
            
            if(tab === 'leagues') renderLeaguesList();
            if(tab === 'teams') { renderTeamFilter(); renderTeamsList(); }
        }
        
        function renderLeaguesList() {
            const container = document.getElementById('leagues-list');
            container.innerHTML = appState.data.leagues.map(l => `
                <div class="flex justify-between items-center bg-gray-700 p-2 rounded">
                    <span>${l}</span>
                    <button onclick="deleteLeague('${l}')" class="text-red-400 hover:text-red-200">&times;</button>
                </div>
            `).join('');
        }
        
        function addLeague() {
            const val = document.getElementById('new-league-input').value.trim();
            if(val && !appState.data.leagues.includes(val)) {
                appState.data.leagues.push(val);
                document.getElementById('new-league-input').value = '';
                saveData();
                renderLeaguesList();
            }
        }
        
        function deleteLeague(name) {
            if(!confirm(`Delete league ${name}?`)) return;
            appState.data.leagues = appState.data.leagues.filter(l => l !== name);
            saveData();
            renderLeaguesList();
        }
        
        function renderTeamFilter() {
            const sel = document.getElementById('filter-league-select');
            sel.innerHTML = `<option value="all">All Leagues</option>` + appState.data.leagues.map(l => `<option value="${l}">${l}</option>`).join('');
            
            const addSel = document.getElementById('team-league-select');
            addSel.innerHTML = appState.data.leagues.map(l => `<option value="${l}">${l}</option>`).join('');
        }
        
        function renderTeamsList() {
            const filter = document.getElementById('filter-league-select').value;
            const teams = appState.data.teams.filter(t => filter === 'all' || t.league === filter);
            
            const container = document.getElementById('teams-list');
            container.innerHTML = teams.map(t => `
                <div class="flex justify-between items-center bg-gray-800 border border-gray-700 p-2 rounded">
                    <div class="flex items-center gap-3">
                        <img src="${t.logo}" class="w-8 h-8 object-contain bg-white/10 rounded">
                        <div>
                            <div class="text-sm font-bold">${t.name}</div>
                            <div class="text-[10px] text-gray-500">${t.league} ‚Ä¢ ${t.abbrev}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                         <button onclick="toggleTeamFav('${t.id}')" class="${t.isFavorite ? 'text-yellow-400' : 'text-gray-600'} hover:text-yellow-200">‚òÖ</button>
                         <button onclick="deleteTeam('${t.id}')" class="text-red-400 hover:text-red-200">&times;</button>
                    </div>
                </div>
            `).join('');
        }
        
        function addTeam() {
            const league = document.getElementById('team-league-select').value;
            const name = document.getElementById('team-name-input').value;
            const abbrev = document.getElementById('team-abbrev-input').value;
            const logo = document.getElementById('team-logo-input').value;
            const fav = document.getElementById('team-fav-input').checked;
            
            if(!league || !name || !abbrev) return alert("Fill required fields");
            
            appState.data.teams.push({
                id: `t_${Date.now()}`,
                league, name, abbrev, logo, isFavorite: fav
            });
            
            // Clear inputs
            document.getElementById('team-name-input').value = '';
            document.getElementById('team-abbrev-input').value = '';
            document.getElementById('team-logo-input').value = '';
            
            saveData();
            renderTeamsList();
        }
        
        function deleteTeam(id) {
            if(!confirm("Delete this team?")) return;
            appState.data.teams = appState.data.teams.filter(t => t.id !== id);
            saveData();
            renderTeamsList();
        }
        
        function toggleTeamFav(id) {
            const t = appState.data.teams.find(x => x.id === id);
            if(t) {
                t.isFavorite = !t.isFavorite;
                saveData();
                renderTeamsList();
            }
        }

        function toggleTaskStatus(id) {
            const item = appState.data.items.find(i => i.id === id);
            if (item) {
                item.status = item.status === 'completed' ? 'pending' : 'completed';
                saveData();
                updateUI();
            }
        }

        function fireConfetti(x, y) {
             confetti({
                particleCount: 100,
                spread: 70,
                origin: { x: x / window.innerWidth, y: y / window.innerHeight },
                colors: ['#10b981', '#34d399', '#6ee7b7'], 
                disableForReducedMotion: true
            });
        }

        function toggleHabitStatus(id, event) {
            const item = appState.data.items.find(i => i.id === id);
            if (item) {
                const wasCompleted = item.status === 'completed';
                item.status = wasCompleted ? 'pending' : 'completed';
                if (!wasCompleted && event) fireConfetti(event.clientX, event.clientY);
                saveData();
                updateUI();
            }
        }

        function navigate(dir) {
            const d = new Date(appState.currentDate);
            if (appState.view === 'day') d.setDate(d.getDate() + dir);
            else if (appState.view === 'week') d.setDate(d.getDate() + (dir * 7));
            else if (appState.view === 'month') d.setMonth(d.getMonth() + dir);
            appState.currentDate = d; updateUI();
        }
        function jumpToToday() { appState.currentDate = new Date(); appState.view = 'day'; updateUI(); }
        function switchView(v) { appState.view = v; updateUI(); }
        function jumpToMonth(m) { appState.currentDate.setMonth(m); appState.currentDate.setDate(1); appState.view = 'month'; updateUI(); toggleSidebar(); }
        function goToDay(dateStr) { appState.currentDate = new Date(dateStr + "T12:00:00"); switchView('day'); }

        function updateUI() {
            ['day', 'week', 'month'].forEach(v => {
                document.getElementById(`btn-view-${v}`).className = v === appState.view ? "px-3 py-1 text-sm rounded-md bg-blue-600 text-white shadow" : "px-3 py-1 text-sm rounded-md hover:bg-gray-600 text-gray-300";
            });
            const container = document.getElementById('view-container');
            const label = document.getElementById('current-view-label');
            container.innerHTML = '';
            if (appState.view === 'day') {
                label.innerText = appState.currentDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
                renderDayView(container);
            } else if (appState.view === 'week') {
                const start = getStartOfWeek(appState.currentDate);
                const end = new Date(start); end.setDate(end.getDate() + 6);
                label.innerText = `${start.toLocaleDateString()} - ${end.toLocaleDateString()}`;
                renderWeekView(container);
            } else if (appState.view === 'month') {
                label.innerText = appState.currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                renderMonthView(container);
            }
        }

        function renderSidebar() {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('month-list').innerHTML = months.map((m, i) => `<button onclick="jumpToMonth(${i})" class="w-full text-left px-4 py-2 rounded hover:bg-gray-700 text-gray-300 text-sm transition">${m}</button>`).join('');
        }

        function renderDayView(container) {
            const ymd = toLocalYMD(appState.currentDate);
            const items = appState.data.items.filter(i => i.date === ymd);
            
            const health = items.find(i => i.type === 'health');
            const work = items.filter(i => i.category === 'work');
            const personal = items.filter(i => i.category !== 'work' && i.type !== 'health');
            
            // Empty State
            const emptyState = items.length === 0 ? `<div class="flex flex-col items-center justify-center h-48 opacity-50 mb-8"><div class="text-6xl mb-4">üì≠</div><div class="text-xl">No entries for this day</div></div>` : '';

            let html = emptyState + `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">`;
            // COL 1: Work
            html += `<div class="space-y-6"><div class="flex justify-between items-center border-b border-gray-700 pb-2"><h3 class="text-xl font-bold text-work">Work & Tasks</h3><button onclick="openItemModal('work', null, 'task,meeting')" class="text-sm bg-gray-800 hover:bg-gray-700 w-8 h-8 rounded flex items-center justify-center text-gray-400 hover:text-white transition" title="Add Item">Ôºã</button></div>`;
            if(work.length === 0 && items.length > 0) html += `<p class="text-gray-500 italic text-sm">No items.</p>`;
            work.forEach(item => { html += renderCard(item); });
            html += `</div>`;
            // COL 2: Personal (Includes Sports)
            html += `<div class="space-y-6"><div class="flex justify-between items-center border-b border-gray-700 pb-2"><h3 class="text-xl font-bold text-personal">Life & Media</h3><button onclick="openItemModal('personal', null, 'habit,media,sports')" class="text-sm bg-gray-800 hover:bg-gray-700 w-8 h-8 rounded flex items-center justify-center text-gray-400 hover:text-white transition" title="Add Item">Ôºã</button></div>`;
            if(personal.length === 0 && items.length > 0) html += `<p class="text-gray-500 italic text-sm">No items.</p>`;
            personal.forEach(item => { html += renderCard(item); });
            html += `</div>`;
            // COL 3: Health
            html += `<div class="space-y-6"><div class="flex justify-between items-center border-b border-gray-700 pb-2"><h3 class="text-xl font-bold text-health">Health & Nutrition</h3><button onclick="openNutritionModal()" class="text-sm bg-gray-800 hover:bg-gray-700 w-8 h-8 rounded flex items-center justify-center text-gray-400 hover:text-white transition" title="Add Meals">Ôºã</button></div>`;
            if(health) html += renderHealthCard(health); else html += `<div class="glass-panel p-6 rounded-xl text-center text-gray-500 cursor-pointer hover:bg-gray-800/50 transition" onclick="openNutritionModal()">Click to log nutrition</div>`;
            html += `</div></div>`;
            container.innerHTML = html;
        }

        function renderWeekView(container) {
            const start = getStartOfWeek(appState.currentDate);
            let html = `<div class="grid grid-cols-7 gap-2 min-h-[600px]">`;
            for(let i=0; i<7; i++) {
                const d = new Date(start); d.setDate(d.getDate() + i);
                const ymd = toLocalYMD(d);
                const items = appState.data.items.filter(item => item.date === ymd);
                html += `
                    <div class="glass-panel rounded-lg flex flex-col h-full ${ymd === toLocalYMD(new Date()) ? 'border-blue-500 bg-blue-900/10' : ''}">
                        <div class="p-2 text-center border-b border-gray-700/50 ${ymd === toLocalYMD(new Date()) ? 'bg-blue-600 text-white' : 'bg-gray-800'}">
                            <div class="text-xs uppercase text-gray-400 font-bold">${d.toLocaleDateString('en-US', {weekday:'short'})}</div>
                            <div class="text-lg font-bold">${d.getDate()}</div>
                        </div>
                        <div class="p-1 flex-1 overflow-y-auto space-y-1">
                            ${items.map(item => {
                                let title = item.type === 'health' ? 'Nutrition Log' : item.title;
                                const timeStr = (item.type === 'meeting' && item.startTime) ? `<span class="text-[8px] text-gray-400 mr-1">${formatTime(item.startTime)}</span>` : '';
                                return `<div class="text-[10px] p-1 rounded border-l-2 ${getTypeColor(item.type)} bg-gray-800 mb-1 truncate cursor-pointer hover:brightness-110" onmouseenter="delayedShowHover(event, '${item.id}')" onmouseleave="cancelHover()">${timeStr}${title}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }
            html += `</div>`; container.innerHTML = html;
        }

        function renderMonthView(container) {
            const year = appState.currentDate.getFullYear(); const month = appState.currentDate.getMonth();
            const firstDay = new Date(year, month, 1); const lastDay = new Date(year, month + 1, 0);
            const startDayIndex = (firstDay.getDay() + 6) % 7;
            let html = `<div class="glass-panel rounded-2xl p-4"><div class="grid grid-cols-7 mb-2 text-center">${['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].map(d => `<div class="font-bold text-gray-500 text-sm py-2">${d}</div>`).join('')}</div><div class="grid grid-cols-7 gap-2 auto-rows-fr">`;
            for(let i=0; i<startDayIndex; i++) { html += `<div class="h-24 bg-gray-800/30 rounded-lg"></div>`; }
            for(let d=1; d<=lastDay.getDate(); d++) {
                const currentDayStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const items = appState.data.items.filter(i => i.date === currentDayStr);
                html += `
                    <div class="h-24 bg-gray-800 rounded-lg border ${currentDayStr === toLocalYMD(new Date()) ? 'border-blue-500' : 'border-gray-700'} p-1 flex flex-col hover:bg-gray-700 transition cursor-pointer overflow-y-auto" onclick="goToDay('${currentDayStr}')">
                        <div class="text-right text-sm font-bold text-gray-400 mb-1">${d}</div>
                        <div class="space-y-1">
                             ${items.map(item => {
                                 let title = item.type === 'health' ? 'Nutrition Log' : item.title;
                                 const timeStr = (item.type === 'meeting' && item.startTime) ? `<span class="text-[8px] text-gray-400 mr-1">${formatTime(item.startTime)}</span>` : '';
                                 return `<div class="text-[9px] p-0.5 rounded border-l-2 ${getTypeColor(item.type)} bg-gray-700/50 truncate" onmouseenter="delayedShowHover(event, '${item.id}')" onmouseleave="cancelHover()">${timeStr}${title}</div>`;
                             }).join('')}
                        </div>
                    </div>
                `;
            }
            html += `</div></div>`; container.innerHTML = html;
        }

        // --- HOVER TOOLTIP LOGIC ---
        function delayedShowHover(e, id) {
            clearTimeout(hoverTimeout);
            hoverTimeout = setTimeout(() => showHoverCard(e, id), 500);
        }
        
        function cancelHover() {
            clearTimeout(hoverTimeout);
            hideHoverCard();
        }

        function showHoverCard(e, itemId) {
            e.stopPropagation(); 
            const item = appState.data.items.find(i => i.id === itemId);
            if(!item) return;

            const tooltip = document.getElementById('hover-card-container');
            let html = item.type === 'health' ? renderHealthCard(item) : renderCard(item);
            html = html.replace('glass-panel', 'solid-panel shadow-2xl');
            
            tooltip.innerHTML = html;
            tooltip.classList.remove('hidden', 'opacity-0');
            
            const rect = e.target.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let top = rect.top + window.scrollY;
            let left = rect.right + 10 + window.scrollX;

            if (left + tooltipRect.width > window.innerWidth) {
                left = rect.left - tooltipRect.width - 10 + window.scrollX;
            }
            if (top + tooltipRect.height > window.innerHeight) {
                top = window.innerHeight - tooltipRect.height - 10 + window.scrollY;
            }

            tooltip.style.top = `${top}px`;
            tooltip.style.left = `${left}px`;
        }

        function hideHoverCard() {
            const tooltip = document.getElementById('hover-card-container');
            tooltip.classList.add('opacity-0');
            setTimeout(() => tooltip.classList.add('hidden'), 200);
        }

        // --- TEAM LOGIC ---
        function getTeamRecord(teamId) {
            let wins = 0, losses = 0, ties = 0;
            // Filter all sports items that are completed
            const sportsItems = appState.data.items.filter(i => i.type === 'sports' && i.status === 'completed');
            
            sportsItems.forEach(g => {
                // Check if team participated
                if (g.homeTeamId === teamId || g.awayTeamId === teamId) {
                    const isHome = g.homeTeamId === teamId;
                    const myScore = isHome ? g.homeScore : g.awayScore;
                    const oppScore = isHome ? g.awayScore : g.homeScore;
                    
                    if (myScore > oppScore) wins++;
                    else if (myScore < oppScore) losses++;
                    else ties++;
                }
            });
            
            if (ties > 0) return `${wins}-${losses}-${ties}`;
            return `${wins}-${losses}`;
        }

        function renderCard(item) {
            let titleHtml = `<h4 class="font-bold text-lg">${item.title}</h4>`;
            let meta = '', descriptionHtml = item.description ? `<p class="text-sm text-gray-300 mt-2">${item.description}</p>` : '', content = '';
            
            if(item.type === 'meeting') {
                meta = `<div class="text-xs text-gray-400 flex flex-col gap-1 mt-1">
                    <span><i class="mr-1">‚è∞</i> ${formatTime(item.startTime)}</span>
                    <span class="font-mono bg-gray-800 px-1 rounded w-fit">Planned: ${formatDuration(item.durationMinutes)}</span>
                    ${item.timeSpentMinutes ? `<span class="font-mono bg-gray-800 px-1 rounded w-fit text-green-400">Actual: ${formatDuration(item.timeSpentMinutes)}</span>` : ''}
                </div>`;
                if(item.linkUrl) titleHtml = `<h4 class="font-bold text-lg flex items-center gap-2"><a href="${item.linkUrl}" target="_blank" class="hover:text-blue-400 hover:underline">${item.title}</a><span class="text-[10px] text-blue-500 bg-blue-500/10 px-1 rounded">‚Üó</span></h4>`;
                if (item.imgUrl) descriptionHtml = `<div class="flex gap-3 mt-2"><img src="${item.imgUrl}" class="h-[16px] w-auto rounded flex-shrink-0" alt="Meeting Icon"><p class="text-sm text-gray-300 self-center">${item.description || ''}</p></div>`;
            } else if(item.type === 'task') {
                const isChecked = item.status === 'completed';
                meta = `<span class="text-xs text-gray-400">${item.ticketNumber || ''}</span>`;
                titleHtml = `<div class="flex items-center gap-3"><input type="checkbox" class="w-5 h-5 rounded border-gray-600 text-blue-600 bg-gray-700 focus:ring-blue-500 focus:ring-offset-gray-800" ${isChecked ? 'checked' : ''} onchange="toggleTaskStatus('${item.id}')"><h4 class="font-bold text-lg ${isChecked ? 'line-through text-gray-500' : ''}">${item.title}</h4></div>`;
                content += `<div class="mt-2 flex gap-2">${item.linkUrl ? `<a href="${item.linkUrl}" target="_blank" class="text-[10px] text-blue-400 hover:underline flex items-center">View Ticket ‚Üó</a>` : ''}</div>`;
            } else if(item.type === 'media') {
                meta = `<div class="flex text-yellow-400 text-xs">${'‚òÖ'.repeat(item.rating)}${'‚òÜ'.repeat(10-item.rating)}</div>`;
                if(item.imgUrl) content += `<img src="${item.imgUrl}" class="w-full h-auto rounded-lg mt-2 mb-2 shadow-lg">`;
                const notesText = item.notes || item.description;
                if(notesText) content += `<p class="text-xs text-gray-400 italic">"${notesText}"</p>`;
                descriptionHtml = ''; 
            } else if(item.type === 'habit') {
                 const isChecked = item.status === 'completed';
                 if(item.imgUrl) {
                     let imgHtml = `<img src="${item.imgUrl}" class="max-h-[25px] w-auto max-w-full object-contain rounded mt-2 mb-2 shadow-sm">`;
                     if(item.linkUrl) imgHtml = `<a href="${item.linkUrl}" target="_blank" class="block hover:opacity-90 transition-opacity">${imgHtml}</a>`;
                     content += imgHtml;
                 }
                 content += `<div class="mt-2 flex items-center justify-between gap-2">
                    <div class="flex items-center gap-2"><div class="text-2xl">üî•</div><div><div class="text-xl font-bold">${item.streakCount}</div><div class="text-[10px] uppercase text-gray-500">Day Streak</div></div></div>
                    <input type="checkbox" class="w-6 h-6 rounded border-green-600 text-green-600 bg-gray-700 focus:ring-green-500" ${isChecked ? 'checked' : ''} onchange="toggleHabitStatus('${item.id}', event)">
                 </div>`;
            } else if (item.type === 'sports') {
                const home = appState.data.teams.find(t => t.id === item.homeTeamId) || { name: 'Unknown', logo: '' };
                const away = appState.data.teams.find(t => t.id === item.awayTeamId) || { name: 'Unknown', logo: '' };
                
                const myTeam = home.isFavorite ? home : (away.isFavorite ? away : null);
                
                let scoreDisplay = `<span class="text-gray-400 text-sm">${item.startTime || 'TBD'}</span>`;
                if(item.status === 'completed') {
                    scoreDisplay = `<div class="text-xl font-bold tracking-widest">${item.awayScore} - ${item.homeScore}</div>`;
                }

                content += `
                    <div class="flex justify-between items-center mt-3 mb-2">
                        <div class="flex flex-col items-center w-1/3">
                            <img src="${away.logo}" class="${away.isFavorite ? 'w-12 h-12' : 'w-8 h-8'} object-contain mb-1">
                            <span class="text-[10px] uppercase font-bold text-gray-400 text-center leading-tight">${away.abbrev || away.name}</span>
                        </div>
                        <div class="text-center w-1/3 flex flex-col items-center">
                             <span class="text-xs text-gray-500 mb-1">AT</span>
                             ${scoreDisplay}
                        </div>
                        <div class="flex flex-col items-center w-1/3">
                            <img src="${home.logo}" class="${home.isFavorite ? 'w-12 h-12' : 'w-8 h-8'} object-contain mb-1">
                            <span class="text-[10px] uppercase font-bold text-gray-400 text-center leading-tight">${home.abbrev || home.name}</span>
                        </div>
                    </div>
                `;
                if(myTeam) {
                    content += `<div class="text-center text-[10px] text-gray-500 border-t border-gray-700 pt-1 mt-1">${myTeam.abbrev} Season Record: <span class="text-white font-bold">${getTeamRecord(myTeam.id)}</span></div>`;
                }
            }
            return `<div class="glass-panel p-4 rounded-xl border-l-4 ${getTypeColor(item.type)} hover:translate-x-1 transition-transform relative group"><div class="flex justify-between items-start"><div>${titleHtml}${meta}</div><div class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-2"><button class="text-gray-400 hover:text-white" onclick="openItemModal('${item.category}', '${item.id}', '${item.type === 'sports' ? 'sports' : ''}')">‚úé</button><button class="text-red-400 hover:text-red-300" onclick="deleteItem('${item.id}', '${item.type}')">üóëÔ∏è</button></div></div>${descriptionHtml}${content}</div>`;
        }

        function renderHealthCard(item) {
            const g = item.goals || { tdee: 2500, calorieGoal: 2000, protein: 150, fat: 80, netCarbs: 100 };
            let totalCal=0, totalPro=0, totalCarb=0, totalFat=0, totalFiber=0;
            (item.meals || []).forEach(m => { totalCal += Number(m.calories||0); totalPro += Number(m.protein||0); totalCarb += Number(m.carbs||0); totalFat += Number(m.fat||0); totalFiber += Number(m.fiber||0); });
            const netCarbs = totalCarb - totalFiber;
            const calRemaining = g.calorieGoal - totalCal;
            const tdeeDiff = totalCal - g.tdee;
            const pctCal = Math.min((totalCal / g.calorieGoal) * 100, 100);
            const pctPro = Math.min((totalPro / g.protein) * 100, 100);
            const pctFat = Math.min((totalFat / g.fat) * 100, 100);
            const pctCarb = Math.min((netCarbs / g.netCarbs) * 100, 100);
            const weeklyData = getWeeklyDeficit();
            return `<div class="glass-panel p-5 rounded-xl border-l-4 border-health relative group"><div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity flex gap-2"><button onclick="openNutritionModal()" class="text-gray-400 hover:text-white">‚úé</button><button onclick="deleteItem('${item.id}', 'health')" class="text-red-400 hover:text-red-300">üóëÔ∏è</button></div><div class="flex justify-between items-center mb-4"><div class="text-sm text-gray-400">Weight</div><span class="text-xl font-bold text-white">${item.weightLbs} lbs</span></div><div class="bg-gray-800/50 rounded-lg p-3 mb-4"><div class="flex justify-between text-sm mb-1"><span class="text-gray-400">Calories</span><span class="font-bold ${totalCal > g.calorieGoal ? 'text-red-400' : 'text-white'}">${totalCal.toLocaleString()} / ${g.calorieGoal.toLocaleString()}</span></div><div class="macro-bar-bg mb-2"><div class="macro-bar-fill bg-health" style="width: ${pctCal}%"></div></div><div class="flex justify-between text-xs"><span class="${calRemaining >= 0 ? 'text-green-400' : 'text-red-400'}">${calRemaining >= 0 ? 'Remaining: ' + calRemaining : 'Over: ' + Math.abs(calRemaining)}</span><span class="text-gray-500">${pctCal.toFixed(1)}% of Goal</span></div></div><div class="grid grid-cols-3 gap-3 mb-4"><div class="bg-gray-800/30 p-2 rounded"><div class="flex justify-between text-xs text-gray-400 mb-1"><span>Pro</span><span>${totalPro}/${g.protein}g</span></div><div class="macro-bar-bg"><div class="macro-bar-fill bg-blue-500" style="width: ${pctPro}%"></div></div><div class="text-[10px] text-right mt-1 text-blue-300">${pctPro.toFixed(0)}%</div></div><div class="bg-gray-800/30 p-2 rounded"><div class="flex justify-between text-xs text-gray-400 mb-1"><span>Fat</span><span>${totalFat}/${g.fat}g</span></div><div class="macro-bar-bg"><div class="macro-bar-fill bg-yellow-500" style="width: ${pctFat}%"></div></div><div class="text-[10px] text-right mt-1 text-yellow-300">${pctFat.toFixed(0)}%</div></div><div class="bg-gray-800/30 p-2 rounded"><div class="flex justify-between text-xs text-gray-400 mb-1"><span>Carb</span><span>${netCarbs}/${g.netCarbs}g</span></div><div class="macro-bar-bg"><div class="macro-bar-fill bg-green-500" style="width: ${pctCarb}%"></div></div><div class="text-[10px] text-right mt-1 text-green-300">${pctCarb.toFixed(0)}%</div></div></div><div class="border-t border-gray-700 pt-3 mb-4"><div class="flex justify-between items-center mb-1"><span class="text-xs text-gray-400">Daily Deficit (vs TDEE)</span><span class="text-sm font-bold ${tdeeDiff < 0 ? 'text-green-400' : 'text-red-400'}">${tdeeDiff > 0 ? '+' : ''}${tdeeDiff.toLocaleString()} Cal</span></div><div class="flex justify-between items-center"><span class="text-xs text-gray-400">Weekly Running Deficit</span><span class="text-sm font-bold ${weeklyData.deficit < 0 ? 'text-green-400' : 'text-gray-400'}">${weeklyData.deficit.toLocaleString()} Cal</span></div><div class="text-[10px] text-gray-500 text-right mt-1">Target: -4,200/wk (1.2lbs)</div></div><div class="space-y-1"><div class="text-xs font-bold text-gray-500 uppercase mb-1">Today's Meals</div>${(item.meals||[]).map(m => `<div class="flex justify-between items-center text-sm py-1 border-b border-gray-700/50 last:border-0"><div class="overflow-hidden"><span class="text-[10px] text-gray-500 uppercase bg-gray-800 px-1 rounded mr-1">${m.mealType||'meal'}</span><span class="font-medium text-gray-300 truncate">${m.name}</span></div><span class="text-gray-400 whitespace-nowrap ml-2">${m.calories} Cal</span></div>`).join('')}</div></div>`;
        }

        function renderStarInput(rating) {
            const container = document.getElementById('star-rating-container');
            container.innerHTML = '';
            for (let i = 1; i <= 10; i++) {
                const star = document.createElement('span'); star.className = `star-btn ${i <= rating ? 'active' : ''}`; star.innerText = '‚òÖ';
                star.onclick = () => { document.getElementById('item-rating').value = i; renderStarInput(i); };
                container.appendChild(star);
            }
        }

        // Updated Function Signature to accept allowedTypes
        function openItemModal(category, itemId = null, allowedTypes = '') {
            const ymd = toLocalYMD(appState.currentDate);
            
            // Clear & Populate Type Select
            const typeSelect = document.getElementById('item-type');
            typeSelect.innerHTML = '';
            const typeMap = {
                'task': 'Task',
                'meeting': 'Meeting',
                'habit': 'Habit',
                'media': 'Media (Movie/Show)',
                'health': 'Nutrition Log',
                'sports': 'Sports Game'
            };
            
            // Convert string to array for robust handling from HTML attributes
            const typesList = allowedTypes ? allowedTypes.split(',') : ['task','meeting','habit','media','sports'];
            
            typesList.forEach(t => {
                if(typeMap[t]) {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.innerText = typeMap[t];
                    typeSelect.appendChild(opt);
                }
            });

            // Reset Fields
            document.getElementById('item-id').value = ''; document.getElementById('item-title').value = ''; document.getElementById('item-desc').value = ''; document.getElementById('item-link').value = ''; document.getElementById('item-img').value = ''; document.getElementById('item-ticket').value = ''; document.getElementById('item-rating').value = '5'; renderStarInput(5); 
            document.getElementById('item-duration').value = '60'; 
            document.getElementById('item-actualDuration').value = '';
            document.getElementById('item-startTime').value = '';
            document.getElementById('item-streak').value = '0';
            document.getElementById('item-fill-month').checked = false;

            if (itemId) {
                document.getElementById('item-modal-title').innerText = "Edit Item";
                document.getElementById('item-id').value = itemId;
                const item = appState.data.items.find(i => i.id === itemId);
                if (item) {
                    // Ensure editing doesn't break if type isn't in filtered list (edge case)
                    if(!typesList.includes(item.type)) {
                        const opt = document.createElement('option'); opt.value = item.type; opt.innerText = typeMap[item.type]; typeSelect.appendChild(opt);
                    }
                    document.getElementById('item-category').value = item.category; 
                    typeSelect.value = item.type; 
                    document.getElementById('item-title').value = item.title; 
                    
                    // Map Correct Description Field
                    const descVal = (item.type === 'media' || item.type === 'habit') ? (item.notes || item.description || '') : (item.description || '');
                    document.getElementById('item-desc').value = descVal;
                    
                    document.getElementById('item-link').value = item.linkUrl || ''; 
                    document.getElementById('item-img').value = item.imgUrl || '';
                    
                    if(item.type === 'meeting') { 
                        document.getElementById('item-startTime').value = item.startTime || ''; 
                        document.getElementById('item-duration').value = item.durationMinutes ? formatDuration(item.durationMinutes) : '60m';
                        document.getElementById('item-actualDuration').value = item.timeSpentMinutes ? formatDuration(item.timeSpentMinutes) : ''; 
                    }
                    if(item.type === 'task') { document.getElementById('item-ticket').value = item.ticketNumber || ''; }
                    if(item.type === 'media') { const r = item.rating || 5; document.getElementById('item-rating').value = r; renderStarInput(r); }
                    if(item.type === 'habit') { document.getElementById('item-streak').value = item.streakCount || 0; }
                    if(item.type === 'sports') {
                        populateTeamSelects(); // Refresh list
                        document.getElementById('sports-league').value = item.league;
                        // Need to re-pop teams after league change
                        populateTeamSelects(); 
                        document.getElementById('sports-time').value = item.startTime || '';
                        document.getElementById('sports-score-my').value = (item.homeTeamId === item.homeTeamId /* logic check */) ? item.homeScore : item.awayScore;
                        // Actually complex to map back to UI "My" vs "Opp" without knowing who "My" was intended to be. 
                        // Simplified: Just map raw home/away
                        const isFavoriteHome = appState.data.teams.find(t=>t.id===item.homeTeamId)?.isFavorite;
                        document.getElementById('sports-myteam').value = isFavoriteHome ? item.homeTeamId : item.awayTeamId;
                        document.getElementById('sports-opponent').value = isFavoriteHome ? item.awayTeamId : item.homeTeamId;
                        document.getElementById('sports-is-home').value = isFavoriteHome ? "true" : "false";
                        document.getElementById('sports-score-my').value = isFavoriteHome ? item.homeScore : item.awayScore;
                        document.getElementById('sports-score-opp').value = isFavoriteHome ? item.awayScore : item.homeScore;
                        updateSportsLabel();
                    }
                }
            } else {
                document.getElementById('item-modal-title').innerText = "Add Item";
                document.getElementById('item-category').value = category || 'work';
            }
            
            updateModalFields();
            document.getElementById('item-modal').classList.remove('hidden');
        }
        function closeItemModal() { document.getElementById('item-modal').classList.add('hidden'); }
        function updateModalFields() {
            const type = document.getElementById('item-type').value;
            if (type === 'health') { closeItemModal(); openNutritionModal(); return; }
            
            document.getElementById('field-meeting').classList.add('hidden'); 
            document.getElementById('field-task').classList.add('hidden'); 
            document.getElementById('field-media').classList.add('hidden'); 
            document.getElementById('field-habit').classList.add('hidden');
            document.getElementById('field-sports').classList.add('hidden');
            
            // Title/Desc are hidden for sports to use specialized UI
            document.getElementById('field-title').style.display = type === 'sports' ? 'none' : 'block';
            
            if(type === 'meeting') document.getElementById('field-meeting').classList.remove('hidden');
            if(type === 'task') document.getElementById('field-task').classList.remove('hidden');
            if(type === 'media') { document.getElementById('field-media').classList.remove('hidden'); renderStarInput(parseInt(document.getElementById('item-rating').value) || 5); }
            if(type === 'habit') document.getElementById('field-habit').classList.remove('hidden');
            
            if(type === 'sports') {
                document.getElementById('field-sports').classList.remove('hidden');
                // Populate Leagues if empty
                const leagueSelect = document.getElementById('sports-league');
                if(leagueSelect.options.length === 0) {
                    (appState.data.leagues || []).forEach(l => {
                        const opt = document.createElement('option'); opt.value = l; opt.innerText = l; leagueSelect.appendChild(opt);
                    });
                    populateTeamSelects();
                }
            }
        }
        
        function populateTeamSelects() {
            const league = document.getElementById('sports-league').value;
            const teams = (appState.data.teams || []).filter(t => t.league === league);
            const mySelect = document.getElementById('sports-myteam');
            const oppSelect = document.getElementById('sports-opponent');
            
            // Save current selection if possible
            const oldMy = mySelect.value;
            
            mySelect.innerHTML = ''; oppSelect.innerHTML = '';
            
            teams.forEach(t => {
                const opt = document.createElement('option'); opt.value = t.id; opt.innerText = t.name; 
                mySelect.appendChild(opt.cloneNode(true));
                oppSelect.appendChild(opt.cloneNode(true));
            });
            
            // Attempt to select favorite
            const fav = teams.find(t => t.isFavorite);
            if(fav) mySelect.value = fav.id;
            else if(oldMy) mySelect.value = oldMy;
            
            updateSportsLabel();
        }
        
        function swapHomeAway() {
            const isHomeInput = document.getElementById('sports-is-home');
            isHomeInput.value = (isHomeInput.value === "true") ? "false" : "true";
            updateSportsLabel();
        }
        
        function updateSportsLabel() {
            const mySelect = document.getElementById('sports-myteam');
            const oppSelect = document.getElementById('sports-opponent');
            const isHome = document.getElementById('sports-is-home').value === "true";
            
            const myName = mySelect.options[mySelect.selectedIndex]?.text || "My Team";
            const oppName = oppSelect.options[oppSelect.selectedIndex]?.text || "Opponent";
            
            const label = isHome ? `${oppName} @ ${myName}` : `${myName} @ ${oppName}`;
            document.getElementById('sports-matchup-label').innerText = label;
        }

        function saveItem() {
            const category = document.getElementById('item-category').value; const type = document.getElementById('item-type').value; 
            const editId = document.getElementById('item-id').value;
            const dateYMD = toLocalYMD(appState.currentDate);
            
            let title = document.getElementById('item-title').value;
            
            // Special Title Generation for Sports
            if (type === 'sports') {
                const myTeamId = document.getElementById('sports-myteam').value;
                const oppTeamId = document.getElementById('sports-opponent').value;
                const isHome = document.getElementById('sports-is-home').value === "true";
                
                // Get team objects for title
                const homeId = isHome ? myTeamId : oppTeamId;
                const awayId = isHome ? oppTeamId : myTeamId;
                const homeTeam = appState.data.teams.find(t=>t.id === homeId);
                const awayTeam = appState.data.teams.find(t=>t.id === awayId);
                
                title = `${awayTeam?.abbrev || 'Away'} @ ${homeTeam?.abbrev || 'Home'}`;
            }
            
            if(!title && type !== 'sports') return alert("Title required");

            const newItemBase = {
                type: type,
                category: category,
                title: title,
                linkUrl: document.getElementById('item-link').value,
                imgUrl: document.getElementById('item-img').value
            };
            
            const rawDesc = document.getElementById('item-desc').value;
            if(type === 'media' || type === 'habit') { newItemBase.notes = rawDesc; newItemBase.description = rawDesc; } 
            else { newItemBase.description = rawDesc; }

            if(type === 'meeting') { 
                newItemBase.startTime = document.getElementById('item-startTime').value || "09:00"; 
                newItemBase.durationMinutes = parseDuration(document.getElementById('item-duration').value); 
                newItemBase.timeSpentMinutes = parseDuration(document.getElementById('item-actualDuration').value);
            }
            if(type === 'task') { newItemBase.ticketNumber = document.getElementById('item-ticket').value; newItemBase.status = 'pending'; }
            if(type === 'media') { newItemBase.rating = parseInt(document.getElementById('item-rating').value) || 5; }
            if(type === 'habit') { 
                const existing = appState.data.items.find(i => i.id === editId);
                const inputStreak = parseInt(document.getElementById('item-streak').value);
                newItemBase.streakCount = (editId || !isNaN(inputStreak)) ? (inputStreak || 1) : (existing ? existing.streakCount : 1);
                // Bulk Add handled elsewhere if needed, simplified here
            }
            
            if (type === 'sports') {
                const myTeamId = document.getElementById('sports-myteam').value;
                const oppTeamId = document.getElementById('sports-opponent').value;
                const isHome = document.getElementById('sports-is-home').value === "true";
                const myScore = parseInt(document.getElementById('sports-score-my').value);
                const oppScore = parseInt(document.getElementById('sports-score-opp').value);
                
                newItemBase.league = document.getElementById('sports-league').value;
                newItemBase.homeTeamId = isHome ? myTeamId : oppTeamId;
                newItemBase.awayTeamId = isHome ? oppTeamId : myTeamId;
                newItemBase.homeScore = isHome ? myScore : oppScore;
                newItemBase.awayScore = isHome ? oppScore : myScore;
                newItemBase.startTime = document.getElementById('sports-time').value;
                newItemBase.status = (!isNaN(myScore) && !isNaN(oppScore)) ? 'completed' : 'scheduled';
            }

            const finalItem = { ...newItemBase, id: editId || `${type}_${new Date().getTime()}`, date: dateYMD };

            if (editId) { 
                const idx = appState.data.items.findIndex(i => i.id === editId); 
                if (idx >= 0) appState.data.items[idx] = finalItem; 
            } else { 
                appState.data.items.push(finalItem); 
            }
            
            saveData(); closeItemModal(); updateUI();
        }

        // ... rest of functions (openNutritionModal, saveNutrition, etc.) remain identical ...
        function openNutritionModal() {
            const ymd = toLocalYMD(appState.currentDate);
            let item = appState.data.items.find(i => i.date === ymd && i.type === 'health');
            if (!item) item = { weightLbs: 0, goals: { calorieGoal: 2220 }, meals: [] };
            document.getElementById('edit-weight').value = item.weightLbs || ''; document.getElementById('edit-cal-goal').value = (item.goals ? item.goals.calorieGoal : 2220);
            const container = document.getElementById('meal-inputs-container'); container.innerHTML = '';
            if (item.meals && item.meals.length > 0) item.meals.forEach(m => addMealInput(m)); else addMealInput(); 
            document.getElementById('nutrition-modal').classList.remove('hidden');
        }
        function closeNutritionModal() { document.getElementById('nutrition-modal').classList.add('hidden'); }
        function addMealInput(data = {}) {
            const container = document.getElementById('meal-inputs-container'); const div = document.createElement('div'); div.className = "bg-gray-700/30 p-3 rounded-lg border border-gray-700 meal-row";
            div.innerHTML = `<div class="flex gap-2 mb-2"><select class="meal-type bg-gray-700 border border-gray-600 rounded text-xs px-2 py-1 text-gray-300 outline-none focus:border-health"><option value="breakfast" ${data.mealType === 'breakfast' ? 'selected' : ''}>Breakfast</option><option value="lunch" ${data.mealType === 'lunch' ? 'selected' : ''}>Lunch</option><option value="dinner" ${data.mealType === 'dinner' ? 'selected' : ''}>Dinner</option><option value="snack" ${data.mealType === 'snack' ? 'selected' : ''}>Snack</option></select><input type="text" placeholder="Food Item" value="${data.name || ''}" class="meal-name flex-1 bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm text-white outline-none focus:border-health"><button onclick="this.closest('.meal-row').remove()" class="text-red-400 hover:text-red-300 px-1">&times;</button></div><div class="grid grid-cols-5 gap-2"><div><label class="text-[10px] text-gray-500 block">Cal</label><input type="number" value="${data.calories || ''}" class="meal-cal w-full bg-gray-800 border border-gray-600 rounded px-1 py-1 text-xs outline-none focus:border-health"></div><div><label class="text-[10px] text-gray-500 block">Pro</label><input type="number" value="${data.protein || ''}" class="meal-pro w-full bg-gray-800 border border-gray-600 rounded px-1 py-1 text-xs outline-none focus:border-health"></div><div><label class="text-[10px] text-gray-500 block">Carb</label><input type="number" value="${data.carbs || ''}" class="meal-carb w-full bg-gray-800 border border-gray-600 rounded px-1 py-1 text-xs outline-none focus:border-health"></div><div><label class="text-[10px] text-gray-500 block">Fat</label><input type="number" value="${data.fat || ''}" class="meal-fat w-full bg-gray-800 border border-gray-600 rounded px-1 py-1 text-xs outline-none focus:border-health"></div><div><label class="text-[10px] text-gray-500 block">Fiber</label><input type="number" value="${data.fiber || ''}" class="meal-fiber w-full bg-gray-800 border border-gray-600 rounded px-1 py-1 text-xs outline-none focus:border-health"></div></div>`;
            container.appendChild(div);
        }
        function saveNutrition() {
            const ymd = toLocalYMD(appState.currentDate); const weight = parseFloat(document.getElementById('edit-weight').value) || 0; const calGoal = parseFloat(document.getElementById('edit-cal-goal').value) || 2220;
            const mealRows = document.querySelectorAll('.meal-row');
            const meals = Array.from(mealRows).map(row => ({ mealType: row.querySelector('.meal-type').value, name: row.querySelector('.meal-name').value, calories: parseFloat(row.querySelector('.meal-cal').value) || 0, protein: parseFloat(row.querySelector('.meal-pro').value) || 0, carbs: parseFloat(row.querySelector('.meal-carb').value) || 0, fat: parseFloat(row.querySelector('.meal-fat').value) || 0, fiber: parseFloat(row.querySelector('.meal-fiber').value) || 0 })).filter(m => m.name.trim() !== ""); 
            let itemIndex = appState.data.items.findIndex(i => i.date === ymd && i.type === 'health');
            const newItem = { id: itemIndex >= 0 ? appState.data.items[itemIndex].id : `health_${new Date().getTime()}`, date: ymd, type: 'health', category: 'personal', weightLbs: weight, goals: { tdee: 2816, calorieGoal: calGoal, protein: 167, fat: 150, netCarbs: 100 }, meals: meals };
            if (itemIndex >= 0) appState.data.items[itemIndex] = newItem; else appState.data.items.push(newItem);
            saveData(); closeNutritionModal(); updateUI();
        }
        
        function getWeeklyDeficit() {
            if (!appState || !appState.currentDate) return { deficit: 0, days: 0 };
            const start = getStartOfWeek(appState.currentDate); 
            const end = new Date(appState.currentDate); 
            let totalDeficit = 0; 
            let daysCounted = 0;
            const loopDate = new Date(start);
            while(loopDate <= end) {
                const ymd = toLocalYMD(loopDate); 
                const item = appState.data.items.find(i => i.date === ymd && i.type === 'health');
                if (item) { 
                    let dailyCal = 0; 
                    (item.meals || []).forEach(m => dailyCal += (m.calories || 0)); 
                    const tdee = (item.goals && item.goals.tdee) ? item.goals.tdee : 2816; 
                    totalDeficit += (dailyCal - tdee); 
                    daysCounted++; 
                }
                loopDate.setDate(loopDate.getDate() + 1);
            }
            return { deficit: totalDeficit, days: daysCounted };
        }
    </script>
</body>
</html>
