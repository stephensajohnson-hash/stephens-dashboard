<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stephens' Dashboard V0.9.9</title>
    <link rel="icon" href="/images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }
        html { font-family: 'Inter', sans-serif; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.75); backdrop-filter: blur(4px); }
        .low-temp-offset { position: relative; top: 6px; }
        .high-temp-offset { position: relative; bottom: 6px; }
        
        /* Carousel Transitions */
        #carousel-content-wrapper { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; flex-grow: 1; max-width: calc(100% - 80px); margin: 0 40px; }
        .carousel-control-button { position: absolute; top: 50%; transform: translateY(-50%); z-index: 10; opacity: 0.7; background-color: rgba(31, 41, 55, 0.5); border: 1px solid rgba(75, 85, 99, 0.5); }
        #carousel-content-wrapper > div { width: 100%; height: 100%; }
        
        /* Link Card Hover Actions */
        .link-card:hover .link-actions { opacity: 1; pointer-events: auto; }
        .link-actions { opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    </style>
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'], }, } } }
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 sm:p-8">

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 right-0 bg-gray-800 border-b border-gray-700 shadow-xl z-30 p-2 flex items-center justify-between">
        <div class="flex items-center">
            <button id="menu-button" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 focus:outline-none mr-4" onclick="toggleMenu()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
            <div id="datetime" class="text-sm sm:text-base font-medium"></div>
        </div>
        <div id="weather-display" class="text-sm flex items-center bg-gray-700 px-3 py-1 rounded-full border border-gray-600">
            <span class="flex items-center" id="weather-content">
                <span id="weather-current-temp" class="text-lg font-bold mr-3">--Â°</span>
                <span id="weather-low" class="low-temp-offset mr-1 text-xs">--Â°</span>
                <span class="mr-1 text-xl" id="weather-icon">...</span>
                <span id="weather-high" class="high-temp-offset text-xs">--Â°</span>
            </span>
        </div>
    </nav>

    <!-- Menu Dropdown -->
    <div id="menu-modal" class="fixed top-[4rem] left-4 z-40 opacity-0 pointer-events-none transform -translate-y-4 transition-all duration-300 ease-out max-w-xs z-40">
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 shadow-2xl w-64">
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h3 class="text-xl font-semibold text-white">Menu</h3>
                <button id="close-menu-button" class="text-gray-400 hover:text-white p-1" onclick="hideMenu()">X</button>
            </div>
            
            <a href="bullet_calendar.html" class="block w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-2 transition duration-150 border-l-4 border-purple-500 bg-gray-700/30">
                Bullet Calendar
            </a>

            <a href="recipes.html" class="block w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-2 transition duration-150 border-l-4 border-blue-500 bg-gray-700/30">
                Recipes
            </a>

            <a href="budget.html" class="block w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-2 transition duration-150 border-l-4 border-blue-500 bg-gray-700/30">
                Budget
            </a>

            <div class="border-b border-gray-700 my-2"></div>

            <button id="add-countdown-button" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-2 transition duration-150" onclick="openCountdownModal()">Add Countdown</button>
            <button id="add-group-button" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-2 transition duration-150" onclick="openGroupModal()">Add Link Group</button>
            <button id="add-link-button" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-4 transition duration-150" onclick="openLinkModal()">Add Link</button>
            <button id="add-stock-button" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-4 transition duration-150" onclick="openStockModal()">Add Stock</button>
            
            <button id="download-data-button" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-4 transition duration-150" onclick="downloadDataFile()">Download Data File</button>
            <button id="clear-draft-button" class="w-full text-left py-2 px-3 rounded-lg text-red-400 hover:bg-red-900/20 mb-4 transition duration-150 border border-red-700/50" onclick="clearDraftData()">Clear Draft Data (Local)</button>
            <p id="version-display" class="text-sm font-mono text-gray-300">Stephens' Dashboard V0.9.9</p>
        </div>
    </div>

    <!-- Modals -->
    <!-- Countdown Modal -->
    <div id="add-countdown-modal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 w-full max-w-lg shadow-2xl">
            <h2 class="text-2xl font-bold mb-4" id="countdown-modal-title">Add Countdown</h2>
            <form id="countdown-form" class="space-y-4" onsubmit="saveCountdown(event)">
                <input type="hidden" id="countdown-id">
                <input type="text" id="countdown-name" placeholder="Event Name" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white" required>
                <input type="date" id="countdown-targetDate" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white" required>
                <input type="url" id="countdown-linkUrl" placeholder="Link URL (Optional)" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white">
                
                <!-- Image Upload / URL Combo -->
                <div class="flex gap-2 items-center">
                    <input type="text" id="countdown-img" placeholder="Image URL or Upload File ->" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white">
                    <label class="cursor-pointer bg-gray-600 hover:bg-gray-500 text-white rounded p-2 flex items-center justify-center border border-gray-500" title="Upload Local Image">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <input type="file" accept="image/*" class="hidden" onchange="processFileUpload(this, 'countdown-img')">
                    </label>
                </div>

                <div class="flex justify-end gap-2">
                    <button type="button" class="text-gray-400 hover:text-white px-4 py-2" onclick="document.getElementById('add-countdown-modal').classList.add('hidden')">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded text-white font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Group Modal -->
    <div id="add-group-modal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 w-full max-w-lg shadow-2xl">
            <h2 class="text-2xl font-bold mb-4" id="group-modal-title">Add Link Group</h2>
            <form id="group-form" class="space-y-4" onsubmit="saveGroup(event)">
                <input type="hidden" id="group-id">
                <input type="text" id="group-name" placeholder="Group Name" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white" required>
                <div>
                    <label class="text-sm text-gray-400 mb-1 block">Color Theme</label>
                    <select id="group-color" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white">
                        <option value="blue">Blue</option>
                        <option value="green">Green</option>
                        <option value="red">Red</option>
                        <option value="purple">Purple</option>
                        <option value="yellow">Yellow</option>
                        <option value="gray">Gray</option>
                    </select>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" class="text-gray-400 hover:text-white px-4 py-2" onclick="document.getElementById('add-group-modal').classList.add('hidden')">Cancel</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded text-white font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Link Modal -->
    <div id="add-link-modal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 w-full max-w-lg shadow-2xl">
            <h2 class="text-2xl font-bold mb-4" id="link-modal-title">Add Link</h2>
            <form id="link-form" class="space-y-4" onsubmit="saveLink(event)">
                <input type="hidden" id="link-id">
                <input type="text" id="link-name" placeholder="Link Name" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white" required>
                <input type="url" id="link-url" placeholder="URL" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white" required>
                
                <!-- Image Upload / URL Combo -->
                <div class="flex gap-2 items-center">
                    <input type="text" id="link-img" placeholder="Image URL or Upload File ->" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white">
                    <label class="cursor-pointer bg-gray-600 hover:bg-gray-500 text-white rounded p-2 flex items-center justify-center border border-gray-500" title="Upload Local Image">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <input type="file" accept="image/*" class="hidden" onchange="processFileUpload(this, 'link-img')">
                    </label>
                </div>

                <div>
                    <label class="text-sm text-gray-400 mb-1 block">Group</label>
                    <select id="link-group-select" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white"></select>
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" class="text-gray-400 hover:text-white px-4 py-2" onclick="document.getElementById('add-link-modal').classList.add('hidden')">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded text-white font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Stock Modal -->
    <div id="add-stock-modal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 w-full max-w-lg shadow-2xl">
            <h2 class="text-2xl font-bold mb-4" id="stock-modal-title">Add Stock</h2>
            <form id="stock-form" class="space-y-4" onsubmit="saveStock(event)">
                <input type="text" id="stock-symbol" placeholder="Symbol (e.g. TSLA)" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white uppercase" required>
                <div class="flex justify-end gap-2">
                    <button type="button" class="text-gray-400 hover:text-white px-4 py-2" onclick="document.getElementById('add-stock-modal').classList.add('hidden')">Cancel</button>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded text-white font-bold">Track</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <main id="dashboard-content" class="px-4 sm:px-8 pt-16 pb-8">
        <!-- Carousel -->
        <div id="countdown-widgets" class="mb-10 w-full h-40 relative flex items-center justify-center">
            <button id="prev-button" onclick="navigateCarousel(-1)" class="carousel-control-button left-0 p-3 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
            <div id="carousel-content-wrapper" class="w-full h-full flex items-center justify-center max-w-5xl overflow-hidden relative rounded-xl border border-gray-700/50 bg-gray-800/50 backdrop-blur-sm">
                <p id="loading-indicator" class="text-gray-400 animate-pulse">Loading Dashboard...</p>
            </div>
            <button id="next-button" onclick="navigateCarousel(1)" class="carousel-control-button right-0 p-3 text-gray-400 hover:text-white hover:bg-gray-700 rounded-full transition"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
        </div>

        <!-- Link Groups -->
        <div id="link-groups-container" class="flex flex-wrap justify-center gap-6 items-start"></div>
    </main>
    
    <script>
        // --- VARIABLES ---
        const menuModal = document.getElementById('menu-modal');
        const carouselContent = document.getElementById('carousel-content-wrapper');
        
        // State
        const state = { 
            localStorageKeys: { 
                countdowns:'sd_custom_countdowns', 
                groups:'sd_custom_groups', 
                links:'sd_custom_links', 
                stocks:'sd_custom_stocks', 
                hiddenItems:'sd_hidden_items' 
            } 
        };

        // Data Containers
        let STATIC_LINK_GROUPS=[], STATIC_COUNTDOWNS=[], STATIC_STOCKS=[];
        let forecastItems=[], stockQuotes=[], allCountdowns=[];
        let currentCardIndex=0, animationFrameId=null;

        // Embedded Defaults (Fallback with IDs)
        const EMBEDDED_DATA = {
            linkGroups: [
                { id: "g1", name: "PBFCM", color: "blue", links: [{id: "l1", name: "Halo", url: "https://pbfcm.haloitsm.com", img: "https://media.licdn.com/dms/image/v2/D4D0BAQHua1QvehlNJg/company-logo_200_200/company-logo_200_200/0/1719256595420/haloitsm_logo?e=1764806400&v=beta&t=Et1KWvi52D9xGj68eE4JmapbZ0fg84N4t9c-aheyINs"}, {id: "l2", name: "2025 Bullet Journal", url: "https://docs.google.com/document/d/1Y2TbxiLuN7K55mL2o_XWDWiTD_bQ8HJLfXjXwEc5m44/edit?tab=t.0#heading=h.clgrn99mtopn", img: "https://cmsv2-assets.apptegy.net/uploads/11435/file/1077963/28e381d9-b33c-4d9c-b92e-164b4ea08c07.png"}, {id: "l3", name: "Dayforce", url: "https://us251.dayforcehcm.com/MyDayforce/u/Iw_6iFiF-0SPEmVMNfEh7A/Common/#SHViPyZpc0ZpcnN0RmVhdHVyZT10cnVl", img: "https://play-lh.googleusercontent.com/GzXqzEjylw9Y2FQPvsw34DcYirDrItkNGYInKrkLg-mFP-cgLYmwF223kA67KlD2miU=s256-rw"}, {id: "l4", name: "3CX", url: "https://pbfcm.businessphone.com/#/chat/9059", img: "https://cdn-1.carierista.com/companies/150/2d05df55a3399d793cfbd01657052b4d.png"}, {id: "l5", name: "Udemy", url: "https://pbfcm.udemy.com/organization/home/", img: "https://images.seeklogo.com/logo-png/40/1/udemy-wordmark-logo-png_seeklogo-409220.png"}] },
                { id: "g2", name: "Fun", color: "yellow", links: [{id: "l6", name: "TikTok", url: "https://www.tiktok.com/@jaspynj", img: "https://images.seeklogo.com/logo-png/37/1/tiktok-app-icon-logo-png_seeklogo-373800.png"}, {id: "l7", name: "Facebook", url: "https://www.facebook.com/", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/cd/Facebook_logo_%28square%29.png/960px-Facebook_logo_%28square%29.png"}, {id: "l8", name: "Duolingo", url: "https://www.duolingo.com", img: "https://images.seeklogo.com/logo-png/45/2/duolingo-logo-png_seeklogo-458347.png"}, {id: "l9", name: "Instapaper", url: "http://instapaper.com", img: "https://play-lh.googleusercontent.com/uQElx_kgheNkInfRZl6_iPZ34HLOpt1KMOiVWmcN_PZFRQ66Ug3vDaAS0eymjsok7g"}, {id: "l10", name: "FFL", url: "https://ultimateffl.xyz", img: "https://www.thebiline.com/wp-content/uploads/2023/11/fantasyFootball.png"}, {id: "l11", name: "Royal Caribbean", url: "https://www.royalcaribbean.com", img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSwdd2L_gTZtJM7N_K5OpKk5SlqKflxBddeQQ&s"}] },
                { id: "g3", name: "Google Apps", color: "green", links: [{id: "l12", name: "Gmail", url: "https://www.gmail.com", img: "https://icons.iconarchive.com/icons/marcus-roberto/google-play/256/Gmail-icon.png"}, {id: "l13", name: "Google News", url: "https://news.google.com/foryou?hl=en-US&gl=US&ceid=US%3Aen", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/da/Google_News_icon.svg/120px-Google_News_icon.svg.png"}, {id: "l14", name: "Drive", url: "https://drive.google.com", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Google_Drive_icon_%282020%29.svg/120px-Google_Drive_icon_%282020%29.svg.png"}, {id: "l15", name: "Keep", url: "http://keep.google.com", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/b/bd/Google_Keep_icon_%282015-2020%29.svg/512px-Google_Keep_icon_%282015-2020%29.svg.png?20210606170001"}, {id: "l16", name: "Calendar", url: "https://www.google.com/calendar/", img: "https://ssl.gstatic.com/calendar/images/dynamiclogo_2020q4/calendar_13_2x.png"}, {id: "l17", name: "Contacts", url: "https://contacts.google.com/#contacts", img: "https://cdn.jsdelivr.net/gh/homarr-labs/dashboard-icons/svg/google-contacts.svg"}, {id: "l18", name: "YouTube", url: "https://www.youtube.com", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/YouTube_full-color_icon_%282017%29.svg/512px-YouTube_full-color_icon_%282017%29.svg.png?20240107144800"}, {id: "l19", name: "YouTube Music", url: "https://music.youtube.com", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6a/Youtube_Music_icon.svg/512px-Youtube_Music_icon.svg.png"}, {id: "l20", name: "YouTube TV", url: "https://tv.youtube.com", img: "https://images.seeklogo.com/logo-png/61/2/youtube-tv-logo-png_seeklogo-612184.png"}, {id: "l21", name: "Photos", url: "https://photos.google.com", img: "https://images.seeklogo.com/logo-png/26/1/google-photos-logo-png_seeklogo-269651.png"}, {id: "l22", name: "Messages", url: "https://messages.android.com", img: "https://play-lh.googleusercontent.com/9AZOTXU_CpreTFAXUPAmJNkm8VGCb1C90fjJ9pHGcVmpGMDSTq3cUbaQJdBT9Tdp9A=w240-h480-rw"}] },
                { id: "g4", name: "Movies & TV", color: "purple", links: [{id: "l23", name: "IMDb", url: "https://www.imdb.com/", img: "https://jeremyirons.net/wp-content/uploads/2009/01/imdb-logo-23962421_std.jpg"}, {id: "l24", name: "TV Time", url: "https://www.tvtime.com/en", img: "https://upload.wikimedia.org/wikipedia/commons/3/33/TVShow_Time_logo.png?20160620170449"}, {id: "l25", name: "Movies Portal", url: "https://movies.do", img: "https://placehold.co/60x60/1E40AF/FFFFFF?text=MP"}, {id: "l26", name: "Bright Star Cinemas", url: "https://www.brightstarcinemas.com/", img: "https://placehold.co/60x60/8B5CF6/FFFFFF?text=BSC"}] },
                { id: "g5", name: "Shopping", color: "red", links: [{id: "l27", name: "Amazon", url: "https://amazon.com", img: "https://images.seeklogo.com/logo-png/40/2/amazon-icon-logo-png_seeklogo-405254.png"}, {id: "l28", name: "Walmart", url: "http://www.walmart.com/", img: "https://www.designmantic.com/blog/wp-content/uploads/2025/02/Walmart-Logo-Icon.png"}, {id: "l29", name: "Black Friday", url: "http://blackfriday.com/", img: "https://images.seeklogo.com/logo-png/39/1/black-friday-logo-png_seeklogo-391204.png"}] },
                { id: "g6", name: "Financial", color: "green", links: [{id: "l30", name: "Alliance Bank", url: "https://alliancebank.com", img: "https://www.ssnewstelegram.com/sites/ssnewstelegram.com/files/styles/article_420/public/2020-03/xVBU_UXM.png?itok=XpQwRzsj"}, {id: "l31", name: "2025 Budget", url: "https://docs.google.com/spreadsheets/d/1o3Ab6q4nMFVZIzxM-6lDXCd6jFt-nhHtT5b1yAKgUkw", img: "https://cmsv2-assets.apptegy.net/uploads/11435/file/1077963/28e381d9-b33c-4d9c-b92e-164b4ea08c07.png"}, {id: "l32", name: "Big Money", url: "https://docs.google.com/spreadsheets/d/17aFT-1c1eZgnvKkHnw8oS2SQzbTh3JnacRS3ChaW9dM/edit?gid=1898418506#gid=1898418506", img: "https://cmsv2-assets.apptegy.net/uploads/11435/file/1077963/28e381d9-b33c-4d9c-b92e-164b4ea08c07.png"}, {id: "l33", name: "Mega Millions", url: "https://www.megamillions.com", img: "https://scontent-dfw5-1.xx.fbcdn.net/v/t39.30808-1/300760619_575966844316568_8359561060352066869_n.png?stp=dst-png_s200x200&_nc_cat=111&ccb=1-7&_nc_sid=2d3e12&_nc_ohc=WBYVKDTj94sQ7kNvwEs4nvR&_nc_oc=AdnmO7Gyl6SerauVZ5yRbG_eNyM2iBM6eKmTAgYtEw2nNpcYsGZXDZs0y18djU8jMUs&_nc_zt=24&_nc_ht=scontent-dfw5-1.xx&_nc_gid=BgDoOuidjtlK_5YJgnN6Cg&oh=00_AfgrMHw4q6LdO16nh7RgdD67C9iqbsqdAbHVXZk76VAmlw&oe=691C4846"}, {id: "l34", name: "Power Ball", url: "https://www.powerball.com/games/home", img: "https://simublast.com/assets/images/lottery/us-powerball.png"}, {id: "l35", name: "Book Sales", url: "https://kdp.amazon.com/en_US/", img: "https://wallpapers.com/images/high/amazon-app-icon-0vxsqxaqsv2hidrm.png"}, {id: "l36", name: "Realtor", url: "http://www.realtor.com", img: "https://hooquest.com/wp-content/uploads/2018/09/realtor-com-logo-300.png"}] },
                { id: "g7", name: "Benefits", color: "teal", links: [{id: "l37", name: "BCBS", url: "https://mybam.bcbstx.com", img: "https://play-lh.googleusercontent.com/EQb_e3MXfOxRvT2U_orh3iV-9z_GvgJFUyn0qfYPlcNDHXCKnW04tMqPLbp4EfjCP8w=w240-h480-rw"}, {id: "l38", name: "MyChart", url: "https://mychart.christushealth.org/mychart/Authentication/Login?postloginurl=Clinical%2fTestResults", img: "https://news.med.virginia.edu/files/2023/12/MyChart-1x1-1-200x200.jpg"}, {id: "l39", name: "BCBS Vision", url: "https://member.eyemedvisioncare.com/bcbstx/en-us/", img: "https://www.bcbsil.com/content/bcbs-v2/public-sites/bcbsil/en/home/welcome/shop-plans/vision-insurance/_jcr_content/root/main-par/section_252757724_co/section-par/horizontal_value_pro/value-prop-one/image.coreimg.svg/1743113970660/circle-eye-glasses-icon.svg"}, {id: "l40", name: "HSA Bank", url: "https://account.hsabank.com/#/", img: "https://media.licdn.com/dms/image/v2/D4E22AQG0tY8-IPbPAQ/feedshare-shrink_800/B4EZTXDi.1GYAg-/0/1738774819262?e=1764806400&v=beta&t=S0Rvm5Ve8gQ7zjOjiLHHnd9zMVS3YSbmC4qeWM6zJfg"}, {id: "l41", name: "Aflac", url: "https://myaflac.aflac.com/home", img: "https://cdn.brandfetch.io/idfLaxzY-K/w/400/h/400/theme/dark/icon.png?c=1bxid64Mup7aczewSAYMX&t=1667924267088"}, {id: "l42", name: "Fidelity", url: "https://login.fidelity.com/ftgw/Fidelity/RtlCust/Login/Init?AuthRedUrl=https://oltx.fidelity.com/ftgw/fbc/ofpositions/brokerageAccountPositions", img: "https://cdn.brandfetch.io/idzIUUVEBm/w/400/h/400/theme/dark/icon.jpeg?c=1bxid64Mup7aczewSAYMX&t=1752030331882"}] },
                { id: "g8", name: "Coding", color: "blue", links: [{id: "l43", name: "Vercel", url: "https://vercel.com/stephensajohnson-hashs-projects/stephens-dashboard", img: "https://pnghdpro.com/wp-content/themes/pnghdpro/download/social-media-and-brands/vercel-logo-icon.png"}, {id: "l44", name: "GitHub", url: "https://github.com/stephensajohnson-hash/stephens-dashboard/tree/main/dashboard", img: "https://cdn.iconscout.com/icon/free/png-512/free-github-logo-icon-svg-download-png-8630395.png?f=webp&w=256"}] }
            ],
            countdowns: [
                { id: "c1", name: "Cruise!", targetDate: "2026-02-01T00:00:00", linkUrl: "https://www.royalcaribbean.com/", img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSwdd2L_gTZtJM7N_K5OpKk5SlqKflxBddeQQ&s" },
                { id: "c2", name: "Thanksgiving", targetDate: "2025-11-27T00:00:00", linkUrl: "#", img: "https://1r77nq.media.zestyio.com/assisted-living-thanksgiving.jpg" },
                { id: "c3", name: "Stephens Retires", targetDate: "2033-03-18T00:00:00", linkUrl: "#", img: "https://i0.wp.com/goodstuffconnections.com/wp-content/uploads/2020/04/retirement.jpg?w=1000&ssl=1" }
            ],
            stocks: [{symbol: "TSLA"}, {symbol: "SCHG"}, {symbol: "SCHD"}]
        };

        // --- HELPERS ---
        function getCustomData(key) { try { return JSON.parse(localStorage.getItem(key)) || []; } catch { return []; } }
        function saveCustomData(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
        function getTempColor(t) { t=parseInt(t); if(t>=80)return'text-red-500'; if(t>70)return'text-green-400'; if(t>=60)return'text-green-400/80'; if(t<50)return'text-sky-300'; return'text-white'; }
        function getStockColor(c) { return c>0 ? 'text-green-400' : (c<0 ? 'text-red-400' : 'text-gray-400'); }
        function getForecastEmoji(c) { if(c.includes('01'))return'â˜€ï¸'; if(c.includes('02'))return'ðŸŒ¤ï¸'; if(c.includes('03'))return'ðŸŒ¥ï¸'; if(c.includes('09')||c.includes('10'))return'ðŸŒ§ï¸'; if(c.includes('13'))return'â„ï¸'; return'â˜ï¸'; }
        
        // --- FILE UPLOAD HELPER ---
        function processFileUpload(input, targetId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Puts the Base64 string directly into the text input
                    // The existing save logic will pick this up as the "img" URL
                    document.getElementById(targetId).value = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- DATA LOGIC ---
        function getMergedData() {
            const hiddenIds = getCustomData(state.localStorageKeys.hiddenItems);
            const customGroups = getCustomData(state.localStorageKeys.groups);
            const customLinks = getCustomData(state.localStorageKeys.links);
            const customCountdowns = getCustomData(state.localStorageKeys.countdowns);

            // Merge Groups
            const groupMap = new Map();
            STATIC_LINK_GROUPS.forEach(g => groupMap.set(g.id, {...g, isStatic: true}));
            customGroups.forEach(g => groupMap.set(g.id, {...g, isStatic: false})); 
            const groups = Array.from(groupMap.values()).filter(g => !hiddenIds.includes(g.id));

            // Attach Links
            groups.forEach(g => {
                g.links = g.links || []; 
                g.links = g.links.filter(l => !hiddenIds.includes(l.id));
            });

            // Add Custom Links
            customLinks.forEach(l => {
                const g = groups.find(grp => grp.id === l.groupId);
                if(g) {
                    const idx = g.links.findIndex(existing => existing.id === l.id);
                    if(idx >= 0) g.links[idx] = l; 
                    else g.links.push(l);
                }
            });
            
            // Merge Countdowns
            const cdMap = new Map();
            STATIC_COUNTDOWNS.forEach(c => cdMap.set(c.id, {...c, isStatic: true}));
            customCountdowns.forEach(c => cdMap.set(c.id, {...c, isStatic: false}));
            const countdowns = Array.from(cdMap.values()).filter(c => !hiddenIds.includes(c.id));

            return { groups, countdowns };
        }

        // --- CAROUSEL ---
        function navigateCarousel(dir) {
            if (allCountdowns.length === 0) return;
            let idx = currentCardIndex + dir;
            if (idx >= allCountdowns.length) idx = 0; else if (idx < 0) idx = allCountdowns.length - 1;
            showCard(idx);
        }
        
        function showCard(idx) {
            if (allCountdowns.length === 0) return;
            idx = (idx + allCountdowns.length) % allCountdowns.length;
            const item = allCountdowns[idx];
            let el;
            if (item.type === 'forecast') el = createForecastPanel();
            else if (item.type === 'stocks') el = createStockPanel(item.data);
            else el = createCountdownItem(item, idx);
            
            carouselContent.style.opacity = '0';
            setTimeout(() => {
                carouselContent.innerHTML = ''; carouselContent.appendChild(el);
                currentCardIndex = idx; carouselContent.style.opacity = '1';
            }, 200);
        }

        function createForecastPanel() {
            const div = document.createElement('div'); div.className = 'w-full h-full p-1';
            const panel = document.createElement('div'); panel.className = 'flex items-stretch justify-between w-full h-full px-4';
            forecastItems.forEach(f => {
                const card = document.createElement('div'); card.className = 'flex flex-col items-center justify-center h-full flex-1 border-r border-gray-700/50 last:border-0';
                card.innerHTML = `<div class="text-sm font-bold uppercase tracking-wider text-gray-400 mb-2">${f.date.toLocaleDateString('en-US',{weekday:'short'})}</div><div class="text-5xl mb-3">${getForecastEmoji(f.icon)}</div><div class="text-lg font-bold"><span class="${getTempColor(f.temp_max)}">${f.temp_max}Â°</span> <span class="text-gray-600">/</span> <span class="${getTempColor(f.temp_min)}">${f.temp_min}Â°</span></div>`;
                panel.appendChild(card);
            });
            div.appendChild(panel); return div;
        }

        function createStockPanel(data) {
            const div = document.createElement('div'); div.className = 'w-full h-full p-1';
            const panel = document.createElement('div'); panel.className = 'flex items-center justify-around w-full h-full px-4 gap-4';
            data.forEach(s => {
                const col = getStockColor(s.change);
                const item = document.createElement('div'); item.className = 'flex flex-col items-center';
                item.innerHTML = `<div class="font-bold text-gray-200 text-sm">${s.symbol}</div><div class="text-lg font-mono font-bold ${col}">${s.price.toFixed(2)}</div><div class="text-[10px] ${col}">${s.change>0?'+':''}${s.change.toFixed(2)} (${s.percentChange.toFixed(2)}%)</div>`;
                panel.appendChild(item);
            });
            div.appendChild(panel); return div;
        }

        // FIXED: Date parsing logic for accurate countdowns (Local Midnight)
        function parseLocalYMD(dateString) {
             const parts = dateString.split(/[-T:]/);
             const y = parseInt(parts[0]);
             const m = parseInt(parts[1]) - 1; 
             const d = parseInt(parts[2]);
             return new Date(y, m, d); 
        }

        function createCountdownItem(c, idx) {
            const div = document.createElement('div'); div.className = 'w-full h-full flex items-center relative group'; 
            const controls = `<div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity bg-gray-900/80 rounded-lg p-1 backdrop-blur-sm"><button onclick="openCountdownModal('${c.id}')" class="text-blue-400 hover:text-white p-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button><button onclick="deleteItem('${c.id}', 'countdowns')" class="text-red-400 hover:text-white p-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>`;
            
            const displayDate = parseLocalYMD(c.targetDate).toLocaleDateString();
            
            div.innerHTML = `
                <a href="${c.linkUrl||'#'}" target="_blank" class="flex items-center justify-center w-full h-full px-8 gap-8 hover:bg-white/5 transition duration-200">
                    ${c.img ? `<img src="${c.img}" class="w-16 h-16 rounded-xl object-cover shadow-lg border border-gray-600">` : ''}
                    <div class="flex flex-col justify-center">
                        <div class="text-3xl font-black text-white tracking-tight">${c.name}</div>
                        <div class="text-sm text-gray-400 uppercase tracking-widest font-semibold mt-1">${displayDate}</div>
                    </div>
                    <div class="text-right pl-8">
                         <div class="text-5xl font-mono text-blue-400 font-bold countdown-timer-main" data-target="${c.targetDate}">--</div>
                         <div class="text-sm font-mono text-gray-400 mt-1 countdown-timer-total" data-target="${c.targetDate}"></div>
                    </div>
                </a>${controls}`;
            return div;
        }

        // --- RENDER MAIN UI ---
        function renderDashboard() {
            const { groups, countdowns } = getMergedData();
            const container = document.getElementById('link-groups-container');
            container.innerHTML = '';
            
            groups.forEach(g => {
                const colorClasses = {
                    blue: 'bg-blue-900/20 border-blue-800/50 text-blue-200',
                    green: 'bg-green-900/20 border-green-800/50 text-green-200',
                    red: 'bg-red-900/20 border-red-800/50 text-red-200',
                    purple: 'bg-purple-900/20 border-purple-800/50 text-purple-200',
                    yellow: 'bg-yellow-900/20 border-yellow-800/50 text-yellow-200',
                    gray: 'bg-gray-800 border-gray-700 text-gray-300',
                    teal: 'bg-teal-900/20 border-teal-800/50 text-teal-200',
                    amber: 'bg-amber-900/20 border-amber-800/50 text-amber-200',
                    pink: 'bg-pink-900/20 border-pink-800/50 text-pink-200',
                    emerald: 'bg-emerald-900/20 border-emerald-800/50 text-emerald-200'
                };
                const theme = colorClasses[g.color] || colorClasses['gray'];
                const groupEl = document.createElement('div');
                groupEl.className = `flex-1 min-w-[300px] max-w-[400px] rounded-2xl border p-5 shadow-xl backdrop-blur-sm ${theme} relative group-card`;
                
                groupEl.innerHTML = `
                    <div class="flex justify-between items-center mb-4 group">
                        <h3 class="text-lg font-bold tracking-wide">${g.name}</h3>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="openGroupModal('${g.id}')" class="p-1 hover:text-white hover:bg-white/10 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                            <button onclick="deleteItem('${g.id}', 'groups')" class="p-1 hover:text-red-400 hover:bg-white/10 rounded"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-4 link-grid"></div>
                `;
                
                const linkGrid = groupEl.querySelector('.link-grid');
                (g.links || []).forEach(l => {
                    const a = document.createElement('div');
                    a.className = 'relative link-card group';
                    a.innerHTML = `
                        <a href="${l.url}" target="_blank" class="flex flex-col items-center text-center hover:scale-105 transition duration-200">
                            <div class="w-24 h-24 bg-gray-900/50 rounded-xl mb-2 p-3 flex items-center justify-center shadow-inner border border-white/5">
                                <img src="${l.img}" class="w-full h-full object-contain rounded-md" onerror="this.style.display='none';this.nextElementSibling.style.display='block'">
                                <span class="hidden text-3xl font-bold text-gray-500">${l.name.charAt(0)}</span>
                            </div>
                            <span class="text-sm font-medium truncate w-full opacity-80 group-hover:opacity-100">${l.name}</span>
                        </a>
                        <div class="link-actions absolute -top-2 -right-2 flex gap-1 bg-gray-900 rounded-full shadow-lg border border-gray-600 p-0.5 scale-75">
                            <button onclick="openLinkModal('${l.id}', '${g.id}')" class="p-1 text-blue-400 hover:text-white"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                            <button onclick="deleteItem('${l.id}', 'links')" class="p-1 text-red-400 hover:text-white"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                        </div>
                    `;
                    linkGrid.appendChild(a);
                });
                container.appendChild(groupEl);
            });

            // 2. Init Carousel List
            const carouselItems = [];
            if(forecastItems.length) carouselItems.push({type:'forecast'});
            if(stockQuotes.length) carouselItems.push({type:'stocks', data:stockQuotes});
            countdowns.forEach(c => carouselItems.push({...c, type:'countdown'}));
            initCarousel(carouselItems);
        }

        // --- TIMER LOGIC ---
        function updateTime() {
            const timersMain = document.querySelectorAll('.countdown-timer-main');
            const timersTotal = document.querySelectorAll('.countdown-timer-total');
            
            const now = new Date();
            const todayMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            timersMain.forEach(el => {
                const targetStr = el.dataset.target;
                const tMidnight = parseLocalYMD(targetStr);
                
                const diffTime = tMidnight - todayMidnight;
                
                if (diffTime <= 0) {
                    el.textContent = "Today!";
                    el.classList.add('text-green-400');
                    if(el.nextElementSibling) el.nextElementSibling.textContent = "";
                } else {
                    let y = tMidnight.getFullYear() - todayMidnight.getFullYear();
                    let m = tMidnight.getMonth() - todayMidnight.getMonth();
                    let d = tMidnight.getDate() - todayMidnight.getDate();

                    if (d < 0) {
                        m -= 1;
                        const prevMonth = new Date(tMidnight.getFullYear(), tMidnight.getMonth(), 0);
                        d += prevMonth.getDate();
                    }
                    if (m < 0) {
                        y -= 1;
                        m += 12;
                    }

                    const parts = [];
                    if(y > 0) parts.push(`${y} Years`);
                    if(m > 0) parts.push(`${m} Months`);
                    if(d > 0) parts.push(`${d} Days`);
                    
                    el.textContent = parts.join(' ') || "0 Days";
                }
            });
            
            timersTotal.forEach(el => {
                const targetStr = el.dataset.target;
                const tMidnight = parseLocalYMD(targetStr);
                const diffTime = tMidnight - todayMidnight;
                
                if (diffTime > 0) {
                     const totalDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                     el.textContent = `[Total: ${totalDays} Days]`;
                }
            });

            animationFrameId = requestAnimationFrame(updateTime);
        }

        function initCarousel(items) {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            allCountdowns = items;
            
            const prev = document.getElementById('prev-button');
            const next = document.getElementById('next-button');
            if(items.length <= 1) { prev.style.display='none'; next.style.display='none'; } 
            else { prev.style.display='block'; next.style.display='block'; }

            if(items.length === 0) { 
                carouselContent.innerHTML = '<div class="w-full h-full flex items-center justify-center text-gray-500">No widgets active</div>'; 
                return; 
            }
            
            currentCardIndex = 0;
            showCard(0);
            animationFrameId = requestAnimationFrame(updateTime);
        }

        // --- ACTIONS ---
        function deleteItem(id, type) {
            if(!confirm("Delete this item?")) return;
            const hidden = getCustomData(state.localStorageKeys.hiddenItems);
            hidden.push(id); 
            saveCustomData(state.localStorageKeys.hiddenItems, hidden);
            
            let custom = getCustomData(state.localStorageKeys[type]);
            custom = custom.filter(x => x.id !== id);
            saveCustomData(state.localStorageKeys[type], custom);
            
            fetchData();
        }

        // MODAL OPENERS
        function openGroupModal(id = null) {
            document.getElementById('group-id').value = id || '';
            document.getElementById('group-modal-title').innerText = id ? "Edit Group" : "Add Link Group";
            if(id) {
                const { groups } = getMergedData();
                const g = groups.find(x => x.id === id);
                if(g) {
                    document.getElementById('group-name').value = g.name;
                    document.getElementById('group-color').value = g.color;
                }
            } else {
                document.getElementById('group-form').reset();
            }
            document.getElementById('add-group-modal').classList.remove('hidden');
            hideMenu();
        }

        function openLinkModal(id = null, groupId = null) {
            document.getElementById('link-id').value = id || '';
            document.getElementById('link-modal-title').innerText = id ? "Edit Link" : "Add Link";
            
            const { groups } = getMergedData();
            const select = document.getElementById('link-group-select');
            select.innerHTML = groups.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
            if(groupId) select.value = groupId;

            if(id) {
                let found = null;
                groups.forEach(g => { const l = g.links.find(x => x.id === id); if(l) found = l; });
                if(found) {
                    document.getElementById('link-name').value = found.name;
                    document.getElementById('link-url').value = found.url;
                    document.getElementById('link-img').value = found.img || '';
                }
            } else {
                document.getElementById('link-form').reset();
            }
            document.getElementById('add-link-modal').classList.remove('hidden');
            hideMenu();
        }

        function openCountdownModal(id = null) {
            document.getElementById('countdown-id').value = id || '';
            document.getElementById('countdown-modal-title').innerText = id ? "Edit Countdown" : "Add Countdown";
            if(id) {
                const { countdowns } = getMergedData();
                const c = countdowns.find(x => x.id === id);
                if(c) {
                    document.getElementById('countdown-name').value = c.name;
                    
                    let dateVal = c.targetDate;
                    if (dateVal.includes('T')) dateVal = dateVal.split('T')[0];
                    document.getElementById('countdown-targetDate').value = dateVal;
                    
                    document.getElementById('countdown-linkUrl').value = c.linkUrl || '';
                    document.getElementById('countdown-img').value = c.img || '';
                }
            } else {
                document.getElementById('countdown-form').reset();
            }
            document.getElementById('add-countdown-modal').classList.remove('hidden');
            hideMenu();
        }

        // SAVE HANDLERS
        function saveGroup(e) {
            e.preventDefault();
            const id = document.getElementById('group-id').value || 'g_' + Date.now();
            const name = document.getElementById('group-name').value;
            const color = document.getElementById('group-color').value;
            let custom = getCustomData(state.localStorageKeys.groups);
            custom = custom.filter(x => x.id !== id);
            custom.push({ id, name, color });
            saveCustomData(state.localStorageKeys.groups, custom);
            document.getElementById('add-group-modal').classList.add('hidden');
            fetchData();
        }

        function saveLink(e) {
            e.preventDefault();
            const id = document.getElementById('link-id').value || 'l_' + Date.now();
            const groupId = document.getElementById('link-group-select').value;
            const name = document.getElementById('link-name').value;
            const url = document.getElementById('link-url').value;
            const img = document.getElementById('link-img').value;
            let custom = getCustomData(state.localStorageKeys.links);
            custom = custom.filter(x => x.id !== id);
            custom.push({ id, groupId, name, url, img });
            saveCustomData(state.localStorageKeys.links, custom);
            document.getElementById('add-link-modal').classList.add('hidden');
            fetchData();
        }

        function saveCountdown(e) {
            e.preventDefault();
            const id = document.getElementById('countdown-id').value || 'c_' + Date.now();
            const name = document.getElementById('countdown-name').value;
            const targetDate = document.getElementById('countdown-targetDate').value;
            const linkUrl = document.getElementById('countdown-linkUrl').value;
            const img = document.getElementById('countdown-img').value;
            let custom = getCustomData(state.localStorageKeys.countdowns);
            custom = custom.filter(x => x.id !== id);
            custom.push({ id, name, targetDate, linkUrl, img });
            saveCustomData(state.localStorageKeys.countdowns, custom);
            document.getElementById('add-countdown-modal').classList.add('hidden');
            fetchData();
        }
        
        function saveStock(e) {
            e.preventDefault();
            const symbol = document.getElementById('stock-symbol').value.toUpperCase();
            let custom = getCustomData(state.localStorageKeys.stocks);
            if(!custom.some(s => s.symbol === symbol)) {
                custom.push({ symbol });
                saveCustomData(state.localStorageKeys.stocks, custom);
            }
            document.getElementById('add-stock-modal').classList.add('hidden');
            fetchData();
        }
        
        function downloadDataFile() {
            hideMenu();
            const { groups, countdowns } = getMergedData();
            const customStocks = getCustomData(state.localStorageKeys.stocks);
            const stockSymbols = new Set(STATIC_STOCKS.map(s => s.symbol));
            const mergedStocks = [...STATIC_STOCKS];
            customStocks.forEach(s => { if (!stockSymbols.has(s.symbol)) { mergedStocks.push(s); stockSymbols.add(s.symbol); } });

            const data = {
                linkGroups: groups,
                countdowns: countdowns,
                stocks: mergedStocks
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `dashboard-data-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        function clearDraftData() { localStorage.clear(); location.reload(); }
        function toggleMenu() { const m = document.getElementById('menu-modal'); if(m.classList.contains('opacity-0')) { m.classList.remove('opacity-0', 'pointer-events-none', '-translate-y-4'); } else { m.classList.add('opacity-0', 'pointer-events-none', '-translate-y-4'); } }
        function hideMenu() { document.getElementById('menu-modal').classList.add('opacity-0', 'pointer-events-none', '-translate-y-4'); }
        function openStockModal() { document.getElementById('add-stock-modal').classList.remove('hidden'); hideMenu(); }

        // --- DATA FETCH & INIT ---
        async function fetchData() {
            let d = EMBEDDED_DATA;
            try { const res = await fetch('/data.json'); if(res.ok) d = await res.json(); } catch(e) {}
            
            // ID Normalization
            if(d.linkGroups) {
                d.linkGroups.forEach((g, gi) => {
                    if(!g.id) g.id = 'static_g_' + gi;
                    if(g.links) g.links.forEach((l, li) => { if(!l.id) l.id = 'static_l_' + gi + '_' + li; });
                });
            }
            if(d.countdowns) { d.countdowns.forEach((c, ci) => { if(!c.id) c.id = 'static_c_' + ci; }); }

            STATIC_LINK_GROUPS = d.linkGroups || [];
            STATIC_COUNTDOWNS = d.countdowns || [];
            STATIC_STOCKS = d.stocks || [];
            
            await fetchWeatherAndStocks();
            renderDashboard();
        }

        async function fetchWeatherAndStocks() {
            const ZIP = '75482,us', KEY = '87256fe2710631542ff491e4c5d73306';
            const FINNHUB_KEY = 'd4geo7pr01qm5b359cugd4geo7pr01qm5b359cv0';

            try {
                const wRes = await fetch(`https://api.openweathermap.org/data/2.5/weather?zip=${ZIP}&units=imperial&appid=${KEY}`);
                const fRes = await fetch(`https://api.openweathermap.org/data/2.5/forecast?zip=${ZIP}&units=imperial&appid=${KEY}`);
                if(wRes.ok && fRes.ok) {
                    const w = await wRes.json(); const f = await fRes.json();
                    document.getElementById('weather-current-temp').textContent = Math.round(w.main.temp) + 'Â°';
                    document.getElementById('weather-current-temp').className = `text-lg font-bold mr-3 ${getTempColor(w.main.temp)}`;
                    document.getElementById('weather-icon').innerHTML = getForecastEmoji(w.weather[0].icon);
                    
                    const daily = {};
                    f.list.forEach(x => { const d = new Date(x.dt*1000).toDateString(); if(!daily[d]) daily[d] = { date: new Date(x.dt*1000), temp_min: x.main.temp_min, temp_max: x.main.temp_max, icon: x.weather[0].icon }; else { daily[d].temp_min = Math.min(daily[d].temp_min, x.main.temp_min); daily[d].temp_max = Math.max(daily[d].temp_max, x.main.temp_max); } });
                    forecastItems = Object.values(daily).slice(0,5).map(x => ({...x, temp_min:Math.round(x.temp_min), temp_max:Math.round(x.temp_max)}));
                }
            } catch(e) {}
            
            // Merge Static + Custom Stocks
            const customStocks = getCustomData(state.localStorageKeys.stocks);
            const allStockSymbols = [...STATIC_STOCKS.map(s => s.symbol), ...customStocks.map(s => s.symbol)];
            const uniqueSymbols = [...new Set(allStockSymbols)];
            
            if (uniqueSymbols.length) {
                try {
                    const promises = uniqueSymbols.map(async sym => {
                        const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${sym}&token=${FINNHUB_KEY}`);
                        if (!res.ok) return null;
                        const d = await res.json();
                        if(d.c === 0 && d.d === null) return null; 
                        return { symbol: sym, price: d.c, change: d.d, percentChange: d.dp };
                    });
                    const results = await Promise.all(promises);
                    stockQuotes = results.filter(s => s !== null);
                } catch(e) {
                    console.error("Stock fetch failed", e);
                }
            }
        }

        function updateClock() { const now = new Date(); document.getElementById('datetime').innerHTML = `<span class="text-gray-400">${now.toLocaleDateString()}</span> <span class="text-blue-300 ml-1">${now.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'}).toLowerCase()}</span>`; }

        window.onload = () => { 
            fetchData(); 
            setInterval(updateClock, 1000); 
            updateClock(); 
        };
    </script>
</body>
</html>

