<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stephens' Dashboard V0.2</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Apply smooth transitions to all interactive elements */
        * {
            transition: all 0.2s ease-in-out;
        }
        /* Custom scrollbar for a polished dark-mode look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111827; /* gray-900 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4B5563; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6B7280; /* gray-500 */
        }

        /* Set default font to Inter */
        html {
            font-family: 'Inter', sans-serif;
        }

        /* Modal backdrop for the form */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        /* Ensure the smooth scroll is applied only to the transform property */
        /* UPDATED: Transition to 3s with ease-in-out for smoother feel */
        #countdown-scroll-container {
            transition: transform 3s ease-in-out; 
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<!-- Main container is set to dark mode -->
<body class="bg-gray-900 text-white min-h-screen p-4 sm:p-8">

    <!-- Fixed Toolbar/Navbar - Height is now smaller (p-2 instead of p-4) -->
    <nav class="fixed top-0 left-0 right-0 bg-gray-800 border-b border-gray-700 shadow-xl z-30 p-2 flex items-center justify-start">
        <!-- Hamburger Menu Button - Now first and on the far left -->
        <button id="menu-button" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500 mr-4">
            <svg class="w-6 h-6 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
        <!-- Date and Time Display - Immediately follows the menu button -->
        <div id="datetime" class="text-sm sm:text-base font-medium">
            <!-- Date and time injected here by JS, with colored time span -->
        </div>
    </nav>

    <!-- Menu Dropdown (now a simple floating menu that transitions down) -->
    <div id="menu-modal" class="fixed top-[4rem] left-4 z-40 opacity-0 pointer-events-none transform -translate-y-4 transition-all duration-300 ease-out max-w-xs">
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 shadow-2xl w-64">
            <!-- Close button (optional in this format, but useful for touch) -->
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h3 class="text-xl font-semibold text-white">Menu</h3>
                <button id="close-menu-button" class="text-gray-400 hover:text-white p-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- NEW: Add Countdown Button -->
            <button id="add-countdown-button" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-2 transition duration-150">
                Add Countdown
            </button>
            
            <!-- NEW: Download Data Button -->
            <button id="download-data-button" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-4 transition duration-150">
                Download Data File
            </button>


            <p id="version-display" class="text-sm font-mono text-gray-300">Stephens' Dashboard Version 0.2</p>
        </div>
    </div>
    
    <!-- NEW: Add Countdown Modal Form (Hidden by default) -->
    <div id="add-countdown-modal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 shadow-2xl w-full max-w-lg mx-auto transform scale-95 transition-transform duration-300">
            <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">Add New Countdown</h2>
            <form id="countdown-form" class="space-y-4">
                <label class="block">
                    <span class="text-gray-400 text-sm">Event Name:</span>
                    <input type="text" id="countdown-name" required class="mt-1 block w-full rounded-lg bg-gray-700 border-gray-600 text-white p-2.5 focus:border-blue-500 focus:ring-blue-500">
                </label>
                <label class="block">
                    <span class="text-gray-400 text-sm">Target Date:</span>
                    <input type="date" id="countdown-targetDate" required class="mt-1 block w-full rounded-lg bg-gray-700 border-gray-600 text-white p-2.5 focus:border-blue-500 focus:ring-blue-500">
                </label>
                <label class="block">
                    <span class="text-gray-400 text-sm">Timezone:</span>
                    <select id="countdown-timezone" required class="mt-1 block w-full rounded-lg bg-gray-700 border-gray-600 text-white p-2.5 focus:border-blue-500 focus:ring-blue-500">
                        <!-- Options populated by JS -->
                    </select>
                </label>
                <label class="block">
                    <span class="text-gray-400 text-sm">Link URL (Optional):</span>
                    <input type="url" id="countdown-linkUrl" class="mt-1 block w-full rounded-lg bg-gray-700 border-gray-600 text-white p-2.5 focus:border-blue-500 focus:ring-blue-500">
                </label>
                <label class="block">
                    <span class="text-gray-400 text-sm">Image URL (Optional, will use placeholder if empty):</span>
                    <input type="url" id="countdown-img" class="mt-1 block w-full rounded-lg bg-gray-700 border-gray-600 text-white p-2.5 focus:border-blue-500 focus:ring-blue-500">
                </label>

                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancel-countdown-button" class="px-4 py-2 text-sm font-medium rounded-lg text-gray-400 border border-gray-600 hover:bg-gray-700">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-500/50">
                        Save Countdown
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- END: Add Countdown Modal Form -->


    <!-- Main Content Container (pt-16 for the smaller toolbar height) -->
    <main id="dashboard-content" class="max-w-7xl mx-auto pt-16 pb-8">
        
        <!-- COUNTDOWN WIDGETS CONTAINER (Overflow hidden, height fixed) -->
        <div id="countdown-widgets" class="mb-8 w-full overflow-hidden h-14 relative">
            <p id="loading-indicator" class="w-full text-center text-gray-400 p-8">Loading dashboard data...</p>
            
            <!-- SCROLL CONTAINER (This element moves horizontally) -->
            <div id="countdown-scroll-container" class="flex flex-nowrap h-full transition-transform duration-1000 ease-in-out absolute inset-0">
                <!-- Countdown items will be rendered here. Each item is w-full. -->
            </div>
        </div>
        <!-- END COUNTDOWN WIDGETS -->

        <div id="link-groups-container" class="flex flex-wrap justify-center gap-6">
            <!-- Link groups will be rendered here -->
        </div>
    </main>
    
    <!-- Debug/Notice Footer -->
    <footer id="debug-log" class="max-w-7xl mx-auto mt-10 p-4 w-full">
        <!-- Fallback notice or debug messages will be injected here -->
    </footer>

    <!-- JavaScript for Data Handling and Rendering -->
    <script>
        // Use an IIFE (Immediately Invoked Function Expression) to create a private scope 
        // and prevent global variable conflicts in environments that rerun scripts.
        (function() {
            const linkGroupsContainer = document.getElementById('link-groups-container');
            const countdownWidgetsContainer = document.getElementById('countdown-widgets');
            const countdownScrollContainer = document.getElementById('countdown-scroll-container'); 
            const loadingIndicator = document.getElementById('loading-indicator');
            const debugLog = document.getElementById('debug-log');
            const menuModal = document.getElementById('menu-modal');
            const menuButton = document.getElementById('menu-button');
            const closeMenuButton = document.getElementById('close-menu-button');
            const downloadDataButton = document.getElementById('download-data-button');
            
            // New elements for the Add Countdown feature
            const addCountdownButton = document.getElementById('add-countdown-button');
            const addCountdownModal = document.getElementById('add-countdown-modal');
            const countdownForm = document.getElementById('countdown-form');
            const cancelCountdownButton = document.getElementById('cancel-countdown-button');
            
            // Variable to hold the original static data for the download function
            let STATIC_LINK_GROUPS = [];
            let STATIC_COUNTDOWNS = [];

            // Variable to hold the clock interval
            let clockInterval = null;

            // List of common IANA timezones
            const TIMEZONES = [
                { name: "Central (CT) - Default", value: "America/Chicago" },
                { name: "Eastern (ET)", value: "America/New_York" },
                { name: "Mountain (MT)", value: "America/Denver" },
                { name: "Pacific (PT)", value: "America/Los_Angeles" },
                { name: "Alaska (AKT)", value: "America/Anchorage" },
                { name: "Hawaii (HST)", value: "Pacific/Honolulu" },
                { name: "London (GMT/BST)", value: "Europe/London" },
                { name: "Paris (CET/CEST)", value: "Europe/Paris" },
                { name: "Shanghai (CST)", value: "Asia/Shanghai" },
                { name: "Tokyo (JST)", value: "Asia/Tokyo" }
            ];

            // --- EMBEDDED DATA FOR PREVIEW/FALLBACK (Identified by '(test)' in names) ---
            const EMBEDDED_DATA = {
                "linkGroups": [
                    {
                        "name": "PBFCM (test)",
                        "color": "bg-blue-600/20",
                        "textColor": "text-blue-400",
                        "links": [
                            {"name": "Halo", "url": "https://pbfcm.haloitsm.com", "img": "https://media.licdn.com/dms/image/v2/D4D0BAQHua1QvehlNJg/company-logo_200_200/company-logo_200_200/0/1719256595420/haloitsm_logo?e=1764806400&v=beta&t=Et1KWvi52D9xGj68eE4JmapbZ0fg84N4t9c-aheyINs"},
                            {"name": "2025 Bullet Journal", "url": "https://docs.google.com/document/d/1Y2TbxiLuN7K55mL2o_XWDWiTD_bQ8HJLfXjXwEc5m44/edit?tab=t.0#heading=h.clgrn99mtopn", "img": "https://cmsv2-assets.apptegy.net/uploads/11435/file/1077963/28e381d9-b33c-4d9c-b92e-164b4ea08c07.png"},
                            {"name": "Dayforce", "url": "https://us251.dayforcehcm.com/MyDayforce/u/Iw_6iFiF-0SPEmVMNfEh7A/Common/#SHViPyZpc0ZpcnN0RmVhdHVyZT10cnVl", "img": "https://play-lh.googleusercontent.com/GzXqzEjylw9Y2FQPvsw34DcYirDrItkNGYInKrkLg-mFP-cgLYmwF223kA67KlD2miU=s256-rw"},
                            {"name": "3CX", "url": "https://pbfcm.businessphone.com/#/chat/9059", "img": "https://cdn-1.carierista.com/companies/150/2d05df55a3399d793cfbd01657052b4d.png"},
                            {"name": "Udemy", "url": "https://pbfcm.udemy.com/organization/home/", "img": "https://images.seeklogo.com/logo-png/40/1/udemy-wordmark-logo-png_seeklogo-409220.png"}
                        ]
                    },
                    {
                        "name": "Fun (test)",
                        "color": "bg-amber-600/20",
                        "textColor": "text-amber-400",
                        "links": [
                            {"name": "TikTok", "url": "https://www.tiktok.com/@jaspynj", "img": "https://images.seeklogo.com/logo-png/37/1/tiktok-app-icon-logo-png_seeklogo-373800.png"},
                            {"name": "Facebook", "url": "https://www.facebook.com/", "img": "https://upload.wikimedia.org/wikipedia/commons/thumb/c/cd/Facebook_logo_%28square%29.png/960px-Facebook_logo_%28square%29.png"},
                            {"name": "Duolingo", "url": "https://www.duolingo.com", "img": "https://images.seeklogo.com/logo-png/45/2/duolingo-logo-png_seeklogo-458347.png"},
                            {"name": "Instapaper", "url": "http://instapaper.com", "img": "https://play-lh.googleusercontent.com/uQElx_kgheNkInfRZl6_iPZ34HLOpt1KMOiVWmcN_PZFRQ66Ug3vDaAS0eymjsok7g"},
                            {"name": "FFL", "url": "https://ultimateffl.xyz", "img": "https://www.thebiline.com/wp-content/uploads/2023/11/fantasyFootball.png"},
                            {"name": "Royal Caribbean", "url": "https://www.royalcaribbean.com", "img": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSwdd2L_gTZtJM7N_K5OpKk5SlqKflxBddeQQ&s"}
                        ]
                    },
                    {
                        "name": "Google Apps (test)",
                        "color": "bg-green-600/20",
                        "textColor": "text-green-400",
                        "links": [
                            {"name": "Gmail", "url": "https://www.gmail.com", "img": "https://icons.iconarchive.com/icons/marcus-roberto/google-play/256/Gmail-icon.png"},
                            {"name": "Google News", "url": "https://news.google.com/foryou?hl=en-US&gl=US&ceid=US%3Aen", "img": "https://upload.wikimedia.org/wikipedia/commons/thumb/d/da/Google_News_icon.svg/120px-Google_News_icon.svg.png"},
                            {"name": "Drive", "url": "https://drive.google.com", "img": "https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Google_Drive_icon_%282020%29.svg/120px-Google_Drive_icon_%282020%29.svg.png"},
                            {"name": "Keep", "url": "http://keep.google.com", "img": "https://upload.wikimedia.org/wikipedia/commons/thumb/b/bd/Google_Keep_icon_%282015-2020%29.svg/512px-Google_Keep_icon_%282015-2020%29.svg.png?20210606170001"},
                            {"name": "Calendar", "url": "https://www.google.com/calendar/", "img": "https://ssl.gstatic.com/calendar/images/dynamiclogo_2020q4/calendar_13_2x.png"},
                            {"name": "Contacts", "url": "https://contacts.google.com/#contacts", "img": "https://cdn.jsdelivr.net/gh/homarr-labs/dashboard-icons/svg/google-contacts.svg"},
                            {"name": "YouTube", "url": "https://www.youtube.com", "img": "https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/YouTube_full-color_icon_%282017%29.svg/512px-YouTube_full-color_icon_%282017%29.svg.png?20240107144800"},
                            {"name": "YouTube Music", "url": "https://music.youtube.com", "img": "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6a/Youtube_Music_icon.svg/512px-Youtube_Music_icon.svg.png"},
                            {"name": "YouTube TV", "url": "https://tv.youtube.com", "img": "https://images.seeklogo.com/logo-png/61/2/youtube-tv-logo-png_seeklogo-612184.png"},
                            {"name": "Photos", "url": "https://photos.google.com", "img": "https://images.seeklogo.com/logo-png/26/1/google-photos-logo-png_seeklogo-269651.png"},
                            {"name": "Messages", "url": "https://messages.android.com", "img": "https://play-lh.googleusercontent.com/9AZOTXU_CpreTFAXUPAmJNkm8VGCb1C90fjJ9pHGcVmpGMDSTq3cUbaQJdBT9Tdp9A=w240-h480-rw"}
                        ]
                    },
                    {
                        "name": "Movies & TV (test)",
                        "color": "bg-purple-600/20",
                        "textColor": "text-purple-400",
                        "links": [
                            {"name": "IMDb", "url": "https://www.imdb.com/", "img": "https://jeremyirons.net/wp-content/uploads/2009/01/imdb-logo-23962421_std.jpg"},
                            {"name": "TV Time", "url": "https://www.tvtime.com/en", "img": "https://upload.wikimedia.org/wikipedia/commons/3/33/TVShow_Time_logo.png?20160620170449"},
                            {"name": "Movies Portal", "url": "https://movies.do", "img": "https://placehold.co/60x60/1E40AF/FFFFFF?text=MP"},
                            {"name": "Bright Star Cinemas", "url": "https://www.brightstarcinemas.com/", "img": "https://placehold.co/60x60/8B5CF6/FFFFFF?text=BSC"},
                            {"name": "YouTube", "url": "https://www.youtube.com", "img": "https://upload.wikimedia.org/wikipedia/commons/thumb/0/09/YouTube_full-color_icon_%282017%29.svg/512px-YouTube_full-color_icon_%282017%29.svg.png?20240107144800"},
                            {"name": "YouTube TV", "url": "https://tv.youtube.com", "img": "https://images.seeklogo.com/logo-png/61/2/youtube-tv-logo-png_seeklogo-612184.png"}
                        ]
                    },
                    {
                        "name": "Shopping (test)",
                        "color": "bg-pink-600/20",
                        "textColor": "text-pink-400",
                        "links": [
                            {"name": "Amazon", "url": "https://amazon.com", "img": "https://images.seeklogo.com/logo-png/40/2/amazon-icon-logo-png_seeklogo-405254.png"},
                            {"name": "Walmart", "url": "http://www.walmart.com/", "img": "https://www.designmantic.com/blog/wp-content/uploads/2025/02/Walmart-Logo-Icon.png"},
                            {"name": "Black Friday", "url": "http://blackfriday.com/", "img": "https://images.seeklogo.com/logo-png/39/1/black-friday-logo-png_seeklogo-391204.png"}
                        ]
                    },
                    {
                        "name": "Financial (test)",
                        "color": "bg-emerald-600/20",
                        "textColor": "text-emerald-400",
                        "links": [
                            {"name": "Alliance Bank", "url": "https://alliancebank.com", "img": "https://www.ssnewstelegram.com/sites/ssnewstelegram.com/files/styles/article_420/public/2020-03/xVBU_UXM.png?itok=XpQwRzsj"},
                            {"name": "2025 Budget", "url": "https://docs.google.com/spreadsheets/d/1o3Ab6q4nMFVZIzxM-6lDXCd6jFt-nhHtT5b1yAKgUkw", "img": "https://cmsv2-assets.apptegy.net/uploads/11435/file/1077963/28e381d9-b33c-4d9c-b29e-164b4ea08c07.png"},
                            {"name": "Big Money", "url": "https://docs.google.com/spreadsheets/d/17aFT-1c1eZgnvKkHnw8oS2SQzbTh3JnacRS3ChaW9dM/edit?gid=1898418506#gid=1898418506", "img": "https://cmsv2-assets.apptegy.net/uploads/11435/file/1077963/28e381d9-b33c-4d9c-b29e-164b4ea08c07.png"},
                            {"name": "Mega Millions", "url": "https://www.megamillions.com", "img": "https://scontent-dfw5-1.xx.fbcdn.net/v/t39.30808-1/300760619_575966844316568_8359561060352066869_n.png?stp=dst-png_s200x200&_nc_cat=111&ccb=1-7&_nc_sid=2d3e12&_nc_ohc=WBYVKDTj94sQ7kNvwEs4nvR&_nc_oc=AdnmO7Gyl6SerauVZ5yRbG_eNyM2iBM6eKmTAgYtEw2nNpcYsGZXDZs0y18djU8jMUs&_nc_zt=24&_nc_ht=scontent-dfw5-1.xx&_nc_gid=BgDoOuidjtlK_5YJgnN6Cg&oh=00_AfgrMHw4q6LdO16nh7RgdD67C9iqbsqdAbHVXZk76VAmlw&oe=691C4846"},
                            {"name": "Power Ball", "url": "https://www.powerball.com/games/home", "img": "https://simublast.com/assets/images/lottery/us-powerball.png"},
                            {"name": "Book Sales", "url": "https://kdp.amazon.com/en_US/", "img": "https://wallpapers.com/images/high/amazon-app-icon-0vxsqxaqsv2hidrm.png"},
                            {"name": "Realtor", "url": "http://www.realtor.com", "img": "https://hooquest.com/wp-content/uploads/2018/09/realtor-com-logo-300.png"}
                        ]
                    },
                    {
                        "name": "Benefits (test)",
                        "color": "bg-teal-600/20",
                        "textColor": "text-teal-400",
                        "links": [
                            {"name": "BCBS", "url": "https://mybam.bcbstx.com", "img": "https://play-lh.googleusercontent.com/EQb_e3MXfOxRvT2U_orh3iV-9z_GvgJFUyn0qfYPlcNDHXCKnW04tMqPLbp4EfjCP8w=w240-h480-rw"},
                            {"name": "MyChart", "url": "https://mychart.christushealth.org/mychart/Authentication/Login?postloginurl=Clinical%2fTestResults", "img": "https://news.med.virginia.edu/files/2023/12/MyChart-1x1-1-200x200.jpg"},
                            {"name": "BCBS Vision", "url": "https://member.eyemedvisioncare.com/bcbstx/en-us/", "img": "https://www.bcbsil.com/content/bcbs-v2/public-sites/bcbsil/en/home/welcome/shop-plans/vision-insurance/_jcr_content/root/main-par/section_252757724_co/section-par/horizontal_value_pro/value-prop-one/image.coreimg.svg/1743113970660/circle-eye-glasses-icon.svg"},
                            {"name": "HSA Bank", "url": "https://account.hsabank.com/#/", "img": "https://media.licdn.com/dms/image/v2/D4E22AQG0tY8-IPbPAQ/feedshare-shrink_800/B4EZTXDi.1GYAg-/0/1738774819262?e=1764806400&v=beta&t=S0Rvm5Ve8gQ7zjOjiLHHnd9zMVS3YSbmC4qeWM6zJfg"},
                            {"name": "Aflac", "url": "https://myaflac.aflac.com/home", "img": "https://cdn.brandfetch.io/idfLaxzY-K/w/400/h/400/theme/dark/icon.png?c=1bxid64Mup7aczewSAYMX&t=1667924267088"},
                            {"name": "Fidelity", "url": "https://login.fidelity.com/ftgw/Fidelity/RtlCust/Login/Init?AuthRedUrl=https://oltx.fidelity.com/ftgw/fbc/ofpositions/brokerageAccountPositions", "img": "https://cdn.brandfetch.io/idzIUUVEBm/w/400/h/400/theme/dark/icon.jpeg?c=1bxid64Mup7aczewSAYMX&t=1752030331882"}
                        ]
                    },
                    {
                        "name": "Coding (test)",
                        "color": "bg-blue-600/20",
                        "textColor": "text-blue-400",
                        "links": [
                            {"name": "Vercel", "url": "https://vercel.com/stephensajohnson-hashs-projects/stephens-dashboard", "img": "https://pnghdpro.com/wp-content/themes/pnghdpro/download/social-media-and-brands/vercel-logo-icon.png"},
                            {"name": "GitHub", "url": "https://github.com/stephensajohnson-hash/stephens-dashboard/tree/main/dashboard", "img": "https://cdn.iconscout.com/icon/free/png-512/free-github-logo-icon-svg-download-png-8630395.png?f=webp&w=256"}
                        ]
                    }
                ],
                // --- EMBEDDED COUNTDOWN DATA ---
                "countdowns": [
                    {
                      "name": "Thanksgiving (test)",
                      "targetDate": "2025-11-27T00:00:00",
                      "linkUrl": "#",
                      "img": "https://1r77nq.media.zestyio.com/assisted-living-thanksgiving.jpg",
                      "timezone": "America/Chicago"
                    },
                    {
                      "name": "Cruise! (test)",
                      "targetDate": "2026-02-01T00:00:00",
                      "linkUrl": "https://www.royalcaribbean.com/",
                      "img": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSwdd2L_gTZtJM7N_K5OpKk5SlqKflxBddeQQ&s",
                      "timezone": "America/Chicago"
                    },
                    {
                      "name": "Stephens Retires (test)",
                      "targetDate": "2033-03-18T00:00:00",
                      "linkUrl": "#",
                      "img": "https://i0.wp.com/goodstuffconnections.com/wp-content/uploads/2020/04/retirement.jpg?w=1000&ssl=1",
                      "timezone": "America/Chicago"
                    }
                ]
                // --- END EMBEDDED COUNTDOWN DATA ---
            };
            // --- END EMBEDDED DATA ---


            // Global state for rotation
            const state = {
                allCountdowns: [],
                activeCountdownElements: [], // Stores references to all time display elements
                currentScrollIndex: 0, // Tracks current position for scrolling
                countdownInterval: null,
                animationFrameId: null,
                localStorageKey: 'stephens_dashboard_custom_countdowns'
            };
            
            // --- TIMEZONE DROPDOWN POPULATION ---
            
            function populateTimezoneDropdown() {
                const select = document.getElementById('countdown-timezone');
                select.innerHTML = ''; 
                
                TIMEZONES.forEach(tz => {
                    const option = document.createElement('option');
                    option.value = tz.value;
                    option.textContent = tz.name;
                    if (tz.value === 'America/Chicago') {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            }

            // --- LOCAL STORAGE FUNCTIONS ---

            function getCustomCountdowns() {
                try {
                    const saved = localStorage.getItem(state.localStorageKey);
                    return saved ? JSON.parse(saved) : [];
                } catch (e) {
                    console.error("Error reading from localStorage:", e);
                    return [];
                }
            }

            function saveCustomCountdowns(countdowns) {
                try {
                    localStorage.setItem(state.localStorageKey, JSON.stringify(countdowns));
                } catch (e) {
                    console.error("Error writing to localStorage:", e);
                }
            }
            
            // --- MODAL AND FORM LOGIC ---

            function showAddCountdownModal() {
                addCountdownModal.classList.remove('hidden');
                menuModal.classList.add('opacity-0', 'pointer-events-none', '-translate-y-4'); 
                countdownForm.reset(); 
                populateTimezoneDropdown(); 
            }

            function hideAddCountdownModal() {
                addCountdownModal.classList.add('hidden');
            }

            // Event listeners for the modal
            addCountdownButton.addEventListener('click', showAddCountdownModal);
            cancelCountdownButton.addEventListener('click', hideAddCountdownModal);
            
            countdownForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const newCountdown = {
                    name: document.getElementById('countdown-name').value.trim(),
                    targetDate: document.getElementById('countdown-targetDate').value.trim() + 'T00:00:00',
                    linkUrl: document.getElementById('countdown-linkUrl').value.trim() || '#',
                    img: document.getElementById('countdown-img').value.trim() || 'https://placehold.co/40x40/374151/FFFFFF?text=NEW',
                    id: 'user_' + Date.now(), 
                    timezone: document.getElementById('countdown-timezone').value, 
                };

                const customCountdowns = getCustomCountdowns();
                customCountdowns.push(newCountdown);
                saveCustomCountdowns(customCountdowns);

                hideAddCountdownModal();
                initDashboard(); 
            });


            // --- UI Logic ---

            // Toggle Menu Modal
            function toggleMenu() {
                const isHidden = menuModal.classList.contains('opacity-0');
                if (isHidden) {
                    menuModal.classList.remove('opacity-0', 'pointer-events-none', '-translate-y-4');
                } else {
                    menuModal.classList.add('opacity-0', 'pointer-events-none', '-translate-y-4');
                }
            }
            
            menuButton.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleMenu();
            });

            closeMenuButton.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleMenu();
            });

            // Close menu if user clicks anywhere else outside the menu or the button
            document.addEventListener('click', (e) => {
                if (!menuModal.contains(e.target) && !menuButton.contains(e.target) && !menuModal.classList.contains('opacity-0')) {
                    toggleMenu();
                }
            });
            
            // --- Download Logic ---
            
            downloadDataButton.addEventListener('click', downloadDataFile);

            function downloadDataFile() {
                hideMenu(); 
                
                // 1. Create the Consolidated Data Object
                const finalLinkGroups = STATIC_LINK_GROUPS.map(group => ({
                    ...group,
                    name: group.name.replace(' (test)', '')
                }));
                
                let finalCountdowns = STATIC_COUNTDOWNS.map(c => ({
                    ...c,
                    name: c.name.replace(' (test)', '') 
                }));
                
                const customCountdowns = getCustomCountdowns();
                
                customCountdowns.forEach(customC => {
                    const { id, ...cleanCountdown } = customC; 
                    finalCountdowns.push(cleanCountdown);
                });
                
                const consolidatedData = {
                    "linkGroups": finalLinkGroups,
                    "countdowns": finalCountdowns 
                };
                
                // 2. Prepare for Download
                const dataStr = JSON.stringify(consolidatedData, null, 2); 
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                // 3. Trigger Download
                const a = document.createElement('a');
                const date = new Date();
                const dateString = date.getFullYear() + String(date.getMonth() + 1).padStart(2, '0') + String(date.getDate()).padStart(2, '0');
                a.download = `data-update-${dateString}.json`;
                a.href = window.URL.createObjectURL(dataBlob);
                a.click();
                
                window.URL.revokeObjectURL(a.href);
            }
            
            function hideMenu() {
                 menuModal.classList.add('opacity-0', 'pointer-events-none', '-translate-y-4');
            }


            // Function to update the clock display (Accurate to the minute)
            function updateClock() {
                const now = new Date();
                
                const datePart = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const timePart = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }).toLowerCase().replace(/\s/g, '');

                let dateWithSuffix = datePart;
                const dayMatch = datePart.match(/,\s(\w+)\s(\d+)/); 
                if (dayMatch) {
                    const day = parseInt(dayMatch[2]);
                    let suffix;
                    if (day > 3 && day < 21) suffix = 'th';
                    else if (day % 10 === 1) suffix = 'st';
                    else if (day % 10 === 2) suffix = 'nd';
                    else if (day % 10 === 3) suffix = 'rd';
                    else suffix = 'th';
                    dateWithSuffix = datePart.replace(` ${day}`, ` ${day}${suffix}`);
                }

                document.getElementById('datetime').innerHTML = `
                    <span class="text-gray-400">${dateWithSuffix}</span>
                    <span class="text-blue-300 ml-1">${timePart}</span>
                `;
            }

            // Function to manage the clock startup with sub-minute accuracy
            function startClockUpdate() {
                if (clockInterval) clearInterval(clockInterval);
                updateClock();

                const now = new Date();
                const ms = now.getMilliseconds();
                const seconds = now.getSeconds();
                
                const msUntilNextMinute = (60 - seconds) * 1000 - ms;

                setTimeout(() => {
                    updateClock();
                    clockInterval = setInterval(updateClock, 60000);
                }, msUntilNextMinute);
            }


            // --- Countdown Scrolling Logic ---

            /**
             * Calculates the time remaining and formats it.
             * @param {Object} countdown - The countdown object.
             * @returns {string} The formatted time string.
             */
            function formatTimeRemaining(countdown) {
                const targetDate = new Date(countdown.targetDate);
                const now = new Date();
                const diffMs = targetDate.getTime() - now.getTime();
                
                if (diffMs <= 0) return null; // Expired

                const msInDay = 1000 * 60 * 60 * 24;
                const totalDays = Math.floor(diffMs / msInDay);
                
                const years = Math.floor(totalDays / 365);
                let remainingDays = totalDays % 365;

                const months = Math.floor(remainingDays / 30);
                const days = remainingDays % 30;

                let primaryDisplay = [];
                if (years > 0) {
                    primaryDisplay.push(`${years} Year${years > 1 ? 's' : ''}`);
                    if (months > 0) primaryDisplay.push(`${months} Month${months > 1 ? 's' : ''}`);
                } else if (months > 0) {
                    primaryDisplay.push(`${months} Month${months > 1 ? 's' : ''}`);
                    if (days > 0) primaryDisplay.push(`${days} Day${days > 1 ? 's' : ''}`);
                } else {
                    const remainingMs = diffMs % msInDay;
                    const hours = Math.floor(remainingMs / (1000 * 60 * 60));
                    const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((remainingMs % (1000 * 60)) / 1000);
                    
                    if (totalDays > 0) primaryDisplay.push(`${totalDays} Day${totalDays > 1 ? 's' : ''}`);
                    if (totalDays < 1) primaryDisplay.push(`${hours}h ${minutes}m ${seconds}s`);
                }

                let finalDisplay = primaryDisplay.filter(part => !part.startsWith('0 '));
                
                const totalDaysString = finalDisplay.length > 1 ? `[${totalDays} days]` : `(${totalDays} days)`;

                const timeString = finalDisplay.join(' ');
                
                return `${timeString} ${totalDaysString}`;
            }

            /**
             * Updates the text content of all active countdown timers (per animation frame).
             */
            function updateCountdownTimeDisplay() {
                if (!state.allCountdowns.length) return;

                // Loop through all active elements and update their text
                state.allCountdowns.forEach((countdown, index) => {
                    const timeString = formatTimeRemaining(countdown);
                    const element = state.activeCountdownElements[index];

                    if (timeString === null) {
                        // If expired, trigger dismissal
                        const dismissedId = countdown.id || countdown.name;
                        window.dismissCountdown(new Event('synthetic'), dismissedId, true);
                    } else if (element) {
                        element.textContent = timeString;
                    }
                });

                state.animationFrameId = requestAnimationFrame(updateCountdownTimeDisplay);
            }

            /**
             * Creates a single countdown card element.
             * @param {Object} countdown - The countdown data.
             * @returns {HTMLElement} The created countdown item div.
             */
            function createCountdownItem(countdown) {
                const placeholderLetter = countdown.name.substring(0, 1);
                const dismissId = countdown.id || countdown.name.replace(' (test)', ''); 
                
                const item = document.createElement('div');
                item.className = 'flex-shrink-0 px-3'; 
                
                // Inner card structure
                item.innerHTML = `
                    <a href="${countdown.linkUrl}" target="_blank" class="flex items-center w-full h-14 bg-gray-800 border border-gray-700 rounded-lg shadow-xl hover:bg-gray-700 transform transition-all duration-200">
                        <!-- Image -->
                        <img
                            src="${countdown.img}"
                            alt="${countdown.name} icon"
                            class="w-10 h-10 rounded-lg object-cover ml-3 mr-4 shadow-md"
                            onerror="this.onerror=null;this.src='https://placehold.co/40x40/374151/FFFFFF?text=${placeholderLetter}';"
                        />
                        
                        <!-- Text Content -->
                        <div class="flex-grow min-w-0 pr-4">
                            <div class="text-sm font-semibold text-white truncate">${countdown.name.replace(' (test)', '')}</div>
                            <div class="countdown-time-display text-xs font-mono text-amber-400">Loading...</div>
                        </div>
                        
                        <!-- Close Button (X) -->
                        <button onclick="window.dismissCountdown(event, '${dismissId}')" class="ml-auto p-2 mr-3 rounded-full text-gray-400 hover:text-red-400 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-red-500 flex-shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    </a>
                `;

                return item;
            }

            /**
             * Renders all countdowns into the scroll container, including a clone for looping.
             */
            function renderAllCountdowns(countdowns) {
                countdownScrollContainer.innerHTML = '';
                state.activeCountdownElements = [];

                if (countdowns.length === 0) return;
                
                const totalItems = countdowns.length + (countdowns.length > 1 ? 1 : 0);
                // Calculate the percentage width each item must take up (100% / Total Items in view, which is 100% / 1 = 100% in our logic here)
                // Since we want ONE item filling the container width, we calculate the width as 100% / totalItems of the scrollable area.
                const itemWidthPercent = 100 / totalItems; 

                // 1. Render Original Items
                countdowns.forEach(countdown => {
                    const item = createCountdownItem(countdown);
                    item.style.width = `${100 / (countdowns.length + (countdowns.length > 1 ? 1 : 0))}%`; // Set width here
                    countdownScrollContainer.appendChild(item);
                    state.activeCountdownElements.push(item.querySelector('.countdown-time-display')); 
                });
                
                // 2. Add Clone(s) for seamless looping 
                if (countdowns.length > 1) {
                    const clone = createCountdownItem(countdowns[0]);
                    clone.style.width = `${100 / (countdowns.length + 1)}%`; // Set width here
                    countdownScrollContainer.appendChild(clone);
                    state.activeCountdownElements.push(clone.querySelector('.countdown-time-display'));
                }
                
                // 3. Set Container Width 
                // Total width is totalItems * 100% (e.g., 4 items * 100% = 400%)
                countdownScrollContainer.style.width = `${totalItems * 100}%`;
                countdownScrollContainer.style.transform = `translateX(0%)`; // Reset to start
                state.currentScrollIndex = 0;
            }

            /**
             * Handles the CSS transform for scrolling and manages the seamless loop reset.
             */
            function animateScroll() {
                const numCountdowns = state.allCountdowns.length;
                if (numCountdowns <= 1) return;

                // Move to the next position
                state.currentScrollIndex += 1;
                
                // Calculate shift based on item width percentage (e.g., 25% of the TOTAL scroll container width)
                // The item width is 100 / (numCountdowns + 1) of the total scrollable area.
                const itemWidthPercentOfTotal = 100 / (numCountdowns + 1);
                const shiftAmount = state.currentScrollIndex * itemWidthPercentOfTotal; 
                
                // Apply the slow transition transform
                // UPDATED: Transition time is 3000ms
                countdownScrollContainer.style.transitionDuration = '3000ms';
                countdownScrollContainer.style.transform = `translateX(-${shiftAmount}%)`;

                // If we hit the clone (index N), reset instantly back to the first item (Index 0)
                if (state.currentScrollIndex >= numCountdowns) {
                    // Use a short delay (longer than the transition) to perform the instant snap
                    // UPDATED: Delay is 3050ms
                    setTimeout(() => {
                        countdownScrollContainer.style.transitionDuration = '0ms'; // Disable transition
                        countdownScrollContainer.style.transform = `translateX(0%)`; // Snap back to 0
                        state.currentScrollIndex = 0;
                    }, 3050); 
                }
            }
            
            /**
             * Sets up the countdown update and scrolling intervals.
             */
            function startCountdownScroll(countdowns) {
                if (state.countdownInterval) clearInterval(state.countdownInterval);
                if (state.animationFrameId) cancelAnimationFrame(state.animationFrameId);

                const activeCountdowns = (countdowns || []).filter(c => new Date(c.targetDate).getTime() > new Date().getTime());

                // Clear container and state if no active countdowns
                if (activeCountdowns.length === 0) {
                    countdownWidgetsContainer.innerHTML = '';
                    return;
                }
                
                state.allCountdowns = activeCountdowns;

                // 1. Render all cards
                renderAllCountdowns(state.allCountdowns);
                
                // Remove the loading indicator now that the container has content
                if(loadingIndicator) loadingIndicator.style.display = 'none';

                // 2. Start the second-by-second time update loop
                state.animationFrameId = requestAnimationFrame(updateCountdownTimeDisplay);

                // 3. Start scroll rotation (6 seconds total cycle time)
                if (state.allCountdowns.length > 1) { 
                    // UPDATED: Interval is 6000ms (3s scroll + 3s hold = 6s total display time)
                    state.scrollInterval = setInterval(animateScroll, 6000); 
                } else if (state.allCountdowns.length > 0) {
                     countdownScrollContainer.style.width = `100%`; 
                }
            }


            // Function to dismiss a countdown (for the 'X' button)
            window.dismissCountdown = function(event, dismissId, expired = false) {
                event.preventDefault();
                event.stopPropagation();

                // 1. Remove from local state
                const initialLength = state.allCountdowns.length;
                
                state.allCountdowns = state.allCountdowns.filter(c => (c.id || c.name.replace(' (test)', '')) !== dismissId);

                if (state.allCountdowns.length < initialLength) {
                    // 2. Remove from Local Storage if it was a custom countdown (using the 'id' field)
                    if (dismissId.startsWith('user_')) {
                        let customCountdowns = getCustomCountdowns();
                        customCountdowns = customCountdowns.filter(c => c.id !== dismissId);
                        saveCustomCountdowns(customCountdowns);
                    } else if (expired) {
                        // If expired, store name in static dismissals
                        const staticDismissals = JSON.parse(localStorage.getItem('static_dismissals') || '[]');
                        if (!staticDismissals.includes(dismissId)) {
                             staticDismissals.push(dismissId);
                             localStorage.setItem('static_dismissals', JSON.stringify(staticDismissals));
                        }
                    }

                    // 3. Re-render and restart scroll
                    startCountdownScroll(state.allCountdowns);
                }
            }

            // --- Core Rendering Logic for Links (Unchanged) ---

            function createLinkElement(link) {
                const linkTile = document.createElement('a');
                linkTile.href = link.url;
                linkTile.target = '_blank';
                
                const placeholderLetter = link.name.substring(0, 1).toUpperCase();
                
                const imgHtml = `
                    <div class="w-full h-full aspect-square flex items-center justify-center bg-gray-900 rounded-xl overflow-hidden shadow-inner">
                        <img
                            src="${link.img}"
                            alt="${link.name} icon"
                            class="w-full h-full object-cover p-1 rounded-xl"
                            loading="lazy"
                            onerror="this.onerror=null;this.src='https://placehold.co/96x96/1F2937/FFFFFF?text=${placeholderLetter}'; this.className='p-4';"
                        />
                    </div>
                `;

                linkTile.className = 'flex flex-col items-center p-2 text-center text-gray-200 bg-gray-800 rounded-xl hover:bg-gray-700 hover:scale-[1.05] active:scale-[0.98] transform shadow-lg transition duration-150 ease-in-out h-full justify-start';
                linkTile.innerHTML = imgHtml + `<span class="mt-2 text-sm font-medium truncate w-full">${link.name}</span>`;
                
                return linkTile;
            }

            /**
             * Renders the dashboard content based on the fetched data.
             */
            function renderDashboard(data, isFallback) {
                STATIC_LINK_GROUPS = data.linkGroups || [];
                STATIC_COUNTDOWNS = data.countdowns || [];
                
                linkGroupsContainer.innerHTML = ''; 

                // 1. Handle Debug Log
                if (isFallback) {
                    const fallbackNote = document.createElement('div');
                    fallbackNote.className = 'bg-yellow-900/20 border border-yellow-700 text-yellow-400 p-3 rounded-xl text-center w-full';
                    fallbackNote.innerHTML = '<p class="font-bold">DEBUG WARNING:</p> <p class="text-sm">Using embedded (test) data. The external <code class="font-mono">data.json</code> failed to load (expected in preview environment).</p>';
                    debugLog.appendChild(fallbackNote);
                }

                // --- MERGE COUNTDOWN DATA ---
                
                let allCountdownsList = data.countdowns || [];
                const customCountdowns = getCustomCountdowns();
                
                const staticDismissals = JSON.parse(localStorage.getItem('static_dismissals') || '[]');
                allCountdownsList = allCountdownsList.filter(c => !staticDismissals.includes(c.name.replace(' (test)', '')));

                const mergedCountdowns = [...allCountdownsList, ...customCountdowns];

                // 2. Render Countdowns (New Logic)
                startCountdownScroll(mergedCountdowns);


                // 3. Render Link Groups (Existing Logic)
                if (data.linkGroups && data.linkGroups.length > 0) {
                    data.linkGroups.forEach(group => {
                        const groupCard = document.createElement('div');
                        groupCard.className = 'group-card bg-gray-800 border border-gray-700 rounded-2xl p-4 shadow-xl w-full max-w-sm';

                        const header = document.createElement('div');
                        const headerClasses = `inline-block px-3 py-1 mb-4 rounded-full text-sm font-semibold ${group.color} ${group.textColor}`;
                        header.innerHTML = `<h2 class="${headerClasses}">${group.name}</h2>`;

                        const linksGrid = document.createElement('div');
                        linksGrid.className = 'grid grid-cols-3 gap-3';

                        if (group.links && group.links.length > 0) {
                            group.links.forEach(link => {
                                const linkElement = createLinkElement(link);
                                linksGrid.appendChild(linkElement);
                            });
                        } else {
                            const emptyMessage = document.createElement('p');
                            emptyMessage.className = 'text-gray-500 text-sm italic col-span-3';
                            emptyMessage.textContent = 'No links in this group.';
                            linksGrid.appendChild(emptyMessage);
                        }

                        groupCard.appendChild(header);
                        groupCard.appendChild(linksGrid);
                        linkGroupsContainer.appendChild(groupCard);
                    });
                } else if (!isFallback) {
                    linkGroupsContainer.innerHTML = '<p class="w-full text-gray-500 text-center">No link groups found in data.</p>';
                }
            }


            /**
             * Initializes the dashboard by trying to fetch the external data,
             * or falling back to the embedded data on failure.
             */
            async function initDashboard() {
                let dashboardData = EMBEDDED_DATA;
                let isFallback = true;
                
                try {
                    const response = await fetch('./data.json');
                    
                    if (response.ok) {
                        dashboardData = await response.json();
                        isFallback = false;
                        console.log('Successfully loaded external data.json.');
                    } else {
                        console.warn(`External data.json returned status ${response.status}. Falling back to embedded data.`);
                    }
                } catch (error) {
                    console.error('Failed to fetch external data.json:', error.message);
                    console.warn('Falling back to embedded test data.');
                }

                renderDashboard(dashboardData, isFallback);
            }

            // Run the initialization function when the window loads
            window.onload = () => {
                populateTimezoneDropdown();
                initDashboard();
                startClockUpdate(); 
            }
        })(); // End of IIFE
    </script>

</body>
</html>
