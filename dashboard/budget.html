<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/images/budget_favicon.png">
    <title>Budget Tracker</title>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --panel-bg: #ffffff;
            --border-color: #e0e0e0;
            --text-main: #333;
            --accent-green: #2ecc71;
            --accent-red: #e74c3c;
            --accent-orange: #f39c12;
            --accent-blue: #3498db;
            --header-bg: #2c3e50;
            --header-text: #fff;
            --hover-bg: #f9f9f9;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding: 20px; 
            min-height: 100vh; box-sizing: border-box;
        }

        .container {
            display: grid; grid-template-columns: 65% 33%; gap: 2%; 
            height: auto; align-items: start;
        }

        /* --- BUTTONS --- */
        .btn { border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; transition: background 0.2s; }
        .btn-primary { background: var(--accent-green); color: white; }
        .btn-primary:hover { background: #27ae60; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-blue { background: var(--accent-blue); color: white; }
        .btn-blue:hover { background: #2980b9; }
        .btn-sm { padding: 2px 6px; font-size: 0.75rem; margin-left: 5px; }
        .btn-icon { background: transparent; color: #7f8c8d; }
        .btn-icon:hover { color: #2c3e50; background: #eee; }
        
        .action-btn {
            background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2);
            padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-left: 5px;
        }
        .action-btn:hover { background: rgba(255,255,255,0.2); }

        /* --- PANELS --- */
        .panel {
            background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px;
            display: flex; flex-direction: column; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px;
        }

        .panel-header {
            background-color: var(--header-bg); color: var(--header-text);
            padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            border-radius: 8px 8px 0 0;
        }

        .scroll-area { flex: 1; overflow: visible; }

        /* --- LEDGER TABLE --- */
        table.ledger-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; table-layout: fixed; }
        .ledger-table th {
            background: #eee; text-align: left; padding: 12px 10px; 
            position: sticky; top: 0; z-index: 100; border-bottom: 2px solid #ccc;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .ledger-table td {
            padding: 8px 10px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .ledger-row:hover { background-color: #f8f9fa; }

        .col-date { width: 12%; }
        .col-desc { width: 43%; }
        .col-amt  { width: 20%; text-align: right; }
        .col-bal  { width: 20%; text-align: right; }
        .col-act  { width: 5%; text-align: center; }

        .amount-text { font-family: monospace; font-size: 1rem;}
        .negative { color: var(--accent-red); }
        .positive { color: var(--accent-green); font-weight: bold; }
        .neutral { color: var(--accent-blue); }
        .ledger-icon { width: 32px; height: 32px; border-radius: 50%; vertical-align: middle; margin-right: 8px; object-fit: cover; border: 1px solid #ddd; }

        /* --- BUDGET --- */
        .cycle-section { border-bottom: 4px solid var(--border-color); }
        .cycle-header {
            background: #e0e0e0; padding: 10px 15px; font-weight: bold; font-size: 0.9rem; color: #444;
            display: flex; justify-content: space-between;
        }
        .budget-item { border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .budget-item:hover { background-color: var(--hover-bg); }

        .budget-summary {
            padding: 10px 15px; display: grid; grid-template-columns: auto 1fr auto auto auto; align-items: center; gap: 8px;
        }
        .budget-icon { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #eee; background: #fff; }
        .budget-bar-bg { height: 4px; width: 100%; background: #eee; margin-top: 4px; border-radius: 2px; overflow: hidden; }
        .budget-bar-fill { height: 100%; background: var(--accent-green); }
        .budget-bar-fill.warning { background: orange; }
        .budget-bar-fill.danger { background: var(--accent-red); }

        .budget-details {
            display: none; background-color: #fafafa; padding: 10px 15px 10px 55px; font-size: 0.85rem; border-top: 1px dashed #eee;
        }
        .budget-details.active { display: block; }

        /* --- SUMMARY DASHBOARD --- */
        .summary-dashboard {
            background: #fff; border-bottom: 1px solid #ddd; padding: 15px;
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px;
            position: sticky; top: 0; z-index: 90;
        }
        .summary-card {
            background: #f8f9fa; padding: 8px; border-radius: 6px; border: 1px solid #eee; text-align: center;
        }
        .summary-label { font-size: 0.75rem; text-transform: uppercase; color: #888; letter-spacing: 0.5px; }
        .summary-val { font-size: 1.1rem; font-weight: bold; font-family: monospace; }
        .sum-in { color: var(--accent-green); }
        .sum-out { color: var(--accent-red); }
        .sum-plan { color: var(--accent-orange); }
        .sum-proj { color: #333; }

        /* --- WATCHLIST --- */
        .watchlist-section {
            background-color: #fffde7; border-top: 2px solid #ffd600; padding: 15px; 
        }
        .watchlist-header { 
            font-weight:bold; color:#f57f17; margin-bottom: 10px; font-size: 1rem; 
            border-bottom: 1px solid #e0e0e0; padding-bottom: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .watchlist-math { font-size: 0.85rem; color: #555; background: rgba(255,255,255,0.6); padding: 4px 8px; border-radius: 4px; }
        .math-result { font-weight: bold; margin-left: 5px; }
        .math-result.positive { color: var(--accent-green); }
        .math-result.negative { color: var(--accent-red); }

        .watchlist-item {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.05); padding: 8px 0; font-size: 0.9rem;
        }
        .watchlist-icon { width: 24px; height: 24px; border-radius: 50%; vertical-align: middle; margin-right: 8px; object-fit: cover; border: 1px solid #ddd; }

        /* --- MODALS --- */
        dialog { border: none; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); padding: 0; width: 450px; }
        dialog::backdrop { background: rgba(0,0,0,0.5); }
        .modal-header { background: var(--header-bg); color: #fff; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .modal-footer { padding: 15px; background: #f9f9f9; text-align: right; border-top: 1px solid #eee; }

        /* Helpers */
        .income-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        .income-row input { flex: 1; }
        .income-preview { width: 30px; height: 30px; border-radius: 50%; border: 1px solid #ddd; object-fit: cover; }
        #split-container { background: #f8f9fa; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .split-line { display: flex; gap: 5px; margin-bottom: 5px; }
        .split-line select { flex: 2; }
        .split-line input { flex: 1; }
        .split-totals { font-weight: bold; text-align: right; font-size: 0.9rem; margin-top: 5px; }
        .split-err { color: red; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="container">
    
    <div class="panel">
        <div class="panel-header">
            <div style="display:flex; align-items:center;">
                <span id="period-name-display" style="font-size:1.1rem; font-weight:bold;">Ledger</span>
                <span id="ledger-header-info" style="font-weight:normal; font-size:0.9rem; margin-left:15px; opacity:0.9;"></span>
                
                <div style="margin-left: 20px; border-left: 1px solid rgba(255,255,255,0.3); padding-left:10px;">
                    <button class="action-btn" onclick="downloadData()" title="Save (Download JSON)">üíæ Save</button>
                    <button class="action-btn" onclick="document.getElementById('file-input').click()" title="Load JSON">üìÇ Load</button>
                    <button class="action-btn" onclick="openSettingsModal()" title="Settings">‚öôÔ∏è</button>
                    <input type="file" id="file-input" style="display:none" onchange="loadData(this)">
                </div>
                <span id="status-indicator" style="font-size:0.7rem; margin-left:10px; color:#aaa;"></span>
            </div>
            <button class="btn btn-primary" onclick="openTxModal()">+ Add Txn</button>
        </div>
        <div class="scroll-area">
            <table class="ledger-table">
                <thead>
                    <tr>
                        <th class="col-date">Date</th>
                        <th class="col-desc">Description</th>
                        <th class="col-amt">Amount</th>
                        <th class="col-bal">Balance</th>
                        <th class="col-act"></th>
                    </tr>
                </thead>
                <tbody id="ledger-body"></tbody>
            </table>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">
            <span style="font-size:1.1rem; font-weight:bold;">Budgets</span>
            <button class="btn btn-blue btn-sm" onclick="openTransferModal()">‚áÑ Transfer</button>
        </div>
        <div class="scroll-area" id="budget-container"></div>
        
        <div class="watchlist-section" id="watchlist-container">
            <div class="watchlist-header">
                <span>Upcoming Expenses</span>
                <div class="watchlist-math" id="watchlist-math-display"></div>
            </div>
            <div id="watchlist-list"></div>
        </div>

        <div style="padding:10px; border-top:1px solid #ddd; background:#fdfdfd;">
             <small style="color:#888; text-transform:uppercase; font-weight:bold;">Income Sources</small>
             <div id="income-sources-list" style="display:flex; gap:10px; margin-top:5px;"></div>
        </div>
    </div>
</div>

<dialog id="settings-modal">
    <div class="modal-header">
        <span>Settings</span>
        <span style="cursor:pointer;" onclick="closeSettingsModal()">‚úï</span>
    </div>
    <div class="modal-body">
        <div class="form-group">
            <label>Period Name (e.g. December 2025)</label>
            <input type="text" id="set-period-name">
        </div>
        <div class="form-group">
            <label>Starting Bank Balance</label>
            <input type="number" step="0.01" id="set-start-bal">
        </div>
        <hr>
        <div class="form-group">
            <label>Income Sources</label>
            <div id="income-rows-container"></div>
            <button class="btn btn-sm btn-secondary" style="margin-top:5px;" onclick="addIncomeRow()">+ Add Source</button>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveSettings()">Save Configuration</button>
    </div>
</dialog>

<dialog id="tx-modal">
    <div class="modal-header">
        <span id="tx-modal-title">Add Transaction</span>
        <span style="cursor:pointer;" onclick="closeTxModal()">‚úï</span>
    </div>
    <div class="modal-body">
        <input type="hidden" id="tx-id">
        <div class="form-group">
            <label>Date</label>
            <input type="date" id="tx-date">
        </div>
        <div class="form-group">
            <label>Type</label>
            <select id="tx-type" onchange="toggleTxType()">
                <option value="expense">Expense</option>
                <option value="income">Income</option>
            </select>
        </div>
        <div class="form-group">
            <label>Amount</label>
            <input type="number" step="0.01" id="tx-amount" oninput="updateSplitMath()">
        </div>
        <div class="form-group">
            <label>Description</label>
            <input type="text" id="tx-desc" placeholder="e.g. Walmart">
        </div>
        
        <div class="form-group" id="group-category">
            <label id="lbl-category">
                Budget Category 
                <span id="lbl-split-link" style="font-size:0.8rem; color:#2980b9; cursor:pointer; float:right;" onclick="toggleSplitMode()">Need to Split?</span>
            </label>
            <select id="tx-category"></select>
        </div>

        <div class="form-group" id="group-split" style="display:none;">
            <label>Split Details <span style="font-size:0.8rem; color:red; cursor:pointer; float:right;" onclick="toggleSplitMode()">Cancel Split</span></label>
            <div id="split-container">
                <div id="split-lines"></div>
                <button class="btn btn-sm btn-secondary" onclick="addSplitLine()">+ Add Split</button>
                <div class="split-totals">
                    Total: <span id="split-total-disp">0.00</span> / Remaining: <span id="split-rem-disp" class="split-err">0.00</span>
                </div>
            </div>
        </div>

        <div class="form-group" id="group-income-source" style="display:none;">
            <label>Income Source</label>
            <select id="tx-income-source"></select>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-icon" onclick="closeTxModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveTransaction()">Save</button>
    </div>
</dialog>

<dialog id="budget-modal">
    <div class="modal-header">
        <span id="budget-modal-title">Edit Budget Item</span>
        <span style="cursor:pointer;" onclick="closeBudgetModal()">‚úï</span>
    </div>
    <div class="modal-body">
        <input type="hidden" id="b-id">
        <input type="hidden" id="b-cycle-id">
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="b-name">
        </div>
        <div class="form-group">
            <label>Planned Amount</label>
            <input type="number" step="0.01" id="b-planned">
        </div>
        <div class="form-group">
            <label>Carried Over</label>
            <input type="number" step="0.01" id="b-carried">
        </div>
        <div class="form-group">
            <label>Icon URL</label>
            <input type="text" id="b-image" placeholder="http://...">
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-icon" onclick="closeBudgetModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveBudgetItem()">Save</button>
    </div>
</dialog>

<dialog id="watch-modal">
    <div class="modal-header">
        <span>Plan Upcoming Expense</span>
        <span style="cursor:pointer;" onclick="document.getElementById('watch-modal').close()">‚úï</span>
    </div>
    <div class="modal-body">
        <input type="hidden" id="w-image">
        <div class="form-group">
            <label>Description</label>
            <input type="text" id="w-desc">
        </div>
        <div class="form-group">
            <label>Expected Amount</label>
            <input type="number" step="0.01" id="w-amount">
        </div>
        <div class="form-group">
            <label>Due Date</label>
            <input type="date" id="w-date">
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveWatchItem()">Add to Watchlist</button>
    </div>
</dialog>

<dialog id="transfer-modal">
    <div class="modal-header">
        <span>Transfer Funds</span>
        <span style="cursor:pointer;" onclick="document.getElementById('transfer-modal').close()">‚úï</span>
    </div>
    <div class="modal-body">
        <div class="form-group">
            <label>From Budget</label>
            <select id="tr-from"></select>
        </div>
        <div class="form-group">
            <label>To Budget</label>
            <select id="tr-to"></select>
        </div>
        <div class="form-group">
            <label>Amount</label>
            <input type="number" step="0.01" id="tr-amount">
        </div>
        <div class="form-group">
            <label>Note (Optional)</label>
            <input type="text" id="tr-note" placeholder="e.g. Needed more for gas">
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-blue" onclick="saveTransfer()">Transfer</button>
    </div>
</dialog>

<script>
    let appData = { periods: [] };

    // --- INIT & IO ---
    async function init() {
        const statusEl = document.getElementById('status-indicator');
        try {
            const response = await fetch('./budget.json');
            if (!response.ok) throw new Error("No budget.json found");
            appData = await response.json();
            statusEl.textContent = "‚úì Synced"; statusEl.style.color = "#2ecc71";
            saveSession();
            renderApp();
        } catch (err) {
            console.warn("Could not auto-load budget.json:", err);
            statusEl.textContent = "‚ö† Local/Offline"; statusEl.style.color = "#f1c40f";
            const saved = localStorage.getItem('budget_backup');
            if(saved) { appData = JSON.parse(saved); renderApp(); }
            else { renderEmptyState(); }
        }
    }

    function saveSession() { localStorage.setItem('budget_backup', JSON.stringify(appData)); }

    function downloadData() {
        saveSession();
        const dataStr = JSON.stringify(appData, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = "budget.json";
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function loadData(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                appData = JSON.parse(e.target.result);
                renderApp();
                saveSession();
                document.getElementById('status-indicator').textContent = "‚úì File Loaded";
            } catch(err) {
                alert("Error loading file: " + err.message);
            }
        };
        reader.readAsText(file);
        input.value = '';
    }

    const formatMoney = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n);
    const getPeriod = () => appData.periods && appData.periods.length > 0 ? appData.periods[0] : null; 

    function renderApp() {
        const period = getPeriod();
        if (!period) { renderEmptyState(); return; }

        document.getElementById('period-name-display').textContent = period.displayName || "Ledger";

        const usage = {};
        const incomeAlloc = {};
        const details = {}; 
        const transferAdj = {}; // New: Track net transfers per budget

        let totalIncome = 0;
        let totalSpent = 0;
        let totalPlanned = 0;

        if(period.paycheckCycles) {
            period.paycheckCycles.forEach(c => c.budgetItems.forEach(i => details[i.id] = []));
        }

        // Process Ledger
        period.ledger.forEach(txn => {
            const addDet = (bid, amt, note, type) => {
                if(!details[bid]) details[bid] = [];
                details[bid].push({ date: txn.date, desc: note || txn.description, amount: amt, type: type });
            };

            if (txn.type === 'expense') {
                totalSpent += Math.abs(txn.amount);
                if(txn.splits) {
                    txn.splits.forEach(s => {
                        usage[s.linkedBudgetItemId] = (usage[s.linkedBudgetItemId] || 0) + Math.abs(s.amount);
                        addDet(s.linkedBudgetItemId, -Math.abs(s.amount), s.note || "Split", 'expense');
                    });
                } else if (txn.linkedBudgetItemId) {
                    usage[txn.linkedBudgetItemId] = (usage[txn.linkedBudgetItemId] || 0) + Math.abs(txn.amount);
                    addDet(txn.linkedBudgetItemId, -Math.abs(txn.amount), null, 'expense');
                }
            } else if (txn.type === 'income') {
                totalIncome += Math.abs(txn.amount);
                if(txn.linkedBudgetItemId) {
                    incomeAlloc[txn.linkedBudgetItemId] = (incomeAlloc[txn.linkedBudgetItemId] || 0) + Math.abs(txn.amount);
                    addDet(txn.linkedBudgetItemId, Math.abs(txn.amount), null, 'income');
                }
            }
        });

        // Process Transfers (Internal Only - Not in Ledger)
        if(period.transfers) {
            period.transfers.forEach(tr => {
                // Adjust Math
                transferAdj[tr.fromId] = (transferAdj[tr.fromId] || 0) - tr.amount;
                transferAdj[tr.toId] = (transferAdj[tr.toId] || 0) + tr.amount;

                // Add Details for audit
                const dateStr = tr.date ? tr.date.substring(5) : '';
                if(details[tr.fromId]) details[tr.fromId].push({ date: dateStr, desc: `Transfer to ${getBudgetName(tr.toId)}`, amount: -tr.amount, type: 'transfer-out' });
                if(details[tr.toId]) details[tr.toId].push({ date: dateStr, desc: `Transfer from ${getBudgetName(tr.fromId)}`, amount: tr.amount, type: 'transfer-in' });
            });
        }

        if(period.watchList) {
            period.watchList.forEach(w => totalPlanned += w.amount);
        }

        // --- Math & Dashboard ---
        const startBal = period.initialBankBalance;
        const netCash = startBal + totalIncome - totalSpent;
        const projected = netCash - totalPlanned;
        
        const mathEl = document.getElementById('watchlist-math-display');
        const projClass = projected < 0 ? 'negative' : 'positive';
        mathEl.innerHTML = `
            <span title="Net Cash (Start + Inc - Exp)">${formatMoney(netCash)}</span> - 
            <span title="Planned">${formatMoney(totalPlanned)}</span> = 
            <span class="math-result ${projClass}">${formatMoney(projected)}</span>
        `;

        document.getElementById('sum-in').textContent = formatMoney(totalIncome);
        document.getElementById('sum-out').textContent = formatMoney(totalSpent);
        document.getElementById('sum-plan').textContent = formatMoney(totalPlanned);
        document.getElementById('sum-proj').textContent = formatMoney(projected);
        document.getElementById('sum-proj').style.color = projected < 0 ? '#e74c3c' : '#333';

        const imgMap = {};
        if(period.incomeSources) period.incomeSources.forEach(i => imgMap[i.id] = i.image);
        if(period.paycheckCycles) period.paycheckCycles.forEach(c => c.budgetItems.forEach(b => imgMap[b.id] = b.image));

        // Ledger Render
        const tbody = document.getElementById('ledger-body');
        tbody.innerHTML = '';
        let balance = period.initialBankBalance;
        const sorted = [...period.ledger].sort((a,b) => a.date.localeCompare(b.date));

        sorted.forEach(txn => {
            balance += txn.amount;
            const tr = document.createElement('tr');
            tr.className = 'ledger-row';
            let iconUrl = '';
            if(txn.type === 'income' && txn.sourceId) iconUrl = imgMap[txn.sourceId];
            else if(txn.linkedBudgetItemId) iconUrl = imgMap[txn.linkedBudgetItemId];
            else if(txn.splits) iconUrl = 'https://placehold.co/40x40/999/white?text=S'; 
            
            const iconHtml = iconUrl ? `<img src="${iconUrl}" class="ledger-icon">` : '<span style="display:inline-block;width:40px;"></span>';
            const amtClass = txn.amount >= 0 ? 'positive' : 'negative';

            tr.innerHTML = `
                <td class="col-date">${txn.date.substring(5)}</td>
                <td class="col-desc">${iconHtml}${txn.description} ${txn.splits?'<small>(Split)</small>':''}</td>
                <td class="col-amt ${amtClass}">${formatMoney(txn.amount)}</td>
                <td class="col-bal">${formatMoney(balance)}</td>
                <td class="col-act"><button class="btn btn-icon" onclick="openTxModal('${txn.id}')">‚úé</button></td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById('ledger-header-info').innerHTML = `Start: <b>${formatMoney(period.initialBankBalance)}</b> | Current: <b>${formatMoney(balance)}</b>`;

        // Budget Render
        const budgetContainer = document.getElementById('budget-container');
        budgetContainer.innerHTML = '';

        if(period.paycheckCycles) {
            period.paycheckCycles.forEach(cycle => {
                const section = document.createElement('div');
                section.className = 'cycle-section';
                section.innerHTML = `
                    <div class="cycle-header">
                        <span>${cycle.label}</span>
                        <button class="btn btn-sm btn-icon" onclick="openBudgetModal(null, ${cycle.cycleId})">+ Add Item</button>
                    </div>`;

                cycle.budgetItems.forEach(item => {
                    const spent = usage[item.id] || 0;
                    const received = incomeAlloc[item.id] || 0;
                    const transfers = transferAdj[item.id] || 0;
                    
                    const total = item.plannedAmount + item.carriedOver + received + transfers;
                    const remaining = total - spent;
                    
                    const percent = total > 0 ? Math.min(100, (spent/total)*100) : 0;
                    let color = 'budget-bar-fill';
                    if(percent > 90) color += ' warning';
                    if(remaining < 0) color += ' danger';

                    const myTxns = details[item.id] || [];
                    const detailHtml = myTxns.map(t => {
                        let colorClass = 'inherit';
                        let prefix = '';
                        if(t.type === 'income' || t.type === 'transfer-in') { colorClass = 'green'; prefix = '+'; }
                        if(t.type === 'transfer-out') { colorClass = 'orange'; } 
                        
                        return `
                        <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#555; margin-bottom:2px;">
                            <span>${t.date} ${t.desc}</span>
                            <span style="font-family:monospace; color:${colorClass}">
                                ${prefix}${formatMoney(t.amount)}
                            </span>
                        </div>
                    `}).join('');

                    const div = document.createElement('div');
                    div.className = 'budget-item';
                    div.innerHTML = `
                        <div class="budget-summary" onclick="this.nextElementSibling.classList.toggle('active')">
                            <img src="${item.image}" class="budget-icon">
                            <div>
                                <span style="font-weight:600">${item.name}</span>
                                <div class="budget-bar-bg"><div class="${color}" style="width:${percent}%"></div></div>
                            </div>
                            <div style="text-align:right">
                                <div class="amount-text ${remaining<0?'negative':''}">${formatMoney(remaining)}</div>
                                <div style="font-size:0.75rem; color:#999;">of ${formatMoney(total)}</div>
                            </div>
                            <button class="btn btn-icon" title="Plan Expense" onclick="event.stopPropagation(); openWatchModal('${item.name}', ${remaining}, '${item.image}')">‚è±</button>
                            <button class="btn btn-icon" title="Edit Item" onclick="event.stopPropagation(); openBudgetModal('${item.id}', ${cycle.cycleId})">‚úé</button>
                        </div>
                        <div class="budget-details">
                            <div style="margin-bottom:5px; border-bottom:1px solid #eee; padding-bottom:5px;">
                                <strong>Plan:</strong> ${formatMoney(item.plannedAmount)} | 
                                <strong>Carry:</strong> ${formatMoney(item.carriedOver)} | 
                                <strong style="color:green">Credits:</strong> ${formatMoney(received)} | 
                                <strong style="color:blue">Transfers:</strong> ${formatMoney(transfers)}
                            </div>
                            ${detailHtml || '<i>No transactions</i>'}
                        </div>
                    `;
                    section.appendChild(div);
                });
                budgetContainer.appendChild(section);
            });
        }

        const wContainer = document.getElementById('watchlist-list');
        wContainer.innerHTML = '';
        if(period.watchList) {
            period.watchList.forEach((w, idx) => {
                const div = document.createElement('div');
                div.className = 'watchlist-item';
                const iconHtml = w.image ? `<img src="${w.image}" class="watchlist-icon">` : '';
                div.innerHTML = `
                    <span style="display:flex; align-items:center;">
                        ${iconHtml}
                        <span>
                            <strong>${w.description}</strong> <span style="font-size:0.8rem; color:#888;">Due ${w.dueDate}</span>
                        </span>
                    </span>
                    <span>
                        <b>${formatMoney(w.amount)}</b>
                        <button class="btn btn-sm btn-icon" onclick="deleteWatchItem(${idx})">‚úï</button>
                    </span>
                `;
                wContainer.appendChild(div);
            });
        }

        const incContainer = document.getElementById('income-sources-list');
        if(period.incomeSources) {
            incContainer.innerHTML = period.incomeSources.map(i => `<img src="${i.image}" title="${i.name}" style="width:30px;height:30px;border-radius:50%;border:1px solid #ccc;">`).join('');
        }
    }

    function getBudgetName(id) {
        const period = getPeriod();
        let name = 'Unknown';
        period.paycheckCycles.forEach(c => c.budgetItems.forEach(b => { if(b.id === id) name = b.name; }));
        return name;
    }

    function renderEmptyState() {
        appData = {
            "periods": [{
                "id": new Date().toISOString().slice(0,7),
                "displayName": "Current Budget",
                "initialBankBalance": 0,
                "incomeSources": [],
                "paycheckCycles": [{ "cycleId": 1, "label": "Paycheck 1", "budgetItems": [] }],
                "ledger": [],
                "watchList": [],
                "transfers": []
            }]
        };
    }

    function openSettingsModal() {
        const period = getPeriod();
        if(!period) return;
        document.getElementById('set-period-name').value = period.displayName || '';
        document.getElementById('set-start-bal').value = period.initialBankBalance;
        const container = document.getElementById('income-rows-container');
        container.innerHTML = '';
        if(period.incomeSources) {
            period.incomeSources.forEach(inc => renderIncomeRow(inc.id, inc.name, inc.image));
        }
        document.getElementById('settings-modal').showModal();
    }
    
    function closeSettingsModal() { document.getElementById('settings-modal').close(); }

    function renderIncomeRow(id, name, img) {
        const container = document.getElementById('income-rows-container');
        const div = document.createElement('div');
        div.className = 'income-row';
        div.innerHTML = `
            <img src="${img}" class="income-preview">
            <input type="text" placeholder="Name" value="${name}" class="inc-name" data-id="${id}">
            <input type="text" placeholder="Image URL" value="${img}" class="inc-img">
            <button class="btn btn-sm btn-icon" onclick="this.parentElement.remove()">‚úï</button>
        `;
        container.appendChild(div);
    }
    function addIncomeRow() { renderIncomeRow('inc'+Date.now(), 'New Source', 'https://placehold.co/40x40/gray/white?text=$'); }
    function saveSettings() {
        const period = getPeriod();
        period.displayName = document.getElementById('set-period-name').value;
        period.initialBankBalance = parseFloat(document.getElementById('set-start-bal').value);
        const newSources = [];
        document.querySelectorAll('.income-row').forEach(row => {
            newSources.push({
                id: row.querySelector('.inc-name').dataset.id,
                name: row.querySelector('.inc-name').value,
                image: row.querySelector('.inc-img').value
            });
        });
        period.incomeSources = newSources;
        closeSettingsModal();
        renderApp();
        saveSession(); 
    }

    let isSplitMode = false;
    function toggleTxType() {
        const type = document.getElementById('tx-type').value;
        const catGroup = document.getElementById('group-category');
        const incGroup = document.getElementById('group-income-source');
        const splitLink = document.getElementById('lbl-split-link');
        const lblCat = document.getElementById('lbl-category');
        
        if (type === 'expense') {
            catGroup.style.display = isSplitMode ? 'none' : 'block';
            document.getElementById('group-split').style.display = isSplitMode ? 'block' : 'none';
            incGroup.style.display = 'none';
            lblCat.firstChild.textContent = "Budget Category";
            splitLink.style.display = "inline";
        } else {
            catGroup.style.display = 'block'; 
            document.getElementById('group-split').style.display = 'none';
            incGroup.style.display = 'block';
            lblCat.firstChild.textContent = "Credit to Budget (Optional)";
            splitLink.style.display = "none";
            isSplitMode = false;
        }
    }

    function toggleSplitMode() {
        isSplitMode = !isSplitMode;
        if(isSplitMode) {
            const lines = document.getElementById('split-lines');
            if(lines.children.length === 0) { addSplitLine(); addSplitLine(); }
        }
        toggleTxType();
        updateSplitMath();
    }

    function addSplitLine(budgetId = '', amount = '', note = '') {
        const lines = document.getElementById('split-lines');
        const period = getPeriod();
        let opts = '<option value="">-- Select --</option>';
        period.paycheckCycles.forEach(c => c.budgetItems.forEach(b => {
            const sel = b.id === budgetId ? 'selected' : '';
            opts += `<option value="${b.id}" ${sel}>${b.name}</option>`;
        }));
        const div = document.createElement('div');
        div.className = 'split-line';
        div.innerHTML = `
            <select class="split-cat">${opts}</select>
            <input type="number" step="0.01" class="split-amt" placeholder="0.00" value="${amount}" oninput="updateSplitMath()">
            <input type="text" class="split-note" placeholder="Note" value="${note}">
            <button class="btn btn-sm btn-icon" onclick="this.parentElement.remove(); updateSplitMath()">‚úï</button>
        `;
        lines.appendChild(div);
    }

    function updateSplitMath() {
        if(!isSplitMode) return;
        const totalTxAmt = parseFloat(document.getElementById('tx-amount').value) || 0;
        let runningTotal = 0;
        document.querySelectorAll('.split-amt').forEach(inp => runningTotal += parseFloat(inp.value) || 0);
        document.getElementById('split-total-disp').innerText = runningTotal.toFixed(2);
        const rem = totalTxAmt - runningTotal;
        const remSpan = document.getElementById('split-rem-disp');
        remSpan.innerText = rem.toFixed(2);
        if(Math.abs(rem) < 0.01) { remSpan.style.color = 'green'; remSpan.innerText = "Balanced"; } else { remSpan.style.color = 'red'; }
    }

    function openTxModal(txId = null) {
        const period = getPeriod();
        if(!period) return;
        const modal = document.getElementById('tx-modal');
        const isEdit = !!txId;
        isSplitMode = false;
        
        const catSelect = document.getElementById('tx-category');
        catSelect.innerHTML = '<option value="">-- None --</option>';
        period.paycheckCycles.forEach(c => c.budgetItems.forEach(b => {
            catSelect.innerHTML += `<option value="${b.id}">${b.name} (${c.label})</option>`;
        }));
        const incSelect = document.getElementById('tx-income-source');
        incSelect.innerHTML = '<option value="">-- Select Source --</option>';
        if(period.incomeSources) period.incomeSources.forEach(i => incSelect.innerHTML += `<option value="${i.id}">${i.name}</option>`);

        document.getElementById('split-lines').innerHTML = '';

        if(isEdit) {
            const tx = period.ledger.find(t => t.id === txId);
            document.getElementById('tx-modal-title').textContent = "Edit Transaction";
            document.getElementById('tx-id').value = tx.id;
            document.getElementById('tx-date').value = tx.date;
            document.getElementById('tx-amount').value = Math.abs(tx.amount);
            document.getElementById('tx-desc').value = tx.description;
            document.getElementById('tx-type').value = tx.type;
            
            if(tx.splits) {
                isSplitMode = true;
                tx.splits.forEach(s => addSplitLine(s.linkedBudgetItemId, Math.abs(s.amount), s.note));
            } else {
                if(tx.linkedBudgetItemId) catSelect.value = tx.linkedBudgetItemId;
                if(tx.type === 'income') incSelect.value = tx.sourceId || '';
            }
        } else {
            document.getElementById('tx-modal-title').textContent = "New Transaction";
            document.getElementById('tx-id').value = '';
            document.getElementById('tx-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('tx-amount').value = '';
            document.getElementById('tx-desc').value = '';
        }
        toggleTxType();
        updateSplitMath();
        modal.showModal();
    }

    function closeTxModal() { document.getElementById('tx-modal').close(); }

    function saveTransaction() {
        const period = getPeriod();
        const id = document.getElementById('tx-id').value;
        const type = document.getElementById('tx-type').value;
        const amountVal = parseFloat(document.getElementById('tx-amount').value);
        const finalAmount = type === 'expense' ? -Math.abs(amountVal) : Math.abs(amountVal);
        
        const newTx = {
            id: id || 't' + Date.now(),
            date: document.getElementById('tx-date').value,
            description: document.getElementById('tx-desc').value,
            amount: finalAmount,
            type: type
        };

        if(type === 'expense') {
            if(isSplitMode) {
                newTx.splits = [];
                document.querySelectorAll('.split-line').forEach(line => {
                    newTx.splits.push({
                        linkedBudgetItemId: line.querySelector('.split-cat').value,
                        amount: -Math.abs(parseFloat(line.querySelector('.split-amt').value)),
                        note: line.querySelector('.split-note').value
                    });
                });
                newTx.linkedBudgetItemId = null;
            } else {
                newTx.linkedBudgetItemId = document.getElementById('tx-category').value;
                newTx.splits = null;
            }
        } else {
            newTx.sourceId = document.getElementById('tx-income-source').value;
            newTx.linkedBudgetItemId = document.getElementById('tx-category').value || null; 
        }

        if(id) {
            const index = period.ledger.findIndex(t => t.id === id);
            period.ledger[index] = newTx;
        } else {
            period.ledger.push(newTx);
        }
        closeTxModal();
        renderApp();
        saveSession();
    }

    function openBudgetModal(itemId, cycleId) {
        const modal = document.getElementById('budget-modal');
        const period = getPeriod();
        document.getElementById('b-cycle-id').value = cycleId;

        if(itemId) {
            let item;
            period.paycheckCycles.forEach(c => {
                const found = c.budgetItems.find(b => b.id === itemId);
                if(found) item = found;
            });
            document.getElementById('budget-modal-title').textContent = "Edit Item";
            document.getElementById('b-id').value = item.id;
            document.getElementById('b-name').value = item.name;
            document.getElementById('b-planned').value = item.plannedAmount;
            document.getElementById('b-carried').value = item.carriedOver;
            document.getElementById('b-image').value = item.image;
        } else {
            document.getElementById('budget-modal-title').textContent = "New Item";
            document.getElementById('b-id').value = '';
            document.getElementById('b-name').value = '';
            document.getElementById('b-planned').value = 0;
            document.getElementById('b-carried').value = 0;
            document.getElementById('b-image').value = 'https://placehold.co/40x40/gray/white?text=?';
        }
        modal.showModal();
    }
    function closeBudgetModal() { document.getElementById('budget-modal').close(); }
    function saveBudgetItem() {
        const period = getPeriod();
        const id = document.getElementById('b-id').value;
        const cycleId = parseInt(document.getElementById('b-cycle-id').value);
        const newItem = {
            id: id || 'b' + Date.now(),
            name: document.getElementById('b-name').value,
            plannedAmount: parseFloat(document.getElementById('b-planned').value),
            carriedOver: parseFloat(document.getElementById('b-carried').value),
            image: document.getElementById('b-image').value
        };
        const cycle = period.paycheckCycles.find(c => c.cycleId === cycleId);
        if(id) {
            const idx = cycle.budgetItems.findIndex(b => b.id === id);
            cycle.budgetItems[idx] = newItem;
        } else {
            cycle.budgetItems.push(newItem);
        }
        closeBudgetModal();
        renderApp();
        saveSession();
    }

    function openWatchModal(defaultDesc, defaultAmt, image) {
        document.getElementById('w-desc').value = defaultDesc || '';
        document.getElementById('w-amount').value = defaultAmt > 0 ? defaultAmt : '';
        document.getElementById('w-date').value = '';
        document.getElementById('w-image').value = image || '';
        document.getElementById('watch-modal').showModal();
    }
    function saveWatchItem() {
        const period = getPeriod();
        if(!period.watchList) period.watchList = [];
        period.watchList.push({
            description: document.getElementById('w-desc').value,
            amount: parseFloat(document.getElementById('w-amount').value) || 0,
            dueDate: document.getElementById('w-date').value || 'TBD',
            image: document.getElementById('w-image').value
        });
        document.getElementById('watch-modal').close();
        renderApp();
        saveSession();
    }
    function deleteWatchItem(idx) {
        const period = getPeriod();
        period.watchList.splice(idx, 1);
        renderApp();
        saveSession();
    }

    // --- TRANSFER LOGIC ---
    function openTransferModal() {
        const period = getPeriod();
        const fromSel = document.getElementById('tr-from');
        const toSel = document.getElementById('tr-to');
        fromSel.innerHTML = '<option value="">-- Select Source --</option>';
        toSel.innerHTML = '<option value="">-- Select Target --</option>';
        
        period.paycheckCycles.forEach(c => c.budgetItems.forEach(b => {
            const opt = `<option value="${b.id}">${b.name}</option>`;
            fromSel.innerHTML += opt;
            toSel.innerHTML += opt;
        }));
        
        document.getElementById('tr-amount').value = '';
        document.getElementById('tr-note').value = '';
        document.getElementById('transfer-modal').showModal();
    }

    function saveTransfer() {
        const period = getPeriod();
        const fromId = document.getElementById('tr-from').value;
        const toId = document.getElementById('tr-to').value;
        const amount = parseFloat(document.getElementById('tr-amount').value);
        const note = document.getElementById('tr-note').value;

        if(!fromId || !toId || !amount || fromId === toId) {
            alert("Please select valid budgets and amount");
            return;
        }

        if(!period.transfers) period.transfers = [];
        period.transfers.push({
            id: 'tr'+Date.now(),
            fromId: fromId,
            toId: toId,
            amount: amount,
            note: note,
            date: new Date().toISOString().split('T')[0]
        });

        document.getElementById('transfer-modal').close();
        renderApp();
        saveSession();
    }

    init();
</script>
</body>
</html>
