<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Tracker Pro</title>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --panel-bg: #ffffff;
            --border-color: #e0e0e0;
            --text-main: #333;
            --accent-green: #2ecc71;
            --accent-red: #e74c3c;
            --header-bg: #2c3e50;
            --header-text: #fff;
            --hover-bg: #f9f9f9;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
        }

        .container {
            display: grid;
            grid-template-columns: 65% 33%;
            gap: 2%;
            height: 95%;
        }

        /* --- BUTTONS --- */
        .btn {
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }
        .btn-primary { background: var(--accent-green); color: white; }
        .btn-primary:hover { background: #27ae60; }
        .btn-sm { padding: 2px 6px; font-size: 0.75rem; margin-left: 5px; }
        .btn-icon { background: transparent; color: #7f8c8d; }
        .btn-icon:hover { color: #2c3e50; background: #eee; }

        /* --- PANELS --- */
        .panel {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .panel-header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scroll-area { flex: 1; overflow-y: auto; }

        /* --- LEDGER TABLE --- */
        table.ledger-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            table-layout: fixed;
        }

        .ledger-table th {
            background: #eee;
            text-align: left;
            padding: 12px 10px;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #ccc;
        }

        .ledger-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .ledger-row:hover { background-color: #f8f9fa; }

        .col-date { width: 12%; }
        .col-desc { width: 43%; }
        .col-amt  { width: 20%; text-align: right; }
        .col-bal  { width: 20%; text-align: right; }
        .col-act  { width: 5%; text-align: center; }

        .amount-text { font-family: monospace; font-size: 1rem;}
        .negative { color: var(--accent-red); }
        .positive { color: var(--accent-green); font-weight: bold; }
        
        .ledger-icon {
            width: 20px; height: 20px;
            border-radius: 50%;
            vertical-align: middle;
            margin-right: 8px;
            object-fit: cover;
            border: 1px solid #ddd;
        }

        /* --- BUDGET --- */
        .cycle-section { border-bottom: 4px solid var(--border-color); }
        .cycle-header {
            background: #e0e0e0; padding: 10px 15px;
            font-weight: bold; font-size: 0.9rem; color: #444;
            display: flex; justify-content: space-between;
        }
        
        .budget-item {
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        .budget-item:hover { background-color: var(--hover-bg); }

        .budget-summary {
            padding: 10px 15px;
            display: grid;
            grid-template-columns: auto 1fr auto auto; /* Added generic 'auto' for edit button */
            align-items: center;
            gap: 10px;
        }

        .budget-icon {
            width: 32px; height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #eee;
            background: #fff;
        }

        .budget-bar-bg {
            height: 4px; width: 100%; background: #eee;
            margin-top: 4px; border-radius: 2px; overflow: hidden;
        }
        .budget-bar-fill { height: 100%; background: var(--accent-green); }
        .budget-bar-fill.warning { background: orange; }
        .budget-bar-fill.danger { background: var(--accent-red); }

        .budget-details {
            display: none; background-color: #fafafa;
            padding: 10px 15px 10px 55px; font-size: 0.85rem;
            border-top: 1px dashed #eee;
        }
        .budget-details.active { display: block; }
        .detail-row { display: flex; justify-content: space-between; padding: 3px 0; color: #666; }

        /* --- MODAL --- */
        dialog {
            border: none;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            padding: 0;
            width: 400px;
        }
        dialog::backdrop { background: rgba(0,0,0,0.5); }
        
        .modal-header {
            background: var(--header-bg); color: #fff;
            padding: 15px; font-weight: bold;
            display: flex; justify-content: space-between;
        }
        .modal-body { padding: 20px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: 500; }
        .form-group input, .form-group select {
            width: 100%; padding: 8px;
            border: 1px solid #ccc; border-radius: 4px;
            box-sizing: border-box;
        }
        .modal-footer {
            padding: 15px; background: #f9f9f9; text-align: right;
            border-top: 1px solid #eee;
        }

    </style>
</head>
<body>

<div class="container">
    
    <div class="panel">
        <div class="panel-header">
            <div>
                <span style="font-size:1.1rem; font-weight:bold;">Ledger</span>
                <span id="ledger-header-info" style="font-weight:normal; font-size:0.9rem; margin-left:15px; opacity:0.9;"></span>
            </div>
            <button class="btn btn-primary" onclick="openTxModal()">+ Add Txn</button>
        </div>
        <div class="scroll-area">
            <table class="ledger-table">
                <thead>
                    <tr>
                        <th class="col-date">Date</th>
                        <th class="col-desc">Description</th>
                        <th class="col-amt">Amount</th>
                        <th class="col-bal">Balance</th>
                        <th class="col-act"></th>
                    </tr>
                </thead>
                <tbody id="ledger-body"></tbody>
            </table>
        </div>
    </div>

    <div class="panel">
        <div class="panel-header">
            <span style="font-size:1.1rem; font-weight:bold;">Budgets</span>
        </div>
        <div class="scroll-area" id="budget-container"></div>
        
        <div style="padding:10px; border-top:1px solid #ddd; background:#fdfdfd;">
             <small style="color:#888; text-transform:uppercase; font-weight:bold;">Configured Income Sources</small>
             <div id="income-sources-list" style="display:flex; gap:10px; margin-top:5px;"></div>
        </div>
    </div>
</div>

<dialog id="tx-modal">
    <div class="modal-header">
        <span id="tx-modal-title">Add Transaction</span>
        <span style="cursor:pointer;" onclick="closeTxModal()">✕</span>
    </div>
    <div class="modal-body">
        <input type="hidden" id="tx-id">
        <div class="form-group">
            <label>Date</label>
            <input type="date" id="tx-date">
        </div>
        <div class="form-group">
            <label>Type</label>
            <select id="tx-type" onchange="toggleTxType()">
                <option value="expense">Expense</option>
                <option value="income">Income</option>
            </select>
        </div>
        <div class="form-group">
            <label>Amount</label>
            <input type="number" step="0.01" id="tx-amount">
        </div>
        <div class="form-group">
            <label>Description</label>
            <input type="text" id="tx-desc" placeholder="e.g. Walmart">
        </div>
        
        <div class="form-group" id="group-category">
            <label>Budget Category</label>
            <select id="tx-category">
                </select>
        </div>

        <div class="form-group" id="group-income-source" style="display:none;">
            <label>Income Source</label>
            <select id="tx-income-source">
                </select>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-icon" onclick="closeTxModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveTransaction()">Save</button>
    </div>
</dialog>

<dialog id="budget-modal">
    <div class="modal-header">
        <span id="budget-modal-title">Edit Budget Item</span>
        <span style="cursor:pointer;" onclick="closeBudgetModal()">✕</span>
    </div>
    <div class="modal-body">
        <input type="hidden" id="b-id">
        <input type="hidden" id="b-cycle-id">
        <div class="form-group">
            <label>Name</label>
            <input type="text" id="b-name">
        </div>
        <div class="form-group">
            <label>Planned Amount</label>
            <input type="number" step="0.01" id="b-planned">
        </div>
        <div class="form-group">
            <label>Carried Over (Saved from prev months)</label>
            <input type="number" step="0.01" id="b-carried">
        </div>
        <div class="form-group">
            <label>Icon URL</label>
            <input type="text" id="b-image" placeholder="http://...">
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-icon" onclick="closeBudgetModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveBudgetItem()">Save</button>
    </div>
</dialog>

<script>
    // --- 1. DATA ---
    const appData = {
        "periods": [{
            "id": "2025-12",
            "initialBankBalance": 3500.00,
            
            "incomeSources": [
                { "id": "inc1", "name": "Paycheck (Stephens)", "image": "https://placehold.co/40x40/2ecc71/white?text=$" },
                { "id": "inc2", "name": "Consulting", "image": "https://placehold.co/40x40/27ae60/white?text=C" }
            ],

            "paycheckCycles": [
                {
                    "cycleId": 1, "label": "Paycheck Set 1 (Nov 21)",
                    "budgetItems": [
                        { "id": "b1", "name": "Groceries", "plannedAmount": 400, "carriedOver": 25.50, "image": "https://placehold.co/40x40/orange/white?text=G" },
                        { "id": "b2", "name": "Personal", "plannedAmount": 50, "carriedOver": 0, "image": "https://placehold.co/40x40/3498db/white?text=P" },
                        { "id": "b3", "name": "Mortgage", "plannedAmount": 2400, "carriedOver": 0, "image": "https://placehold.co/40x40/2c3e50/white?text=M" }
                    ]
                },
                {
                    "cycleId": 2, "label": "Paycheck Set 2 (Dec 05)",
                    "budgetItems": [
                        { "id": "b4", "name": "Electric", "plannedAmount": 180, "carriedOver": 0, "image": "https://placehold.co/40x40/f1c40f/white?text=E" }
                    ]
                }
            ],

            "ledger": [
                { "id": "t1", "date": "2025-11-21", "description": "Paycheck", "amount": 3500.00, "type": "income", "sourceId": "inc1" },
                { "id": "t2", "date": "2025-11-22", "description": "ATM Withdrawal", "amount": -100.00, "type": "expense", 
                  "splits": [{ "linkedBudgetItemId": "b2", "amount": -40, "note": "Haircut" }, { "linkedBudgetItemId": "b1", "amount": -60, "note": "Cash Groceries" }] 
                },
                { "id": "t3", "date": "2025-11-24", "description": "Kroger", "amount": -120.50, "type": "expense", "linkedBudgetItemId": "b1" }
            ]
        }]
    };

    // --- 2. UTILS ---
    const formatMoney = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n);
    const getPeriod = () => appData.periods[0]; // Simplification for demo

    // --- 3. RENDERING ---
    function renderApp() {
        const period = getPeriod();
        const usage = {};
        
        // A. Calculate Usage
        period.ledger.forEach(txn => {
            if(txn.splits) {
                txn.splits.forEach(s => usage[s.linkedBudgetItemId] = (usage[s.linkedBudgetItemId] || 0) + Math.abs(s.amount));
            } else if (txn.linkedBudgetItemId) {
                usage[txn.linkedBudgetItemId] = (usage[txn.linkedBudgetItemId] || 0) + Math.abs(txn.amount);
            }
        });

        // B. Image Maps for easy lookup
        const imgMap = {};
        period.incomeSources.forEach(i => imgMap[i.id] = i.image);
        period.paycheckCycles.forEach(c => c.budgetItems.forEach(b => imgMap[b.id] = b.image));

        // C. Render Ledger
        const tbody = document.getElementById('ledger-body');
        tbody.innerHTML = '';
        let balance = period.initialBankBalance;
        
        // Sort
        const sorted = [...period.ledger].sort((a,b) => a.date.localeCompare(b.date));

        sorted.forEach(txn => {
            balance += txn.amount;
            const tr = document.createElement('tr');
            tr.className = 'ledger-row';
            
            // Icon Logic
            let iconUrl = '';
            if(txn.type === 'income' && txn.sourceId) iconUrl = imgMap[txn.sourceId];
            else if(txn.linkedBudgetItemId) iconUrl = imgMap[txn.linkedBudgetItemId];
            else if(txn.splits) iconUrl = 'https://placehold.co/40x40/999/white?text=S'; // Generic Split
            
            const iconHtml = iconUrl ? `<img src="${iconUrl}" class="ledger-icon">` : '<span style="display:inline-block;width:28px;"></span>';
            const amtClass = txn.amount >= 0 ? 'positive' : 'negative';

            tr.innerHTML = `
                <td class="col-date">${txn.date.substring(5)}</td>
                <td class="col-desc">${iconHtml}${txn.description} ${txn.splits?'<small>(Split)</small>':''}</td>
                <td class="col-amt ${amtClass}">${formatMoney(txn.amount)}</td>
                <td class="col-bal">${formatMoney(balance)}</td>
                <td class="col-act"><button class="btn btn-icon" onclick="openTxModal('${txn.id}')">✎</button></td>
            `;
            tbody.appendChild(tr);
        });
        
        document.getElementById('ledger-header-info').innerHTML = `Start: <b>${formatMoney(period.initialBankBalance)}</b> | Current: <b>${formatMoney(balance)}</b>`;

        // D. Render Budgets
        const budgetContainer = document.getElementById('budget-container');
        budgetContainer.innerHTML = '';

        period.paycheckCycles.forEach(cycle => {
            const section = document.createElement('div');
            section.className = 'cycle-section';
            
            // Header with Add Button
            section.innerHTML = `
                <div class="cycle-header">
                    <span>${cycle.label}</span>
                    <button class="btn btn-sm btn-icon" onclick="openBudgetModal(null, ${cycle.cycleId})">+ Add Item</button>
                </div>`;

            cycle.budgetItems.forEach(item => {
                const spent = usage[item.id] || 0;
                const total = item.plannedAmount + item.carriedOver;
                const remaining = total - spent;
                const percent = Math.min(100, (spent/total)*100);
                
                let color = 'budget-bar-fill';
                if(percent > 90) color += ' warning';
                if(remaining < 0) color += ' danger';

                const div = document.createElement('div');
                div.className = 'budget-item';
                div.innerHTML = `
                    <div class="budget-summary" onclick="this.nextElementSibling.classList.toggle('active')">
                        <img src="${item.image}" class="budget-icon">
                        <div>
                            <span style="font-weight:600">${item.name}</span>
                            <div class="budget-bar-bg"><div class="${color}" style="width:${percent}%"></div></div>
                        </div>
                        <div style="text-align:right">
                            <div class="amount-text ${remaining<0?'negative':''}">${formatMoney(remaining)}</div>
                            <div style="font-size:0.75rem; color:#999;">of ${formatMoney(total)}</div>
                        </div>
                        <button class="btn btn-icon" onclick="event.stopPropagation(); openBudgetModal('${item.id}', ${cycle.cycleId})">✎</button>
                    </div>
                    <div class="budget-details">
                        Spent: ${formatMoney(spent)} <br>
                        Planned: ${formatMoney(item.plannedAmount)} <br>
                        Rollover: ${formatMoney(item.carriedOver)}
                    </div>
                `;
                section.appendChild(div);
            });
            budgetContainer.appendChild(section);
        });

        // E. Render Income Sources List (Visual Reference)
        const incContainer = document.getElementById('income-sources-list');
        incContainer.innerHTML = period.incomeSources.map(i => `<img src="${i.image}" title="${i.name}" style="width:30px;height:30px;border-radius:50%;border:1px solid #ccc;">`).join('');
    }


    // --- 4. MODAL LOGIC (TRANSACTIONS) ---
    
    function toggleTxType() {
        const type = document.getElementById('tx-type').value;
        const catGroup = document.getElementById('group-category');
        const incGroup = document.getElementById('group-income-source');
        
        if (type === 'expense') {
            catGroup.style.display = 'block';
            incGroup.style.display = 'none';
        } else {
            catGroup.style.display = 'none';
            incGroup.style.display = 'block';
        }
    }

    function openTxModal(txId = null) {
        const period = getPeriod();
        const modal = document.getElementById('tx-modal');
        const isEdit = !!txId;
        
        // Populate Selects
        const catSelect = document.getElementById('tx-category');
        catSelect.innerHTML = '<option value="">-- Select Budget --</option>';
        period.paycheckCycles.forEach(c => {
            c.budgetItems.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.id;
                opt.textContent = `${b.name} (${c.label})`;
                catSelect.appendChild(opt);
            });
        });

        const incSelect = document.getElementById('tx-income-source');
        incSelect.innerHTML = '<option value="">-- Select Source --</option>';
        period.incomeSources.forEach(i => {
            const opt = document.createElement('option');
            opt.value = i.id;
            opt.textContent = i.name;
            incSelect.appendChild(opt);
        });

        // Set Values
        if(isEdit) {
            const tx = period.ledger.find(t => t.id === txId);
            document.getElementById('tx-modal-title').textContent = "Edit Transaction";
            document.getElementById('tx-id').value = tx.id;
            document.getElementById('tx-date').value = tx.date;
            document.getElementById('tx-amount').value = Math.abs(tx.amount); // Show positive in form
            document.getElementById('tx-desc').value = tx.description;
            document.getElementById('tx-type').value = tx.type;
            
            // Logic for linking
            if(tx.type === 'expense') catSelect.value = tx.linkedBudgetItemId || '';
            if(tx.type === 'income') incSelect.value = tx.sourceId || '';

        } else {
            document.getElementById('tx-modal-title').textContent = "New Transaction";
            document.getElementById('tx-id').value = '';
            document.getElementById('tx-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('tx-amount').value = '';
            document.getElementById('tx-desc').value = '';
        }
        
        toggleTxType();
        modal.showModal();
    }

    function closeTxModal() { document.getElementById('tx-modal').close(); }

    function saveTransaction() {
        const period = getPeriod();
        const id = document.getElementById('tx-id').value;
        const type = document.getElementById('tx-type').value;
        const amountVal = parseFloat(document.getElementById('tx-amount').value);
        const finalAmount = type === 'expense' ? -Math.abs(amountVal) : Math.abs(amountVal);
        
        const newTx = {
            id: id || 't' + Date.now(),
            date: document.getElementById('tx-date').value,
            description: document.getElementById('tx-desc').value,
            amount: finalAmount,
            type: type
        };

        if(type === 'expense') {
            newTx.linkedBudgetItemId = document.getElementById('tx-category').value;
        } else {
            newTx.sourceId = document.getElementById('tx-income-source').value;
        }

        if(id) {
            // Update existing
            const index = period.ledger.findIndex(t => t.id === id);
            period.ledger[index] = newTx;
        } else {
            period.ledger.push(newTx);
        }

        closeTxModal();
        renderApp();
    }


    // --- 5. MODAL LOGIC (BUDGETS) ---

    function openBudgetModal(itemId, cycleId) {
        const modal = document.getElementById('budget-modal');
        const period = getPeriod();
        
        document.getElementById('b-cycle-id').value = cycleId;

        if(itemId) {
            // Find item
            let item;
            period.paycheckCycles.forEach(c => {
                const found = c.budgetItems.find(b => b.id === itemId);
                if(found) item = found;
            });

            document.getElementById('budget-modal-title').textContent = "Edit Item";
            document.getElementById('b-id').value = item.id;
            document.getElementById('b-name').value = item.name;
            document.getElementById('b-planned').value = item.plannedAmount;
            document.getElementById('b-carried').value = item.carriedOver;
            document.getElementById('b-image').value = item.image;
        } else {
            document.getElementById('budget-modal-title').textContent = "New Item";
            document.getElementById('b-id').value = '';
            document.getElementById('b-name').value = '';
            document.getElementById('b-planned').value = 0;
            document.getElementById('b-carried').value = 0;
            document.getElementById('b-image').value = 'https://placehold.co/40x40/gray/white?text=?';
        }

        modal.showModal();
    }

    function closeBudgetModal() { document.getElementById('budget-modal').close(); }

    function saveBudgetItem() {
        const period = getPeriod();
        const id = document.getElementById('b-id').value;
        const cycleId = parseInt(document.getElementById('b-cycle-id').value);
        
        const newItem = {
            id: id || 'b' + Date.now(),
            name: document.getElementById('b-name').value,
            plannedAmount: parseFloat(document.getElementById('b-planned').value),
            carriedOver: parseFloat(document.getElementById('b-carried').value),
            image: document.getElementById('b-image').value
        };

        const cycle = period.paycheckCycles.find(c => c.cycleId === cycleId);

        if(id) {
            const idx = cycle.budgetItems.findIndex(b => b.id === id);
            cycle.budgetItems[idx] = newItem;
        } else {
            cycle.budgetItems.push(newItem);
        }

        closeBudgetModal();
        renderApp();
    }

    // Init
    renderApp();
</script>
</body>
</html>
