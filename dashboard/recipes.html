<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stephens' Recipes V0.8.5</title>
    <link rel="icon" href="/images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }
        html { font-family: 'Inter', sans-serif; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.75); backdrop-filter: blur(4px); }
        .recipe-card { width: 100%; max-width: 300px; min-width: 250px; cursor: pointer; }
        input, textarea, select { background-color: #374151; border: 1px solid #4B5563; color: white; padding: 0.5rem; border-radius: 0.375rem; width: 100%; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #3B82F6; ring: 2px; ring-color: #3B82F6; }
        .low-temp-offset { position: relative; top: 2px; }
        .high-temp-offset { position: relative; bottom: 2px; }
        
        /* Tag Cloud Animation */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
            100% { transform: translateY(0px); }
        }
        .tag-cloud-item:hover {
            animation: float 2s ease-in-out infinite;
            text-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }
        /* Dropdown Animation */
        .dropdown-fade { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'], }, } } }
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 sm:p-8">

    <datalist id="ingredient-datalist"></datalist>

    <nav class="fixed top-0 left-0 right-0 bg-gray-800 border-b border-gray-700 shadow-xl z-30 p-2 flex items-center justify-between">
        <div class="flex items-center">
            <button id="menu-button" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 focus:outline-none mr-4" onclick="toggleMenu()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
            <a href="index.html" class="text-gray-400 hover:text-white mr-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0h6"></path></svg>
            </a>
            <div id="datetime" class="text-sm sm:text-base font-medium"></div>
        </div>
        <div id="weather-display" class="text-sm flex items-center bg-gray-700 px-3 py-1 rounded-full border border-gray-600">
            <span class="flex items-center" id="weather-content">...</span>
        </div>
    </nav>

    <div id="menu-modal" class="fixed top-[4rem] left-4 z-40 opacity-0 pointer-events-none transform -translate-y-4 transition-all duration-300 ease-out max-w-xs z-50">
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 shadow-2xl w-64">
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h3 class="text-xl font-semibold text-white">Recipe Menu</h3>
                <button id="close-menu-button" class="text-gray-400 hover:text-white p-1" onclick="hideMenu()">X</button>
            </div>
            <button id="add-recipe-button" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-2 transition duration-150" onclick="openRecipeModal()">Add New Recipe</button>
            <button id="add-category-button" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-4 transition duration-150" onclick="document.getElementById('add-category-modal').classList.remove('hidden'); hideMenu();">Add New Category</button>
            <button id="download-data-button" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-4 transition duration-150" onclick="downloadDataFile()">Download Data File</button>
            <button id="clear-draft-button" class="w-full text-left py-2 px-3 rounded-lg text-red-400 hover:bg-red-900/20 mb-4 transition duration-150 border border-red-700/50" onclick="clearDraftData()">Clear Local Data</button>
            <p id="version-display" class="text-sm font-mono text-gray-300">Recipe Dashboard V0.8.5</p>
        </div>
    </div>

    <main id="recipes-content" class="px-4 sm:px-8 pt-16 pb-8">
        <div class="mb-8 relative max-w-xl mx-auto">
            <input type="text" id="recipe-search" placeholder="Search recipes, ingredients, sources..." class="w-full bg-gray-800 border border-gray-700 rounded-xl py-3 px-4 pl-11 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition duration-200 shadow-lg" oninput="handleSearch(this.value)">
            <div class="absolute left-3.5 top-3.5 text-gray-500">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
        </div>

        <div id="recipe-groups-container" class="flex flex-col space-y-8 min-h-[200px]"></div>
        
        <div id="tag-cloud-wrapper" class="mt-16 pt-8 border-t border-gray-700">
            <div id="tag-cloud-container" class="flex flex-wrap gap-x-4 gap-y-2 justify-center items-baseline p-4"></div>
        </div>
    </main>

    <main id="recipe-detail-view" class="px-4 sm:px-8 pt-16 pb-8 hidden">
        <div class="flex justify-between items-start mb-4 z-40 relative">
            <button id="back-to-list" class="flex items-center text-gray-400 hover:text-white transition px-3 py-2 rounded-lg hover:bg-gray-800 bg-gray-800 border border-gray-700" onclick="renderRecipeGroups()">
                <span class="mr-1">‚Üê</span> Back
            </button>
            
            <div class="flex space-x-2 relative">
                <div class="relative">
                    <button id="share-recipe-btn" onclick="document.getElementById('share-dropdown').classList.toggle('hidden')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg> Share
                    </button>
                    <div id="share-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-lg shadow-2xl border border-gray-700 z-50 dropdown-fade overflow-hidden">
                        <button onclick="shareLink('copy')" class="w-full text-left px-4 py-3 hover:bg-gray-700 text-sm flex items-center"><span class="mr-2">üìã</span> Copy Link</button>
                        <button onclick="shareLink('sms')" class="w-full text-left px-4 py-3 hover:bg-gray-700 text-sm flex items-center"><span class="mr-2">üí¨</span> Send Text</button>
                        <button onclick="shareLink('messenger')" class="w-full text-left px-4 py-3 hover:bg-gray-700 text-sm flex items-center"><span class="mr-2">‚ö°</span> Messenger</button>
                        <button id="native-share-btn" onclick="shareLink('native')" class="hidden w-full text-left px-4 py-3 hover:bg-gray-700 text-sm border-t border-gray-700"><span class="mr-2">üì±</span> System Share</button>
                    </div>
                </div>

                <button id="edit-recipe-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg> Edit
                </button>
                <button id="delete-recipe-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center">
                   <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg> Delete
                </button>
            </div>
        </div>
        <div id="detail-content" class="bg-gray-800 rounded-2xl p-6 border border-gray-700 shadow-2xl max-w-5xl mx-auto"></div>
    </main>
    
    <div id="recipe-form-modal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center hidden">
        <div class="bg-900 border border-gray-700 rounded-2xl w-full max-w-4xl h-[90vh] flex flex-col shadow-2xl overflow-hidden m-4 bg-gray-900">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800">
                <h2 class="text-xl font-bold text-white" id="recipe-modal-title">Add Recipe</h2>
                <button id="close-recipe-modal" class="text-gray-400 hover:text-white" onclick="document.getElementById('recipe-form-modal').classList.add('hidden')">‚úï</button>
            </div>
            <div class="flex border-b border-gray-700 bg-gray-800">
                <button class="tab-btn flex-1 py-3 text-sm font-medium text-blue-400 border-b-2 border-blue-500 transition" data-tab="tab-general" onclick="switchTab('tab-general')">General Info</button>
                <button class="tab-btn flex-1 py-3 text-sm font-medium text-gray-400 hover:text-white transition" data-tab="tab-ingredients" onclick="switchTab('tab-ingredients')">Ingredients</button>
                <button class="tab-btn flex-1 py-3 text-sm font-medium text-gray-400 hover:text-white transition" data-tab="tab-instructions" onclick="switchTab('tab-instructions')">Instructions</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <form id="full-recipe-form">
                    <input type="hidden" id="form-recipe-id">
                    <div id="tab-general" class="tab-content space-y-4">
                        <div><label class="block text-sm text-gray-400 mb-1">Title</label><input type="text" id="form-title" required class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">Description</label><textarea id="form-desc" rows="3" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></textarea></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm text-gray-400 mb-1">Category</label><select id="form-category" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></select></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Servings</label><input type="number" id="form-servings" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm text-gray-400 mb-1">Prep Time</label><input type="text" id="form-prep" placeholder="e.g. 15 mins" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Cook Time</label><input type="text" id="form-cook" placeholder="e.g. 1 hour" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></div>
                        </div>
                        <div><label class="block text-sm text-gray-400 mb-1">Image URL</label><input type="url" id="form-image" placeholder="https://..." class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm text-gray-400 mb-1">Source Description</label><input type="text" id="form-source-desc" placeholder="e.g. Grandma's Kitchen" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Source URL</label><input type="url" id="form-source-url" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></div>
                        </div>
                        <div><label class="block text-sm text-gray-400 mb-1">Tags (comma separated)</label><input type="text" id="form-tags" placeholder="Dinner, Keto, Spicy" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></div>
                    </div>
                    <div id="tab-ingredients" class="tab-content hidden space-y-4">
                        <div id="ingredients-container"></div>
                        <button type="button" id="add-ing-section-btn" class="w-full py-2 border-2 border-dashed border-gray-600 text-gray-400 rounded-lg hover:border-gray-400 hover:text-white transition" onclick="addIngredientSection()">+ Add Ingredient Section</button>
                    </div>
                    <div id="tab-instructions" class="tab-content hidden space-y-4">
                        <div id="instructions-container"></div>
                        <button type="button" id="add-inst-section-btn" class="w-full py-2 border-2 border-dashed border-gray-600 text-gray-400 rounded-lg hover:border-gray-400 hover:text-white transition" onclick="addInstructionSection()">+ Add Instruction Section</button>
                    </div>
                </form>
            </div>
            <div class="p-4 border-t border-gray-700 bg-gray-800 flex justify-end gap-3">
                <button type="button" id="cancel-recipe-btn" class="px-4 py-2 text-gray-400 hover:text-white" onclick="document.getElementById('recipe-form-modal').classList.add('hidden')">Cancel</button>
                <button type="button" id="save-recipe-btn" class="bg-blue-600 px-6 py-2 rounded-lg text-white hover:bg-blue-700 font-bold" onclick="saveRecipe()">Save Recipe</button>
            </div>
        </div>
    </div>

    <div id="add-category-modal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Add Category</h2>
            <form id="category-form" onsubmit="saveCategory(event)"><input type="text" id="category-modal-input" class="mb-4 w-full bg-gray-700 border border-gray-600 rounded p-2 text-white" required><div class="flex justify-end gap-2"><button type="button" class="close-simple-modal text-gray-400 px-3 py-2" onclick="document.getElementById('add-category-modal').classList.add('hidden')">Cancel</button><button type="submit" class="bg-green-600 px-4 py-2 rounded text-white">Add</button></div></form>
        </div>
    </div>

    <script>
        // --- VARIABLES ---
        const state = { localStorageKeys: { recipes: 'sd_custom_recipes', categories: 'sd_custom_categories', tags: 'sd_custom_tags' } };
        let STATIC_RECIPES = [], STATIC_CATEGORIES = [], STATIC_TAGS = [];
        let currentFilterTag = null, currentEditingId = null, currentRecipeBase = null;
        let currentSearchTerm = ""; 
        let INGREDIENT_DB = {};
        let views, containers, menuModal, modals, ingContainer, instContainer;

        const EMBEDDED_RECIPES = {
            "recipes": [
                { "id": "1", "title": "Chili", "category": "Soup", "servings": 12, "prepTime": "90 minutes", "cookTime": "30 minutes", "image": "https://cdn.apartmenttherapy.info/image/upload/f_auto,q_auto:eco,c_fit,w_730,h_913/k%2FPhoto%2FRecipes%2F2023-11-chili%2Fchili-2", "source": { "description": "Cayce's Recipe", "url": "" }, "tags": [ "Keto", "Gluten Free", "Beef", "Texas", "Cayce Diet" ], "ingredients": [ { "sectionTitle": "Base", "list": [ { "name": "Ground Beef", "quantity": "3", "unit": "pounds", "notes": "Wagyu", "macros": { "calories": 2040, "protein": 276, "carbs": 0, "fat": 96, "fiber": 0 } }, { "name": "Onion", "quantity": "1", "unit": "", "notes": "medium", "macros": { "calories": 60, "protein": 2, "carbs": 14, "fat": 0, "fiber": 3 } }, { "name": "Garlic", "quantity": "12", "unit": "cloves", "notes": "minced", "macros": { "calories": 15, "protein": 1.6, "carbs": 12.3, "fat": 0.3, "fiber": 0 } }, { "name": "Organic Tomato Sauce", "quantity": "15", "unit": "oz", "notes": "", "macros": { "calories": 140, "protein": 7, "carbs": 28, "fat": 0, "fiber": 7 } }, { "name": "Spinach", "quantity": "1", "unit": "cup", "notes": "chopped", "macros": { "calories": 7, "protein": 4, "carbs": 5, "fat": 0.5, "fiber": 3 } } ] }, { "sectionTitle": "Spices", "list": [ { "name": "Chili Powder", "quantity": "3", "unit": "tbsp", "notes": "", "macros": { "calories": 0, "protein": 0, "carbs": 0, "fat": 0, "fiber": 0 } }, { "name": "Sea Salt", "quantity": "1", "unit": "tbsp", "notes": "Redmond's", "macros": { "calories": 0, "protein": 0, "carbs": 0, "fat": 0, "fiber": 0 } }, { "name": "Cumin", "quantity": "2", "unit": "tbsp", "notes": "", "macros": { "calories": 0, "protein": 0, "carbs": 0, "fat": 0, "fiber": 0 } }, { "name": "Chipotle Chile Pepper", "quantity": "1/2", "unit": "tsp", "notes": "", "macros": { "calories": 0, "protein": 0, "carbs": 0, "fat": 0, "fiber": 0 } }, { "name": "Smoked Paprika", "quantity": "1 1/2", "unit": "tsp", "notes": "", "macros": { "calories": 0, "protein": 0, "carbs": 0, "fat": 0, "fiber": 0 } } ] } ], "instructions": [ { "sectionTitle": "Directions", "steps": [ "Brown 3 lbs Ground Beef until mostly done (it will continue to cook)", "Add Onion (chopped) and 12 cloves garlic (minced)", "Cook for 3-5 minutes until onions brown a bit", "Add Spices and Tomatoes", "Bring to a boil and let it simmer for 30 minutes." ] } ] },
                { "id": "user_rec_1763590797634", "title": "Doctor's Daily Bread", "category": "Bread", "servings": 10, "prepTime": "10 Minutes", "cookTime": "1 Hour 15 Minutes", "image": "https://ik.thedoctorskitchen.com/tr:n-medium/doctors-daily-bread_cZ58RgYL8", "source": { "description": "The Doctor's Kitchen", "url": "https://www.thedoctorskitchen.com/recipes/doctor-s-daily-bread" }, "tags": [ "Keto", "Cayce Diet", "Dairy Free", "Gluten Free", "Grain Free", "Vegetarian", "Fiber" ], "ingredients": [ { "sectionTitle": "Dry Ingredients", "list": [ { "name": "Hemp Hearts", "quantity": "20", "unit": "g", "notes": "", "macros": { "calories": 120, "protein": 3, "carbs": 1, "fat": 10, "fiber": 1 } }, { "name": "Psyllium Husk", "quantity": "35", "unit": "g", "notes": "", "macros": { "calories": 70, "protein": 1.6, "carbs": 27, "fat": 0, "fiber": 27 } }, { "name": "Amaranth Flour", "quantity": "150", "unit": "g", "notes": "", "macros": { "calories": 555, "protein": 22, "carbs": 100, "fat": 4, "fiber": 10 } }, { "name": "Mixed Nuts", "quantity": "150", "unit": "g", "notes": "Chopped", "macros": { "calories": 911, "protein": 30, "carbs": 28, "fat": 91, "fiber": 8 } }, { "name": "Mixed Seeds", "quantity": "150", "unit": "g", "notes": "", "macros": { "calories": 841, "protein": 32, "carbs": 32, "fat": 72, "fiber": 15 } }, { "name": "Sea Salt", "quantity": "1 1/2", "unit": "tsp", "notes": "Fine", "macros": { "calories": 0, "protein": 0, "carbs": 0, "fat": 0, "fiber": 0 } } ] }, { "sectionTitle": "Wet Ingredients", "list": [ { "name": "Water", "quantity": "400", "unit": "g", "notes": "", "macros": { "calories": 0, "protein": 0, "carbs": 0, "fat": 0, "fiber": 0 } }, { "name": "Extra Virgin Olive Oil", "quantity": "3", "unit": "tbsp", "notes": "", "macros": { "calories": 360, "protein": 0, "carbs": 0, "fat": 42, "fiber": 0 } } ] } ], "instructions": [ { "sectionTitle": "Directions", "steps": [ "Line a 2lb loaf tin with parchment paper and/or lightly grease with olive oil. ", "Mix dry ingredients in a medium bowl.", "Pour in the water and olive oil and mix well.  Start with half the water.", "Pack the mixture into your prepared tin.", "Leave it to soak for 30 minutes - 8 hours at this stage. (overnight is best)", "Bake for 60 minutes at 375 or 335 with convection. ", "Remove from the tin and bake for a further 15 minutes. ", "Remove from the oven and allow to cool completely before slicing. (this takes a long time)" ] } ] },
                { "id": "user_rec_1763611965884", "title": "Oat and Flax Wraps", "category": "Bread", "servings": 4, "prepTime": "5 minutes", "cookTime": "20 minutes", "image": "https://ik.thedoctorskitchen.com/tr:n-medium/oat-and-flax-wraps_P81WRQ96W", "source": { "description": "The Doctor's Kitchen", "url": "https://www.thedoctorskitchen.com/recipes/oat-and-flax-wraps" }, "tags": [ "Keto", "Dairy Free", "Gluten Free", "Grain Free", "Vegetarian", "Fiber" ], "ingredients": [ { "sectionTitle": "Ingredients", "list": [ { "name": "Oat Flour", "quantity": "75", "unit": "g", "notes": "", "macros": { "calories": 303, "protein": 11.3, "carbs": 48.8, "fat": 6.7, "fiber": 10 } }, { "name": "Ground Flaxseed", "quantity": "25", "unit": "g", "notes": "", "macros": { "calories": 134, "protein": 6, "carbs": 7, "fat": 10, "fiber": 6 } }, { "name": "Water", "quantity": "250", "unit": "g", "notes": "", "macros": {} }, { "name": "Salt", "quantity": "4", "unit": "g", "notes": "", "macros": {} } ] } ], "instructions": [ { "sectionTitle": "Directions", "steps": [ "Gather and prepare your ingredients.", "Place the oats into a blender and blend until you have a flour-like consistency.", "Add the flax, water, and salt and blend again until you have a smooth batter.  Start with half the water then add more later to fully mix well.", "Heat a small amount of olive oil in a non-stick pan over medium heat. Pour in the batter and gently swirl it around the pan or use the back of a spoon, until you have a wide flat surface. Cook for 3-4 minutes on each side, until they are sturdy enough to flip without breaking. Remove onto a wire rack to cool before using. (The batter will thicken as it rests, add small splashes of water to loosen as needed)." ] } ] },
                { "id": "user_rec_1763611965885", "title": "Chickpea and Flax Wraps", "category": "Bread", "servings": 4, "prepTime": "5 minutes", "cookTime": "20 minutes", "image": "https://ik.thedoctorskitchen.com/tr:n-medium/oat-and-flax-wraps_P81WRQ96W", "source": { "description": "The Doctor's Kitchen", "url": "https://www.thedoctorskitchen.com/recipes/oat-and-flax-wraps?utm_medium=referral&utm_campaign=healthy-wraps-youtube-sept25&utm_source=youtube" }, "tags": [ "Keto", "Cayce Diet", "Dairy Free", "Gluten Free", "Grain Free", "Vegetarian", "Fiber" ], "ingredients": [ { "sectionTitle": "Ingredients", "list": [ { "name": "Chickpea Flour", "quantity": "75", "unit": "g", "notes": "", "macros": { "calories": 290, "protein": 17, "carbs": 17, "fat": 1.5, "fiber": 7 } }, { "name": "Ground Flaxseed", "quantity": "25", "unit": "g", "notes": "", "macros": { "calories": 134, "protein": 6, "carbs": 7, "fat": 10, "fiber": 6 } }, { "name": "Water", "quantity": "250", "unit": "g", "notes": "", "macros": { "calories": 0, "protein": 0, "carbs": 0, "fat": 0, "fiber": 0 } }, { "name": "Salt", "quantity": "4", "unit": "g", "notes": "", "macros": { "calories": 0, "protein": 0, "carbs": 0, "fat": 0, "fiber": 0 } } ] } ], "instructions": [ { "sectionTitle": "Directions", "steps": [ "Gather and prepare your ingredients.", "Add the chickpea flour, flax, water, and salt and blend again until you have a smooth batter.  Start with half the water then add more later to fully mix well.", "Heat a small amount of olive oil in a non-stick pan over medium heat. Pour in the batter and gently swirl it around the pan or use the back of a spoon, until you have a wide flat surface. Cook for 3-4 minutes on each side, until they are sturdy enough to flip without breaking. Remove onto a wire rack to cool before using. (The batter will thicken as it rests, add small splashes of water to loosen as needed)." ] } ] },
                { "id": "user_rec_1763650159154", "title": "Keto Salisbury Steak", "category": "American", "servings": 3, "prepTime": "10 minutes", "cookTime": "18 minutes", "image": "https://www.ibreatheimhungry.com/wp-content/uploads/2021/07/IMG_0882-2.jpg", "source": { "description": "I Breathe I'm Hungry", "url": "https://www.ibreatheimhungry.com/low-carb-salisbury-steak-with-mushroom-gravy/" }, "tags": [ "Keto", "Beef" ], "ingredients": [ { "sectionTitle": "Steak Ingredients", "list": [ { "name": "Ground Beef", "quantity": "1", "unit": "lb", "notes": "", "macros": { "calories": 680, "protein": 92, "carbs": 0, "fat": 32, "fiber": 0 } }, { "name": "Almond Flour", "quantity": "1/2", "unit": "cup", "notes": "", "macros": { "calories": 340, "protein": 13, "carbs": 11, "fat": 27, "fiber": 6 } }, { "name": "Fresh Parsley", "quantity": "1 1/2", "unit": "tsp", "notes": "chopped", "macros": {} }, { "name": "Beef Broth", "quantity": "1/8", "unit": "cup", "notes": "", "macros": {} }, { "name": "Worcestershire Sauce", "quantity": "1 1/2", "unit": "tsp", "notes": "", "macros": {} }, { "name": "Garlic Powder", "quantity": "1/4", "unit": "tsp", "notes": "", "macros": {} }, { "name": "Dried Onion Flakes", "quantity": "1 1/2", "unit": "tsp", "notes": "", "macros": {} }, { "name": "Salt", "quantity": "3/4", "unit": "tsp", "notes": "", "macros": {} }, { "name": "Black Pepper", "quantity": "1/4", "unit": "tsp", "notes": "", "macros": {} } ] }, { "sectionTitle": "Gravy Ingredients", "list": [ { "name": "Butter", "quantity": "2", "unit": "tbsp", "notes": "", "macros": { "calories": 200, "protein": 0.5, "carbs": 0, "fat": 15, "fiber": 0 } }, { "name": "Bacon Grease", "quantity": "2", "unit": "tbsp", "notes": "", "macros": { "calories": 269, "protein": 0, "carbs": 0, "fat": 28, "fiber": 0 } }, { "name": "Button Mushrooms", "quantity": "1", "unit": "cup", "notes": "sliced", "macros": { "calories": 15, "protein": 2.2, "carbs": 2.3, "fat": 0.2, "fiber": 0.7 } }, { "name": "Yellow Onions", "quantity": "1/2", "unit": "cup", "notes": "sliced", "macros": { "calories": 34, "protein": 1, "carbs": 8, "fat": 1, "fiber": 1.7 } }, { "name": "Worcestershire Sauce", "quantity": "1/2", "unit": "tsp", "notes": "", "macros": { "calories": 2.5, "protein": 0, "carbs": 0.5, "fat": 0, "fiber": 0 } }, { "name": "Beef Broth", "quantity": "1/2", "unit": "cup", "notes": "", "macros": { "calories": 5, "protein": 0, "carbs": 0, "fat": 0, "fiber": 0 } }, { "name": "Sour Cream", "quantity": "1/4", "unit": "cup", "notes": "", "macros": { "calories": 240, "protein": 4, "carbs": 4, "fat": 20, "fiber": 0 } } ] } ], "instructions": [ { "sectionTitle": "Steak Directions", "steps": [ "Combine all of the steak ingredients in a medium sized bowl and mix well.", "Form into 3 oval patties, about 1 inch thick, and place them on a cookie sheet.", "Bake in a preheated 375¬∞ (F) oven for 18 minutes." ] }, { "sectionTitle": "Gravy Directions", "steps": [ "Melt the butter and bacon fat (if using) in a large skillet (4 Tbsp total).", "Add the 1 cup mushrooms and cook on medium high heat until golden brown (about 3 minutes per side.)", "Add the 1/2 cup onions and cook for 5 minutes over medium heat, until golden and soft.", "Add the 1/2 cup broth and the 1/4 tsp Worcestershire sauce, stir and cook for 3 minutes, stirring to scrape any bits off of the bottom of the pan.", "Add the 1/4 cup sour cream, stir well, and remove from the heat. (if you want a thicker gravy you can cook it on low for a 5 extra minutes to condense it.)", "Season with salt and pepper to taste.", "Serve over the warm Salisbury Steaks" ] } ] },
                { "id": "user_rec_1763652731628", "title": "Roasted Turkey", "category": "American", "servings": 16, "prepTime": "30 minutes", "cookTime": "2 hours 15 minutes", "image": "https://images.ctfassets.net/lufu0clouua1/2cSQKvJYskEqgyaAYawE48/7b71e49f5de264f38541c055926f8f5a/classic-roast-turkey.jpg", "source": { "description": "Americas Test Kitchen", "url": "https://www.americastestkitchen.com/" }, "tags": [ "Thanksgiving", "Keto" ], "ingredients": [ { "sectionTitle": "Ingredients", "list": [ { "name": "Turkey", "quantity": "12", "unit": "lb", "notes": "Reserve Giblets and Neck", "macros": { "calories": 3800, "protein": 390, "carbs": 0, "fat": 175, "fiber": 0 } }, { "name": "Salt", "quantity": "4", "unit": "Tbsp", "notes": "", "macros": {} }, { "name": "Sugar", "quantity": "4", "unit": "Tbsp", "notes": "", "macros": {} }, { "name": "Avocado Oil", "quantity": "3 1/2", "unit": "Tsp", "notes": "", "macros": {} }, { "name": "Baking Powder", "quantity": "1", "unit": "Tsp", "notes": "", "macros": {} } ] } ], "instructions": [ { "sectionTitle": "Directions", "steps": [ "Combine salt/sugar...", "Roast..." ] } ] },
                { "id": "user_rec_1763653389089", "title": "Turkey Gravy", "category": "American", "servings": 16, "prepTime": "30 minutes", "cookTime": "3 1/2 hours", "image": "https://natashaskitchen.com/wp-content/uploads/2023/11/Turkey-Gravy-tall.jpg", "source": { "description": "America's Test Kitchen", "url": "https://www.americastestkitchen.com/recipes/11217-our-favorite-turkey-gravy" }, "tags": [ "Thanksgiving", "Gluten Free", "Dairy Free" ], "ingredients": [ { "sectionTitle": "Ingredients", "list": [ { "name": "Reserved Giblets", "quantity": "1", "unit": "", "notes": "", "macros": {} }, { "name": "Carrot", "quantity": "1", "unit": "", "notes": "", "macros": {} }, { "name": "Onions", "quantity": "2", "unit": "", "notes": "", "macros": {} }, { "name": "Garlic", "quantity": "6", "unit": "cloves", "notes": "", "macros": {} }, { "name": "Turkey Broth", "quantity": "6", "unit": "cups", "notes": "", "macros": { "calories": 120, "protein": 12, "carbs": 0, "fat": 6, "fiber": 0 } }, { "name": "Thyme", "quantity": "6", "unit": "sprigs", "notes": "", "macros": {} }, { "name": "Flour Mix", "quantity": "1/4", "unit": "cup", "notes": "GF", "macros": { "calories": 110, "protein": 4, "carbs": 23, "fat": 0, "fiber": 0.25 } }, { "name": "Avocado Oil", "quantity": "1", "unit": "Tbsp", "notes": "", "macros": { "calories": 124, "protein": 0, "carbs": 0, "fat": 14, "fiber": 0 } } ] } ], "instructions": [ { "sectionTitle": "Directions", "steps": [ "Heat oven...", "Roast...", "Strain...", "Simmer..." ] } ] }
            ],
            "categories": [ "Bread", "Soup", "Dessert", "American" ],
            "availableTags": []
        };

        // --- 2. HELPER FUNCTIONS ---
        function getCustomData(key) { try { return JSON.parse(localStorage.getItem(key)) || []; } catch { return []; } }
        function saveCustomData(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
        function getTempColor(t) { t=parseInt(t); if(t>=80)return'text-red-500'; if(t>70)return'text-green-400'; if(t>=60)return'text-green-400/80'; if(t<50)return'text-sky-300'; return'text-white'; }
        function getForecastEmoji(c) { if(c.includes('01'))return'‚òÄÔ∏è'; if(c.includes('02'))return'üå§Ô∏è'; if(c.includes('03'))return'üå•Ô∏è'; if(c.includes('09')||c.includes('10'))return'üåßÔ∏è'; if(c.includes('13'))return'‚ùÑÔ∏è'; return'‚òÅÔ∏è'; }

        function initDOM() {
            views = { list: document.getElementById('recipes-content'), detail: document.getElementById('recipe-detail-view') };
            containers = { groups: document.getElementById('recipe-groups-container'), detail: document.getElementById('detail-content'), tags: document.getElementById('tag-cloud-container') };
            menuModal = document.getElementById('menu-modal');
            modals = { recipe: document.getElementById('recipe-form-modal'), category: document.getElementById('add-category-modal') };
            ingContainer = document.getElementById('ingredients-container');
            instContainer = document.getElementById('instructions-container');
        }

        function getAllRecipes() {
            const staticRecs = STATIC_RECIPES.map(r => ({...r, source_type: 'static'}));
            const customRecs = getCustomData(state.localStorageKeys.recipes).map(r => ({...r, source_type: 'custom'}));
            const map = new Map();
            staticRecs.forEach(r => map.set(String(r.id), r));
            customRecs.forEach(r => map.set(String(r.id), r));
            return Array.from(map.values());
        }

        function buildIngredientDB() {
            INGREDIENT_DB = {};
            const all = getAllRecipes();
            all.forEach(r => {
                if(r.ingredients) {
                    r.ingredients.forEach(sec => {
                        if(sec.list) {
                            sec.list.forEach(ing => {
                                const rawName = ing.name.trim();
                                const key = rawName.toLowerCase();
                                const hasMacros = ing.macros && (ing.macros.calories > 0 || ing.macros.protein > 0);
                                const existing = INGREDIENT_DB[key];
                                const existingHasMacros = existing && existing.macros && (existing.macros.calories > 0 || existing.macros.protein > 0);
                                if (key && (!existing || (hasMacros && !existingHasMacros))) {
                                     INGREDIENT_DB[key] = ing; 
                                }
                            });
                        }
                    });
                }
            });
            const dl = document.getElementById('ingredient-datalist');
            if(dl) {
                const sortedKeys = Object.keys(INGREDIENT_DB).sort();
                dl.innerHTML = sortedKeys.map(key => `<option value="${INGREDIENT_DB[key].name}">`).join('');
            }
        }

        function parseQuantity(q) {
            if (!q) return 0;
            if (typeof q === 'number') return q;
            const parts = String(q).split(' ');
            let total = 0;
            parts.forEach(p => {
                if (p.includes('/')) { const [n, d] = p.split('/'); total += parseFloat(n) / parseFloat(d); }
                else { total += parseFloat(p); }
            });
            return isNaN(total) ? 0 : total;
        }

        function prettifyFractions(str) {
            if(!str) return '';
            return str.replace(/(^|\s)1\/2(?!\d)/g, '$1¬Ω').replace(/(^|\s)1\/4(?!\d)/g, '$1¬º').replace(/(^|\s)3\/4(?!\d)/g, '$1¬æ').replace(/(^|\s)1\/3(?!\d)/g, '$1‚Öì').replace(/(^|\s)2\/3(?!\d)/g, '$1‚Öî').replace(/(^|\s)1\/8(?!\d)/g, '$1‚Öõ').replace(/(^|\s)3\/8(?!\d)/g, '$1‚Öú').replace(/(^|\s)5\/8(?!\d)/g, '$1‚Öù').replace(/(^|\s)7\/8(?!\d)/g, '$1‚Öû');
        }

        function formatQuantity(num) {
            if (num <= 0.02) return "Pinch";
            if (num <= 0) return "";
            const fractions = [ { val: 0.125, str: "‚Öõ" }, { val: 0.25, str: "¬º" }, { val: 0.333, str: "‚Öì" }, { val: 0.375, str: "‚Öú" }, { val: 0.5, str: "¬Ω" }, { val: 0.625, str: "‚Öù" }, { val: 0.666, str: "‚Öî" }, { val: 0.75, str: "¬æ" }, { val: 0.875, str: "‚Öû" } ];
            const whole = Math.floor(num);
            let decimal = num - whole;
            let bestFrac = "";
            for (let f of fractions) { if (Math.abs(decimal - f.val) < 0.08) { decimal = f.val; bestFrac = f.str; break; } }
            if (Math.abs(decimal - 1) < 0.08) return String(whole + 1);
            if (Math.abs(decimal) < 0.08) return whole > 0 ? String(whole) : "Pinch";
            if (whole > 0 && bestFrac) return `${whole} ${bestFrac}`;
            if (whole > 0) return String(whole);
            return bestFrac || num.toFixed(1).replace('.0', '');
        }

        function convertUnits(qty, unit) {
            let newQty = qty;
            let newUnit = unit ? unit.toLowerCase().trim() : "";
            if (newUnit === 'tablespoon' || newUnit === 'tbsp' || newUnit === 'tbs') newUnit = 'Tbsp';
            if (newUnit === 'teaspoon' || newUnit === 'tsp') newUnit = 'tsp';
            if (newUnit === 'cup' || newUnit === 'cups') newUnit = 'cup';
            if (newUnit === 'cup' && newQty < 0.23) { newQty = newQty * 16; newUnit = 'Tbsp'; }
            if (newUnit === 'Tbsp' && newQty < 0.30) { newQty = newQty * 3; newUnit = 'tsp'; }
            if (newUnit === 'tsp' && newQty < 0.12) { return { qty: 0, display: "Pinch", unit: "" }; }
            return { qty: newQty, unit: newUnit, display: formatQuantity(newQty) };
        }

        function getNormalizedAmount(qty, unit) {
            const q = parseQuantity(qty);
            const u = unit ? unit.toLowerCase().trim().replace(/s$/, '') : ''; 
            if (u === 'g' || u === 'gram') return { val: q, type: 'weight' };
            if (u === 'oz' || u === 'ounce') return { val: q * 28.35, type: 'weight' };
            if (u === 'lb' || u === 'pound') return { val: q * 453.6, type: 'weight' };
            if (u === 'kg' || u === 'kilogram') return { val: q * 1000, type: 'weight' };
            if (u === 'tsp' || u === 'teaspoon') return { val: q, type: 'volume' };
            if (u === 'tbsp' || u === 'tablespoon') return { val: q * 3, type: 'volume' };
            if (u === 'cup') return { val: q * 48, type: 'volume' };
            if (u === 'ml' || u === 'milliliter') return { val: q / 5, type: 'volume' };
            if (u === 'l' || u === 'liter') return { val: (q * 1000) / 5, type: 'volume' };
            return { val: q, type: 'count' };
        }

        // --- 3. APP LOGIC & UI FUNCTIONS ---

        function handleSearch(term) {
            currentSearchTerm = term.toLowerCase().trim();
            renderRecipeGroups();
        }

        function autoFillMacros(inputElement) {
            const row = inputElement.closest('.ing-row');
            const nameInput = row.querySelector('.ing-name');
            const qtyInput = row.querySelector('.ing-qty');
            const unitInput = row.querySelector('.ing-unit');
            const name = nameInput.value.toLowerCase().trim();
            const ref = INGREDIENT_DB[name];
            if (!ref) return;
            const currentQtyRaw = qtyInput.value;
            const currentUnit = unitInput.value;
            if (!currentQtyRaw) return;
            const currentNorm = getNormalizedAmount(currentQtyRaw, currentUnit);
            const refNorm = getNormalizedAmount(ref.quantity, ref.unit);
            let ratio = 1;
            if (currentNorm.type === refNorm.type) {
                if (refNorm.val === 0) ratio = 1; else ratio = currentNorm.val / refNorm.val;
            } else { return; }
            if (ref.macros) {
                row.querySelector('.macro-cal').value = Math.round((ref.macros.calories || 0) * ratio);
                row.querySelector('.macro-pro').value = Math.round((ref.macros.protein || 0) * ratio);
                row.querySelector('.macro-carb').value = Math.round((ref.macros.carbs || 0) * ratio);
                row.querySelector('.macro-fat').value = Math.round((ref.macros.fat || 0) * ratio);
                row.querySelector('.macro-fib').value = Math.round((ref.macros.fiber || 0) * ratio);
            }
        }

        function calculateRecipeMacros(recipe) {
            let tm = { fat: 0, carbs: 0, fiber: 0, protein: 0, calories: 0 };
            if (recipe.ingredients) { recipe.ingredients.forEach(sec => { if (sec.list) sec.list.forEach(ing => { if (ing.macros) { tm.fat += (ing.macros.fat || 0); tm.carbs += (ing.macros.carbs || 0); tm.fiber += (ing.macros.fiber || 0); tm.protein += (ing.macros.protein || 0); tm.calories += (ing.macros.calories || 0); } }); }); }
            const s = recipe.servings || 1;
            const ps = { fat: Math.round(tm.fat / s), carbs: Math.round(tm.carbs / s), fiber: Math.round(tm.fiber / s), protein: Math.round(tm.protein / s), calories: Math.round(tm.calories / s) };
            ps.netCarbs = Math.max(0, ps.carbs - ps.fiber);
            return ps;
        }

        function toggleMenu() {
            if(menuModal.classList.contains('opacity-0')) { menuModal.classList.remove('opacity-0', 'pointer-events-none', '-translate-y-4'); } 
            else { menuModal.classList.add('opacity-0', 'pointer-events-none', '-translate-y-4'); }
        }

        function hideMenu() {
             menuModal.classList.add('opacity-0', 'pointer-events-none', '-translate-y-4');
        }

        function filterByTag(tag) {
            currentFilterTag = tag;
            renderRecipeGroups();
            window.scrollTo(0,0);
        }

        function clearTagFilter() {
            currentFilterTag = null;
            renderRecipeGroups();
        }

        function deleteRecipe(id) {
            if(!confirm("Delete recipe?")) return;
            let d = getCustomData(state.localStorageKeys.recipes).filter(r => String(r.id) !== String(id));
            saveCustomData(state.localStorageKeys.recipes, d);
            renderRecipeGroups();
            buildIngredientDB();
        }

        function saveCategory(e) {
            e.preventDefault(); const val = document.getElementById('category-modal-input').value.trim();
            if(val) { const d = getCustomData(state.localStorageKeys.categories); if(!d.includes(val)) { d.push(val); saveCustomData(state.localStorageKeys.categories, d); } modals.category.classList.add('hidden'); e.target.reset(); renderRecipeGroups(); }
        }
        
        function updateServings(change) {
            if (!currentRecipeBase) return;
            const currentSpan = document.getElementById('current-servings');
            let currentVal = parseInt(currentSpan.textContent);
            let newVal = currentVal + change;
            if (newVal < 1) newVal = 1;
            currentSpan.textContent = newVal;
            const baseServings = currentRecipeBase.servings || 1;
            const ratio = newVal / baseServings;
            document.querySelectorAll('.ingredient-line').forEach(line => {
                const baseQty = parseFloat(line.dataset.baseQty);
                if (!isNaN(baseQty) && baseQty > 0) {
                    const newQty = baseQty * ratio;
                    const unit = line.dataset.unit || "";
                    let result;
                    if (unit === 'g' || unit === 'ml' || unit === 'oz' || unit === 'lb' || unit === 'pounds') { 
                        result = { display: (Math.round(newQty * 10) / 10).toString(), unit: unit }; 
                        if (unit === 'g' || unit === 'ml') result.display = Math.round(newQty).toString(); 
                        if (unit === 'lb' || unit === 'pounds' || unit === 'oz') result.display = formatQuantity(newQty); 
                    } else { result = convertUnits(newQty, unit); }
                    line.querySelector('.qty-display').textContent = result.display;
                    line.querySelector('.unit-display').textContent = result.unit;
                }
            });
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('text-blue-400', 'border-b-2', 'border-blue-500'); b.classList.add('text-gray-400'); });
            const activeBtn = document.querySelector(`[data-tab="${tabId}"]`);
            if(activeBtn) { activeBtn.classList.add('text-blue-400', 'border-b-2', 'border-blue-500'); activeBtn.classList.remove('text-gray-400'); }
        }

        function addIngredientSection(data = null) {
            const div = document.createElement('div'); div.className = 'bg-gray-800 p-3 rounded-lg border border-gray-700 mb-4 ing-section'; div.innerHTML = `<div class="flex justify-between mb-2"><input type="text" class="section-title font-bold bg-transparent border-b border-gray-600 w-full mr-2" placeholder="Section Title" value="${data ? data.sectionTitle : ''}"><button type="button" class="text-red-400 text-xs remove-sec" onclick="this.parentElement.parentElement.remove()">Remove Section</button></div><div class="rows-container space-y-2"></div><button type="button" class="text-xs text-blue-400 mt-2 add-row-btn">+ Add Ingredient</button>`;
            const rows = div.querySelector('.rows-container');
            const addRow = (ing = null) => {
                const row = document.createElement('div'); row.className = 'ing-row grid grid-cols-12 gap-2 items-center bg-gray-700/30 p-2 rounded';
                row.innerHTML = `<input class="col-span-2 text-sm ing-qty" placeholder="Qty" value="${ing ? ing.quantity : ''}" onchange="autoFillMacros(this)"><input class="col-span-2 text-sm ing-unit" placeholder="Unit" value="${ing ? ing.unit : ''}" onchange="autoFillMacros(this)"><input class="col-span-4 text-sm ing-name" placeholder="Name" value="${ing ? ing.name : ''}" list="ingredient-datalist" onchange="autoFillMacros(this)"><input class="col-span-3 text-sm ing-notes" placeholder="Notes" value="${ing ? ing.notes || '' : ''}"><button type="button" class="col-span-1 text-red-400 remove-row" onclick="this.parentElement.remove()">X</button><button type="button" class="col-span-12 text-xs text-gray-400 text-left toggle-macros" onclick="this.nextElementSibling.classList.toggle('hidden')">‚ñº Macros</button><div class="col-span-12 grid grid-cols-5 gap-2 mt-1 macro-fields hidden bg-gray-700/50 p-2 rounded"><div><label class="text-[10px]">Calories</label><input type="number" class="macro-cal text-xs bg-gray-600 w-full" value="${ing&&ing.macros?ing.macros.calories:''}"></div><div><label class="text-[10px]">Protein</label><input type="number" class="macro-pro text-xs bg-gray-600 w-full" value="${ing&&ing.macros?ing.macros.protein:''}"></div><div><label class="text-[10px]">Carbs</label><input type="number" class="macro-carb text-xs bg-gray-600 w-full" value="${ing&&ing.macros?ing.macros.carbs:''}"></div><div><label class="text-[10px]">Fat</label><input type="number" class="macro-fat text-xs bg-gray-600 w-full" value="${ing&&ing.macros?ing.macros.fat:''}"></div><div><label class="text-[10px]">Fiber</label><input type="number" class="macro-fib text-xs bg-gray-600 w-full" value="${ing&&ing.macros?ing.macros.fiber:''}"></div></div>`;
                rows.appendChild(row);
            };
            div.querySelector('.add-row-btn').onclick = () => addRow();
            if (data && data.list) data.list.forEach(i => addRow(i)); else addRow();
            ingContainer.appendChild(div);
        }
        
        function addInstructionSection(data = null) {
            const div = document.createElement('div'); div.className = 'bg-gray-800 p-3 rounded-lg border border-gray-700 mb-4 inst-section'; div.innerHTML = `<div class="flex justify-between mb-2"><input type="text" class="section-title font-bold bg-transparent border-b border-gray-600 w-full mr-2" placeholder="Section Title" value="${data ? data.sectionTitle : ''}"><button type="button" class="text-red-400 text-xs remove-sec" onclick="this.parentElement.parentElement.remove()">Remove Section</button></div><div class="steps-container space-y-2"></div><button type="button" class="text-xs text-green-400 mt-2 add-step-btn">+ Add Step</button>`; 
            const steps = div.querySelector('.steps-container');
            const addStep = (text = '') => { const row = document.createElement('div'); row.className = 'flex gap-2 step-row'; row.innerHTML = `<textarea class="flex-1 text-sm bg-gray-700 border-gray-600 rounded p-1 step-text text-white" rows="2">${text}</textarea><button type="button" class="text-red-400 remove-step self-center" onclick="this.parentElement.remove()">X</button>`; steps.appendChild(row); }; 
            div.querySelector('.add-step-btn').onclick = () => addStep(); 
            if(data && data.steps) data.steps.forEach(s => addStep(s)); else addStep(); 
            instContainer.appendChild(div);
        }

        function saveRecipe() {
            const title = document.getElementById('form-title').value;
            if(!title) return alert("Title is required");
            const newRecipe = {
                id: currentEditingId || 'user_rec_' + Date.now(), title: title, description: document.getElementById('form-desc').value, category: document.getElementById('form-category').value,
                servings: parseInt(document.getElementById('form-servings').value) || 1, prepTime: document.getElementById('form-prep').value, cookTime: document.getElementById('form-cook').value, image: document.getElementById('form-image').value,
                source: { description: document.getElementById('form-source-desc').value, url: document.getElementById('form-source-url').value },
                tags: document.getElementById('form-tags').value.split(',').map(t => t.trim()).filter(t => t), ingredients: [], instructions: []
            };
            document.querySelectorAll('.ing-section').forEach(sec => { const section = { sectionTitle: sec.querySelector('.section-title').value, list: [] }; sec.querySelectorAll('.ing-row').forEach(row => { section.list.push({ name: row.querySelector('.ing-name').value, quantity: row.querySelector('.ing-qty').value, unit: row.querySelector('.ing-unit').value, notes: row.querySelector('.ing-notes').value, macros: { calories: parseFloat(row.querySelector('.macro-cal').value)||0, protein: parseFloat(row.querySelector('.macro-pro').value)||0, carbs: parseFloat(row.querySelector('.macro-carb').value)||0, fat: parseFloat(row.querySelector('.macro-fat').value)||0, fiber: parseFloat(row.querySelector('.macro-fib').value)||0 } }); }); newRecipe.ingredients.push(section); }); 
            document.querySelectorAll('.inst-section').forEach(sec => { const section = { sectionTitle: sec.querySelector('.section-title').value, steps: [] }; sec.querySelectorAll('.step-text').forEach(txt => section.steps.push(txt.value)); newRecipe.instructions.push(section); }); 
            let customRecipes = getCustomData(state.localStorageKeys.recipes); const idx = customRecipes.findIndex(r => String(r.id) === String(newRecipe.id)); if (idx >= 0) customRecipes[idx] = newRecipe; else customRecipes.push(newRecipe); saveCustomData(state.localStorageKeys.recipes, customRecipes); modals.recipe.classList.add('hidden');
            buildIngredientDB();
            if (currentEditingId) showDetailView(newRecipe.id); else renderRecipeGroups();
        }

        function openRecipeModal(recipe = null) {
            currentEditingId = recipe ? recipe.id : null;
            document.getElementById('recipe-modal-title').textContent = recipe ? "Edit Recipe" : "Add Recipe";
            document.getElementById('form-recipe-id').value = recipe ? recipe.id : "";
            document.getElementById('full-recipe-form').reset();
            ingContainer.innerHTML = ''; instContainer.innerHTML = '';
            const cats = [...STATIC_CATEGORIES, ...getCustomData(state.localStorageKeys.categories)].filter((v,i,a)=>a.indexOf(v)===i);
            document.getElementById('form-category').innerHTML = cats.map(c => `<option>${c}</option>`).join('');
            if (recipe) { document.getElementById('form-title').value = recipe.title; document.getElementById('form-desc').value = recipe.description; document.getElementById('form-category').value = recipe.category; document.getElementById('form-servings').value = recipe.servings; document.getElementById('form-prep').value = recipe.prepTime; document.getElementById('form-cook').value = recipe.cookTime; document.getElementById('form-image').value = recipe.image; if(recipe.source) { document.getElementById('form-source-desc').value = recipe.source.description; document.getElementById('form-source-url').value = recipe.source.url; } document.getElementById('form-tags').value = (recipe.tags || []).join(', '); if(recipe.ingredients) recipe.ingredients.forEach(sec => addIngredientSection(sec)); if(recipe.instructions) recipe.instructions.forEach(sec => addInstructionSection(sec)); } else { addIngredientSection(); addInstructionSection(); } modals.recipe.classList.remove('hidden'); switchTab('tab-general'); hideMenu();
        }

        function showDetailView(recipeId) {
            currentEditingId = String(recipeId);
            const recipe = getAllRecipes().find(r => String(r.id) === String(recipeId));
            if (!recipe) return;
            
            // --- URL UPDATE LOGIC ---
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?id=' + recipeId;
            window.history.replaceState({path:newUrl},'',newUrl);
            
            currentRecipeBase = recipe;
            views.list.classList.add('hidden'); views.detail.classList.remove('hidden'); window.scrollTo(0,0);
            
            // Hide share dropdown initially
            document.getElementById('share-dropdown').classList.add('hidden');
            // Show native share button only if navigator.share exists
            if (navigator.share) { document.getElementById('native-share-btn').classList.remove('hidden'); }
            
            const ps = calculateRecipeMacros(recipe);
            containers.detail.innerHTML = `<div class="flex flex-col md:flex-row gap-6 mb-8"><img src="${recipe.image}" class="w-full md:w-1/2 rounded-xl object-cover h-96 shadow-lg border border-gray-700" onerror="this.src='https://placehold.co/400x250?text=No+Image'"><div class="flex-1 flex flex-col justify-center"><h1 class="text-4xl font-extrabold text-white mb-2">${recipe.title.replace(' (test)', '')}</h1>${recipe.source ? `<div class="text-sm text-blue-300 mb-4 font-medium">Source: ${recipe.source.url ? `<a href="${recipe.source.url}" target="_blank" class="underline hover:text-white transition">${recipe.source.description}</a>` : recipe.source.description}</div>` : ''}<p class="text-gray-400 italic mb-6 text-lg">${recipe.description || ''}</p><div class="flex gap-4 mb-6 text-sm"><span class="bg-gray-700 px-3 py-1 rounded">Prep: <strong>${recipe.prepTime}</strong></span><span class="bg-gray-700 px-3 py-1 rounded">Cook: <strong>${recipe.cookTime}</strong></span><div class="bg-gray-700 px-3 py-1 rounded flex items-center space-x-2 select-none"><span>Serves:</span><button onclick="window.updateServings(-1)" class="text-blue-400 hover:text-white font-bold text-lg px-1">‚àí</button><strong id="current-servings">${recipe.servings}</strong><button onclick="window.updateServings(1)" class="text-blue-400 hover:text-white font-bold text-lg px-1">+</button></div></div><div class="bg-gray-900/80 p-4 rounded-xl border border-gray-700"><h3 class="text-xs font-bold text-gray-500 uppercase mb-2 text-center">Per Serving</h3><div class="grid grid-cols-3 sm:grid-cols-6 gap-2 text-center"><div><div class="text-xl font-black text-white">${ps.calories}</div><div class="text-[10px] text-gray-500 uppercase">Calories</div></div><div><div class="text-lg font-bold text-blue-400">${ps.protein}g</div><div class="text-[10px] text-gray-500 uppercase">Protein</div></div><div><div class="text-lg font-bold text-green-400">${ps.carbs}g</div><div class="text-[10px] text-gray-500 uppercase">Carbs</div></div><div><div class="text-lg font-bold text-emerald-400">${ps.netCarbs}g</div><div class="text-[10px] text-gray-500 uppercase">Net Carb</div></div><div><div class="text-lg font-bold text-yellow-400">${ps.fat}g</div><div class="text-[10px] text-gray-500 uppercase">Fat</div></div><div><div class="text-lg font-bold text-gray-300">${ps.fiber}g</div><div class="text-[10px] text-gray-500 uppercase">Fiber</div></div></div></div></div></div><div class="grid md:grid-cols-2 gap-8"><div><h2 class="text-2xl font-bold border-b border-blue-900/50 pb-2 mb-4 text-blue-300">Ingredients</h2>${(recipe.ingredients || []).map(section => `<div class="mb-6"><h3 class="text-lg font-semibold text-white mb-2 pl-2 border-l-2 border-blue-500">${section.sectionTitle}</h3><ul class="space-y-2">${section.list.map(ing => { const baseQty = parseQuantity(ing.quantity); const displayQty = (ing.unit==='g'||ing.unit==='ml'||ing.unit==='oz'||ing.unit==='lb'||ing.unit==='pounds') ? formatQuantity(baseQty) : formatQuantity(baseQty); return `<li class="flex justify-between border-b border-gray-700/50 pb-1 ingredient-line" data-base-qty="${baseQty}" data-unit="${ing.unit}"><span class="text-gray-200"><span class="font-bold text-white qty-display">${displayQty}</span> <span class="font-bold text-white unit-display">${ing.unit}</span> ${ing.name}</span><span class="text-xs text-gray-500 italic ml-2">${prettifyFractions(ing.notes||'')}</span></li>` }).join('')}</ul></div>`).join('')}</div><div><h2 class="text-2xl font-bold border-b border-green-900/50 pb-2 mb-4 text-green-300">Instructions</h2>${(recipe.instructions || []).map(section => `<div class="mb-8"><h3 class="text-lg font-semibold text-white mb-3 pl-2 border-l-2 border-green-500">${section.sectionTitle}</h3><ol class="list-decimal list-outside space-y-4 text-gray-300 pl-5">${section.steps.map(step => `<li class="pl-2 instruction-step" data-original-text="${step.replace(/"/g, '&quot;')}">${prettifyFractions(step)}</li>`).join('')}</ol></div>`).join('')}</div></div>`;
            const tagsContainer = document.createElement('div'); tagsContainer.className = 'flex flex-wrap gap-1 mb-4'; if(recipe.tags) { recipe.tags.forEach(tag => { const btn = document.createElement('button'); btn.className = 'px-2 py-1 text-xs rounded-full bg-blue-900/50 text-blue-300 hover:bg-blue-600 hover:text-white transition'; btn.textContent = tag; btn.onclick = (e) => { e.stopPropagation(); filterByTag(tag); }; tagsContainer.appendChild(btn); }); } containers.detail.querySelector('h1').after(tagsContainer);
            document.getElementById('edit-recipe-btn').onclick = () => openRecipeModal(recipe); document.getElementById('delete-recipe-btn').onclick = () => deleteRecipe(recipe.id);
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = "fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-2xl z-50 transition-opacity duration-300 opacity-0 border border-gray-600";
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Trigger reflow to enable transition
            void toast.offsetWidth; 
            
            toast.classList.remove('opacity-0');
            
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
        
        async function shareLink(type) {
             const url = window.location.href;
             document.getElementById('share-dropdown').classList.add('hidden');
             if (type === 'copy') {
                 try { 
                     await navigator.clipboard.writeText(url); 
                     showToast('Link copied to clipboard!'); 
                 } catch(err) { 
                     prompt("Copy this link:", url); 
                 }
             } else if (type === 'sms') {
                 window.location.href = `sms:?body=Check out this recipe: ${encodeURIComponent(url)}`;
             } else if (type === 'messenger') {
                 // Try to open messenger app protocol, fallback to standard share if needed (hard to target messenger web specifically without app ID)
                 window.location.href = `fb-messenger://share/?link=${encodeURIComponent(url)}`;
             } else if (type === 'native' && navigator.share) {
                 navigator.share({ title: currentRecipeBase.title, text: 'Check out this recipe!', url: url });
             }
        }

        function createRecipeCard(r) {
            const ps = calculateRecipeMacros(r);
            const letter = r.title.charAt(0).toUpperCase();
            const tags = (r.tags||[]).map(t => `<span class="px-2 py-0.5 text-xs rounded-full bg-blue-900/50 text-blue-300 hover:bg-blue-600 hover:text-white transition" onclick="event.stopPropagation(); filterByTag('${t}')">${t}</span>`).join('');
            return `<div class="recipe-card bg-gray-800 border border-gray-700 rounded-xl shadow-lg overflow-hidden hover:bg-gray-700 transition duration-200" onclick="showDetailView('${r.id}')"><img src="${r.image}" class="w-full h-32 object-cover" onerror="this.src='https://placehold.co/400?text=${r.title[0]}'"><div class="p-3"><h3 class="text-lg font-bold text-white truncate">${r.title.replace(' (test)','')}</h3><p class="text-xs text-gray-400 mt-1 mb-2">${r.prepTime} | ${r.cookTime}</p><div class="flex gap-2 text-[10px] text-gray-300 mb-2 font-mono border-t border-b border-gray-700/50 py-1"><span class="text-white font-bold">${ps.calories}</span> Cal | <span class="text-blue-300">${ps.protein}g</span> P | <span class="text-emerald-300">${ps.netCarbs}g</span> NC | <span class="text-yellow-300">${ps.fat}g</span> F</div><div class="flex flex-wrap gap-1">${tags}</div></div></div>`;
        }

        function renderRecipeGroups() {
            views.detail.classList.add('hidden');
            views.list.classList.remove('hidden');
            
            // --- URL CLEANUP ---
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
            window.history.replaceState({path:newUrl},'',newUrl);
            
            const allRecipes = getAllRecipes();
            const customCats = getCustomData(state.localStorageKeys.categories);
            const customTags = getCustomData(state.localStorageKeys.tags);
            const allCategories = [...STATIC_CATEGORIES, ...customCats].filter((v, i, a) => a.indexOf(v) === i);
            containers.groups.innerHTML = '';

            const counts = {}; 
            allRecipes.forEach(r => (r.tags||[]).forEach(t => counts[t]=(counts[t]||0)+1));

            const allTagsSet = new Set([...STATIC_TAGS, ...customTags]); allRecipes.forEach(r => (r.tags||[]).forEach(t => allTagsSet.add(t)));
            const sortedTags = Array.from(allTagsSet).sort();
            
            const colors = ["text-blue-400","text-green-400","text-yellow-400","text-red-400","text-purple-400","text-pink-400"];
            
            // --- UPDATED LOGIC (5 + count*3) ---
            containers.tags.innerHTML = sortedTags.map(tag => {
                const count = counts[tag] || 0;
                const fontSize = 5 + (count * 3); 
                return `<button onclick="filterByTag('${tag}')" style="font-size: ${fontSize}pt;" class="tag-cloud-item font-bold ${colors[Math.floor(Math.random()*colors.length)]} hover:scale-110 transition duration-200 cursor-pointer px-2">${tag}</button>`;
            }).join('');
            // --------------------------

            let displayRecipes = allRecipes;

            if (currentSearchTerm) {
                const term = currentSearchTerm.toLowerCase();
                displayRecipes = displayRecipes.filter(r => {
                    const inTitle = r.title.toLowerCase().includes(term);
                    const inDesc = (r.description || '').toLowerCase().includes(term);
                    const inSource = r.source && ((r.source.description || '').toLowerCase().includes(term) || (r.source.url || '').toLowerCase().includes(term));
                    const inIng = r.ingredients && r.ingredients.some(sec => sec.list.some(ing => ing.name.toLowerCase().includes(term) || (ing.notes || '').toLowerCase().includes(term)));
                    const inInst = r.instructions && r.instructions.some(sec => sec.steps.some(step => step.toLowerCase().includes(term)));
                    return inTitle || inDesc || inSource || inIng || inInst;
                });
            }

            if (currentFilterTag) {
                const filtered = displayRecipes.filter(r => (r.tags || []).includes(currentFilterTag));
                containers.groups.innerHTML = `<div class="flex items-center justify-between mb-4"><h2 class="text-2xl font-bold text-white">Recipes Tagged: <span class="text-blue-400">${currentFilterTag}</span></h2><button onclick="clearTagFilter()" class="text-sm bg-gray-700 px-3 py-1 rounded text-gray-200">Clear Filter ‚úï</button></div><div class="flex flex-wrap gap-4 justify-start">${filtered.map(r => createRecipeCard(r)).join('')}</div>`;
                return;
            }
            
            if (currentSearchTerm && !currentFilterTag) {
                 if (displayRecipes.length === 0) {
                     containers.groups.innerHTML = `<p class="text-center text-gray-500 mt-10">No recipes found matching "${currentSearchTerm}"</p>`;
                 } else {
                     containers.groups.innerHTML = `<div class="mb-4 text-gray-400 text-sm">Found ${displayRecipes.length} matching recipes</div><div class="flex flex-wrap gap-4 justify-start">${displayRecipes.map(r => createRecipeCard(r)).join('')}</div>`;
                 }
                 return;
            }

            const grouped = new Map();
            displayRecipes.forEach(r => { const c = r.category || 'Uncategorized'; if(!grouped.has(c)) grouped.set(c, []); grouped.get(c).push(r); });
            [...allCategories, 'Uncategorized'].forEach(cat => {
                const recipes = grouped.get(cat);
                if(recipes && recipes.length) {
                    containers.groups.innerHTML += `<section><div class="bg-gray-800 border border-gray-700 inline-block px-4 py-1.5 rounded-full mb-4 text-lg font-semibold text-white shadow-md">${cat.replace(' (test)', '')}</div><div class="flex flex-wrap gap-4 justify-start">${recipes.map(r => createRecipeCard(r)).join('')}</div></section>`;
                }
            });
            if(!containers.groups.innerHTML) containers.groups.innerHTML = '<p class="text-center text-gray-500 mt-10">No recipes found.</p>';
        }

        function downloadDataFile() { hideMenu(); const customRecipes = getCustomData(state.localStorageKeys.recipes); const cleanStatic = STATIC_RECIPES.map(r => ({...r, title: r.title.replace(' (test)', '')})); const exportMap = new Map(); cleanStatic.forEach(r => exportMap.set(String(r.id), r)); customRecipes.forEach(r => exportMap.set(String(r.id), r)); const data = { recipes: Array.from(exportMap.values()), categories: [...STATIC_CATEGORIES, ...getCustomData(state.localStorageKeys.categories)].filter((v,i,a)=>a.indexOf(v)===i), availableTags: [...STATIC_TAGS, ...getCustomData(state.localStorageKeys.tags)].filter((v,i,a)=>a.indexOf(v)===i) }; const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `recipes-data-${new Date().toISOString().slice(0,10)}.json`; a.click(); }
        function clearDraftData() { localStorage.removeItem(state.localStorageKeys.recipes); localStorage.removeItem(state.localStorageKeys.categories); localStorage.removeItem(state.localStorageKeys.tags); hideMenu(); initRecipeDashboard(); }

        // --- EXPOSING FUNCTIONS TO GLOBAL SCOPE ---
        window.toggleMenu = toggleMenu;
        window.hideMenu = hideMenu;
        window.filterByTag = filterByTag;
        window.clearTagFilter = clearTagFilter;
        window.deleteRecipe = deleteRecipe;
        window.saveCategory = saveCategory;
        window.updateServings = updateServings;
        window.switchTab = switchTab;
        window.saveRecipe = saveRecipe;
        window.openRecipeModal = openRecipeModal;
        window.showDetailView = showDetailView;
        window.downloadDataFile = downloadDataFile;
        window.clearDraftData = clearDraftData;
        window.addIngredientSection = addIngredientSection;
        window.addInstructionSection = addInstructionSection;
        window.renderRecipeGroups = renderRecipeGroups;
        window.autoFillMacros = autoFillMacros;
        window.handleSearch = handleSearch;
        window.shareLink = shareLink;
        window.showToast = showToast;

        // --- INIT ---
        async function initRecipeDashboard() {
            initDOM(); 
            
            // 1. Load Data FIRST
            let data = EMBEDDED_RECIPES;
            try { 
                const res = await fetch('/recipes_data.json'); 
                if(res.ok) data = await res.json(); 
            } catch(e) {
                console.log("Using embedded data");
            }
            
            // 2. Set Global Variables
            STATIC_RECIPES = data.recipes || []; 
            STATIC_CATEGORIES = data.categories || []; 
            STATIC_TAGS = data.availableTags || [];
            
            // 3. Build DB
            buildIngredientDB();
            
            // 4. Check URL for ID *AFTER* data is loaded
            const urlParams = new URLSearchParams(window.location.search);
            const recipeId = urlParams.get('id');
            
            if(recipeId) {
                const all = getAllRecipes();
                const targetRecipe = all.find(r => String(r.id) === String(recipeId));
                
                if(targetRecipe) {
                    showDetailView(recipeId);
                } else {
                    const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                    window.history.replaceState({path:newUrl},'',newUrl);
                    renderRecipeGroups();
                }
            } else {
                renderRecipeGroups();
            }
        }
        async function updateWeather() { try { const res = await fetch('https://api.openweathermap.org/data/2.5/weather?zip=75482,us&units=imperial&appid=87256fe2710631542ff491e4c5d73306'); if(res.ok) { const d = await res.json(); document.getElementById('weather-current-temp').textContent = Math.round(d.main.temp)+'¬∞'; document.getElementById('weather-current-temp').className = `text-lg font-bold mr-3 ${getTempColor(d.main.temp)}`; document.getElementById('weather-low').textContent = Math.round(d.main.temp_min)+'¬∞'; document.getElementById('weather-low').className = `low-temp-offset mr-1 text-xs ${getTempColor(d.main.temp_min)}`; document.getElementById('weather-high').textContent = Math.round(d.main.temp_max)+'¬∞'; document.getElementById('weather-high').className = `high-temp-offset text-xs ${getTempColor(data.main.temp_max)}`; document.getElementById('weather-icon').innerHTML = getForecastEmoji(d.weather[0].icon); } } catch(e) {} }
        function updateClock() { const now = new Date(); document.getElementById('datetime').innerHTML = `<span class="text-gray-400">${now.toLocaleDateString()}</span> <span class="text-blue-300 ml-1">${now.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'}).toLowerCase()}</span>`; }

        window.onload = () => { initRecipeDashboard(); setInterval(updateClock, 1000); updateClock(); updateWeather(); };
    </script>
</body>
</html>
