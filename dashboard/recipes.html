<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stephens' Recipes V0.6.12</title>
    <link rel="icon" href="/images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }
        html { font-family: 'Inter', sans-serif; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.75); backdrop-filter: blur(4px); }
        .recipe-card { width: 100%; max-width: 300px; min-width: 250px; cursor: pointer; }
        input, textarea, select { background-color: #374151; border: 1px solid #4B5563; color: white; padding: 0.5rem; border-radius: 0.375rem; width: 100%; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: #3B82F6; ring: 2px; ring-color: #3B82F6; }
        .low-temp-offset { position: relative; top: 2px; }
        .high-temp-offset { position: relative; bottom: 2px; }
        
        /* Tag Cloud Animation */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
            100% { transform: translateY(0px); }
        }
        .tag-cloud-item:hover {
            animation: float 2s ease-in-out infinite;
            text-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }
    </style>
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'], }, } } }
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 sm:p-8">

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 right-0 bg-gray-800 border-b border-gray-700 shadow-xl z-30 p-2 flex items-center justify-between">
        <div class="flex items-center">
            <button id="menu-button" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 focus:outline-none mr-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
            <a href="index.html" class="text-gray-400 hover:text-white mr-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0h6"></path></svg>
            </a>
            <div id="datetime" class="text-sm sm:text-base font-medium"></div>
        </div>
        <div id="weather-display" class="text-sm flex items-center bg-gray-700 px-3 py-1 rounded-full border border-gray-600">
            <span class="flex items-center" id="weather-content">
                <span id="weather-current-temp" class="text-lg font-bold mr-3">--¬∞</span>
                <span id="weather-low" class="low-temp-offset mr-1 text-xs">--¬∞</span>
                <span class="mr-1 text-xl" id="weather-icon">...</span>
                <span id="weather-high" class="high-temp-offset text-xs">--¬∞</span>
            </span>
        </div>
    </nav>

    <!-- Menu Dropdown -->
    <div id="menu-modal" class="fixed top-[4rem] left-4 z-40 opacity-0 pointer-events-none transform -translate-y-4 transition-all duration-300 ease-out max-w-xs z-50">
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 shadow-2xl w-64">
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h3 class="text-xl font-semibold text-white">Recipe Menu</h3>
                <button id="close-menu-button" class="text-gray-400 hover:text-white p-1">X</button>
            </div>
            <button id="add-recipe-button" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-2 transition duration-150">Add New Recipe</button>
            <button id="add-category-button" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-4 transition duration-150">Add New Category</button>
            <button id="download-data-button" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-4 transition duration-150">Download Data File</button>
            <button id="clear-draft-button" class="w-full text-left py-2 px-3 rounded-lg text-red-400 hover:bg-red-900/20 mb-4 transition duration-150 border border-red-700/50">Clear Local Data</button>
            <p id="version-display" class="text-sm font-mono text-gray-300">Recipe Dashboard V0.6.12</p>
        </div>
    </div>

    <!-- LIST VIEW Container -->
    <main id="recipes-content" class="px-4 sm:px-8 pt-16 pb-8">
        <div id="recipe-groups-container" class="flex flex-col space-y-8 min-h-[200px]"></div>
        
        <!-- Tag Cloud Section -->
        <div id="tag-cloud-wrapper" class="mt-16 pt-8 border-t border-gray-700">
            <div id="tag-cloud-container" class="flex flex-wrap gap-x-4 gap-y-2 justify-center items-baseline p-4"></div>
        </div>
    </main>

    <!-- DETAIL VIEW Container -->
    <main id="recipe-detail-view" class="px-4 sm:px-8 pt-16 pb-8 hidden">
        <div class="flex justify-between items-start mb-4 z-40 relative">
            <button id="back-to-list" class="flex items-center text-gray-400 hover:text-white transition px-3 py-2 rounded-lg hover:bg-gray-800 bg-gray-800 border border-gray-700">
                <span class="mr-1">‚Üê</span> Back
            </button>
            <div class="flex space-x-2">
                <button id="edit-recipe-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg> Edit
                </button>
                <button id="delete-recipe-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex items-center">
                   <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg> Delete
                </button>
            </div>
        </div>
        <div id="detail-content" class="bg-gray-800 rounded-2xl p-6 border border-gray-700 shadow-2xl max-w-5xl mx-auto">
            <!-- Content injected via JS -->
        </div>
    </main>
    
    <!-- RECIPE MODAL (Full Screen / Tabbed) -->
    <div id="recipe-form-modal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center hidden">
        <div class="bg-900 border border-gray-700 rounded-2xl w-full max-w-4xl h-[90vh] flex flex-col shadow-2xl overflow-hidden m-4 bg-gray-900">
            <!-- Header -->
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800">
                <h2 class="text-xl font-bold text-white" id="recipe-modal-title">Add Recipe</h2>
                <button id="close-recipe-modal" class="text-gray-400 hover:text-white">‚úï</button>
            </div>
            <!-- Tabs -->
            <div class="flex border-b border-gray-700 bg-gray-800">
                <button class="tab-btn flex-1 py-3 text-sm font-medium text-blue-400 border-b-2 border-blue-500 transition" data-tab="tab-general">General Info</button>
                <button class="tab-btn flex-1 py-3 text-sm font-medium text-gray-400 hover:text-white transition" data-tab="tab-ingredients">Ingredients</button>
                <button class="tab-btn flex-1 py-3 text-sm font-medium text-gray-400 hover:text-white transition" data-tab="tab-instructions">Instructions</button>
            </div>
            <!-- Body -->
            <div class="flex-1 overflow-y-auto p-6">
                <form id="full-recipe-form">
                    <input type="hidden" id="form-recipe-id">
                    <!-- TAB: GENERAL -->
                    <div id="tab-general" class="tab-content space-y-4">
                        <div><label class="block text-sm text-gray-400 mb-1">Title</label><input type="text" id="form-title" required class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></div>
                        <div><label class="block text-sm text-gray-400 mb-1">Description</label><textarea id="form-desc" rows="3" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></textarea></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm text-gray-400 mb-1">Category</label><select id="form-category" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></select></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Servings</label><input type="number" id="form-servings" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm text-gray-400 mb-1">Prep Time</label><input type="text" id="form-prep" placeholder="e.g. 15 mins" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Cook Time</label><input type="text" id="form-cook" placeholder="e.g. 1 hour" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></div>
                        </div>
                        <div><label class="block text-sm text-gray-400 mb-1">Image URL</label><input type="url" id="form-image" placeholder="https://..." class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm text-gray-400 mb-1">Source Description</label><input type="text" id="form-source-desc" placeholder="e.g. Grandma's Kitchen" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></div>
                            <div><label class="block text-sm text-gray-400 mb-1">Source URL</label><input type="url" id="form-source-url" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></div>
                        </div>
                        <div><label class="block text-sm text-gray-400 mb-1">Tags (comma separated)</label><input type="text" id="form-tags" placeholder="Dinner, Keto, Spicy" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white"></div>
                    </div>

                    <!-- TAB: INGREDIENTS -->
                    <div id="tab-ingredients" class="tab-content hidden space-y-4">
                        <div id="ingredients-container"></div>
                        <button type="button" id="add-ing-section-btn" class="w-full py-2 border-2 border-dashed border-gray-600 text-gray-400 rounded-lg hover:border-gray-400 hover:text-white transition">+ Add Ingredient Section</button>
                    </div>

                    <!-- TAB: INSTRUCTIONS -->
                    <div id="tab-instructions" class="tab-content hidden space-y-4">
                        <div id="instructions-container"></div>
                        <button type="button" id="add-inst-section-btn" class="w-full py-2 border-2 border-dashed border-gray-600 text-gray-400 rounded-lg hover:border-gray-400 hover:text-white transition">+ Add Instruction Section</button>
                    </div>
                </form>
            </div>
            <!-- Footer -->
            <div class="p-4 border-t border-gray-700 bg-gray-800 flex justify-end gap-3">
                <button type="button" id="cancel-recipe-btn" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                <button type="button" id="save-recipe-btn" class="bg-blue-600 px-6 py-2 rounded-lg text-white hover:bg-blue-700 font-bold" onclick="saveRecipe()">Save Recipe</button>
            </div>
        </div>
    </div>

    <!-- Simple Modals -->
    <div id="add-category-modal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Add Category</h2>
            <form id="category-form" onsubmit="saveCategory(event)"><input type="text" id="category-modal-input" class="mb-4 w-full bg-gray-700 border border-gray-600 rounded p-2 text-white" required><div class="flex justify-end gap-2"><button type="button" class="close-simple-modal text-gray-400 px-3 py-2">Cancel</button><button type="submit" class="bg-green-600 px-4 py-2 rounded text-white">Add</button></div></form>
        </div>
    </div>

    <!-- JS Logic -->
    <script>
        (function() {
            // --- VARIABLES ---
            const menuModal = document.getElementById('menu-modal');
            const ingContainer = document.getElementById('ingredients-container');
            const instContainer = document.getElementById('instructions-container');
            const modals = { recipe: document.getElementById('recipe-form-modal'), category: document.getElementById('add-category-modal') };
            const views = { list: document.getElementById('recipes-content'), detail: document.getElementById('recipe-detail-view') };
            const containers = { groups: document.getElementById('recipe-groups-container'), detail: document.getElementById('detail-content'), tags: document.getElementById('tag-cloud-container') };

            let STATIC_RECIPES = [], STATIC_CATEGORIES = [], STATIC_TAGS = [];
            let currentFilterTag = null, currentEditingId = null;
            let currentRecipeBase = null;
            const state = { localStorageKeys: { recipes: 'sd_custom_recipes', categories: 'sd_custom_categories', tags: 'sd_custom_tags' } };
            const EMBEDDED_RECIPES = { 
                "categories": ["Bread", "Soup", "Dessert"], 
                "availableTags": ["gluten free", "keto", "dairy free"], 
                "recipes": [ { "id": "1", "title": "Hearty Classic Chili", "category": "Soup", "description": "Test recipe.", "tags": ["Dinner"], "prepTime": "15m", "cookTime": "4h", "servings": 8, "image": "https://placehold.co/400x250/111827/ffffff?text=Chili", "ingredients": [{ "sectionTitle": "Base", "list": [{ "name": "Beef", "quantity": 2, "unit": "lbs", "macros": { "fat":110,"carbs":0,"protein":140,"calories":1500 } }] }], "instructions": [{ "sectionTitle": "Prep", "steps": ["Cook."] }] } ] 
            };

            // --- HELPERS (Hoisted) ---
            function getCustomData(key) { try { return JSON.parse(localStorage.getItem(key)) || []; } catch { return []; } }
            function saveCustomData(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
            function getTempColor(t) { t=parseInt(t); if(t>=80)return'text-red-500'; if(t>70)return'text-green-400'; if(t>=60)return'text-green-400/80'; if(t<50)return'text-sky-300'; return'text-white'; }
            function getForecastEmoji(c) { if(c.includes('01'))return'‚òÄÔ∏è'; if(c.includes('02'))return'üå§Ô∏è'; if(c.includes('03'))return'üå•Ô∏è'; if(c.includes('09')||c.includes('10'))return'üåßÔ∏è'; if(c.includes('13'))return'‚ùÑÔ∏è'; return'‚òÅÔ∏è'; }
            
            function parseQuantity(q) {
                if (!q) return 0;
                if (typeof q === 'number') return q;
                const parts = String(q).split(' ');
                let total = 0;
                parts.forEach(p => {
                    if (p.includes('/')) { const [n, d] = p.split('/'); total += parseFloat(n) / parseFloat(d); }
                    else { total += parseFloat(p); }
                });
                return isNaN(total) ? 0 : total;
            }

            function formatQuantity(num) {
                if (num <= 0.02) return "Pinch";
                if (num <= 0) return "";
                const fractions = [ { val: 0.125, str: "1/8" }, { val: 0.25, str: "1/4" }, { val: 0.333, str: "1/3" }, { val: 0.5, str: "1/2" }, { val: 0.666, str: "2/3" }, { val: 0.75, str: "3/4" } ];
                const whole = Math.floor(num);
                let decimal = num - whole;
                let bestFrac = "";
                for (let f of fractions) { if (Math.abs(decimal - f.val) < 0.1) { decimal = f.val; bestFrac = f.str; break; } }
                if (Math.abs(decimal - 1) < 0.1) return String(whole + 1);
                if (Math.abs(decimal) < 0.1) return whole > 0 ? String(whole) : "Pinch";
                if (whole > 0 && bestFrac) return `${whole} ${bestFrac}`;
                if (whole > 0) return String(whole);
                return bestFrac || num.toFixed(1).replace('.0', '');
            }

            function convertUnits(qty, unit) {
                let newQty = qty;
                let newUnit = unit ? unit.toLowerCase().trim() : "";
                if (newUnit === 'tablespoon' || newUnit === 'tbsp' || newUnit === 'tbs') newUnit = 'Tbsp';
                if (newUnit === 'teaspoon' || newUnit === 'tsp') newUnit = 'tsp';
                if (newUnit === 'cup' || newUnit === 'cups') newUnit = 'cup';
                if (newUnit === 'cup' && newQty < 0.25) { newQty = newQty * 16; newUnit = 'Tbsp'; }
                if (newUnit === 'Tbsp' && newQty < 0.34) { newQty = newQty * 3; newUnit = 'tsp'; }
                if (newUnit === 'tsp' && newQty < 0.125) { return { qty: 0, display: "Pinch", unit: "" }; }
                return { qty: newQty, unit: newUnit, display: formatQuantity(newQty) };
            }

            function getAllRecipes() {
                const staticRecs = STATIC_RECIPES.map(r => ({...r, source_type: 'static'}));
                const customRecs = getCustomData(state.localStorageKeys.recipes).map(r => ({...r, source_type: 'custom'}));
                const map = new Map();
                staticRecs.forEach(r => map.set(String(r.id), r));
                customRecs.forEach(r => map.set(String(r.id), r));
                return Array.from(map.values());
            }

            // --- UI & EXPOSED FUNCTIONS ---
            function toggleMenu() {
                if (menuModal.classList.contains('opacity-0')) { menuModal.classList.remove('opacity-0', 'pointer-events-none', '-translate-y-4'); }
                else { menuModal.classList.add('opacity-0', 'pointer-events-none', '-translate-y-4'); }
            }
            function hideMenu() { menuModal.classList.add('opacity-0', 'pointer-events-none', '-translate-y-4'); }

            // Expose helper functions to window for HTML onclick
            window.toggleMenu = toggleMenu;
            window.hideMenu = hideMenu;
            
            window.switchTab = function(tabId) {
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.getElementById(tabId).classList.remove('hidden');
                document.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('text-blue-400', 'border-b-2', 'border-blue-500'); b.classList.add('text-gray-400'); });
                const activeBtn = document.querySelector(`[data-tab="${tabId}"]`);
                if(activeBtn) { activeBtn.classList.add('text-blue-400', 'border-b-2', 'border-blue-500'); activeBtn.classList.remove('text-gray-400'); }
            };

            window.addIngredientSection = function(data = null) {
                const div = document.createElement('div');
                div.className = 'bg-gray-800 p-3 rounded-lg border border-gray-700 mb-4 ing-section';
                div.innerHTML = `<div class="flex justify-between mb-2"><input type="text" class="section-title font-bold bg-transparent border-b border-gray-600 w-full mr-2" placeholder="Section Title (e.g. Sauce)" value="${data ? data.sectionTitle : ''}"><button type="button" class="text-red-400 text-xs remove-sec" onclick="this.parentElement.parentElement.remove()">Remove</button></div><div class="rows-container space-y-2"></div><button type="button" class="text-xs text-blue-400 mt-2 add-row-btn">+ Add Ingredient</button>`;
                const rowsContainer = div.querySelector('.rows-container');
                const addRow = (ing = null) => {
                    const row = document.createElement('div');
                    row.className = 'ing-row grid grid-cols-12 gap-2 items-center bg-gray-700/30 p-2 rounded';
                    row.innerHTML = `<input class="col-span-2 text-sm ing-qty" placeholder="Qty" value="${ing ? ing.quantity : ''}"><input class="col-span-2 text-sm ing-unit" placeholder="Unit" value="${ing ? ing.unit : ''}"><input class="col-span-4 text-sm ing-name" placeholder="Name" value="${ing ? ing.name : ''}"><input class="col-span-3 text-sm ing-notes" placeholder="Notes" value="${ing ? ing.notes || '' : ''}"><button type="button" class="col-span-1 text-red-400 remove-row" onclick="this.parentElement.remove()">X</button><button type="button" class="col-span-12 text-xs text-gray-400 text-left toggle-macros" onclick="this.nextElementSibling.classList.toggle('hidden')">‚ñº Macros</button><div class="col-span-12 grid grid-cols-5 gap-2 mt-1 macro-fields hidden bg-gray-700/50 p-2 rounded"><div><label class="text-[10px]">Cal</label><input type="number" class="macro-cal text-xs bg-gray-600 w-full" value="${ing&&ing.macros?ing.macros.calories:''}"></div><div><label class="text-[10px]">Pro</label><input type="number" class="macro-pro text-xs bg-gray-600 w-full" value="${ing&&ing.macros?ing.macros.protein:''}"></div><div><label class="text-[10px]">Carb</label><input type="number" class="macro-carb text-xs bg-gray-600 w-full" value="${ing&&ing.macros?ing.macros.carbs:''}"></div><div><label class="text-[10px]">Fat</label><input type="number" class="macro-fat text-xs bg-gray-600 w-full" value="${ing&&ing.macros?ing.macros.fat:''}"></div><div><label class="text-[10px]">Fib</label><input type="number" class="macro-fib text-xs bg-gray-600 w-full" value="${ing&&ing.macros?ing.macros.fiber:''}"></div></div>`;
                    rowsContainer.appendChild(row);
                };
                div.querySelector('.add-row-btn').onclick = () => addRow();
                if (data && data.list) data.list.forEach(i => addRow(i)); else addRow();
                ingContainer.appendChild(div);
            };

            window.addInstructionSection = function(data = null) {
                const div = document.createElement('div');
                div.className = 'bg-gray-800 p-3 rounded-lg border border-gray-700 mb-4 inst-section';
                div.innerHTML = `<div class="flex justify-between mb-2"><input type="text" class="section-title font-bold bg-transparent border-b border-gray-600 w-full mr-2" placeholder="Section Title" value="${data ? data.sectionTitle : ''}"><button type="button" class="text-red-400 text-xs remove-sec" onclick="this.parentElement.parentElement.remove()">Remove</button></div><div class="steps-container space-y-2"></div><button type="button" class="text-xs text-green-400 mt-2 add-step-btn">+ Add Step</button>`;
                const stepsContainer = div.querySelector('.steps-container');
                const addStep = (text = '') => {
                    const row = document.createElement('div');
                    row.className = 'flex gap-2 step-row';
                    row.innerHTML = `<textarea class="flex-1 text-sm bg-gray-700 border-gray-600 rounded p-1 step-text text-white" rows="2">${text}</textarea><button type="button" class="text-red-400 remove-step self-center" onclick="this.parentElement.remove()">X</button>`;
                    stepsContainer.appendChild(row);
                };
                div.querySelector('.add-step-btn').onclick = () => addStep();
                if(data && data.steps) data.steps.forEach(s => addStep(s)); else addStep();
                instContainer.appendChild(div);
            };

            window.updateServings = function(change) {
                if (!currentRecipeBase) return;
                const currentSpan = document.getElementById('current-servings');
                let currentVal = parseInt(currentSpan.textContent);
                let newVal = currentVal + change;
                if (newVal < 1) newVal = 1;
                currentSpan.textContent = newVal;
                
                const baseServings = currentRecipeBase.servings || 1;
                const ratio = newVal / baseServings;

                document.querySelectorAll('.ingredient-line').forEach(line => {
                    const baseQty = parseFloat(line.dataset.baseQty);
                    if (!isNaN(baseQty) && baseQty > 0) {
                        const newQty = baseQty * ratio;
                        const unit = line.dataset.unit || "";
                        let result;
                        if (unit === 'g' || unit === 'ml' || unit === 'oz' || unit === 'lb' || unit === 'pounds') {
                             result = { display: (Math.round(newQty * 10) / 10).toString(), unit: unit }; 
                             if (unit === 'g' || unit === 'ml') result.display = Math.round(newQty).toString();
                             if (unit === 'lb' || unit === 'pounds' || unit === 'oz') result.display = formatQuantity(newQty);
                        } else if (['cup', 'cups', 'tbsp', 'tsp', 'tablespoon', 'teaspoon'].some(u => unit.toLowerCase().startsWith(u))) {
                             result = convertUnits(newQty, unit);
                        } else {
                             result = { display: formatQuantity(newQty), unit: unit };
                        }
                        line.querySelector('.qty-display').textContent = result.display;
                        line.querySelector('.unit-display').textContent = result.unit;
                    }
                });
                
                document.querySelectorAll('.instruction-step').forEach(step => {
                    let text = step.dataset.originalText;
                    if (currentRecipeBase.ingredients) {
                        currentRecipeBase.ingredients.forEach(section => {
                            section.list.forEach(ing => {
                                const q = parseQuantity(ing.quantity);
                                if (q > 0) {
                                    const unit = ing.unit ? ing.unit.trim() : "";
                                    const qStr = ing.quantity.toString().replace('/', '\\/');
                                    const uStr = unit ? `\\s*${unit}s?` : "";
                                    const searchPattern = new RegExp(`\\b${qStr}${uStr}\\b`, 'gi');
                                    const newQVal = q * ratio;
                                    let replaceStr = "";
                                     if (unit === 'g' || unit === 'ml') { replaceStr = `${Math.round(newQVal)} ${unit}`; } 
                                     else if (['cup', 'cups', 'tbsp', 'tsp', 'tablespoon', 'teaspoon'].some(u => unit.toLowerCase().startsWith(u))) { const conv = convertUnits(newQVal, unit); replaceStr = `${conv.display} ${conv.unit}`; } 
                                     else { replaceStr = `${formatQuantity(newQVal)} ${unit}`; }
                                    text = text.replace(searchPattern, replaceStr.trim());
                                }
                            });
                        });
                    }
                    step.textContent = text;
                });
            };

            window.saveRecipe = function() {
                const title = document.getElementById('form-title').value;
                if(!title) return alert("Title is required");
                const newRecipe = {
                    id: currentEditingId || 'user_rec_' + Date.now(),
                    title: title,
                    description: document.getElementById('form-desc').value,
                    category: document.getElementById('form-category').value,
                    servings: parseInt(document.getElementById('form-servings').value) || 1,
                    prepTime: document.getElementById('form-prep').value,
                    cookTime: document.getElementById('form-cook').value,
                    image: document.getElementById('form-image').value,
                    source: { description: document.getElementById('form-source-desc').value, url: document.getElementById('form-source-url').value },
                    tags: document.getElementById('form-tags').value.split(',').map(t => t.trim()).filter(t => t),
                    ingredients: [], instructions: []
                };
                document.querySelectorAll('.ing-section').forEach(sec => {
                    const section = { sectionTitle: sec.querySelector('.section-title').value, list: [] };
                    sec.querySelectorAll('.ing-row').forEach(row => {
                        section.list.push({ name: row.querySelector('.ing-name').value, quantity: row.querySelector('.ing-qty').value, unit: row.querySelector('.ing-unit').value, notes: row.querySelector('.ing-notes').value, macros: { calories: parseFloat(row.querySelector('.macro-cal').value)||0, protein: parseFloat(row.querySelector('.macro-pro').value)||0, carbs: parseFloat(row.querySelector('.macro-carb').value)||0, fat: parseFloat(row.querySelector('.macro-fat').value)||0, fiber: parseFloat(row.querySelector('.macro-fib').value)||0 } });
                    });
                    newRecipe.ingredients.push(section);
                });
                document.querySelectorAll('.inst-section').forEach(sec => {
                    const section = { sectionTitle: sec.querySelector('.section-title').value, steps: [] };
                    sec.querySelectorAll('.step-text').forEach(txt => section.steps.push(txt.value));
                    newRecipe.instructions.push(section);
                });
                let customRecipes = getCustomData(state.localStorageKeys.recipes);
                const idx = customRecipes.findIndex(r => String(r.id) === String(newRecipe.id));
                if (idx >= 0) customRecipes[idx] = newRecipe; else customRecipes.push(newRecipe);
                saveCustomData(state.localStorageKeys.recipes, customRecipes);
                modals.recipe.classList.add('hidden');
                if (currentEditingId) window.showDetailView(newRecipe.id); else renderRecipeGroups();
            };

            window.deleteRecipe = function(id) {
                if(!confirm("Delete recipe?")) return;
                let customRecipes = getCustomData(state.localStorageKeys.recipes);
                const newParams = customRecipes.filter(r => String(r.id) !== String(id));
                saveCustomData(state.localStorageKeys.recipes, newParams);
                renderRecipeGroups();
            };

            window.saveCategory = function(e) {
                e.preventDefault();
                const val = document.getElementById('category-modal-input').value.trim();
                if(val) {
                    const d = getCustomData(state.localStorageKeys.categories);
                    if(!d.includes(val)) { d.push(val); saveCustomData(state.localStorageKeys.categories, d); }
                    modals.category.classList.add('hidden'); e.target.reset(); renderRecipeGroups();
                }
            };

            window.openRecipeModal = function(recipe = null) {
                currentEditingId = recipe ? recipe.id : null;
                document.getElementById('recipe-modal-title').textContent = recipe ? "Edit Recipe" : "Add Recipe";
                document.getElementById('form-recipe-id').value = recipe ? recipe.id : "";
                document.getElementById('full-recipe-form').reset();
                ingContainer.innerHTML = ''; instContainer.innerHTML = '';
                const cats = [...STATIC_CATEGORIES, ...getCustomData(state.localStorageKeys.categories)].filter((v,i,a)=>a.indexOf(v)===i);
                document.getElementById('form-category').innerHTML = cats.map(c => `<option>${c}</option>`).join('');

                if (recipe) {
                    document.getElementById('form-title').value = recipe.title;
                    document.getElementById('form-desc').value = recipe.description;
                    document.getElementById('form-category').value = recipe.category;
                    document.getElementById('form-servings').value = recipe.servings;
                    document.getElementById('form-prep').value = recipe.prepTime;
                    document.getElementById('form-cook').value = recipe.cookTime;
                    document.getElementById('form-image').value = recipe.image;
                    if(recipe.source) { document.getElementById('form-source-desc').value = recipe.source.description; document.getElementById('form-source-url').value = recipe.source.url; }
                    document.getElementById('form-tags').value = (recipe.tags || []).join(', ');
                    if(recipe.ingredients) recipe.ingredients.forEach(sec => window.addIngredientSection(sec));
                    if(recipe.instructions) recipe.instructions.forEach(sec => window.addInstructionSection(sec));
                } else { window.addIngredientSection(); window.addInstructionSection(); }
                modals.recipe.classList.remove('hidden');
                window.switchTab('tab-general');
                hideMenu();
            };

            window.showDetailView = function(recipeId) {
                currentEditingId = String(recipeId);
                const recipe = getAllRecipes().find(r => String(r.id) === String(recipeId));
                if (!recipe) return;
                currentRecipeBase = recipe;
                views.list.classList.add('hidden');
                views.detail.classList.remove('hidden');
                window.scrollTo(0,0);
                
                let tm = { fat: 0, carbs: 0, fiber: 0, protein: 0, calories: 0 };
                if(recipe.ingredients) recipe.ingredients.forEach(s => s.list && s.list.forEach(i => { if(i.macros) { tm.fat+=i.macros.fat||0; tm.carbs+=i.macros.carbs||0; tm.fiber+=i.macros.fiber||0; tm.protein+=i.macros.protein||0; tm.calories+=i.macros.calories||0; }}));
                const s = recipe.servings || 1;
                const ps = { fat: Math.round(tm.fat/s), carbs: Math.round(tm.carbs/s), fiber: Math.round(tm.fiber/s), protein: Math.round(tm.protein/s), calories: Math.round(tm.calories/s) };
                ps.netCarbs = Math.max(0, ps.carbs - ps.fiber);

                containers.detail.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-6 mb-8">
                        <img src="${recipe.image}" class="w-full md:w-1/3 rounded-xl object-cover h-64 shadow-lg border border-gray-700" onerror="this.src='https://placehold.co/400x250?text=No+Image'">
                        <div class="flex-1 flex flex-col justify-center">
                            <h1 class="text-4xl font-extrabold text-white mb-2">${recipe.title.replace(' (test)', '')}</h1>
                            ${recipe.source ? `<div class="text-sm text-blue-300 mb-4 font-medium">Source: ${recipe.source.url ? `<a href="${recipe.source.url}" target="_blank" class="underline hover:text-white transition">${recipe.source.description}</a>` : recipe.source.description}</div>` : ''}
                            <p class="text-gray-400 italic mb-6 text-lg">${recipe.description}</p>
                            <div class="flex gap-4 mb-6 text-sm"><span class="bg-gray-700 px-3 py-1 rounded">Prep: <strong>${recipe.prepTime}</strong></span><span class="bg-gray-700 px-3 py-1 rounded">Cook: <strong>${recipe.cookTime}</strong></span><div class="bg-gray-700 px-3 py-1 rounded flex items-center space-x-2 select-none"><span>Serves:</span><button onclick="window.updateServings(-1)" class="text-blue-400 hover:text-white font-bold text-lg px-1">‚àí</button><strong id="current-servings">${recipe.servings}</strong><button onclick="window.updateServings(1)" class="text-blue-400 hover:text-white font-bold text-lg px-1">+</button></div></div>
                            <div class="bg-gray-900/80 p-4 rounded-xl border border-gray-700"><h3 class="text-xs font-bold text-gray-500 uppercase mb-2 text-center">Per Serving</h3><div class="grid grid-cols-3 sm:grid-cols-6 gap-2 text-center"><div><div class="text-xl font-black text-white">${ps.calories}</div><div class="text-[10px] text-gray-500 uppercase">Cals</div></div><div><div class="text-lg font-bold text-blue-400">${ps.protein}g</div><div class="text-[10px] text-gray-500 uppercase">Prot</div></div><div><div class="text-lg font-bold text-green-400">${ps.carbs}g</div><div class="text-[10px] text-gray-500 uppercase">Carb</div></div><div><div class="text-lg font-bold text-emerald-400">${ps.netCarbs}g</div><div class="text-[10px] text-gray-500 uppercase">Net Carb</div></div><div><div class="text-lg font-bold text-yellow-400">${ps.fat}g</div><div class="text-[10px] text-gray-500 uppercase">Fat</div></div><div><div class="text-lg font-bold text-gray-300">${ps.fiber}g</div><div class="text-[10px] text-gray-500 uppercase">Fiber</div></div></div></div>
                        </div>
                    </div>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div><h2 class="text-2xl font-bold border-b border-blue-900/50 pb-2 mb-4 text-blue-300">Ingredients</h2>${(recipe.ingredients || []).map(section => `<div class="mb-6"><h3 class="text-lg font-semibold text-white mb-2 pl-2 border-l-2 border-blue-500">${section.sectionTitle}</h3><ul class="space-y-2">${section.list.map(ing => { 
                            const baseQty = parseQuantity(ing.quantity);
                            return `<li class="flex justify-between border-b border-gray-700/50 pb-1 ingredient-line" data-base-qty="${baseQty}" data-unit="${ing.unit}"><span class="text-gray-200"><span class="font-bold text-white qty-display">${ing.quantity}</span> <span class="font-bold text-white unit-display">${ing.unit}</span> ${ing.name}</span><span class="text-xs text-gray-500 italic ml-2">${ing.notes||''}</span></li>`
                        }).join('')}</ul></div>`).join('')}</div>
                        <div><h2 class="text-2xl font-bold border-b border-green-900/50 pb-2 mb-4 text-green-300">Instructions</h2>${(recipe.instructions || []).map(section => `<div class="mb-8"><h3 class="text-lg font-semibold text-white mb-3 pl-2 border-l-2 border-green-500">${section.sectionTitle}</h3><ol class="list-decimal list-outside space-y-4 text-gray-300 pl-5">${section.steps.map(step => `<li class="pl-2 instruction-step" data-original-text="${step.replace(/"/g, '&quot;')}">${step}</li>`).join('')}</ol></div>`).join('')}</div>
                    </div>
                `;
                document.getElementById('edit-recipe-btn').onclick = () => window.openRecipeModal(recipe);
                document.getElementById('delete-recipe-btn').onclick = () => window.deleteRecipe(recipe.id);
            };

            window.filterByTag = function(tag) { currentFilterTag = tag; renderRecipeGroups(); window.scrollTo(0,0); };
            window.clearTagFilter = function() { currentFilterTag = null; renderRecipeGroups(); };
            window.downloadDataFile = function() {
                hideMenu(); 
                const customRecipes = getCustomData(state.localStorageKeys.recipes);
                const cleanStatic = STATIC_RECIPES.map(r => ({...r, title: r.title.replace(' (test)', '')}));
                const exportMap = new Map();
                cleanStatic.forEach(r => exportMap.set(String(r.id), r));
                customRecipes.forEach(r => exportMap.set(String(r.id), r)); 
                const data = { recipes: Array.from(exportMap.values()), categories: [...STATIC_CATEGORIES, ...getCustomData(state.localStorageKeys.categories)].filter((v,i,a)=>a.indexOf(v)===i), availableTags: [...STATIC_TAGS, ...getCustomData(state.localStorageKeys.tags)].filter((v,i,a)=>a.indexOf(v)===i) };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `recipes-data-${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };
            window.clearDraftData = function() {
                localStorage.removeItem(state.localStorageKeys.recipes);
                localStorage.removeItem(state.localStorageKeys.categories);
                localStorage.removeItem(state.localStorageKeys.tags);
                hideMenu();
                initRecipeDashboard();
            };

            function createRecipeCard(r) {
                const letter = r.title.charAt(0).toUpperCase();
                const tags = (r.tags||[]).map(t => `<span class="px-2 py-0.5 text-xs rounded-full bg-blue-900/50 text-blue-300 hover:bg-blue-600 hover:text-white transition" onclick="event.stopPropagation(); filterByTag('${t}')">${t}</span>`).join('');
                return `<div class="recipe-card bg-gray-800 border border-gray-700 rounded-xl shadow-lg overflow-hidden hover:bg-gray-700 transition duration-200" onclick="showDetailView('${r.id}')"><img src="${r.image}" class="w-full h-32 object-cover" onerror="this.src='https://placehold.co/400?text=${r.title[0]}'"><div class="p-3"><h3 class="text-lg font-bold text-white truncate">${r.title.replace(' (test)','')}</h3><p class="text-xs text-gray-400 mt-1 mb-2">${r.prepTime} | ${r.cookTime}</p><div class="flex flex-wrap gap-1">${tags}</div></div></div>`;
            }

            function renderRecipeGroups() {
                views.detail.classList.add('hidden');
                views.list.classList.remove('hidden');
                const allRecipes = getAllRecipes();
                containers.groups.innerHTML = '';
                const allTagsSet = new Set([...STATIC_TAGS, ...getCustomData(state.localStorageKeys.tags)]);
                allRecipes.forEach(r => (r.tags||[]).forEach(t => allTagsSet.add(t)));
                const sortedTags = Array.from(allTagsSet).sort();
                const getSize = c => c>3?"text-4xl font-black":c>2?"text-2xl font-bold":c>1?"text-lg font-semibold":"text-xs font-normal text-gray-400";
                const colors = ["text-blue-400","text-green-400","text-yellow-400","text-red-400","text-purple-400","text-pink-400"];
                const counts = {}; allRecipes.forEach(r => (r.tags||[]).forEach(t => counts[t]=(counts[t]||0)+1));
                containers.tags.innerHTML = sortedTags.map(tag => `<button onclick="filterByTag('${tag}')" class="tag-cloud-item ${getSize(counts[tag])} ${colors[Math.floor(Math.random()*colors.length)]} hover:scale-110 transition duration-200 cursor-pointer px-2">${tag}</button>`).join('');

                if (currentFilterTag) {
                    const filtered = allRecipes.filter(r => (r.tags || []).includes(currentFilterTag));
                    containers.groups.innerHTML = `<div class="flex items-center justify-between mb-4"><h2 class="text-2xl font-bold text-white">Recipes Tagged: <span class="text-blue-400">${currentFilterTag}</span></h2><button onclick="clearTagFilter()" class="text-sm bg-gray-700 px-3 py-1 rounded text-gray-200">Clear Filter ‚úï</button></div><div class="flex flex-wrap gap-4 justify-start">${filtered.map(r => createRecipeCard(r)).join('')}</div>`;
                    return;
                }

                const customCats = getCustomData(state.localStorageKeys.categories);
                const allCategories = [...STATIC_CATEGORIES, ...customCats].filter((v, i, a) => a.indexOf(v) === i);
                const grouped = new Map();
                allRecipes.forEach(r => { const c = r.category || 'Uncategorized'; if(!grouped.has(c)) grouped.set(c, []); grouped.get(c).push(r); });
                
                [...allCategories, 'Uncategorized'].forEach(cat => {
                    const recipes = grouped.get(cat);
                    if(recipes && recipes.length) {
                        containers.groups.innerHTML += `<section><div class="bg-gray-800 border border-gray-700 inline-block px-4 py-1.5 rounded-full mb-4 text-lg font-semibold text-white shadow-md">${cat.replace(' (test)', '')}</div><div class="flex flex-wrap gap-4 justify-start">${recipes.map(r => createRecipeCard(r)).join('')}</div></section>`;
                    }
                });
                if(!containers.groups.innerHTML) containers.groups.innerHTML = '<p class="text-center text-gray-500 mt-10">No recipes found.</p>';
            }

            // --- EVENT HANDLERS ---
            document.getElementById('menu-button').onclick = (e) => { e.stopPropagation(); toggleMenu(); };
            document.getElementById('close-menu-button').onclick = hideMenu;
            document.body.onclick = (e) => { if (!menuModal.contains(e.target) && !document.getElementById('menu-button').contains(e.target)) hideMenu(); };

            document.getElementById('add-recipe-button').onclick = () => { window.openRecipeModal(); hideMenu(); };
            document.getElementById('add-category-button').onclick = () => { modals.category.classList.remove('hidden'); hideMenu(); };
            document.getElementById('download-data-button').onclick = window.downloadDataFile;
            document.getElementById('clear-draft-button').onclick = window.clearDraftData;
            
            document.querySelectorAll('.close-simple-modal').forEach(b => b.onclick = () => { modals.category.classList.add('hidden'); });
            document.getElementById('cancel-recipe-btn').onclick = () => modals.recipe.classList.add('hidden');
            document.getElementById('close-recipe-modal').onclick = () => modals.recipe.classList.add('hidden');
            document.querySelectorAll('.tab-btn').forEach(btn => btn.onclick = (e) => window.switchTab(e.target.dataset.tab));

            document.getElementById('add-ing-section-btn').onclick = () => window.addIngredientSection();
            document.getElementById('add-inst-section-btn').onclick = () => window.addInstructionSection();
            document.getElementById('save-recipe-btn').onclick = window.saveRecipe;
            document.getElementById('back-to-list').onclick = renderRecipeGroups;
            document.getElementById('category-form').onsubmit = saveCategory;

            // --- INIT ---
            async function initRecipeDashboard() {
                let data = EMBEDDED_RECIPES;
                try { const res = await fetch('/recipes_data.json'); if(res.ok) data = await res.json(); } catch(e) {}
                STATIC_RECIPES = data.recipes || []; STATIC_CATEGORIES = data.categories || []; STATIC_TAGS = data.availableTags || [];
                renderRecipeGroups();
            }

            async function updateWeather() {
                try { const res = await fetch('https://api.openweathermap.org/data/2.5/weather?zip=75482,us&units=imperial&appid=87256fe2710631542ff491e4c5d73306'); if(res.ok) { const d = await res.json(); document.getElementById('weather-current-temp').textContent = Math.round(d.main.temp)+'¬∞'; document.getElementById('weather-current-temp').className = `text-lg font-bold mr-3 ${getTempColor(d.main.temp)}`; document.getElementById('weather-low').textContent = Math.round(d.main.temp_min)+'¬∞'; document.getElementById('weather-low').className = `low-temp-offset mr-1 text-xs ${getTempColor(d.main.temp_min)}`; document.getElementById('weather-high').textContent = Math.round(d.main.temp_max)+'¬∞'; document.getElementById('weather-high').className = `high-temp-offset text-xs ${getTempColor(data.main.temp_max)}`; document.getElementById('weather-icon').innerHTML = getForecastEmoji(d.weather[0].icon); } } catch(e) {}
            }
            function updateClock() { const now = new Date(); document.getElementById('datetime').innerHTML = `<span class="text-gray-400">${now.toLocaleDateString()}</span> <span class="text-blue-300 ml-1">${now.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'}).toLowerCase()}</span>`; }

            window.onload = () => { initRecipeDashboard(); setInterval(updateClock, 1000); updateClock(); updateWeather(); };
        })();
    </script>
</body>
</html>
