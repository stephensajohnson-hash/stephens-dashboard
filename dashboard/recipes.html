<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stephens' Recipes V0.5.5</title>
    <link rel="icon" href="/images/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { transition: color 0.2s ease-in-out, background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6B7280; }
        html { font-family: 'Inter', sans-serif; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); }
        .recipe-card { width: 100%; max-width: 300px; min-width: 250px; cursor: pointer; }
        .low-temp-offset { position: relative; top: 2px; }
        .high-temp-offset { position: relative; bottom: 2px; }
    </style>
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'], }, } } }
    </script>
</head>
<body class="bg-gray-900 text-white min-h-screen p-4 sm:p-8">

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 right-0 bg-gray-800 border-b border-gray-700 shadow-xl z-30 p-2 flex items-center justify-between">
        <div class="flex items-center">
            <button id="menu-button" class="p-2 rounded-full bg-gray-700 hover:bg-gray-600 focus:outline-none mr-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
            <a href="index.html" class="text-gray-400 hover:text-white mr-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0h6"></path></svg>
            </a>
            <div id="datetime" class="text-sm sm:text-base font-medium"></div>
        </div>
        <div id="weather-display" class="text-sm flex items-center bg-gray-700 px-3 py-1 rounded-full border border-gray-600">
            <span class="flex items-center" id="weather-content">
                <span id="weather-current-temp" class="text-lg font-bold mr-3">--°</span>
                <span id="weather-low" class="low-temp-offset mr-1 text-xs">--°</span>
                <span class="mr-1 text-xl" id="weather-icon">...</span>
                <span id="weather-high" class="high-temp-offset text-xs">--°</span>
            </span>
        </div>
    </nav>

    <!-- Menu Dropdown -->
    <div id="menu-modal" class="fixed top-[4rem] left-4 z-40 opacity-0 pointer-events-none transform -translate-y-4 transition-all duration-300 ease-out max-w-xs">
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 shadow-2xl w-64">
            <div class="flex justify-between items-center mb-3 border-b border-gray-700 pb-2">
                <h3 class="text-xl font-semibold text-white">Recipe Menu</h3>
                <button id="close-menu-button" class="text-gray-400 hover:text-white p-1">X</button>
            </div>
            <button id="add-recipe-button" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-2 transition duration-150">Add New Recipe</button>
            <button id="add-category-button" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-2 transition duration-150">Add New Category</button>
            <button id="add-tag-button" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-4 transition duration-150">Add New Tag</button>
            <button id="download-data-button" class="w-full text-left py-2 px-3 rounded-lg text-gray-200 hover:bg-gray-700 mb-4 transition duration-150">Download Data File</button>
            <button id="clear-draft-button" class="w-full text-left py-2 px-3 rounded-lg text-red-400 hover:bg-red-900/20 mb-4 transition duration-150 border border-red-700/50">Clear Draft Data</button>
            <p id="version-display" class="text-sm font-mono text-gray-300">Recipe Dashboard V0.5.5</p>
        </div>
    </div>

    <!-- LIST VIEW Container -->
    <main id="recipes-content" class="px-4 sm:px-8 pt-16 pb-8">
        <div class="flex items-center justify-between mb-6">
            <div class="flex space-x-3 bg-gray-800 p-1 rounded-lg border border-gray-700">
                <button id="group-by-category" class="px-4 py-2 text-sm font-medium rounded-md bg-blue-600 text-white">Group by Category</button>
                <button id="group-by-tag" class="px-4 py-2 text-sm font-medium rounded-md text-gray-400">Group by Tag</button>
            </div>
        </div>
        <div id="recipe-groups-container" class="flex flex-col space-y-8"></div>
    </main>

    <!-- DETAIL VIEW Container (Hidden by default) -->
    <main id="recipe-detail-view" class="px-4 sm:px-8 pt-16 pb-8 hidden">
        <button id="back-to-list" class="mb-4 flex items-center text-gray-400 hover:text-white">
            <span class="mr-1">←</span> Back to Recipes
        </button>
        <div id="detail-content" class="bg-gray-800 rounded-2xl p-6 border border-gray-700 shadow-2xl max-w-4xl mx-auto">
            <!-- Content injected via JS -->
        </div>
    </main>
    
    <!-- MODALS -->
    <div id="add-category-modal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Add Category</h2>
            <form id="category-form"><input type="text" id="category-name" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white mb-4" placeholder="Name" required>
            <div class="flex justify-end gap-2"><button type="button" id="cancel-category-button" class="text-gray-400">Cancel</button><button type="submit" class="bg-green-600 px-4 py-2 rounded">Add</button></div></form>
        </div>
    </div>

    <div id="add-tag-modal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Add Tag</h2>
            <form id="tag-form"><input type="text" id="tag-name" class="w-full bg-gray-700 border border-gray-600 rounded p-2 text-white mb-4" placeholder="Name" required>
            <div class="flex justify-end gap-2"><button type="button" id="cancel-tag-button" class="text-gray-400">Cancel</button><button type="submit" class="bg-green-600 px-4 py-2 rounded">Add</button></div></form>
        </div>
    </div>

    <!-- JS Logic -->
    <script>
        (function() {
            // --- STATE & DOM ---
            const views = { list: document.getElementById('recipes-content'), detail: document.getElementById('recipe-detail-view') };
            const containers = { groups: document.getElementById('recipe-groups-container'), detail: document.getElementById('detail-content') };
            
            let STATIC_RECIPES = [], STATIC_CATEGORIES = [], STATIC_TAGS = [];
            let isTagMode = false;

            const state = { localStorageKeys: { recipes: 'sd_custom_recipes', categories: 'sd_custom_categories', tags: 'sd_custom_tags' } };
            
            // --- EMBEDDED DATA (Fallback) ---
            const EMBEDDED_RECIPES = {
                "categories": ["Bread", "Soup", "Dessert"], "availableTags": ["gluten free", "keto"],
                "recipes": [
                    {
                      "id": "1", "title": "Hearty Classic Chili", "category": "Soup", "description": "Classic comfort food.",
                      "tags": ["Dinner", "Comfort Food"], "prepTime": "15 mins", "cookTime": "4 hours", "servings": 8,
                      "image": "https://placehold.co/400x250/111827/ffffff?text=Chili",
                      "source": { "description": "Grandma's recipe", "url": "" },
                      "ingredients": [ { "sectionTitle": "Base", "list": [ { "name": "Ground Beef", "quantity": 2, "unit": "lbs", "macros": { "fat": 110, "carbs": 0, "protein": 140, "calories": 1500 } } ] } ],
                      "instructions": [ { "sectionTitle": "Prep", "steps": ["Cook beef."] } ]
                    }
                ]
            };

            // --- HELPERS ---
            function getCustomData(key) { try { return JSON.parse(localStorage.getItem(key)) || []; } catch { return []; } }
            function saveCustomData(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
            
            // --- UI FUNCTIONS ---
            function showDetailView(recipeId) {
                const allRecipes = [...STATIC_RECIPES, ...getCustomData(state.localStorageKeys.recipes)];
                const recipe = allRecipes.find(r => r.id == recipeId);
                if (!recipe) return;

                views.list.classList.add('hidden');
                views.detail.classList.remove('hidden');
                
                // Calculate Macros
                let totalMacros = { fat: 0, carbs: 0, fiber: 0, protein: 0, calories: 0 };
                if(recipe.ingredients) {
                    recipe.ingredients.forEach(sec => {
                        if(sec.list) sec.list.forEach(ing => {
                            if(ing.macros) {
                                totalMacros.fat += (ing.macros.fat || 0);
                                totalMacros.carbs += (ing.macros.carbs || 0);
                                totalMacros.fiber += (ing.macros.fiber || 0);
                                totalMacros.protein += (ing.macros.protein || 0);
                                totalMacros.calories += (ing.macros.calories || 0);
                            }
                        });
                    });
                }
                
                const servings = recipe.servings || 1;
                const perServing = {
                    fat: Math.round(totalMacros.fat / servings),
                    carbs: Math.round(totalMacros.carbs / servings),
                    fiber: Math.round(totalMacros.fiber / servings),
                    protein: Math.round(totalMacros.protein / servings),
                    calories: Math.round(totalMacros.calories / servings)
                };

                // Render Detail
                containers.detail.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-6 mb-6">
                        <img src="${recipe.image}" class="w-full md:w-1/3 rounded-xl object-cover h-64 shadow-lg">
                        <div class="flex-1">
                            <h1 class="text-4xl font-bold text-white mb-2">${recipe.title.replace(' (test)', '')}</h1>
                            <p class="text-gray-400 italic mb-4">${recipe.description}</p>
                            <div class="flex flex-wrap gap-2 mb-4">
                                <span class="bg-gray-700 px-3 py-1 rounded-lg text-sm">Prep: ${recipe.prepTime}</span>
                                <span class="bg-gray-700 px-3 py-1 rounded-lg text-sm">Cook: ${recipe.cookTime}</span>
                                <span class="bg-gray-700 px-3 py-1 rounded-lg text-sm">Serves: ${recipe.servings}</span>
                            </div>
                            
                            <!-- Macro Table -->
                            <div class="bg-gray-900/50 p-4 rounded-xl border border-gray-700">
                                <h3 class="text-sm font-bold text-gray-400 uppercase mb-2">Nutrition Per Serving</h3>
                                <div class="grid grid-cols-5 gap-2 text-center">
                                    <div><div class="text-xl font-bold text-white">${perServing.calories}</div><div class="text-xs text-gray-500">Cals</div></div>
                                    <div><div class="text-xl font-bold text-blue-400">${perServing.protein}g</div><div class="text-xs text-gray-500">Prot</div></div>
                                    <div><div class="text-xl font-bold text-green-400">${perServing.carbs}g</div><div class="text-xs text-gray-500">Carb</div></div>
                                    <div><div class="text-xl font-bold text-yellow-400">${perServing.fat}g</div><div class="text-xs text-gray-500">Fat</div></div>
                                    <div><div class="text-xl font-bold text-white">${perServing.fiber}g</div><div class="text-xs text-gray-500">Fiber</div></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <h2 class="text-2xl font-bold border-b border-gray-700 pb-2 mb-4 text-blue-300">Ingredients</h2>
                            ${(recipe.ingredients || []).map(section => `
                                <div class="mb-4">
                                    <h3 class="text-lg font-semibold text-gray-300 mb-2">${section.sectionTitle}</h3>
                                    <ul class="space-y-2">
                                        ${section.list.map(ing => `
                                            <li class="flex justify-between border-b border-gray-700/50 pb-1">
                                                <span>${ing.quantity} ${ing.unit} <strong>${ing.name}</strong></span>
                                                <span class="text-xs text-gray-500 italic">${ing.notes || ''}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold border-b border-gray-700 pb-2 mb-4 text-green-300">Instructions</h2>
                            ${(recipe.instructions || []).map(section => `
                                <div class="mb-6">
                                    <h3 class="text-lg font-semibold text-gray-300 mb-2">${section.sectionTitle}</h3>
                                    <ol class="list-decimal list-inside space-y-3 text-gray-300">
                                        ${section.steps.map(step => `<li>${step}</li>`).join('')}
                                    </ol>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    ${recipe.source ? `
                    <div class="mt-8 pt-4 border-t border-gray-700 text-sm text-gray-500">
                        <strong>Source:</strong> ${recipe.source.description} 
                        ${recipe.source.url ? `<a href="${recipe.source.url}" target="_blank" class="text-blue-400 hover:underline ml-1">(Link)</a>` : ''}
                    </div>` : ''}
                `;
            }

            function renderRecipeGroups() {
                views.detail.classList.add('hidden');
                views.list.classList.remove('hidden');
                
                const allRecipes = [...STATIC_RECIPES, ...getCustomData(state.localStorageKeys.recipes)];
                const customCats = getCustomData(state.localStorageKeys.categories);
                const customTags = getCustomData(state.localStorageKeys.tags);
                
                const groupingList = isTagMode 
                    ? [...STATIC_TAGS, ...customTags].filter((v, i, a) => a.indexOf(v) === i)
                    : [...STATIC_CATEGORIES, ...customCats].filter((v, i, a) => a.indexOf(v) === i);

                const defaultGroup = isTagMode ? 'Untagged' : 'Uncategorized';
                containers.groups.innerHTML = '';

                const groupedRecipes = new Map();
                allRecipes.forEach(recipe => {
                    if (isTagMode) {
                        const tags = recipe.tags || [];
                        if (tags.length === 0) {
                             if (!groupedRecipes.has(defaultGroup)) groupedRecipes.set(defaultGroup, []);
                             groupedRecipes.get(defaultGroup).push(recipe);
                        } else {
                            tags.forEach(tag => {
                                if(groupingList.includes(tag)) {
                                    if (!groupedRecipes.has(tag)) groupedRecipes.set(tag, []);
                                    groupedRecipes.get(tag).push(recipe);
                                }
                            });
                        }
                    } else {
                        const cat = recipe.category || defaultGroup;
                        if (!groupedRecipes.has(cat)) groupedRecipes.set(cat, []);
                        groupedRecipes.get(cat).push(recipe);
                    }
                });

                [...groupingList, defaultGroup].forEach(groupName => {
                    const recipes = groupedRecipes.get(groupName);
                    if (recipes && recipes.length > 0) {
                        const section = document.createElement('section');
                        section.innerHTML = `<div class="bg-gray-800 border border-gray-700 inline-block px-4 py-1.5 rounded-full mb-4 text-lg font-semibold text-white shadow-md">${groupName.replace(' (test)', '')}</div>`;
                        const grid = document.createElement('div');
                        grid.className = 'flex flex-wrap gap-4 justify-start';
                        
                        recipes.forEach(r => {
                            const card = document.createElement('div');
                            card.className = 'recipe-card bg-gray-800 border border-gray-700 rounded-xl shadow-lg overflow-hidden hover:bg-gray-700 transition duration-200';
                            card.onclick = () => showDetailView(r.id);
                            const letter = r.title.charAt(0).toUpperCase();
                            card.innerHTML = `
                                <img src="${r.image}" class="w-full h-32 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x250/1F2937/FFFFFF?text=${letter}';"/>
                                <div class="p-3">
                                    <h3 class="text-lg font-bold text-white truncate">${r.title.replace(' (test)', '')}</h3>
                                    <p class="text-xs text-gray-400 mt-1">${r.prepTime} | ${r.cookTime}</p>
                                </div>`;
                            grid.appendChild(card);
                        });
                        section.appendChild(grid);
                        containers.groups.appendChild(section);
                    }
                });
                if(containers.groups.innerHTML === '') containers.groups.innerHTML = '<p class="text-center text-gray-500 mt-10">No recipes found.</p>';
            }

            // --- INITIALIZATION ---
            async function init() {
                let data = EMBEDDED_RECIPES;
                try {
                    const res = await fetch('/recipes_data.json');
                    if(res.ok) data = await res.json();
                } catch(e) { console.warn('Using embedded recipes'); }
                
                STATIC_RECIPES = data.recipes || [];
                STATIC_CATEGORIES = data.categories || [];
                STATIC_TAGS = data.availableTags || [];
                renderRecipeGroups();
            }

            // Events
            document.getElementById('back-to-list').onclick = renderRecipeGroups;
            document.getElementById('group-by-category').onclick = () => { isTagMode = false; renderRecipeGroups(); };
            document.getElementById('group-by-tag').onclick = () => { isTagMode = true; renderRecipeGroups(); };
            
            // Menu & Modals (Simplified for brevity - assume logic from previous block exists for modals)
            document.getElementById('menu-button').onclick = (e) => { e.stopPropagation(); document.getElementById('menu-modal').classList.toggle('hidden'); document.getElementById('menu-modal').classList.toggle('opacity-0'); };
            document.getElementById('close-menu-button').onclick = () => document.getElementById('menu-modal').classList.add('opacity-0');
            
            // Weather & Clock placeholders
            function updateWeather() { /* ... */ }
            window.onload = () => { init(); updateWeather(); };
        })();
    </script>
</body>
</html>
